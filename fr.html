<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>
   Concepteur Pédagogique
  </title>
<script src="https://cdn.tailwindcss.com">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js">
</script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
<style>
   @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
            font-size: 0.92rem;line-height: 1.4;
        }

        
        .pattern-stripes {
            background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);
            background-size: 8px 8px;
        }
        
        .pattern-dots {
            background-image: radial-gradient(rgba(255,255,255,0.5) 1.5px, transparent 1.5px);
            background-size: 6px 6px;
        }

        .pattern-vertical {
            background-image: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 4px);
        }

        .pattern-grid-dark {
             background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 6px 6px;
        }

        
        body.hide-types .learning-type-container,
        body.hide-types .timeline-track-pedagogy,
        body.hide-types .activity-type-bar {
            display: none !important;
        }

        .activity-container {
            border-left: 3px solid #cbd5e1; 
        }

        .step-card {
            transition: transform 0.1s ease;
        }

        
        .sortable-ghost {
            opacity: 0.3;
            background-color: #f1f5f9 !important;
            border: 2px dashed #94a3b8 !important;
        }

        .sortable-drag {
            cursor: grabbing;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        
        .type-none { border-left: 5px solid #e5e7eb; }

        .type-acquisition { border-left: 5px solid #a1f5ed; } 
        .type-collaboration { border-left: 5px solid #ffd966; } 
        .type-discussion { border-left: 5px solid #7aaeea; } 
        .type-investigation { border-left: 5px solid #f8807f; } 
        .type-practice { border-left: 5px solid #bb98dc; } 
        .type-production { border-left: 5px solid #bdea75; } 

        .select-none { background-color: #e5e7eb; color: #000; border-color: #d1d5db; }
 

        .select-acquisition { background-color: #a1f5ed; color: #000; border-color: #7dded6; }
        .select-collaboration { background-color: #ffd966; color: #000; border-color: #f0c953; }
        .select-discussion { background-color: #7aaeea; color: #000; border-color: #6a9bd6; }
        .select-investigation { background-color: #f8807f; color: #000; border-color: #e06e6d; }
        .select-practice { background-color: #bb98dc; color: #000; border-color: #a582c6; }
        .select-production { background-color: #bdea75; color: #000; border-color: #a6d15e; }

        .drag-handle {
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        
        .material-icons-round {
            display: inline-flex;
            vertical-align: middle;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        
        .panel-content {
            transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .panel-content.open {
            max-height: 2000px; 
            opacity: 1;
        }
        .rotate-icon {
            transition: transform 0.2s ease;
        }
        .rotate-icon.open {
            transform: rotate(180deg);
        }

        
        .step-body {
            transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
            max-height: 2000px;
            opacity: 1;
            overflow: hidden;
        }
        .step-body.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding-bottom: 0 !important;
        }

        
        .activity-body {
            transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
            max-height: 5000px; 
            opacity: 1;
            overflow: hidden;
        }
        .activity-body.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        
        
        .moment-body {
            transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
            max-height: 5000px;
            opacity: 1;
            overflow: hidden;
        }
        .moment-body.collapsed {
            max-height: 0;
            opacity: 0;
        }
input, select, textarea {
            font-size: 0.9rem;
        }

        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }

        :focus-visible {
            outline: 2px solid rgba(99, 102, 241, 0.55);
            outline-offset: 2px;
        }
        
        .compact-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #64748b;
            letter-spacing: 0.04em;
            margin-bottom: 4px;
        }

        .compact-label-lg {
            font-size: 0.8rem;
        }

        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .activity-group { break-inside: avoid; margin-bottom: 1rem; border: none; border-radius: 8px; padding: 0.5rem; }
            .step-card { border: none; break-inside: avoid; margin-bottom: 0.5rem; }
            select { appearance: none; border: none; padding: 0; background: none; }
            textarea { border: none; padding: 0; }
            #key-params-panel { max-height: none !important; opacity: 1 !important; display: block !important; }
            .step-body.collapsed, .activity-body.collapsed { max-height: none !important; opacity: 1 !important; display: block !important; }
        }
    

        
        .activity-group { scroll-margin-top: 80px; }
        .step-card { box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06); }
        .step-card:hover { box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08); }
        .activity-title { letter-spacing: -0.01em; }
        .activity-container { border-left-color: #cbd5e1; }

        
        header { margin-bottom: 0.5rem ; }
        .activity-group { padding: 0.5rem ; }
        .activity-group > .flex { margin-bottom: 0.5rem ; gap: 0.5rem ; }
        .step-card > .flex.items-center { padding: 6px 8px ; gap: 0.5rem ; }
        .step-body.panel-content { padding: 0.5rem ; padding-top: 0.35rem ; }
        .activity-description { padding: 0.35rem 0.5rem ; font-size: 0.85rem ; }
        .activity-steps-container { padding-top: 0.25rem; }
        input, select, textarea { font-size: 0.88rem; }
        .compact-label { font-size: 0.68rem; margin-bottom: 2px; }
        .compact-label-lg { font-size: 0.74rem; }

        
        .step-body label [data-i18n="label_grouping"] { font-size: 10px; }
        #timeline-panel { gap: 0.75rem ; }
        #timeline-panel .timeline-track-pedagogy,
        #timeline-panel .flex.flex-col.gap-0\.5 { gap: 0.35rem ; }

        
        
        #timeline-panel [data-i18n^="label_timeline_"] { font-size: 0.82rem ; }
        #timeline-panel [data-i18n^="label_"][data-i18n$="grouping"],
        #timeline-panel [data-i18n="label_trainer"],
        #timeline-panel [data-i18n="label_place"],
        #timeline-panel [data-i18n="label_time"] { font-size: 0.95rem ; }
        #timeline-panel [data-i18n^="legend_"] { font-size: 0.82rem ; }
        #timeline-panel #timeline-activities-planned-labels,
        #timeline-panel #timeline-activities-labels { font-size: 0.85rem ; }
        #timeline-ruler { font-size: 0.82rem ; }

        body.hc {
            background-color: #ffffff;
            color: #0f172a;
        }
        body.hc .text-slate-300 { color: #475569 !important; }
        body.hc .text-slate-400 { color: #334155 !important; }
        body.hc .text-slate-500 { color: #334155 !important; }
        body.hc .text-slate-600 { color: #1f2937 !important; }
        body.hc .text-slate-700 { color: #0f172a !important; }
        body.hc .bg-slate-50 { background-color: #f8fafc !important; }
        body.hc .bg-slate-100 { background-color: #f1f5f9 !important; }
        body.hc .border-slate-100 { border-color: #cbd5e1 !important; }
        body.hc .border-slate-200 { border-color: #94a3b8 !important; }
        body.hc .border-slate-300 { border-color: #64748b !important; }
        body.hc .activity-container { border-left-color: #475569 !important; }
        body.hc .activity-type-bar { background-color: #e2e8f0 !important; border-color: #94a3b8 !important; }
        body.hc #timeline-activities-planned,
        body.hc #timeline-activities,
        body.hc #timeline-steps,
        body.hc #timeline-grouping,
        body.hc #timeline-trainer,
        body.hc #timeline-place,
        body.hc #timeline-time {
            border-color: #94a3b8 !important;
            background-color: #e2e8f0 !important;
        }
        body.hc #timeline-ruler { color: #0f172a !important; }
        body.hc #custom-confirm-modal { background-color: rgba(15, 23, 42, 0.75) !important; }
        body.hc #global-tooltip { background-color: #0f172a !important; border-color: #0f172a !important; }
        body.hc :focus-visible {
            outline-color: rgba(37, 99, 235, 0.8);
        }

#timeline-panel { gap: 0.75rem; }

#timeline-details { gap: 0.35rem; }

#timeline-details .timeline-track { padding: 0.40rem; }
#timeline-details .timeline-track { background: transparent !important; border: 0 !important; }

#timeline-details [data-i18n="label_grouping"],
#timeline-details [data-i18n="label_trainer"],
#timeline-details [data-i18n="label_place"],
#timeline-details [data-i18n="label_time"],
.step-card [data-i18n="label_grouping"],
.step-card [data-i18n="label_trainer"],
.step-card [data-i18n="label_place"],
.step-card [data-i18n="label_time"]{
  font-size: 10px !important;
}

.step-card .step-group-mode,
.step-card .trainer-select,
.step-card .place-select,
.step-card .time-select {
  font-size: 10px !important;
}

#timeline-panel .timeline-duration-label { background: transparent !important; border: 0 !important; box-shadow: none !important; }

#timeline-panel .timeline-track { transition: box-shadow 0.15s ease; }
#timeline-panel .timeline-track:hover { box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06); }
#timeline-panel { padding: 0.5rem ; }
#timeline-panel #timeline-activities-planned,
#timeline-panel #timeline-activities,
#timeline-panel #timeline-steps { height: 1.25rem ; }
#timeline-panel #timeline-grouping,
#timeline-panel #timeline-trainer,
#timeline-panel #timeline-place,
#timeline-panel #timeline-time { height: 0.95rem ; }
#timeline-panel #timeline-ruler { height: 2.25rem ; }

#timeline-ruler { padding: 0.25rem 0.4rem 0.15rem 0.4rem; }
#timeline-ruler .timeline-ruler-tick { top: 0.3rem; bottom: 1.15rem; background-color: #94a3b8; }
#timeline-ruler .timeline-ruler-label {
    bottom: 0.15rem;
    font-size: 0.78rem;
    font-weight: 400;
    color: #0f172a;
    background-color: rgba(255, 255, 255, 0.92);
    border: none;
    padding: 0 0.25rem;
    border-radius: 0.25rem;
    line-height: 1.1;
}
#timeline-ruler .timeline-ruler-label { font-size: 0.74rem; }
body.hc #timeline-ruler .timeline-ruler-tick { background-color: #475569; }
body.hc #timeline-ruler .timeline-ruler-label { border-color: #94a3b8; background-color: #ffffff; }
  

.moment-target-wrap{display:none !important;}

  
  .timeline-missing-light,
  .timeline-alert-light{
    
    background:
      repeating-linear-gradient(
        135deg,
        rgba(254, 202, 202, 0.95),
        rgba(254, 202, 202, 0.95) 8px,
        rgba(239, 68, 68, 0.22) 8px,
        rgba(239, 68, 68, 0.22) 16px
      );
    box-shadow: inset 0 0 0 2px rgba(239, 68, 68, 0.95);
  }

  
  .duration-alert-light{
    background: rgba(254, 202, 202, 0.95) !important;
    border-color: rgba(239, 68, 68, 0.55) !important;
    box-shadow: inset 0 0 0 2px rgba(239, 68, 68, 0.35) !important;
  }

  
  .timeline-alert-icons{
    position:absolute;
    top:-18px;
    right:6px;
    display:flex;
    gap:6px;
    align-items:center;
    z-index:60;
    pointer-events:none;
    padding:2px 6px;
    border-radius:9999px;
    background: rgba(239, 68, 68, 0.92);
    box-shadow: 0 2px 10px rgba(15, 23, 42, 0.35);
     color: #ffffff;
    font-size: 12px;
    font-weight: 800;
    line-height: 1;
    letter-spacing: 0.2px;
    text-transform: uppercase;
  }
  .timeline-alert-icons svg{
    width:16px;
    height:16px;
    opacity:1;
    filter: drop-shadow(0 1px 2px rgba(15, 23, 42, 0.45));
  }

  
  @keyframes timelineAlertPulse{
    0%, 100% { filter: saturate(1) brightness(1); }
    50%      { filter: saturate(1.15) brightness(1.05); }
  }
  .timeline-missing-light,
  .timeline-alert-light{
    animation: timelineAlertPulse 1.4s ease-in-out infinite;
  }

  
  .timeline-overrun-light{background:#fecaca;}

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

        .timeline-zoom-outer{
            overflow-x: auto !important;
            overflow-y: hidden !important;
        }
        .timeline-inner{
            display: flex;
            height: 100%;
            min-width: 100%;
        }

#timelines-wrapper{
  width: 100%;
  max-width: 100%;
  min-width: 0; 
  box-sizing: border-box;
}
#timelines-wrapper .panel-content,
#timelines-wrapper #timeline-panel{
  width: 100%;
  max-width: 100%;
  min-width: 0;
  box-sizing: border-box;
}
#timelines-wrapper #timeline-panel{
  overflow-x: hidden; 
}
#timelines-wrapper .timeline-track,
#timelines-wrapper .timeline-track > *{
  max-width: 100%;
  min-width: 0;
  box-sizing: border-box;
}

#timelines-wrapper .timeline-zoom-outer{
  max-width: 100%;
  overflow-x: auto !important;
  overflow-y: hidden !important;
}

#timeline-panel #timeline-activities{
  overflow-x: hidden !important;
  overflow-y: visible !important;
}

#timeline-hscroll{
  width: 100%;
  max-width: 100%;
  overflow-x: scroll;
  overflow-y: hidden;
  scrollbar-gutter: stable both-edges;
  height: 28px;
  margin-top: 10px;
  border-radius: 9999px;
  border: 1px solid rgba(148,163,184,0.70);
  background: rgba(241,245,249,0.98);
  box-sizing: border-box;
  cursor: ew-resize;
}

/* Make the scrollbar clearly visible (Chrome/Safari/Edge) */
#timeline-hscroll::-webkit-scrollbar{ height: 18px; }
#timeline-hscroll::-webkit-scrollbar-track{
  background: rgba(226,232,240,0.95);
  border-radius: 9999px;
}
#timeline-hscroll::-webkit-scrollbar-thumb{
  background: rgba(71,85,105,0.85);
  border-radius: 9999px;
  border: 4px solid rgba(226,232,240,0.95);
}
#timeline-hscroll::-webkit-scrollbar-thumb:hover{ background: rgba(51,65,85,0.95); }


/* Firefox */
#timeline-hscroll{ scrollbar-width: auto; scrollbar-color: rgba(71,85,105,0.85) rgba(226,232,240,0.95); }

#timeline-hscroll-inner{
  height: 1px;
  width: 0px;
}


/* Hide per-line horizontal scrollbars inside timeline tracks (keep only the unified scrollbar at the bottom) */
#timeline-panel .timeline-zoom-outer{
  scrollbar-width: none; /* Firefox */
}
#timeline-panel .timeline-zoom-outer::-webkit-scrollbar{
  height: 0px;
  width: 0px;
}


/* Unified scrollbar: render a persistent, easy-to-grab custom thumb (macOS overlay scrollbars can be hard to grab) */
#timeline-hscroll{ position: relative; }
#timeline-hscroll-thumb{
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  height: 18px;
  width: 72px;
  border-radius: 9999px;
  background: rgba(71,85,105,0.85);
  border: 4px solid rgba(226,232,240,0.95);
  box-sizing: border-box;
  cursor: grab;
  z-index: 5;
}
#timeline-hscroll-thumb:active{ cursor: grabbing; }

/* Hide the native scrollbar visuals; keep wheel/trackpad scrolling functional */
#timeline-hscroll{ scrollbar-width: none; }
#timeline-hscroll::-webkit-scrollbar{ height: 0px; width: 0px; }


/* --- Added: Timeline↔Editor navigation highlight + Focus mode --- */
.temp-highlight {
  outline: 3px solid rgba(245, 158, 11, 0.9);
  outline-offset: 2px;
  border-radius: 14px;
}

body.focus-mode .activity-group { display: none; }
body.focus-mode .activity-group.focus-active { display: block; }

</style>
<script>
/* Modèles: stubs globaux disponibles dès le chargement (évite les clics "inerte" avant l'initialisation).
   Les vraies implémentations sont branchées plus bas dans le fichier. */
(function(){
  window.__pendingTemplateModal = null;

  function callOrQueue(which){
    const fn = (which === 'export') ? window.__realOpenTemplateExport : window.__realOpenTemplateImport;
    if (typeof fn === 'function') return fn();
    window.__pendingTemplateModal = which;
  }

  window.openTemplateExportModal = function(){ return callOrQueue('export'); };
  window.openTemplateImportModal = function(){ return callOrQueue('import'); };

  // Sécurisation clic: déclenchement immédiat même si un overlay capte l'évènement.
  // On ne déclenche QUE si le point de clic tombe dans la zone exacte des boutons "Modèles".
  (function(){
    function hitTestRect(el, x, y){
      if (!el) return false;
      const r = el.getBoundingClientRect();
      return x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
    }
    function handlePointer(e){
      // uniquement clic primaire / toucher
      if (e.type === 'mousedown' && e.button !== 0) return;
      const x = e.clientX, y = e.clientY;
      const expBtn = document.getElementById('btn-template-export');
      const impBtn = document.getElementById('btn-template-import');
      const hitExport = hitTestRect(expBtn, x, y);
      const hitImport = hitTestRect(impBtn, x, y);
      if (!hitExport && !hitImport) return;

      // Empêche tout routeur global de détourner / retarder l'action
      try { e.preventDefault(); } catch(_){}
      try { e.stopImmediatePropagation(); } catch(_){}
      try { e.stopPropagation(); } catch(_){}

      if (hitExport) window.openTemplateExportModal();
      else window.openTemplateImportModal();
    }

    // Capture le plus tôt possible
    window.addEventListener('pointerdown', handlePointer, true);
    window.addEventListener('mousedown', handlePointer, true);
    window.addEventListener('touchstart', handlePointer, { capture: true, passive: false });
  })();


  // flush appelé une fois que les vraies fonctions sont disponibles
  window.__flushPendingTemplateModal = function(){
    const w = window.__pendingTemplateModal;
    if (!w) return;
    window.__pendingTemplateModal = null;
    const fn = (w === 'export') ? window.__realOpenTemplateExport : window.__realOpenTemplateImport;
    if (typeof fn === 'function') fn();
  };
})();
</script>
</head>
<body class="p-2 md:p-4 hide-types text-slate-900">
<div class="max-w-7xl mx-auto">
<header class="mb-3">
<h1 class="text-2xl font-bold text-slate-900 leading-tight">
    Concepteur Pédagogique - Design Pédagogique &amp; Analytique
  </h1>
<div class="mt-2 flex flex-wrap gap-x-3 gap-y-3 no-print items-start content-start">
<div class="flex flex-col relative gap-0.5 bg-slate-50 border border-slate-200 rounded-lg p-1">
<span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider pl-1" data-i18n="grp_project">
       Projet
      </span>
<div class="flex items-center bg-white border border-slate-200 rounded-md p-0.5 gap-0.5 shadow-sm h-[34px]">
<button class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors flex items-center gap-1.5" data-i18n-title="title_save_project" onclick="saveProject()">
<span class="material-icons-round text-lg">
         save
        </span>
<span class="text-xs font-medium hidden md:inline" data-i18n="btn_save">
         Enregistrer
        </span>
</button>
<button class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors flex items-center gap-1.5" data-i18n-title="title_load_project" onclick="triggerFileLoad()">
<span class="material-icons-round text-lg">
         file_upload
        </span>
<span class="text-xs font-medium hidden md:inline" data-i18n="btn_load">
         Charger
        </span>
</button>
<div class="w-px bg-slate-200 my-1 mx-0.5">
</div>
<div class="relative group">
<div class="flex items-center">
<span class="material-icons-round text-slate-600 absolute left-1.5 pointer-events-none text-lg z-10 group-hover:text-indigo-600 transition-colors">
          download
         </span>
<select class="appearance-none bg-transparent hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 pl-7 pr-6 py-1 rounded transition-colors outline-none cursor-pointer text-xs font-medium h-[28px]" data-i18n-title="title_export_dropdown" onchange="handleExport(this)">
<option data-i18n="btn_export_dropdown" disabled="" selected="" value="">
           Exporter...
          </option>
<option data-i18n="opt_md" value="markdown">
           Markdown
          </option>
<option data-i18n="opt_csv" value="csv">
           CSV
          </option>
<option data-i18n="opt_pdf" value="pdf">
           PDF
          </option>
<option data-i18n="opt_rtf" value="richtext">
           Texte enrichi
          </option>
<option data-i18n="opt_real_rtf" value="rtf">
           Text (.rtf)
          </option>
</select>
<span class="material-icons-round text-slate-400 pointer-events-none absolute right-1 text-sm">
          expand_more
         </span>
</div>
</div>
<input accept=".json" class="hidden" id="load-file-input" onchange="loadProject(event)" type="file"/>
</div>
</div>
<div class="flex flex-col relative gap-0.5 shrink-0 bg-slate-50 border border-slate-200 rounded-lg p-1">
<span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider pl-1">Modèles</span>
<div class="flex items-center bg-white border border-slate-200 rounded-md p-0.5 gap-1 shadow-sm h-[34px] min-w-max">
<button class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors flex items-center gap-1.5" id="btn-template-export" onclick="openTemplateExportModal()" title="Exporter un modèle (module, moment ou activité)" type="button">
<span class="material-icons-round text-lg">upload_file</span>
<span class="text-xs font-medium hidden md:inline">Exporter</span>
</button>
<button class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors flex items-center gap-1.5" id="btn-template-import" onclick="openTemplateImportModal()" title="Importer un modèle dans la conception existante" type="button">
<span class="material-icons-round text-lg">download_for_offline</span>
<span class="text-xs font-medium hidden md:inline">Importer</span>
</button>
<input accept=".json" class="hidden" id="template-file-input" type="file"/>
</div>
</div>
<div class="flex flex-col relative gap-0.5 bg-slate-50 border border-slate-200 rounded-lg p-1">
<span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider pl-1" data-i18n="grp_view">
       Vue
      </span>
<div class="flex items-center bg-white border border-slate-200 rounded-md p-0.5 gap-1 shadow-sm h-[34px]">
<button class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors flex items-center justify-center ml-0.5" data-i18n-title="title_fold_all" id="btn-toggle-all-header" onclick="toggleAllActivities()">
<span class="material-icons-round text-xl" id="icon-toggle-all">
         unfold_less
        </span>
</button>
<div class="w-px h-5 bg-slate-200">
</div>
<button aria-pressed="false" class="text-slate-700 hover:text-indigo-700 hover:bg-slate-50 active:bg-slate-100 px-2 h-[28px] rounded-md transition flex items-center gap-1" id="contrast-toggle-btn" onclick="toggleHighContrast(event)" title="Passer au haut contraste" type="button">
<span class="material-icons-round text-base">
         invert_colors
        </span>
<span class="text-[11px] font-extrabold tracking-wide" id="contrast-btn-text">
         STD
        </span>
</button>
<div class="w-px h-5 bg-slate-200">
</div>
<button class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors flex items-center gap-1" data-i18n-title="title_toggle_types" onclick="toggleLearningTypes()">
<span class="material-icons-round text-base" id="icon-toggle-types">
         visibility_off
        </span>
<span class="text-xs font-bold" data-i18n="btn_toggle_types">
         Types d'appr.
        </span>
</button>
<div class="w-px h-5 bg-slate-200">
</div>
</div>
</div>
</div>
</header>
<div class="mb-3 bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
<button class="w-full px-3 py-2 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition-colors no-print h-[32px] rounded-lg border border-slate-200 rounded-lg border border-slate-200" data-i18n-title="title_toggle_panel" onclick="togglePanel('key-params-panel')">
<div class="flex items-center gap-1.5">
<span class="material-icons-round text-slate-500 text-sm">
       tune
      </span>
<span class="font-bold text-slate-700 uppercase text-xs tracking-wide" data-i18n="panel_key_parameters">
       Informations sur la formation
      </span>
</div>
<span class="material-icons-round text-slate-400 rotate-icon text-sm" id="key-params-panel-icon">
      expand_more
     </span>
</button><div class="panel-content" id="key-params-panel" style="display: none;">
<div class="p-3 border-t border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
<div>
<label class="compact-label block" data-i18n="label_course_name">
        Nom de la formation
       </label>
<input class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none" data-i18n-placeholder="ph_course_name" id="param-name" placeholder="Entrez le nom de la formation..." type="text"/>
</div><div class="flex-1">
<label class="compact-label block" data-i18n="label_learning_time">
         Temps d'Apprentissage (Cible)
        </label>
<div class="flex gap-1">
<input class="w-2/3 px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none" id="param-learning-val" min="0" oninput="updateStatsDebounced()" placeholder="0" type="number"/>
<select class="w-1/3 px-1 py-1 text-xs border border-slate-200 rounded bg-slate-50 focus:ring-1 focus:ring-indigo-500 outline-none" id="param-learning-unit" onchange="updateStats()">
<option data-i18n="unit_mins" value="mins">
           min
          </option>
<option data-i18n="unit_hours" value="hours">
           Heures
          </option>
<option data-i18n="unit_days" value="days">
           Jours
          </option>
<option data-i18n="unit_weeks" value="weeks">
           Semaines
          </option>
<option data-i18n="unit_months" value="months">
           Mois
          </option>
</select>
</div>
</div><div class="flex-1">
<label class="compact-label block" data-i18n="label_designed_time">
         Temps Conçu (Planifié)
        </label>
<div class="flex gap-1 items-center">
<input class="w-2/3 px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none bg-slate-100 text-slate-500" id="param-designed-val" min="0" placeholder="0" readonly="" type="number"/>
<span class="w-1/3 text-xs text-slate-600 font-bold px-1" id="param-designed-unit-display">
          min
         </span>
</div>
</div></div>
<div class="p-3 border-t border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"><div>
<label class="compact-label block" data-i18n="label_mode">
       Modalité
      </label>
<select class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none bg-white" id="param-mode">
<option data-i18n="opt_mode_placeholder" disabled="" selected="" value="">
        Sélectionnez une modalité...
       </option>
<option data-i18n="opt_mode_classroom" value="classroom">
        Présentiel (sur site)
       </option>
<option data-i18n="opt_mode_online" value="online">
        Distanciel (en ligne)
       </option>
<option data-i18n="opt_mode_blended" value="blended">
        Hybride (sur site et en ligne)
       </option>
</select>
</div><div>
<label class="compact-label block" data-i18n="label_level">Niveau</label>
<select class="w-full px-2 py-1 border border-slate-200 rounded text-sm focus:ring-1 focus:ring-indigo-500 outline-none bg-white" id="param-level">
<option data-i18n="opt_level_unspecified" selected="" value="unspecified">Non spécifié</option>
<option data-i18n="opt_level_mixed" value="mixed">Mixte</option>
<option data-i18n="opt_level_beginner" value="beginner">Débutant</option>
<option data-i18n="opt_level_intermediate" value="intermediate">Intermédiaire</option>
<option data-i18n="opt_level_advanced" value="advanced">Avancé</option>
<option data-i18n="opt_level_expert" value="expert">Expert</option>
</select>
</div><div>
<label class="compact-label block" data-i18n="label_class_size">
       Taille de la cohorte
      </label>
<input class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none font-bold text-slate-800" id="global-class-size" min="1" oninput="updateStatsDebounced()" type="number" value="30"/>
</div>
<div>
<label class="compact-label block" data-i18n="label_authors">
        Auteur(s)
       </label>
<input class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none" data-i18n-placeholder="ph_authors" id="param-authors" placeholder="Entrez le nom de l'auteur..." type="text"/>
</div>
<div class="md:col-span-2 lg:col-span-3">
<label class="compact-label block" data-i18n="label_description">
        Description générale
       </label>
<textarea class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-y" data-i18n-placeholder="ph_description" id="param-description" placeholder="Description détaillée..." rows="1"></textarea>
</div><div class="md:col-span-2 lg:col-span-3">
<label class="compact-label block" data-i18n="label_target_audience">Public cible</label>
<textarea class="w-full px-2 py-1 border border-slate-200 rounded text-sm focus:ring-1 focus:ring-indigo-500 outline-none resize-y" id="param-target-audience" placeholder="" rows="1"></textarea>
</div>
<div class="md:col-span-2 lg:col-span-3">
<label class="compact-label block" data-i18n="label_prerequisites">Prérequis</label>
<textarea class="w-full px-2 py-1 border border-slate-200 rounded text-sm focus:ring-1 focus:ring-indigo-500 outline-none resize-y" id="param-prerequisites" placeholder="" rows="1"></textarea>
</div>
<div class="md:col-span-2 lg:col-span-3">
<label class="compact-label block" data-i18n="label_aims">
        Objectifs
       </label>
<textarea class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-y" data-i18n-placeholder="ph_aims" id="param-aims" placeholder="Entrez les objectifs..." rows="2"></textarea>
</div>
<div class="md:col-span-2 lg:col-span-3">
<label class="compact-label block" data-i18n="label_outcomes_text">
        Résultats d'apprentissage
       </label>
<textarea class="w-full px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-y" data-i18n-placeholder="ph_outcomes_text" id="param-outcomes-text" placeholder="Entrez les résultats d'apprentissage..." rows="2"></textarea>
</div>
<div class="md:col-span-2 lg:col-span-3">
<label class="compact-label block" data-i18n="label_outcomes">
        Résultats d'apprentissage (Bloom)
       </label>
<div class="flex gap-1 mb-1 no-print flex-col sm:flex-row">
<div class="flex gap-1">
<select class="text-[10px] font-bold text-slate-600 border border-slate-200 rounded py-1 px-1 bg-white focus:ring-1 focus:ring-indigo-500 outline-none w-24" id="new-bloom-level">
<option data-i18n="bloom_placeholder" disabled="" selected="" value="">
           Bloom...
          </option>
</select>
<select class="text-[10px] text-slate-600 border border-slate-200 rounded py-1 px-1 bg-white focus:ring-1 focus:ring-indigo-500 outline-none w-24 hidden" id="new-bloom-sub">
<option data-i18n="bloom_sub_placeholder" disabled="" selected="" value="">
           Sous-cat...
          </option>
</select>
</div>
<div class="flex flex-1 gap-1">
<input class="flex-1 px-2 py-1 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none text-xs" data-i18n-placeholder="ph_add_outcome" id="new-outcome-input" placeholder="Ajouter un résultat..." type="text"/>
<button class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold hover:bg-indigo-200 transition-colors flex items-center justify-center h-[26px]" data-action="add-outcome" data-i18n-title="title_add_outcome" id="btn-add-outcome" style="position:relative; z-index:5;" type="button">
<span class="material-icons-round text-sm">
           add
          </span>
</button>
</div>
</div>
<ul class="space-y-0.5" id="outcomes-list">
</ul>
<p class="text-xs text-slate-400 italic mt-1" data-i18n="text_no_outcomes" id="no-outcomes-text">
        Aucun résultat défini
       </p>
</div>
</div>
</div>
</div>
<div class="mb-3 no-print flex flex-col gap-3">
<div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col justify-center" id="timelines-wrapper">
<button class="w-full px-3 py-2 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition-colors no-print h-[32px] rounded-lg border border-slate-200" data-i18n-title="title_toggle_panel" onclick="togglePanel('timeline-panel')">
<div class="flex items-center gap-1.5">
<span class="material-icons-round text-slate-500 text-sm">
        insights
       </span>
<span class="font-bold text-slate-700 uppercase text-xs tracking-wide" data-i18n="panel_timelines_title">
        Visualisations des séquences
       </span>
</div>
<span class="material-icons-round text-slate-400 rotate-icon text-sm" id="timeline-panel-icon">
       expand_more
      </span>
</button>
<div class="panel-content w-full flex flex-col gap-2 mt-2 p-2 rounded-xl border border-slate-200 bg-slate-50" id="timeline-panel" style="display: none;">
<div class="flex justify-end">
<span class="text-slate-400 text-[10px] italic" data-i18n="status_calculating" id="stats-update-info"></span>
</div>
<div class="bg-white rounded-xl border border-slate-200 p-1.5 flex items-center justify-start gap-3 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">zoom_in</span>
<span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Échelle temporelle</span>
</div>
<div class="flex items-center gap-1">
<button class="px-2 py-1 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 transition-colors flex items-center justify-center" id="timeline-zoom-out" title="Zoom arrière" type="button">
<span class="material-icons-round text-slate-600 text-base">remove</span>
</button>
<input class="w-40 md:w-56" id="timeline-zoom-range" max="3" min="0.5" step="0.1" type="range" value="1"/>
<span class="text-xs font-bold text-slate-600 w-12 text-right tabular-nums" id="timeline-zoom-value">100%</span>
<button class="px-2 py-1 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 transition-colors flex items-center justify-center" id="timeline-zoom-in" title="Zoom avant" type="button">
<span class="material-icons-round text-slate-600 text-base">add</span>
</button>
<button class="px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition-colors flex items-center justify-center" id="timeline-zoom-reset" title="Réinitialiser" type="button">
<span class="material-icons-round text-slate-600 text-base">restart_alt</span>
</button>
</div>
</div>
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          view_agenda
         </span>
<span class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_timeline_structure_planned">
          Modules prévus
         </span>
</div>
</div>
<div class="w-full h-6 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-activities-planned">
<div class="timeline-inner" id="timeline-activities-planned-inner"></div>
</div>
<div class="w-full flex text-xs text-slate-600 font-medium leading-none mt-1 timeline-zoom-outer" id="timeline-activities-planned-labels">
<div class="timeline-inner" id="timeline-activities-planned-labels-inner"></div>
</div>
</div>
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          account_tree
         </span>
<span class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_timeline_structure">
          Modules conçus
         </span>
</div>
</div>
<div class="w-full h-6 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-activities">
<div class="timeline-inner" id="timeline-activities-inner"></div>
</div>
<div class="w-full flex text-xs text-slate-600 font-medium leading-none mt-1 timeline-zoom-outer" id="timeline-activities-labels">
<div class="timeline-inner" id="timeline-activities-labels-inner"></div>
</div>
</div>
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1 timeline-track-pedagogy">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          psychology
         </span>
<span class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_timeline_pedagogy">
          Types d'apprentissage
         </span>
</div>
</div>
<div class="w-full h-6 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-steps">
<div class="timeline-inner" id="timeline-steps-inner"></div>
</div>
</div>
<button class="w-full px-2 py-1.5 flex items-center justify-between bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors" onclick="toggleTimelineDetails()" type="button">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
         tune
        </span>
<span class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_timeline_details">
         Détails
        </span>
</div>
<span class="material-icons-round text-slate-400 rotate-icon text-sm" id="timeline-details-icon">
        expand_more
       </span>
</button>
<div class="panel-content w-full flex flex-col gap-2" data-display="flex" id="timeline-details" style="display: none;">
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          groups
         </span>
<span class="text-sm font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_grouping">
          Regroupement
         </span>
</div>
<span class="text-xs text-slate-600 font-medium bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5" data-i18n="legend_grouping">
         Plein : Classe • Rayé : Groupes
        </span>
</div>
<div class="w-full h-4 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-grouping">
<div class="timeline-inner" id="timeline-grouping-inner"></div>
</div>
</div>
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          face
         </span>
<span class="text-sm font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_trainer">
          Formateur
         </span>
</div>
<span class="text-xs text-slate-600 font-medium bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5" data-i18n="legend_trainer">
         Plein : Présent • Rayé : Absent
        </span>
</div>
<div class="w-full h-4 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-trainer">
<div class="timeline-inner" id="timeline-trainer-inner"></div>
</div>
</div>
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          place
         </span>
<span class="text-sm font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_place">
          Lieu
         </span>
</div>
<span class="text-xs text-slate-600 font-medium bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5" data-i18n="legend_place">
         Plein : Présentiel • Rayé : En ligne
        </span>
</div>
<div class="w-full h-4 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-place">
<div class="timeline-inner" id="timeline-place-inner"></div>
</div>
</div>
<div class="timeline-track bg-white rounded-xl border border-slate-200 p-1.5 flex flex-col gap-1">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="flex items-center gap-1.5">
<span aria-hidden="true" class="material-icons-round text-slate-500 text-base">
          event
         </span>
<span class="text-sm font-bold text-slate-500 uppercase tracking-wider" data-i18n="label_time">
          Temps
         </span>
</div>
<span class="text-xs text-slate-600 font-medium bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5" data-i18n="legend_time">
         Plein : Synchrone • Rayé : Asynchrone
        </span>
</div>
<div class="w-full h-4 flex rounded-lg overflow-hidden bg-slate-100 border border-slate-200 cursor-help timeline-zoom-outer" id="timeline-time">
<div class="timeline-inner" id="timeline-time-inner"></div>
</div>
</div>
</div>
<div class="w-full h-9 relative mt-1 select-none pointer-events-none rounded-lg bg-white timeline-zoom-outer" id="timeline-ruler">
<div class="timeline-inner" id="timeline-ruler-inner"></div>
</div>
<div aria-label="Défilement horizontal des visualisations" class="timeline-hscroll no-print" id="timeline-hscroll" role="scrollbar"><div id="timeline-hscroll-inner"></div><div aria-hidden="true" id="timeline-hscroll-thumb"></div></div></div>
</div>
</div>
<div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden w-full flex flex-col justify-center">
<button class="w-full px-3 py-2 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition-colors no-print h-[32px] rounded-lg border border-slate-200" onclick="togglePanel('charts-panel')" title="title_toggle_panel">
<div class="flex items-center gap-1.5">
<span class="material-icons-round text-slate-500 text-sm">pie_chart</span>
<span class="font-bold text-slate-700 uppercase text-xs tracking-wide">Graphiques d'analyse</span>
</div>
<span class="material-icons-round text-slate-400 rotate-icon text-sm" id="charts-panel-icon">expand_more</span>
</button>
<div class="panel-content w-full flex flex-col gap-1 mt-1 p-1 rounded-lg border border-slate-200 bg-slate-50" id="charts-panel" style="display: none;">
<div class="grid grid-cols-1 md:grid-cols-2 gap-2">
<div class="bg-white rounded-xl border border-slate-200 p-2">
<div class="flex items-center justify-between">
<div class="text-xs font-bold text-slate-600">Types d'apprentissage</div>
<div class="text-[11px] text-slate-500">(% de durée)</div>
</div>
<div class="mt-2 flex gap-2 items-stretch">
<div class="w-1/2">
<canvas class="w-full" height="300" id="chart-learning-types"></canvas>
</div>
<div class="w-1/2 h-[300px] flex flex-col justify-center gap-1 text-[11px] leading-tight text-slate-700" id="chart-learning-types-legend"></div>
</div>
</div>
<div class="grid grid-cols-1 gap-2">
<div class="bg-white rounded-xl border border-slate-200 p-1.5">
<div class="flex items-center justify-between">
<div class="text-xs font-bold text-slate-600">Modes de groupes</div>
<div class="text-[11px] text-slate-500">(% de durée)</div>
</div>
<canvas height="80" id="chart-group-modes"></canvas>
</div>
<div class="bg-white rounded-xl border border-slate-200 p-1.5">
<div class="flex items-center justify-between">
<div class="text-xs font-bold text-slate-600">Modes de lieu</div>
<div class="text-[11px] text-slate-500">(% de durée)</div>
</div>
<canvas height="80" id="chart-place-modes"></canvas>
</div>
<div class="bg-white rounded-xl border border-slate-200 p-1.5">
<div class="flex items-center justify-between">
<div class="text-xs font-bold text-slate-600">Modes de temps</div>
<div class="text-[11px] text-slate-500">(% de durée)</div>
</div>
<canvas height="80" id="chart-time-modes"></canvas>
</div>
<div class="bg-white rounded-xl border border-slate-200 p-1.5">
<div class="flex items-center justify-between">
<div class="text-xs font-bold text-slate-600">Présence du formateur</div>
<div class="text-[11px] text-slate-500">(% de durée)</div>
</div>
<canvas height="80" id="chart-trainer-presence"></canvas>
</div>
</div>
</div>
</div>
</div>
<div id="view-designer">
<div class="flex justify-end mb-2 no-print">
<button class="text-slate-500 hover:text-indigo-600 text-xs font-medium flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-slate-100" id="btn-toggle-all-main" onclick="toggleAllActivities()">
<span class="material-icons-round text-base" id="icon-toggle-all-main">
       unfold_less
      </span>
<span data-i18n="btn_collapse_all" id="text-toggle-all-main">
       Tout replier
      </span>
</button>
</div>
<div class="space-y-4" id="activities-root">
</div>
<div class="hidden text-center py-12 bg-white rounded-xl border-2 border-dashed border-slate-300" id="empty-state">
<h3 class="mt-1 text-base font-medium text-slate-900" data-i18n="empty_title">
      Aucun module conçu
     </h3>
<p class="mt-0.5 text-xs text-slate-500" data-i18n="empty_subtitle">
      Commencez par créer votre premier module.
     </p>
<button class="mt-4 inline-flex items-center px-3 py-1.5 border border-transparent shadow-sm text-xs font-medium rounded text-white bg-indigo-600 hover:bg-indigo-700" data-i18n-title="title_create_activity" onclick="addActivity()">
<span class="material-icons-round mr-1 text-sm">
       add
      </span>
<span data-i18n="btn_create_activity">
       Créer un Module
      </span>
</button>
</div>
</div>
<div class="mt-6 mb-4 no-print flex justify-start">
<button class="bg-white border border-slate-300 hover:border-indigo-500 text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded font-bold shadow-sm flex items-center gap-1.5 transition-all text-xs" data-i18n-title="title_new_activity" onclick="addActivity()">
<span class="material-icons-round text-lg">
      add_circle
     </span>
<span data-i18n="btn_new_activity">
      Nouveau Module
     </span>
</button>
</div>
<footer class="mt-8 mb-4 text-center text-[10px] text-slate-400 no-print">
<p>
     François Jourde (2026) - CC BY SA, inspiré par le
     <a class="underline hover:text-slate-500" href="https://www.ucl.ac.uk/learning-designer/" target="_blank">
      Learning Designer
     </a>
     (UCL Knowledge Lab).
    </p>

<details class="mt-1 inline-block text-left max-w-3xl mx-auto px-3">
<summary class="cursor-pointer no-underline hover:text-slate-500 select-none bg-transparent hover:bg-transparent focus:bg-transparent active:bg-transparent" style="background: transparent;">Mentions légales / Confidentialité</summary>
<div class="mt-2 text-slate-500 leading-relaxed">
<div class="font-semibold text-slate-400">Mentions Légales et Politique de Confidentialité</div>
<ol class="mt-2 space-y-2">
<li>
<div class="font-semibold text-slate-400">1. Éditeur et Hébergement</div>
<div><span class="font-semibold">Éditeur :</span> L'application Concepteur pédagogique est éditée par François Jourde.</div>
<div><span class="font-semibold">Hébergement :</span> Ce site est hébergé par GitHub Inc. Adresse : 88 Colin P. Kelly Jr. Street, San Francisco, CA 94107, United States.</div>
</li>
<li>
<div class="font-semibold text-slate-400">2. Fonctionnement de l'application et Données personnelles</div>
<div>Cette application a été conçue selon une approche « Privacy by design » (respect de la vie privée par défaut).</div>
<div class="mt-1"><span class="font-semibold">Absence de collecte de données :</span> L'application fonctionne entièrement en mode « côté client » (client-side) sur votre navigateur web.</div>
<ul class="list-disc ml-5 mt-1 space-y-1">
<li>Aucune donnée saisie ou manipulée dans l'application n'est transmise à l'éditeur.</li>
<li>Aucune donnée n'est stockée sur un serveur distant (base de données cloud).</li>
</ul>
<div class="mt-1">Toutes les informations restent strictement confinées à votre appareil (ordinateur ou smartphone).</div>
</li>
<li>
<div class="font-semibold text-slate-400">3. Utilisation du Stockage Local (Local Storage)</div>
<div>Pour permettre le fonctionnement de l'application (ex : sauvegarder vos préférences ou votre avancement), nous utilisons la technologie du <span class="font-semibold">localStorage</span> ou <span class="font-semibold">sessionStorage</span> de votre navigateur.</div>
<ul class="list-disc ml-5 mt-1 space-y-1">
<li>Ces données sont stockées uniquement sur votre appareil.</li>
<li>Elles ne sont accessibles par personne d'autre que vous.</li>
<li>Ces mécanismes sont purement techniques et fonctionnels, ils sont donc exemptés de consentement préalable (pas de bandeau cookies nécessaire).</li>
</ul>
<div class="mt-1">Vous pouvez à tout moment supprimer ces données en vidant le cache de votre navigateur.</div>
</li>
<li>
<div class="font-semibold text-slate-400">4. Données techniques (Logs serveur)</div>
<div>Bien que l'éditeur ne collecte aucune donnée, l'infrastructure d'hébergement (GitHub Pages) peut collecter des données techniques standards lors de votre connexion (telles que votre adresse IP et le type de navigateur) dans des journaux de connexion (logs) à des fins de sécurité et de fiabilité du service.</div>
<div class="mt-1">L'éditeur de ce site n'a pas accès à ces données brutes. Pour plus d'informations, vous pouvez consulter la Déclaration de confidentialité de GitHub.</div>
</li>
<li>
<div class="font-semibold text-slate-400">5. Services Tiers</div>
<div>Ce site peut charger des ressources techniques (polices d'écriture, librairies JavaScript) depuis des serveurs tiers (ex : Google Fonts, CDNJ). Ces services peuvent techniquement avoir accès à votre adresse IP lors du chargement de ces ressources.</div>
</li>
<li>
<div class="font-semibold text-slate-400">6. Contact</div>
<div>Pour toute question relative à l'application, vous pouvez contacter l'éditeur via <a class="underline hover:text-slate-600" href="https://github.com/jourde" rel="noopener" target="_blank">https://github.com/jourde</a>.</div>
</li>
</ol>
</div>
</details>

</footer>
</div>
<div class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4" id="custom-confirm-modal">
<div class="bg-white rounded-lg shadow-lg p-4 max-w-sm w-full">
<h3 class="text-sm font-bold text-slate-800 mb-2" data-i18n="modal_confirm_title">
     Confirmer l'action
    </h3>
<p class="text-slate-600 mb-4 text-xs" id="custom-confirm-msg">
     Êtes-vous sûr ?
    </p>
<div class="flex justify-end gap-2">
<button class="px-3 py-1.5 text-slate-600 hover:bg-slate-100 rounded text-xs font-medium transition-colors" data-i18n="btn_cancel" id="custom-confirm-no">
      Annuler
     </button>
<button class="px-3 py-1.5 bg-red-500 text-white hover:bg-red-600 rounded text-xs font-medium transition-colors" data-i18n="btn_delete" id="custom-confirm-yes">
      Supprimer
     </button>
</div>
</div>
</div>
<div class="fixed z-[100] hidden bg-slate-800 text-white text-[10px] font-medium rounded px-2 py-1.5 pointer-events-none shadow-xl border border-slate-700 max-w-[200px] whitespace-normal leading-tight" id="global-tooltip">
</div>
<template id="activity-template">
<div class="activity-group relative bg-white rounded-xl shadow-sm border border-slate-200 p-3">
<div class="flex flex-col sm:flex-row sm:items-start justify-between mb-2 gap-2">
<div class="flex-1 flex items-center gap-2">
<div class="drag-handle-activity drag-handle text-slate-300 hover:text-slate-500 no-print flex items-center justify-center w-6 h-6 cursor-grab">
<span class="material-icons-round text-lg">
        drag_indicator
       </span>
</div>
<div class="h-6 w-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600 activity-index shrink-0 text-xs">
       1
      </div>
<div class="flex-1 w-full">
<input class="activity-title text-base font-bold text-slate-800 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 outline-none w-full py-0.5 transition-colors" data-i18n-placeholder="ph_activity_title" oninput="updateStatsDebounced()" placeholder="Titre du module (ex: Module 1 : Introduction)" type="text"/>
<div class="flex items-center gap-2 mt-0.5 pr-1">
<div class="activity-type-bar flex-1 h-1.5 bg-slate-100 border border-slate-200 rounded-full overflow-hidden flex">
</div>
</div>
</div>
</div>
<div class="flex items-center gap-1 no-print">
<div class="flex items-center gap-3 mr-2">
<div class="flex flex-col items-end">
<span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider leading-none mb-0.5" data-i18n="label_target">
         Cible
        </span>
<div class="flex items-center gap-1">
<input class="activity-target-time w-12 px-1 py-0.5 text-xs text-right border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none h-[22px]" min="0" oninput="updateStatsDebounced()" placeholder="0" type="number"/>
<select class="activity-target-unit w-20 px-0 py-0.5 text-[10px] border border-slate-200 rounded bg-slate-50 focus:ring-1 focus:ring-indigo-500 outline-none h-[22px]" onchange="updateStats()">
<option data-i18n="unit_mins" value="60">
           min
          </option>
<option data-i18n="unit_hours" value="3600">
           Heures
          </option>
<option data-i18n="unit_days" value="86400">
           Jours
          </option>
<option data-i18n="unit_weeks" value="604800">
           Semaines
          </option>
<option data-i18n="unit_months" value="2592000">
           Mois
          </option>
</select>
</div>
</div>
<span aria-hidden="true" class="module-time-compare text-xs font-bold bg-transparent mx-1 select-none self-center">=</span>
<div class="flex flex-col items-end">
<span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider leading-none mb-0.5" data-i18n="label_designed">
         Conçu
        </span>
<div class="bg-indigo-50 border border-indigo-100 rounded px-2 py-0.5 h-[22px] flex items-center min-w-[3rem] justify-end activity-designed-badge">
<span class="activity-total-time text-xs font-bold text-indigo-700 font-mono">
          0m
         </span>
</div>
</div>
</div>
<div class="h-8 w-px bg-slate-100 mx-1">
</div>
<button class="text-slate-400 hover:text-indigo-500 p-1 transition-colors" data-i18n-title="title_toggle_description" onclick="toggleDescription(this)" title="Afficher/Masquer la description">
<span class="material-icons-round text-lg">
        description
       </span>
</button>
<button class="text-slate-400 hover:text-indigo-500 p-1 transition-colors" data-i18n-title="title_toggle_panel" onclick="toggleActivity(this)" title="Afficher/Masquer les paramètres">
<span class="material-icons-round text-lg rotate-icon">
        expand_more
       </span>
</button>
<button class="text-slate-400 hover:text-indigo-500 p-1 transition-colors" data-action="duplicate-module" data-i18n-title="title_duplicate_activity" title="Dupliquer ce module" type="button">
<span class="material-icons-round text-lg">
        content_copy
       </span>
</button>
<button aria-pressed="false" class="text-slate-400 hover:text-indigo-500 p-1 transition-colors" data-i18n-title="title_focus_module" onclick="toggleFocusModule(this)" title="Mode focus" type="button">
<span class="material-icons-round text-lg focus-toggle-icon">center_focus_strong</span>
</button>
<button class="text-slate-400 hover:text-red-500 p-1 transition-colors" data-action="delete-module" data-i18n-title="title_delete_activity" title="Supprimer ce module" type="button">
<span class="material-icons-round text-lg">
        delete_outline
       </span>
</button>
</div>
</div>
<div class="activity-body panel-content open">
<div class="activity-description-panel panel-content">
<div class="mb-2 ml-8 pr-1">
<textarea class="activity-description w-full px-3 py-2 text-sm text-slate-700 border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-y bg-slate-50 leading-relaxed" data-i18n-placeholder="ph_activity_desc" placeholder="Description du module..." rows="1"></textarea>
</div>
</div>
<div class="activity-moments-container ml-4 pl-4 space-y-3 min-h-[20px]"></div>
<div class="mt-2 pt-1 flex justify-center gap-2 no-print border-t border-slate-100">
<button class="text-sm font-semibold text-slate-500 hover:text-indigo-700 px-3 py-1 rounded transition-colors flex items-center gap-1 hover:bg-slate-50" data-i18n-title="title_add_step" onclick="addStepToActivity(this)" type="button">
<span class="material-icons-round text-sm">
        add
       </span>
<span data-i18n="btn_add_step">
        Ajouter Activité
       </span>
</button>
<button class="text-sm font-semibold text-slate-500 hover:text-indigo-700 px-3 py-1 rounded transition-colors flex items-center gap-1 hover:bg-slate-50" onclick="addMomentToActivity(this)" title="Ajouter un moment" type="button">
<span class="material-icons-round text-sm">add</span>
<span>Ajouter moment</span>
</button>
</div>
</div>
</div>
</template>
<template id="moment-template">
<div class="moment-group bg-transparent rounded-lg border border-slate-200/60">
<div class="flex items-center justify-between px-3 py-2">
<div class="flex items-center gap-2 flex-1 min-w-0">
<div class="drag-handle-moment drag-handle text-slate-300 hover:text-slate-500 no-print flex items-center justify-center w-6 h-6 cursor-grab">
<span class="material-icons-round text-lg">drag_indicator</span>
</div>
<div class="h-6 w-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600 moment-index shrink-0 text-xs">1</div>
<input class="moment-title flex-1 text-sm font-semibold text-slate-800 bg-transparent focus:outline-none focus:ring-0 border-0 p-0 m-0 min-w-0" placeholder="Nom du moment (ex : Accueil)" type="text"/>
</div>
<div class="flex items-center gap-3">
<div class="flex items-center gap-2">
<div class="moment-target-wrap flex flex-col items-end">
<span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider leading-none mb-0.5" data-i18n="label_target">Cible</span>
<div class="flex gap-1 items-center">
<input class="moment-target-time w-12 px-1 py-0.5 text-xs border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none h-[22px]" min="0" oninput="updateStatsDebounced()" placeholder="0" type="number"/>
<select class="moment-target-unit w-20 px-1 py-0.5 text-xs border border-slate-200 rounded bg-slate-50 focus:ring-1 focus:ring-indigo-500 outline-none h-[22px]" onchange="updateStats()">
<option data-i18n="unit_mins" value="60">min</option>
<option data-i18n="unit_hours" value="3600">Heures</option>
<option data-i18n="unit_days" value="86400">Jours</option>
<option data-i18n="unit_weeks" value="604800">Semaines</option>
</select>
</div>
</div>
<div class="flex flex-col items-end">
<span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider leading-none mb-0.5" data-i18n="label_designed">Conçu</span>
<div class="bg-indigo-50 border border-indigo-100 rounded px-2 py-0.5 h-[22px] flex items-center min-w-[3rem] justify-end">
<span class="moment-total-time text-xs font-bold text-indigo-700 font-mono">0m</span>
</div>
</div>
</div>
<button aria-expanded="false" class="no-print text-slate-400 hover:text-indigo-500 p-1 transition-colors" data-i18n-title="title_toggle_description" onclick="toggleMomentDescription(this)" title="Afficher/Masquer la description" type="button"><span class="material-icons-round text-lg">description</span></button>
<button aria-expanded="true" class="no-print text-slate-400 hover:text-slate-700 transition-colors" onclick="toggleMoment(this)" title="Replier / déplier ce moment" type="button">
<span class="material-icons-round text-lg rotate-icon-moment" style="transform: rotate(180deg);">expand_more</span>
</button>
<button class="no-print text-slate-400 hover:text-rose-600 transition-colors" onclick="trashMoment(this)" title="Supprimer ce moment" type="button">
<span class="material-icons-round text-lg">delete_outline</span>
</button>
</div>
</div>
<div class="moment-body px-3 pb-3">
<div class="moment-description-wrap hidden mt-2">
<div class="compact-label">Description</div>
<textarea class="moment-description w-full min-h-[64px] resize-y px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Description du moment..."></textarea>
</div>
<div class="activity-steps-container activity-container space-y-2 min-h-[20px]"></div>
</div>
</div>
</template>
<template id="step-template">
<div class="step-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative group flex flex-col">
<div class="flex items-center gap-2 p-2 bg-slate-50 border-b border-slate-100 transition-colors">
<div class="drag-handle-step drag-handle flex items-center justify-center text-slate-300 hover:text-slate-500 cursor-grab">
<span class="material-icons-round text-base">
       drag_indicator
      </span>
</div>
<div class="flex-1">
<input class="step-input-title w-full px-1 py-0.5 text-sm font-semibold text-slate-800 border-none bg-transparent focus:ring-0 outline-none" data-i18n-placeholder="ph_step_title" placeholder="Titre de l'activité..." type="text"/>
</div>
<div class="flex items-center gap-1">
<input class="duration-input w-16 px-2 py-0.5 text-xs font-semibold border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none h-[22px] text-right text-slate-600" min="0" oninput="updateStatsDebounced()" placeholder="0" type="number"/>
<select class="duration-unit w-24 px-2 py-0.5 text-xs border border-slate-200 rounded bg-slate-50 focus:ring-1 focus:ring-indigo-500 outline-none h-[22px]" onchange="updateStats()">
<option data-i18n="unit_mins" value="60">
        min
       </option>
<option data-i18n="unit_hours" value="3600">
        Heures
       </option>
<option data-i18n="unit_days" value="86400">
        Jours
       </option>
<option data-i18n="unit_weeks" value="604800">
        Semaines
       </option>
</select>
</div>
<div class="w-24 learning-type-container">
<select class="learning-type-select w-full px-2 py-0.5 text-xs font-semibold border rounded focus:ring-1 focus:ring-indigo-500 outline-none transition-all select-acquisition h-[22px]" onchange="updateStepType(this)">
<option data-i18n="type_none" value="none">
        Aucun
       </option>
<option data-i18n="type_acquisition" value="acquisition">
        Acquisition
       </option>
<option data-i18n="type_collaboration" value="collaboration">
        Collaboration
       </option>
<option data-i18n="type_discussion" value="discussion">
        Discussion
       </option>
<option data-i18n="type_investigation" value="investigation">
        Enquête
       </option>
<option data-i18n="type_practice" value="practice">
        Entraînement
       </option>
<option data-i18n="type_production" value="production">
        Production
       </option>
</select>
</div>
<div class="flex items-center gap-0.5 no-print">
<button class="text-slate-400 hover:text-indigo-500 p-0.5" data-i18n-title="title_toggle_panel" onclick="toggleStep(this)" title="Afficher/Masquer les paramètres">
<span class="material-icons-round text-base rotate-icon">
        expand_more
       </span>
</button>
<button class="text-slate-300 hover:text-indigo-500 p-0.5" data-action="duplicate-step" data-i18n-title="title_duplicate_step" title="Dupliquer cette activité" type="button">
<span class="material-icons-round text-base">
        content_copy
       </span>
</button>
<button class="text-slate-300 hover:text-red-400 p-0.5" data-action="delete-step" data-i18n-title="title_delete_step" title="Supprimer cette activité" type="button">
<span class="material-icons-round text-base">
        delete_outline
       </span>
</button>
</div>
</div>
<div class="step-body panel-content collapsed p-3 pt-2">
<div class="flex flex-col lg:flex-row gap-3 mt-1">
<div class="lg:w-1/3 space-y-2">
<div>
<label class="compact-label compact-label-lg flex items-center gap-1">
<span class="material-icons-round text-[10px] text-slate-400">
          groups
         </span>
<span data-i18n="label_grouping">
          Regroupement
         </span>
</label>
<div class="space-y-1">
<select class="step-group-mode w-full px-2 py-0.5 text-xs rounded border border-slate-200 bg-white outline-none h-[24px]" onchange="toggleGroupMode(this)">
<option data-i18n="opt_whole_class" value="class">
           Groupe entier
          </option>
<option data-i18n="opt_groups" value="groups">
           Sous-groupe
          </option>
<option data-i18n="opt_individual" value="individual">
           Individuel
          </option>
</select>
<div class="step-group-details hidden flex gap-1">
<div class="relative flex-1">
<input class="step-group-count w-full px-2 py-0.5 text-xs border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none h-[24px]" data-i18n-placeholder="ph_nb_groups" min="1" oninput="updateGroupMath(this, 'count')" placeholder="Nb groupes" type="number"/>
<span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-slate-400 pointer-events-none pr-1" data-i18n="label_short_groups">
            Grps
           </span>
</div>
<div class="relative flex-1">
<input class="step-group-size w-full px-2 py-0.5 text-xs border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none h-[24px]" data-i18n-placeholder="ph_per_group" min="1" oninput="updateGroupMath(this, 'size')" placeholder="Par groupe" type="number"/>
<span class="absolute right-1 top-1/2 -translate-y-1/2 text-[8px] text-slate-400 pointer-events-none pr-1" data-i18n="label_short_pers">
            Pers
           </span>
</div>
</div>
</div>
</div>
<div class="space-y-1 pt-1 border-t border-slate-100">
<div class="space-y-0.5">
<span class="text-[10px] w-12 text-slate-400 font-bold uppercase flex items-center gap-0.5 relative z-10">
<span class="material-icons-round text-[10px]">
           face
          </span>
<span data-i18n="label_trainer">
           Formateur
          </span>
</span>
<select class="trainer-select w-full px-1 py-0.5 text-[10px] rounded border border-slate-200 bg-white outline-none h-[22px]" onchange="updateStats()">
<option data-i18n="opt_present" value="present">
           Présent
          </option>
<option data-i18n="opt_absent" value="absent">
           Absent
          </option>
</select>
</div>
<div class="space-y-0.5">
<span class="text-[10px] w-12 text-slate-400 font-bold uppercase flex items-center gap-0.5 relative z-10">
<span class="material-icons-round text-[10px]">
           place
          </span>
<span data-i18n="label_place">
           Lieu
          </span>
</span>
<select class="place-select w-full px-1 py-0.5 text-[10px] rounded border border-slate-200 bg-white outline-none h-[22px]" onchange="updateStats()">
<option data-i18n="opt_insitu" value="situ">
           Présentiel (sur site)
          </option>
<option data-i18n="opt_online" value="online">
           Distanciel (en ligne)
          </option>
<option data-i18n="opt_hybrid" value="hybrid">
           Hybride (sur site et en ligne)
          </option>
</select>
</div>
<div class="space-y-0.5">
<span class="text-[10px] w-12 text-slate-400 font-bold uppercase flex items-center gap-0.5 relative z-10">
<span class="material-icons-round text-[10px]">
           event
          </span>
<span data-i18n="label_time">
           Temps
          </span>
</span>
<select class="time-select w-full px-1 py-0.5 text-[10px] rounded border border-slate-200 bg-white outline-none h-[22px]" onchange="updateStats()">
<option data-i18n="opt_sync" value="sync">
           Synchrone
          </option>
<option data-i18n="opt_async" value="async">
           Asynchrone
          </option>
</select>
</div>
</div>
</div>
<div class="lg:w-2/3 space-y-2">
<div>
<label class="compact-label flex items-center gap-1">
<span class="material-icons-round text-[10px] text-slate-400">
          flag
         </span>
<span>
          Objectif de l'activité
         </span>
</label>
<textarea class="step-input-objective w-full px-2 py-1.5 text-[12px] border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300 bg-slate-50 text-slate-700" placeholder="Décrivez l'objectif de cette activité..." rows="2"></textarea>
</div>
<div>
<label class="compact-label flex items-center gap-1">
<span class="material-icons-round text-[10px] text-slate-400">
          assignment
         </span>
<span data-i18n="label_tasks">
          Ce que les apprenants doivent faire
         </span>
</label>
<textarea class="step-input-tasks w-full px-2 py-1.5 text-xs border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-y leading-relaxed" data-i18n-placeholder="ph_tasks" placeholder="Décrivez les étapes, instructions et tâches..." rows="4"></textarea>
</div>
<div>
<label class="compact-label flex items-center gap-1">
<span class="material-icons-round text-[10px] text-slate-400">
          comment
         </span>
<span data-i18n="label_notes">
          Notes
         </span>
</label>
<textarea class="step-input-notes w-full px-2 py-1.5 text-xs border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-y bg-slate-50 text-slate-600 italic" data-i18n-placeholder="ph_notes" placeholder="Notes formateur, ressources ou liens..." rows="2"></textarea>
</div>
</div>
</div>
</div>
</div>
</template>
<script>

   const root = document.getElementById('activities-root');
        const emptyState = document.getElementById('empty-state');
        const activityTemplate = document.getElementById('activity-template');
        const momentTemplate = document.getElementById('moment-template');
        const stepTemplate = document.getElementById('step-template');
        const tooltipEl = document.getElementById('global-tooltip');

        const currentLang = 'fr';

        
        let __confirmAction = null;

        // Wire the custom confirmation modal buttons (Annuler / Supprimer)
        // so they reliably trigger the pending action set by trashModule().
        (function initCustomConfirmModal() {
            const modal = document.getElementById('custom-confirm-modal');
            const btnNo = document.getElementById('custom-confirm-no');
            const btnYes = document.getElementById('custom-confirm-yes');
            if (!modal || !btnNo || !btnYes) return;

            const close = () => {
                modal.classList.add('hidden');
            };

            btnNo.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                __confirmAction = null;
                close();
            });

            btnYes.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const action = __confirmAction;
                __confirmAction = null;
                close();
                if (typeof action === 'function') action();
            });

            // Optional: click outside the dialog cancels
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    e.preventDefault();
                    e.stopPropagation();
                    __confirmAction = null;
                    close();
                }
            });

            // Optional: Escape closes the modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    __confirmAction = null;
                    close();
                }
            });
        })();
        
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;

            const action = btn.dataset.action;
            if (!action) return;

            
            e.preventDefault();
            e.stopPropagation();

            switch (action) {
                case 'duplicate-module':
                    cloneModule(btn);
                    break;
                case 'delete-module':
                    trashModule(e, btn);
                    break;
                case 'duplicate-step':
                    cloneStep(btn);
                    break;
                case 'delete-step':
                    trashStep(btn);
                    break;
                case 'add-outcome':
                    safeAddOutcome();
                    break;

                default:
                    break;
            }
        });

        
        function showJsErrorBanner(message) {
            const el = document.getElementById('js-error-banner');
            if (!el) return;
            el.style.display = 'block';
            el.querySelector('[data-js-error-text]').innerText = message;
        }

        window.addEventListener('error', (e) => {
            try {
                showJsErrorBanner((e && e.message) ? e.message : 'Erreur JavaScript');
            } catch (_) {}
        });

        window.addEventListener('unhandledrejection', (e) => {
            try {
                const msg = (e && e.reason && (e.reason.message || String(e.reason))) ? (e.reason.message || String(e.reason)) : 'Promesse rejetée';
                showJsErrorBanner(msg);
            } catch (_) {}
        });

        function safeAddOutcome() {
            const input = document.getElementById('new-outcome-input');
            try {
                
                if (input && !input.value.trim()) {
                    input.setCustomValidity("Saisissez un résultat avant d'ajouter.");
                    input.reportValidity();
                    input.focus();
                    input.setCustomValidity('');
                    return;
                }
                addOutcome();
            } catch (err) {

                showJsErrorBanner('Erreur lors de l\'ajout du résultat : ' + (err && err.message ? err.message : String(err)));
            }
        }


        
        function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function showTooltip(e, content, isHtml = false) {
    if (isHtml) {
        tooltipEl.innerHTML = content;
    } else {
        tooltipEl.textContent = content;
    }
    tooltipEl.classList.remove('hidden');
    updateTooltipPos(e);
}

        function hideTooltip() {
            tooltipEl.classList.add('hidden');
        }

        function updateTooltipPos(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            
            
            const rect = tooltipEl.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            let finalX = x;
            let finalY = y;

            if (x + rect.width > winW) finalX = e.clientX - rect.width - 10;
            if (y + rect.height > winH) finalY = e.clientY - rect.height - 10;

            tooltipEl.style.left = `${finalX}px`;
            tooltipEl.style.top = `${finalY}px`;
        }

        
        const BLOOM_TAXONOMY = {
            remember: ["cite", "define", "describe", "identify", "label", "list", "match", "name", "outline", "quote", "recall", "report", "reproduce", "retrieve", "show", "state", "tabulate", "tell"],
            understand: ["abstract", "arrange", "articulate", "associate", "categorize", "clarify", "classify", "compare", "compute", "conclude", "contrast", "defend", "diagram", "differentiate", "discuss", "distinguish", "estimate", "exemplify", "explain", "extend", "extrapolate", "generalize", "give examples of", "illustrate", "infer", "interpolate", "interpret", "match", "outline", "paraphrase", "predict", "rearrange", "reorder", "rephrase", "represent", "restate", "summarize", "transform", "translate"],
            apply: ["apply", "calculate", "carry out", "classify", "complete", "compute", "demonstrate", "dramatize", "employ", "examine", "execute", "experiment", "generalize", "illustrate", "implement", "infer", "interpret", "manipulate", "modify", "operate", "organize", "outline", "predict", "solve", "transfer", "translate", "use"],
            analyze: ["analyze", "arrange", "break down", "categorize", "classify", "compare", "connect", "contrast", "deconstruct", "detect", "diagram", "differentiate", "discriminate", "distinguish", "divide", "explain", "identify", "integrate", "inventory", "order", "organize", "relate", "separate", "structure"],
            evaluate: ["appraise", "apprise", "argue", "assess", "compare", "conclude", "consider", "contrast", "convince", "criticize", "critique", "decide", "determine", "discriminate", "evaluate", "grade", "judge", "justify", "measure", "rank", "rate", "recommend", "review", "score", "select", "standardize", "support", "test", "validate"],
            create: ["arrange", "assemble", "build", "collect", "combine", "compile", "compose", "constitute", "construct", "create", "design", "develop", "devise", "formulate", "generate", "hypothesize", "integrate", "invent", "make", "manage", "modify", "organize", "perform", "plan", "prepare", "produce", "propose", "rearrange", "reconstruct", "reorganize", "revise", "rewrite", "specify", "synthesize", "write"]
        };

        const translations = {
            fr: {
                app_title: "Concepteur Pédagogique",
                app_subtitle: "Design Pédagogique & Analytique",
                btn_new_activity: "Nouveau Module",
                btn_export_md: "Exporter pour IA/RAG",
                btn_print: "Imprimer / PDF",
                btn_save: "Enregistrer",
                btn_load: "Charger",
                grp_project: "Projet",
                grp_view: "Vue",
                grp_actions: "Actions",
                grp_help: "Aide",
                
                btn_export_dropdown: "Exporter...",
                title_export_dropdown: "Choisir le format d'export",
                opt_md: "Markdown (IA)",
                opt_csv: "CSV (modules/moments/activités)",
                opt_pdf: "PDF (Imprimer)",
                opt_rtf: "Page Web (HTML)",
                opt_real_rtf: "Texte (.rtf)",
                csv_synthetic_moment: "Moment (auto)",
                title_export_term: "Exporter le tableau de traduction",
                info_export_genai: "Le format d'exportation est le design pédagogique au format Markdown pour un traitement facilité par un chatbot d'IA générative.",
                label_total_time: "Chronologie",
                status_calculating: "",
                label_class_size: "Taille de la cohorte",
                label_timeline_structure: "Modules conçus",
                label_timeline_details: "Détails",
                label_timeline_structure_planned: "Modules prévus",
                label_timeline_pedagogy: "Types d'apprentissage",
                empty_title: "Aucun module conçu",
                empty_subtitle: "Commencez par créer votre premier module.",
                btn_create_activity: "Créer un Module",
                btn_add_step: "Ajouter Activité",
                ph_activity_title: "Titre du module (ex: Module 1 : Introduction)",
                ph_activity_desc: "Description du module...",
                label_step_title: "Titre de l'activité",
                ph_step_title: "Titre pour cette activité...",
                label_learning_type: "Type d'apprentissage",
                label_duration: "Durée",
                label_grouping: "Regroupement",
                opt_whole_class: "Groupe entier",
                opt_individual: "Individuel",
                opt_groups: "Sous-groupe",
                ph_nb_groups: "Nb groupes",
                label_short_groups: "Grps",
                ph_per_group: "Par groupe",
                label_short_pers: "Pers",
                label_trainer: "Formateur",
                opt_present: "Présent",
                opt_absent: "Absent",
                label_place: "Lieu",
                opt_insitu: "Présentiel (sur site)",
                opt_online: "Distanciel (en ligne)",
                opt_hybrid: "Hybride (sur site et en ligne)",
                label_time: "Temps",
                opt_sync: "Synchrone",
                opt_async: "Asynchrone",
                label_tasks: "Ce que les apprenants doivent faire",
                ph_tasks: "Décrivez les étapes, instructions et tâches...",
                label_notes: "Notes",
                ph_notes: "Notes formateur, ressources ou liens...",
                type_none: "Aucun",

                type_acquisition: "Acquisition",
                type_collaboration: "Collaboration",
                type_discussion: "Discussion",
                type_investigation: "Enquête",
                type_practice: "Entraînement",
                type_production: "Production",
                unit_mins: "min",
                unit_hours: "Heures",
                unit_days: "Jours",
                unit_weeks: "Semaines",
                unit_months: "Mois",
                md_title: "# Profil de Design d'Expérience d'Apprentissage",
                md_class_size: "Taille de la cohorte",
                md_total_duration: "Durée totale estimée",
                md_untitled_activity: "Module sans titre",
                md_untitled_step: "Activité sans titre",
                md_format_whole: "Classe entière",
                md_format_individual: "Individuel",
                md_format_groups: "Groupes de",
                md_tasks: "Tâches et instructions des apprenants",
                md_notes: "Notes pédagogiques",
                rtf_title: "Profil de Design d'Expérience d'Apprentissage",
                title_duplicate: "Dupliquer",
                panel_key_parameters: "Informations sur la formation",
                panel_timelines_title: "Visualisations des séquences",
                label_course_name: "Nom de la formation",
                ph_course_name: "Entrez le nom de la formation...",
label_learning_time: "Temps d'Apprentissage (Cible)",
                label_designed_time: "Temps Conçu (Planifié)",
                label_hours: "h",
                label_minutes: "m",
                label_description: "Description générale",
                ph_description: "Description détaillée...",
                label_mode: "Modalité",
                label_level: "Niveau",
                label_target_audience: "Public cible",
                label_prerequisites: "Prérequis",
                opt_mode_placeholder: "Sélectionnez une modalité...",
                opt_mode_online: "Distanciel (en ligne)",
                opt_mode_blended: "Hybride (sur site et en ligne)",
                opt_mode_classroom: "Présentiel (sur site)",
                opt_mode_location: "Basé sur le lieu",
                opt_mode_other: "Autre",
                label_aims: "Objectifs",
                ph_aims: "Entrez les objectifs...",
                label_outcomes_text: "Résultats d'apprentissage",
                ph_outcomes_text: "Entrez les résultats d'apprentissage...",
                label_outcomes: "Résultats d'apprentissage (Bloom)",
                ph_add_outcome: "Ajouter un résultat...",
                text_no_outcomes: "Aucun résultat défini",
                title_fold_all: "Tout replier / Tout déplier",
                btn_collapse_all: "Tout replier",
                btn_expand_all: "Tout déplier",
                title_duplicate_activity: "Dupliquer ce module",
                title_delete_activity: "Supprimer ce module",
                title_focus_module: "Mode focus",
                title_exit_focus: "Quitter le mode focus",
                title_duplicate_step: "Dupliquer cette activité",
                title_delete_step: "Supprimer cette activité",
                title_save_project: "Enregistrer le projet dans un fichier",
                title_load_project: "Charger un projet depuis un fichier",
title_new_activity: "Ajouter un nouveau module",
                title_toggle_panel: "Afficher/Masquer les paramètres",
                title_toggle_description: "Afficher/Masquer la description",
                title_add_outcome: "Ajouter un résultat d'apprentissage",
                title_remove_outcome: "Supprimer le résultat",
                title_add_step: "Ajouter une nouvelle activité d'apprentissage",
                title_create_activity: "Créer votre premier module",
                title_help: "Aide & Information",
                help_title: "Comment utiliser le Concepteur Pédagogique",
                help_structure_title: "1. Structure du Design",
                help_structure_text: "Construisez votre cours en ajoutant des <strong>Modules</strong> (sujets) et en les remplissant d'<strong>Activités</strong> (tâches spécifiques). Réorganisez les éléments à l'aide des poignées <span class=\"inline-block align-middle\"><span class=\"material-icons-round text-base text-slate-400\">drag_indicator</span></span>.",
                help_types_title: "2. Types d'Apprentissage",
                help_types_intro: "Sélectionnez un type pédagogique pour chaque étape :",
                help_export_title: "3. Enregistrer & Exporter",
                help_export_text: "<strong>Enregistrer/Charger :</strong> Conservez votre travail dans un fichier .json.<br><strong>Exporter :</strong> Générez des fichiers aux formats Markdown (IA), PDF ou Texte Riche.",
                footer_disclaimer: "Ce site n'utilise pas de cookies de suivi ou de session. Aucune donnée personnelle n'est traitée en ligne.",
                footer_ai_disclaimer: "Cette application a été créée principalement à l'aide d'une IA générative ; le code peut contenir des erreurs.",
                footer_github: "Code disponible sur <a href=\"https://github.com/jourde/artefacts\" target=\"_blank\" class=\"underline hover:text-slate-500\">https://github.com/jourde/artefacts</a>",
                bloom_placeholder: "Bloom...",
                bloom_sub_placeholder: "Sous-cat...",
                bloom_remember: "Mémoriser",
                bloom_understand: "Comprendre",
                bloom_apply: "Appliquer",
                bloom_analyze: "Analyser",
                bloom_evaluate: "Évaluer",
                bloom_create: "Créer",
                bloom_sub_recognizing: "Reconnaître",
                bloom_sub_recalling: "Se rappeler",
                bloom_sub_interpreting: "Interpréter",
                bloom_sub_exemplifying: "Illustrer",
                bloom_sub_classifying: "Classer",
                bloom_sub_summarizing: "Résumer",
                bloom_sub_inferring: "Inférer",
                bloom_sub_comparing: "Comparer",
                bloom_sub_explaining: "Expliquer",
                bloom_sub_executing: "Exécuter",
                bloom_sub_implementing: "Implémenter",
                bloom_sub_differentiating: "Différencier",
                bloom_sub_organizing: "Organiser",
                bloom_sub_attributing: "Attribuer",
                bloom_sub_checking: "Vérifier",
                bloom_sub_critiquing: "Critiquer",
                bloom_sub_generating: "Générer",
                bloom_sub_planning: "Planifier",
                bloom_sub_producing: "Produire",
                
                modal_confirm_title: "Confirmer l'action",
                confirm_delete_activity: "Supprimer tout le module ?",
                confirm_delete_moment: "Supprimer ce moment ?",
                btn_cancel: "Annuler",
                btn_delete: "Supprimer",
                
                legend_grouping: "Plein : Classe • Rayé : Groupes",
                legend_trainer: "Plein : Présent • Rayé : Absent",
                legend_place: "Plein : Présentiel • Rayé : En ligne",
                legend_time: "Plein : Synchrone • Rayé : Asynchrone",
                title_toggle_types: "Afficher/Masquer le menu Type d'Apprentissage",
                btn_toggle_types: "Types d'appr.",
                label_target: "Cible",
                label_designed: "Conçu",
                
                bloom_sub_cite: "Citer",
                bloom_sub_define: "Définir",
                bloom_sub_describe: "Décrire",
                bloom_sub_identify: "Identifier",
                bloom_sub_label: "Étiqueter",
                bloom_sub_list: "Lister",
                bloom_sub_match: "Apparier",
                bloom_sub_name: "Nommer",
                bloom_sub_outline: "Esquisser",
                bloom_sub_quote: "Citer",
                bloom_sub_recall: "Se rappeler",
                bloom_sub_report: "Rapporter",
                bloom_sub_reproduce: "Reproduire",
                bloom_sub_retrieve: "Récupérer",
                bloom_sub_show: "Montrer",
                bloom_sub_state: "Énoncer",
                bloom_sub_tabulate: "Tabuler",
                bloom_sub_tell: "Dire",
                bloom_sub_abstract: "Abstraire",
                bloom_sub_arrange: "Arranger",
                bloom_sub_articulate: "Articuler",
                bloom_sub_associate: "Associer",
                bloom_sub_categorize: "Catégoriser",
                bloom_sub_clarify: "Clarifier",
                bloom_sub_classify: "Classer",
                bloom_sub_compare: "Comparer",
                bloom_sub_compute: "Calculer",
                bloom_sub_conclude: "Conclure",
                bloom_sub_contrast: "Contraster",
                bloom_sub_defend: "Défendre",
                bloom_sub_diagram: "Diagrammer",
                bloom_sub_differentiate: "Différencier",
                bloom_sub_discuss: "Discuter",
                bloom_sub_distinguish: "Distinguer",
                bloom_sub_estimate: "Estimer",
                bloom_sub_exemplify: "Exemplifier",
                bloom_sub_explain: "Expliquer",
                bloom_sub_extend: "Étendre",
                bloom_sub_extrapolate: "Extrapoler",
                bloom_sub_generalize: "Généraliser",
                "bloom_sub_give examples of": "Donner des exemples",
                bloom_sub_illustrate: "Illustrer",
                bloom_sub_infer: "Inférer",
                bloom_sub_interpolate: "Interpoler",
                bloom_sub_interpret: "Interpréter",
                bloom_sub_paraphrase: "Paraphraser",
                bloom_sub_predict: "Prédire",
                bloom_sub_rearrange: "Réarranger",
                bloom_sub_reorder: "Réordonner",
                bloom_sub_rephrase: "Reformuler",
                bloom_sub_represent: "Représenter",
                bloom_sub_restate: "Réitérer",
                bloom_sub_summarize: "Résumer",
                bloom_sub_transform: "Transformer",
                bloom_sub_translate: "Traduire",
                bloom_sub_apply: "Appliquer",
                bloom_sub_calculate: "Calculer",
                "bloom_sub_carry out": "Effectuer",
                bloom_sub_complete: "Compléter",
                bloom_sub_demonstrate: "Démontrer",
                bloom_sub_dramatize: "Théâtraliser",
                bloom_sub_employ: "Employer",
                bloom_sub_examine: "Examiner",
                bloom_sub_execute: "Exécuter",
                bloom_sub_experiment: "Expérimenter",
                bloom_sub_implement: "Implémenter",
                bloom_sub_manipulate: "Manipuler",
                bloom_sub_modify: "Modifier",
                bloom_sub_operate: "Opérer",
                bloom_sub_organize: "Organiser",
                bloom_sub_solve: "Résoudre",
                bloom_sub_transfer: "Transférer",
                bloom_sub_use: "Utiliser",
                bloom_sub_analyze: "Analyser",
                "bloom_sub_break down": "Décomposer",
                bloom_sub_connect: "Connecter",
                bloom_sub_deconstruct: "Déconstruire",
                bloom_sub_detect: "Détecter",
                bloom_sub_discriminate: "Discriminer",
                bloom_sub_divide: "Diviser",
                bloom_sub_integrate: "Intégrer",
                bloom_sub_inventory: "Inventorier",
                bloom_sub_order: "Ordonner",
                bloom_sub_relate: "Relier",
                bloom_sub_separate: "Séparer",
                bloom_sub_structure: "Structurer",
                bloom_sub_appraise: "Apprécier",
                bloom_sub_apprise: "Informer",
                bloom_sub_argue: "Argumenter",
                bloom_sub_assess: "Évaluer",
                bloom_sub_consider: "Considérer",
                bloom_sub_convince: "Convaincre",
                bloom_sub_criticize: "Critiquer",
                bloom_sub_critique: "Critiquer",
                bloom_sub_decide: "Décider",
                bloom_sub_determine: "Déterminer",
                bloom_sub_evaluate: "Évaluer",
                bloom_sub_grade: "Noter",
                bloom_sub_judge: "Juger",
                bloom_sub_justify: "Justifier",
                bloom_sub_measure: "Mesurer",
                bloom_sub_rank: "Classer",
                bloom_sub_rate: "Évaluer",
                bloom_sub_recommend: "Recommander",
                bloom_sub_review: "Revoir",
                bloom_sub_score: "Scorer",
                bloom_sub_select: "Sélectionner",
                bloom_sub_standardize: "Standardiser",
                bloom_sub_support: "Soutenir",
                bloom_sub_test: "Tester",
                bloom_sub_validate: "Valider",
                bloom_sub_assemble: "Assembler",
                bloom_sub_build: "Bâtir",
                bloom_sub_collect: "Collecter",
                bloom_sub_combine: "Combiner",
                bloom_sub_compile: "Compiler",
                bloom_sub_compose: "Composer",
                bloom_sub_constitute: "Constituer",
                bloom_sub_construct: "Construire",
                bloom_sub_create: "Créer",
                bloom_sub_design: "Concevoir",
                bloom_sub_develop: "Développer",
                bloom_sub_devise: "Imaginer",
                bloom_sub_formulate: "Formuler",
                bloom_sub_generate: "Générer",
                bloom_sub_hypothesize: "Hypothétiser",
                bloom_sub_invent: "Inventer",
                bloom_sub_make: "Faire",
                bloom_sub_manage: "Gérer",
                bloom_sub_perform: "Performer",
                bloom_sub_plan: "Planifier",
                bloom_sub_prepare: "Préparer",
                bloom_sub_produce: "Produire",
                bloom_sub_propose: "Proposer",
                bloom_sub_reconstruct: "Reconstruire",
                bloom_sub_reorganize: "Réorganiser",
                bloom_sub_revise: "Réviser",
                bloom_sub_rewrite: "Réécrire",
                bloom_sub_specify: "Spécifier",
                bloom_sub_synthesize: "Synthétiser",
                bloom_sub_write: "Écrire"
            }
        };

        const TYPE_COLORS = {
            none: '#e5e7eb',
            acquisition: '#a1f5ed',
            collaboration: '#ffd966',
            discussion: '#7aaeea',
            investigation: '#f8807f',
            practice: '#bb98dc',
            production: '#bdea75'
        };

        
        if (typeof Sortable !== 'undefined') {
            new Sortable(root, {
                animation: 150,
                handle: '.drag-handle-activity',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onStart: () => { __pendingDragSnapshot = snapshotProject(); },
                onEnd: () => {
                    if (__pendingDragSnapshot) { pushUndoSnapshot(__pendingDragSnapshot); __pendingDragSnapshot = null; }
                    updateEmptyState();
                }
            });

            
            const outcomesListEl = document.getElementById('outcomes-list');
            if (outcomesListEl) {
                new Sortable(outcomesListEl, {
                    animation: 150,
                    handle: '.drag-handle-outcome',
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag'
                });
            }
        } else {

        }

function initSortableSteps(container) {
            if (typeof Sortable === 'undefined' || !container) return;
            new Sortable(container, {
                group: 'shared-steps',
                animation: 150,
                handle: '.drag-handle-step',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onStart: () => { __pendingDragSnapshot = snapshotProject(); },
                onEnd: () => {
                    if (__pendingDragSnapshot) { pushUndoSnapshot(__pendingDragSnapshot); __pendingDragSnapshot = null; }
                    updateStats();
                }
            });
        }

        function initSortableMoments(container) {
            if (typeof Sortable === 'undefined' || !container) return;
            new Sortable(container, {
                // Shared group enables moving moments between modules
                group: 'shared-moments',
                animation: 150,
                handle: '.drag-handle-moment',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onStart: () => { __pendingDragSnapshot = snapshotProject(); },
                onEnd: (evt) => {
                    if (__pendingDragSnapshot) { pushUndoSnapshot(__pendingDragSnapshot); __pendingDragSnapshot = null; }
                    // Re-index both source and destination modules after cross-module moves
                    const fromModule = evt?.from?.closest?.('.activity-group');
                    const toModule = evt?.to?.closest?.('.activity-group');
                    if (fromModule) updateMomentIndexes(fromModule);
                    if (toModule && toModule !== fromModule) updateMomentIndexes(toModule);
                    updateStats();
                }
            });
        }

        function ensureDefaultMoment(activityGroup) {
            const momentsRoot = activityGroup.querySelector('.activity-moments-container');
            if (!momentsRoot) return null;
            const existing = momentsRoot.querySelector('.moment-group');
            if (existing) return existing;
            const clone = momentTemplate.content.cloneNode(true);
            momentsRoot.appendChild(clone);
            const moment = momentsRoot.lastElementChild;
            initSortableSteps(moment.querySelector('.activity-steps-container'));
            const mUnitSel = moment.querySelector('.moment-target-unit');
            if (mUnitSel) mUnitSel.value = 60;
            updateMomentIndexes(activityGroup);
            return moment;
        }

        function updateMomentIndexes(activityGroup) {
            if (!activityGroup) return;

            
            let moduleNum = '';
            const moduleBadge = activityGroup.querySelector('.activity-index');
            if (moduleBadge) moduleNum = String(moduleBadge.textContent || moduleBadge.innerText || '').trim();

            if (!moduleNum) {
                const allActs = Array.from(root.querySelectorAll('.activity-group'));
                const idx = allActs.indexOf(activityGroup);
                moduleNum = String((idx >= 0 ? idx : 0) + 1);
            }

            const moments = activityGroup.querySelectorAll('.activity-moments-container .moment-group');
            moments.forEach((m, i) => {
                const badge = m.querySelector('.moment-index');
                if (badge) badge.textContent = moduleNum + '.' + String(i + 1);
            });
        }

        function addMomentToActivity(btn) {
            const activityGroup = btn.closest('.activity-group');
            const momentsRoot = activityGroup.querySelector('.activity-moments-container');
            if (!momentsRoot) return;
            const clone = momentTemplate.content.cloneNode(true);
            momentsRoot.appendChild(clone);
            const moment = momentsRoot.lastElementChild;
            initSortableSteps(moment.querySelector('.activity-steps-container'));
            const mUnitSel = moment.querySelector('.moment-target-unit');
            if (mUnitSel) mUnitSel.value = 60;
            updateMomentIndexes(activityGroup);
            applyTranslations();
            updateStats();
        }

        function deleteMoment(btn) {
            historyCaptureNow();
            // Direct deletion (no confirmation). Kept for internal calls.
            const moment = btn.closest('.moment-group');
            if (!moment) return;
            const activityGroup = moment.closest('.activity-group');
            moment.remove();
            ensureDefaultMoment(activityGroup);
            updateMomentIndexes(activityGroup);
            updateStats();
        }

        function trashMoment(evtOrBtn, maybeBtn) {
            const evt = (evtOrBtn && typeof evtOrBtn === 'object' && 'preventDefault' in evtOrBtn) ? evtOrBtn : null;
            const btn = evt ? maybeBtn : evtOrBtn;

            if (!btn) return;
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }

            const moment = btn.closest('.moment-group');
            if (!moment) return;

            const activityGroup = moment.closest('.activity-group');

            const modal = document.getElementById('custom-confirm-modal');
            const msg = document.getElementById('custom-confirm-msg');

            // Fallback: if modal is missing for any reason, delete directly.
            if (!modal || !msg) {
                moment.remove();
                ensureDefaultMoment(activityGroup);
                updateMomentIndexes(activityGroup);
                updateStats();
                return;
            }

            msg.innerText = (translations[currentLang] && translations[currentLang].confirm_delete_moment) || 'Supprimer ce moment ?';

            __confirmAction = () => {
                historyCaptureNow();
                moment.remove();
                ensureDefaultMoment(activityGroup);
                updateMomentIndexes(activityGroup);
                updateStats();
            };

            modal.classList.remove('hidden');
        }


        

        function getPanelDisplay(el) {
            if (!el) return 'block';
            if (el.dataset && el.dataset.display) return el.dataset.display;
            if (el.classList.contains('flex')) return 'flex';
            if (el.classList.contains('grid')) return 'grid';
            return 'block';
        }

        function togglePanel(panelId) {
            const content = document.getElementById(panelId);
            const icon = document.getElementById(panelId + '-icon');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.classList.remove('open');
                setTimeout(() => content.style.display = 'none', 300); 
            } else {
                content.style.display = getPanelDisplay(content); 
                setTimeout(() => {
                    content.classList.add('open');
                    icon.classList.add('open');
                    setTimeout(updateTimelineHScroll, 0);
                }, 10);
            }
        }

        function toggleTimelineDetails() {
            const content = document.getElementById('timeline-details');
            const icon = document.getElementById('timeline-details-icon');
            if (!content) return;

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                if (icon) icon.classList.remove('open');
                setTimeout(() => content.style.display = 'none', 250);
            } else {
                content.style.display = getPanelDisplay(content);
                setTimeout(() => {
                    content.classList.add('open');
                    if (icon) icon.classList.add('open');
                    setTimeout(updateTimelineHScroll, 0);
                }, 10);
            }
        }

        function toggleAllActivities() {
            const bodies = document.querySelectorAll('.activity-body');
            const icons = document.querySelectorAll('.activity-group .rotate-icon');
            const mainBtnIcon = document.getElementById('icon-toggle-all-main');
            const mainBtnText = document.getElementById('text-toggle-all-main');
            const headerBtnIcon = document.getElementById('icon-toggle-all');
            
            let anyOpen = false;
            bodies.forEach(b => {
                if (!b.classList.contains('collapsed')) anyOpen = true;
            });

            bodies.forEach(b => {
                if (anyOpen) {
                    b.classList.add('collapsed');
                } else {
                    b.classList.remove('collapsed');
                }
            });

            icons.forEach(icon => {
                if (anyOpen) {
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    icon.style.transform = 'rotate(180deg)';
                }
            });

            
            const iconText = anyOpen ? 'unfold_more' : 'unfold_less';
            const labelKey = anyOpen ? 'btn_expand_all' : 'btn_collapse_all';
            
            if(mainBtnIcon) mainBtnIcon.innerText = iconText;
            if(mainBtnText) {
                mainBtnText.innerText = translations[currentLang][labelKey];
                mainBtnText.setAttribute('data-i18n', labelKey);
            }
            if(headerBtnIcon) headerBtnIcon.innerText = iconText;
        }

        function toggleLearningTypes() {
            document.body.classList.toggle('hide-types');
            const icon = document.getElementById('icon-toggle-types');
            if (document.body.classList.contains('hide-types')) {
                icon.innerText = 'visibility_off';
            } else {
                icon.innerText = 'visibility';
            }
        }

        
        function toggleActivity(btn) {
            const activityGroup = btn.closest('.activity-group');
            const body = activityGroup.querySelector('.activity-body');
            const icon = btn.querySelector('.rotate-icon');

            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                icon.style.transform = 'rotate(180deg)';
            } else {
                body.classList.add('collapsed');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        function toggleMoment(btn) {
            const momentGroup = btn.closest('.moment-group');
            const body = momentGroup.querySelector('.moment-body');
            const icon = btn.querySelector('.rotate-icon-moment');

            if (!body) return;

            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                if (icon) icon.style.transform = 'rotate(180deg)';
                btn.setAttribute('aria-expanded', 'true');
            } else {
                body.classList.add('collapsed');
                if (icon) icon.style.transform = 'rotate(0deg)';
                btn.setAttribute('aria-expanded', 'false');
            }
        }

        function toggleMomentDescription(btn) {
            const momentGroup = btn.closest('.moment-group');
            if (!momentGroup) return;
            const wrap = momentGroup.querySelector('.moment-description-wrap');
            if (!wrap) return;

            const isHidden = wrap.classList.contains('hidden');
            if (isHidden) {
                wrap.classList.remove('hidden');
                btn.setAttribute('aria-expanded', 'true');
            } else {
                wrap.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
            }
        }

        

        // --- Added: Timeline ↔ Editor synced navigation ---
        function flashHighlight(el) {
            if (!el) return;
            el.classList.add('temp-highlight');
            setTimeout(() => el.classList.remove('temp-highlight'), 1600);
        }

        function scrollToEditor(moduleIndex, stepIndex = null) {
            const modules = Array.from(document.querySelectorAll('.activity-group'));
            const moduleEl = modules[moduleIndex];
            if (!moduleEl) return;

            // Ensure module is expanded
            const moduleBody = moduleEl.querySelector('.activity-body');
            if (moduleBody && moduleBody.classList.contains('collapsed')) {
                moduleBody.classList.remove('collapsed');
            }

            let targetEl = moduleEl;

            if (stepIndex !== null && stepIndex !== undefined) {
                const steps = Array.from(moduleEl.querySelectorAll('.step-card'));
                const stepEl = steps[stepIndex];
                if (stepEl) {
                    targetEl = stepEl;

                    // Ensure the parent moment is expanded (if applicable)
                    const momentGroup = stepEl.closest('.moment-group');
                    const momentBody = momentGroup ? momentGroup.querySelector('.moment-body') : null;
                    if (momentBody && momentBody.classList.contains('collapsed')) {
                        momentBody.classList.remove('collapsed');
                    }
                }
            }

            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            flashHighlight(targetEl);
        }

        // --- Added: Focus mode (per module) ---
        function updateFocusButtons() {
            const t = translations[currentLang] || translations.fr;
            const focusTitle = t.title_focus_module || 'Mode focus';
            const exitTitle = t.title_exit_focus || 'Quitter le mode focus';

            document.querySelectorAll('button[onclick="toggleFocusModule(this)"]').forEach(btn => {
                const icon = btn.querySelector('.focus-toggle-icon');
                const moduleEl = btn.closest('.activity-group');
                const active = document.body.classList.contains('focus-mode') && moduleEl && moduleEl.classList.contains('focus-active');

                if (icon) icon.textContent = active ? 'close_fullscreen' : 'center_focus_strong';
                btn.title = active ? exitTitle : focusTitle;
                btn.setAttribute('aria-pressed', active ? 'true' : 'false');
            });
        }

        function exitFocusMode() {
            document.body.classList.remove('focus-mode');
            document.querySelectorAll('.activity-group').forEach(el => el.classList.remove('focus-active'));
            updateFocusButtons();
        }

        function toggleFocusModule(btn) {
            const moduleEl = btn.closest('.activity-group');
            if (!moduleEl) return;

            const isActive = document.body.classList.contains('focus-mode') && moduleEl.classList.contains('focus-active');

            if (isActive) {
                exitFocusMode();
                return;
            }

            document.body.classList.add('focus-mode');
            document.querySelectorAll('.activity-group').forEach(el => el.classList.remove('focus-active'));
            moduleEl.classList.add('focus-active');

            moduleEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            flashHighlight(moduleEl);
            updateFocusButtons();
        }

        // ESC exits focus mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.body.classList.contains('focus-mode')) {
                exitFocusMode();
            }
        });


        function toggleStep(btn) {
            const stepCard = btn.closest('.step-card');
            const body = stepCard.querySelector('.step-body');
            const icon = btn.querySelector('.rotate-icon');

            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                icon.style.transform = 'rotate(180deg)';
            } else {
                body.classList.add('collapsed');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleDescription(btn) {
            const group = btn.closest('.activity-group');
            const descPanel = group.querySelector('.activity-description-panel');
            
            if (descPanel.classList.contains('open')) {
                descPanel.classList.remove('open');
                btn.classList.remove('text-indigo-600'); 
                btn.classList.add('text-slate-400');
            } else {
                descPanel.classList.add('open');
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-indigo-600');
            }
        }

        

        function renderBloomOptions(selectElement, selectedValue = "") {
            const t = translations[currentLang];
            let options = `<option value="" disabled ${!selectedValue ? 'selected' : ''}>${t.bloom_placeholder}</option>`;
            
            Object.keys(BLOOM_TAXONOMY).forEach(level => {
                options += `<option value="${level}" ${selectedValue === level ? 'selected' : ''}>${t['bloom_' + level]}</option>`;
            });
            selectElement.innerHTML = options;
        }

        function renderBloomSubOptions(subSelectElement, level, selectedValue = "") {
            const t = translations[currentLang];
            
            if (!level || !BLOOM_TAXONOMY[level]) {
                subSelectElement.innerHTML = `<option value="" disabled selected>${t.bloom_sub_placeholder}</option>`;
                subSelectElement.classList.add('hidden');
                return;
            }

            subSelectElement.classList.remove('hidden');
            let options = `<option value="" disabled ${!selectedValue ? 'selected' : ''}>${t.bloom_sub_placeholder}</option>`;
            
            BLOOM_TAXONOMY[level].forEach(sub => {
                options += `<option value="${sub}" ${selectedValue === sub ? 'selected' : ''}>${t['bloom_sub_' + sub] || sub}</option>`;
            });
            subSelectElement.innerHTML = options;
        }

        function updateOutcomeBloom(levelSelect) {
            const subSelect = levelSelect.nextElementSibling;
            renderBloomSubOptions(subSelect, levelSelect.value);
        }

        
        function addOutcome(data = null) {
            let text = '';
            let level = '';
            let sub = '';

            const input = document.getElementById('new-outcome-input');
            const headerLevel = document.getElementById('new-bloom-level');
            const headerSub = document.getElementById('new-bloom-sub');

            if (data) {
                if (typeof data === 'string') {
                    text = data;
                } else {
                    text = data.text;
                    level = data.level || '';
                    sub = data.sub || '';
                }
            } else {
                text = input.value.trim();
                level = headerLevel.value;
                sub = headerSub.value;
            }

            if (!text) return;

            const list = document.getElementById('outcomes-list');
            const t = translations[currentLang];
            
            const li = document.createElement('li');
            li.className = "flex items-start sm:items-center justify-between bg-slate-50 px-1 py-1 rounded border border-slate-100 group gap-1";
            li.setAttribute("data-i18n-title", "title_remove_outcome");
            li.title = t.title_remove_outcome;
            
            
            const dragHandle = document.createElement('div');
            dragHandle.className = "drag-handle-outcome drag-handle text-slate-300 hover:text-slate-500 cursor-grab mt-1 sm:mt-0";
            dragHandle.innerHTML = '<span class="material-icons-round text-base">drag_indicator</span>';

            
            const levelSelect = document.createElement('select');
            levelSelect.className = "outcome-bloom-level text-[9px] uppercase font-bold text-slate-500 border border-slate-200 rounded py-0.5 px-0.5 bg-white focus:ring-1 focus:ring-indigo-500 outline-none w-20";
            levelSelect.onchange = function() { updateOutcomeBloom(this); };
            renderBloomOptions(levelSelect, level);

            const subSelect = document.createElement('select');
            subSelect.className = "outcome-bloom-sub text-[9px] text-slate-500 border border-slate-200 rounded py-0.5 px-0.5 bg-white focus:ring-1 focus:ring-indigo-500 outline-none w-20";
            renderBloomSubOptions(subSelect, level, sub); 

            const span = document.createElement('span');
            span.className = "text-xs text-slate-700 outcome-text flex-1 min-w-[150px] break-words";
            span.innerText = text;

            const btn = document.createElement('button');
            btn.onclick = function() { this.closest('li').remove(); checkOutcomesEmpty(); };
            btn.className = "text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto";
            btn.innerHTML = '<span class="material-icons-round text-sm">close</span>';

            const contentContainer = document.createElement('div');
            contentContainer.className = "flex flex-col sm:flex-row gap-1 flex-1 items-start sm:items-center w-full";

            const selectContainer = document.createElement('div');
            selectContainer.className = "flex gap-1 shrink-0";
            selectContainer.appendChild(levelSelect);
            selectContainer.appendChild(subSelect);

            contentContainer.appendChild(selectContainer);
            contentContainer.appendChild(span);

            li.appendChild(dragHandle);
            li.appendChild(contentContainer);
            li.appendChild(btn);
            
            list.appendChild(li);

            if (!data) {
                input.value = '';
                headerLevel.value = "";
                renderBloomSubOptions(headerSub, ""); 
            }
            checkOutcomesEmpty();
        }

        function checkOutcomesEmpty() {
            const list = document.getElementById('outcomes-list');
            const emptyText = document.getElementById('no-outcomes-text');
            if (list.children.length === 0) {
                emptyText.classList.remove('hidden');
            } else {
                emptyText.classList.add('hidden');
            }
        }

                

        
        
        function buildExportProjectData() {
            // Build a complete, portable representation of the current design (used for file save and autosave)
            const outcomes = [];
            document.querySelectorAll('#outcomes-list li').forEach(li => {
                outcomes.push({
                    texte: li.querySelector('.outcome-text').innerText,
                    niveau: li.querySelector('.outcome-bloom-level').value,
                    sousNiveau: li.querySelector('.outcome-bloom-sub').value
                });
            });

            const exportProject = {
                version: "1.8",
                parametres: {
                    nom: document.getElementById('param-name').value,
                    theme: (document.getElementById('param-topic') ? document.getElementById('param-topic').value : ''),
                    auteurs: document.getElementById('param-authors').value,
                    niveau: document.getElementById('param-level')?.value || 'unspecified',
                    publicCible: document.getElementById('param-target-audience')?.value || '',
                    prerequis: document.getElementById('param-prerequisites')?.value || '',
                    modalite: document.getElementById('param-mode').value,
                    tailleCohorte: document.getElementById('global-class-size').value,
                    dureeApprentissageValeur: document.getElementById('param-learning-val').value,
                    dureeApprentissageUnite: document.getElementById('param-learning-unit').value,
                    dureeConcueValeur: document.getElementById('param-designed-val').value,
                    dureeConcueUnite: document.getElementById('param-learning-unit').value,
                    objectifs: document.getElementById('param-aims').value,
                    resultatsTexte: document.getElementById('param-outcomes-text')?.value || "",
                    resultats: outcomes,
                    description: document.getElementById('param-description').value
                },
                modules: []
            };

            document.querySelectorAll('.activity-group').forEach(actEl => {
                const moduleData = {
                    titre: actEl.querySelector('.activity-title').value,
                    description: actEl.querySelector('.activity-description').value,
                    dureeCible: actEl.querySelector('.activity-target-time').value,
                    uniteDureeCible: actEl.querySelector('.activity-target-unit')?.value || "60",
                    moments: [],
                    activites: []
                };

                const momentsRoot = actEl.querySelector('.activity-moments-container');
                const momentEls = momentsRoot ? momentsRoot.querySelectorAll('.moment-group') : [];

                if (momentEls && momentEls.length) {
                    momentEls.forEach(momentEl => {
                        const momentData = {
                            titre: momentEl.querySelector('.moment-title')?.value || "",
                            description: momentEl.querySelector('.moment-description')?.value || "",
                            dureeCible: momentEl.querySelector('.moment-target-time')?.value,
                            uniteDureeCible: momentEl.querySelector('.moment-target-unit')?.value || getDefaultDurationUnitSecs(),
                            activites: []
                        };
                        momentEl.querySelectorAll('.step-card').forEach(stepEl => {
                            const stepObj = {
                                titre: stepEl.querySelector('.step-input-title').value,
                                type: stepEl.querySelector('.learning-type-select').value,
                                duree: stepEl.querySelector('.duration-input').value,
                                unite: stepEl.querySelector('.duration-unit').value,
                                regroupement: stepEl.querySelector('.step-group-mode').value,
                                nombreGroupes: stepEl.querySelector('.step-group-count').value,
                                tailleGroupe: stepEl.querySelector('.step-group-size').value,
                                formateur: stepEl.querySelector('.trainer-select').value,
                                lieu: stepEl.querySelector('.place-select').value,
                                temps: stepEl.querySelector('.time-select').value,
                                objectifActivite: stepEl.querySelector('.step-input-objective').value,
                                aFaire: stepEl.querySelector('.step-input-tasks').value,
                                notes: stepEl.querySelector('.step-input-notes').value
                            };
                            momentData.activites.push(stepObj);
                            moduleData.activites.push({ ...stepObj });
                        });
                        moduleData.moments.push(momentData);
                    });
                } else {
                    actEl.querySelectorAll('.step-card').forEach(stepEl => {
                        moduleData.activites.push({
                            titre: stepEl.querySelector('.step-input-title').value,
                            type: stepEl.querySelector('.learning-type-select').value,
                            duree: stepEl.querySelector('.duration-input').value,
                            unite: stepEl.querySelector('.duration-unit').value,
                            regroupement: stepEl.querySelector('.step-group-mode').value,
                            nombreGroupes: stepEl.querySelector('.step-group-count').value,
                            tailleGroupe: stepEl.querySelector('.step-group-size').value,
                            formateur: stepEl.querySelector('.trainer-select').value,
                            lieu: stepEl.querySelector('.place-select').value,
                            temps: stepEl.querySelector('.time-select').value,
                            objectifActivite: stepEl.querySelector('.step-input-objective').value,
                            aFaire: stepEl.querySelector('.step-input-tasks').value,
                            notes: stepEl.querySelector('.step-input-notes').value
                        });
                    });
                }

                exportProject.modules.push(moduleData);
            });

            return exportProject;
        }

function saveProject() {
            const exportProject = buildExportProjectData();

            const blob = new Blob([JSON.stringify(exportProject, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const courseName = (document.getElementById('param-name')?.value || '').trim();
            const safeCourseName = courseName
                .replace(/[\\/:*?"<>|]+/g, '-')
                .replace(/\s+/g, ' ')
                .trim()
                .slice(0, 120);

            const ymd = new Date().toISOString().slice(0, 10);
            a.download = safeCourseName
                ? `conception_pedagogique_${safeCourseName}_${ymd}.json`
                : `conception_pedagogique_${ymd}.json`;

            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerFileLoad() {
            document.getElementById('load-file-input').click();
        }

        
        function loadProjectFromObject(project) {
            // Support multiple saved-file shapes (legacy / FR / wrapper objects)
            if (project && typeof project === 'object') {
                project = project.project || project.data || project.conception || project.learningDesign || project;
            }
            const rootEl = document.getElementById('activities-root') || root;
            if (rootEl) rootEl.innerHTML = '';

            // Restore Key Params
            if (project.keyParams) {
                document.getElementById('param-name').value = project.keyParams.name || "";
                { const __el=document.getElementById('param-topic'); if(__el){ __el.value = project.keyParams.topic || ""; } }
                document.getElementById('param-authors').value = project.keyParams.authors || "";
                document.getElementById('param-level').value = project.keyParams.level || 'unspecified';
                document.getElementById('param-target-audience').value = project.keyParams.targetAudience || "";
                document.getElementById('param-prerequisites').value = project.keyParams.prerequisites || "";
                document.getElementById('param-mode').value = project.keyParams.mode || "";
                document.getElementById('global-class-size').value = project.keyParams.cohortSize || 30;
                document.getElementById('param-learning-val').value = project.keyParams.learningTimeVal || "";
                document.getElementById('param-learning-unit').value = project.keyParams.learningTimeUnit || "mins";
                document.getElementById('param-designed-val').value = project.keyParams.designedTimeVal || "";
                // Designed Time Unit is now synced with Learning Time Unit
                document.getElementById('param-aims').value = project.keyParams.aims || "";
                document.getElementById('param-outcomes-text').value = project.keyParams.outcomesText || "";
                document.getElementById('param-description').value = project.keyParams.description || "";

                // Restore Outcomes
                document.getElementById('outcomes-list').innerHTML = '';
                if (project.keyParams.outcomes && Array.isArray(project.keyParams.outcomes)) {
                    project.keyParams.outcomes.forEach(out => addOutcome(out));
                }
                checkOutcomesEmpty();
            } else if (project.parametres) {
                document.getElementById('param-name').value = project.parametres.nom || "";
                { const __el=document.getElementById('param-topic'); if(__el){ __el.value = project.parametres.theme || ""; } }
                document.getElementById('param-authors').value = project.parametres.auteurs || "";
                document.getElementById('param-level').value = project.parametres.niveau || 'unspecified';
                document.getElementById('param-target-audience').value = project.parametres.publicCible || "";
                document.getElementById('param-prerequisites').value = project.parametres.prerequis || "";
                document.getElementById('param-mode').value = project.parametres.modalite || "";
                document.getElementById('global-class-size').value = project.parametres.tailleCohorte || 30;
                document.getElementById('param-learning-val').value = project.parametres.dureeApprentissageValeur || "";
                document.getElementById('param-learning-unit').value = project.parametres.dureeApprentissageUnite || "mins";
                document.getElementById('param-designed-val').value = project.parametres.dureeConcueValeur || "";
                document.getElementById('param-aims').value = project.parametres.objectifs || "";
                document.getElementById('param-outcomes-text').value = project.parametres.resultatsTexte || "";
                document.getElementById('param-description').value = project.parametres.description || "";

                // Restore Outcomes (FR export)
                document.getElementById('outcomes-list').innerHTML = '';
                if (project.parametres.resultats && Array.isArray(project.parametres.resultats)) {
                    project.parametres.resultats.forEach(out => addOutcome({
                        text: out.texte ?? out.text,
                        level: out.niveau ?? out.level,
                        sub: out.sousNiveau ?? out.sub
                    }));
                }
                checkOutcomesEmpty();
            } else if (project.cohortSize) {
                document.getElementById('global-class-size').value = project.cohortSize;
            }

            applyTranslations();

            const loadedActivitiesRaw = Array.isArray(project.activities)
                ? project.activities
                : (Array.isArray(project.modules)
                    ? project.modules
                    : (Array.isArray(project) ? project : []));

            const normaliseStep = (s) => ({
                title: s?.title ?? s?.titre ?? "",
                type: s?.type ?? "",
                duration: s?.duration ?? s?.duree ?? "",
                unit: s?.unit ?? s?.unite ?? "",
                groupMode: s?.groupMode ?? s?.regroupement ?? "Classe entière",
                groupCount: s?.groupCount ?? s?.nombreGroupes ?? "",
                groupSize: s?.groupSize ?? s?.tailleGroupe ?? "",
                trainer: s?.trainer ?? s?.formateur ?? "",
                place: s?.place ?? s?.lieu ?? "",
                time: s?.time ?? s?.temps ?? "",
                objective: s?.objective ?? s?.objectifActivite ?? "",
                tasks: s?.tasks ?? s?.aFaire ?? "",
                notes: s?.notes ?? ""
            });

            const normaliseMoment = (m) => ({
                title: m?.title ?? m?.titre ?? "",
                description: m?.description ?? "",
                targetTime: m?.targetTime ?? m?.dureeCible ?? "",
                targetUnit: m?.targetUnit ?? m?.uniteDureeCible ?? (document.getElementById('param-learning-unit')?.value || "mins"),
                steps: Array.isArray(m?.steps) ? m.steps.map(normaliseStep) : (Array.isArray(m?.activites) ? m.activites.map(normaliseStep) : [])
            });

            const normaliseActivity = (a) => ({
                title: a?.title ?? a?.titre ?? "",
                description: a?.description ?? "",
                targetTime: a?.targetTime ?? a?.dureeCible ?? "",
                targetUnit: a?.targetUnit ?? a?.uniteDureeCible ?? "60",
                moments: Array.isArray(a?.moments) ? a.moments.map(normaliseMoment) : [],
                steps: Array.isArray(a?.steps) ? a.steps.map(normaliseStep) : (Array.isArray(a?.activites) ? a.activites.map(normaliseStep) : [])
            });

            loadedActivitiesRaw.forEach(actData => {
                addActivityFromData(normaliseActivity(actData));
            });

            // If nothing was restored, keep a minimal empty state consistent with default behaviour
            if (!loadedActivitiesRaw.length) {
                addActivity();
            }

            updateEmptyState();
            updateStats();
        }

function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const project = JSON.parse(e.target.result);
                    loadProjectFromObject(project);
                    event.target.value = '';
                } catch (err) {

                    alert("Erreur : impossible de charger ce fichier de sauvegarde. Vérifiez qu’il s’agit bien d’un fichier JSON exporté par cet outil.");
                }
            };
            reader.readAsText(file);
        }

        function addActivityFromData(data) {
            const clone = activityTemplate.content.cloneNode(true);
            root.appendChild(clone);
            const actEl = root.lastElementChild;

            const momentsRoot = actEl.querySelector('.activity-moments-container');
            initSortableMoments(momentsRoot);

            actEl.querySelector('.activity-title').value = data.title || "";
            actEl.querySelector('.activity-description').value = data.description || "";
            actEl.querySelector('.activity-target-time').value = data.targetTime || "";
            const tgtUnitSel = actEl.querySelector('.activity-target-unit');
            if (tgtUnitSel) tgtUnitSel.value = mapUnitToSecs(data.targetUnit || getDefaultDurationUnitKey());

            // Clear any template content and rebuild moments/steps from data (backward compatible)
            if (momentsRoot) momentsRoot.innerHTML = '';

            if (data.moments && Array.isArray(data.moments) && data.moments.length) {
                data.moments.forEach(momentData => {
                    const mClone = momentTemplate.content.cloneNode(true);
                    if (momentsRoot) momentsRoot.appendChild(mClone);
                    const momentEl = momentsRoot ? momentsRoot.lastElementChild : null;
                    if (momentEl) {
                        const titleInput = momentEl.querySelector('.moment-title');
                        if (titleInput) titleInput.value = momentData.title || "";
                                                const mTgt = momentEl.querySelector('.moment-target-time');
                        if (mTgt) mTgt.value = momentData.targetTime || "";
                        const mUnitSel = momentEl.querySelector('.moment-target-unit');
                        if (mUnitSel) mUnitSel.value = mapUnitToSecs(momentData.targetUnit ?? getDefaultDurationUnitKey());
const stepsContainer = momentEl.querySelector('.activity-steps-container');
                        initSortableSteps(stepsContainer);
                        (momentData.steps || []).forEach(stepData => {
                            addStepToContainerFromData(stepsContainer, stepData);
                        });
                    }
                });
                ensureDefaultMoment(actEl);
                updateMomentIndexes(actEl);
            } else {
                ensureDefaultMoment(actEl);
                const moments = actEl.querySelectorAll('.activity-moments-container .moment-group');
                const targetMoment = moments[moments.length - 1];
                const container = targetMoment ? targetMoment.querySelector('.activity-steps-container') : actEl.querySelector('.activity-steps-container');
                (data.steps || []).forEach(stepData => {
                    addStepToContainerFromData(container, stepData);
                });
            }

            applyTranslations();
            return actEl;
        }

        function addStepToContainerFromData(container, data) {
            if (!container) return;
            const clone = stepTemplate.content.cloneNode(true);
            const stepEl = clone.querySelector('.step-card');
            stepEl.querySelector('.step-input-title').value = data.title || "";
            stepEl.querySelector('.learning-type-select').value = data.type || "acquisition";
            stepEl.querySelector('.duration-input').value = data.duration || 0;
            stepEl.querySelector('.duration-unit').value = mapUnitToSecs(data.unit || getDefaultDurationUnitKey());
            stepEl.querySelector('.step-group-mode').value = data.groupMode || "class";
            stepEl.querySelector('.step-group-count').value = data.groupCount || 1;
            stepEl.querySelector('.step-group-size').value = data.groupSize || 30;
            stepEl.querySelector('.trainer-select').value = data.trainer || "present";
            stepEl.querySelector('.place-select').value = data.place || "situ";
            stepEl.querySelector('.time-select').value = data.time || "sync";
            stepEl.querySelector('.step-input-objective').value = data.objective || "";
            stepEl.querySelector('.step-input-tasks').value = data.tasks || "";
            stepEl.querySelector('.step-input-notes').value = data.notes || "";
            if (data.groupMode === 'groups') stepEl.querySelector('.step-group-details').classList.remove('hidden');
            container.appendChild(clone);
            updateStepType(stepEl.querySelector('.learning-type-select'));
        }

                // --- Core Application Logic ---

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) el.innerHTML = translations[currentLang][key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLang][key]) el.placeholder = translations[currentLang][key];
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[currentLang][key]) el.title = translations[currentLang][key];
            });
        }

        function toggleGroupMode(select) {
            const card = select.closest('.step-card');
            const details = card.querySelector('.step-group-details');
            if (details) details.classList.add('hidden');
            updateStats();
        }

        function updateGroupMath(input, type) {
            updateStats();
        }

        function updateEmptyState() {
            const hasActivities = root.children.length > 0;
            emptyState.classList.toggle('hidden', hasActivities);
            document.querySelectorAll('.activity-index').forEach((el, i) => { el.innerText = i + 1; });
            root.querySelectorAll('.activity-group').forEach((ag) => { updateMomentIndexes(ag); });
            updateStats();
        }

        function addActivity() {
            historyCaptureNow();
            const clone = activityTemplate.content.cloneNode(true);
            root.appendChild(clone);
            const lastActivity = root.lastElementChild;

            const momentsRoot = lastActivity.querySelector('.activity-moments-container');
            initSortableMoments(momentsRoot);
            ensureDefaultMoment(lastActivity);
            const actUnitSel = lastActivity.querySelector('.activity-target-unit');
            if (actUnitSel) actUnitSel.value = 60;

            addStepToActivity(lastActivity.querySelector('button'));
            applyTranslations();
            updateEmptyState();
        }

        function addStepToActivity(btnOrEvent) {
            historyCaptureNow();
            // Robust handler: accepts either a button element or a click event
            const btn = (btnOrEvent && (btnOrEvent.currentTarget || btnOrEvent.target)) ? (btnOrEvent.currentTarget || btnOrEvent.target) : btnOrEvent;

            const activityGroup = btn && btn.closest ? btn.closest('.activity-group') : null;
            if (!activityGroup) return;

            ensureDefaultMoment(activityGroup);
            const moments = activityGroup.querySelectorAll('.activity-moments-container .moment-group');
            const targetMoment = moments[moments.length - 1];
            const container = targetMoment
                ? targetMoment.querySelector('.activity-steps-container')
                : activityGroup.querySelector('.activity-steps-container');

            if (!container) return;

            const clone = stepTemplate.content.cloneNode(true);
            container.appendChild(clone);

            const newStep = container.lastElementChild;

            // Default unit should be "min" (stored as 60 seconds)
            const unitSelect = newStep ? newStep.querySelector('.duration-unit') : null;
            if (unitSelect) unitSelect.value = 60;

            // Ensure group-size reflects global cohort size at creation time
            const groupSize = newStep ? newStep.querySelector('.step-group-size') : null;
            const globalSize = document.getElementById('global-class-size');
            if (groupSize && globalSize) groupSize.value = globalSize.value;

            // Ensure Bloom dropdowns are correctly populated on newly-added steps
            const outLevel = newStep ? newStep.querySelector('.outcome-bloom-level') : null;
            if (outLevel) renderBloomOptions(outLevel, outLevel.value || "");

            // Ensure UI updates
            updateStats();
        }

        function copyFormValues(source, dest) {
            const srcInputs = source.querySelectorAll('input');
            const destInputs = dest.querySelectorAll('input');
            srcInputs.forEach((inp, i) => destInputs[i].value = inp.value);
            const srcText = source.querySelectorAll('textarea');
            const destText = dest.querySelectorAll('textarea');
            srcText.forEach((txt, i) => destText[i].value = txt.value);
            const srcSelects = source.querySelectorAll('select');
            const destSelects = dest.querySelectorAll('select');
            srcSelects.forEach((sel, i) => destSelects[i].value = sel.value);
        }

        // RENAMED TO AVOID CONFLICTS
        function cloneModule(btn) {
            historyCaptureNow();
            const original = btn.closest('.activity-group');
            const clone = original.cloneNode(true);
            original.after(clone);
            copyFormValues(original, clone);
            
            // Explicitly rebind buttons in the clone to be safe - CRITICAL FIX
            // Remove any manual rebind logic that depends on titles and let inline handlers work
            // The cloneNode(true) copies the type="button" data-action="duplicate-module" correctly.
            
            const momentsRoot = clone.querySelector('.activity-moments-container');
            initSortableMoments(momentsRoot);
            clone.querySelectorAll('.activity-steps-container').forEach((c) => initSortableSteps(c));
            ensureDefaultMoment(clone);
            updateMomentIndexes(clone);
            updateEmptyState();
            updateStats();
        }

        // RENAMED TO AVOID CONFLICTS
        function cloneStep(btn) {
            historyCaptureNow();
            const original = btn.closest('.step-card');
            const clone = original.cloneNode(true);
            original.after(clone);
            copyFormValues(original, clone);
            const select = clone.querySelector('.learning-type-select');
            updateStepType(select);
            updateStats();
        }

        // RENAMED AND FIXED MODAL LOGIC
        // Signature supports both: trashModule(this) and trashModule(event, this)
        function trashModule(evtOrBtn, maybeBtn) {
            const evt = (evtOrBtn && typeof evtOrBtn === 'object' && 'preventDefault' in evtOrBtn) ? evtOrBtn : null;
            const btn = evt ? maybeBtn : evtOrBtn;

            if (!btn) return;
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }

            const activityGroup = btn.closest('.activity-group');
            if (!activityGroup) return;

            const modal = document.getElementById('custom-confirm-modal');
            const msg = document.getElementById('custom-confirm-msg');

            // Fallback: if modal is missing for any reason, delete directly.
            if (!modal || !msg) {
                activityGroup.remove();
                updateEmptyState();
                return;
            }

            msg.innerText = translations[currentLang].confirm_delete_activity || 'Supprimer ce module ?';

            // Set the *single* pending confirm action. This prevents stacked handlers (which can cause duplication).
            __confirmAction = () => {
                historyCaptureNow();
                activityGroup.remove();
                updateEmptyState();
            };

            modal.classList.remove('hidden');
        }
        // RENAMED TO AVOID CONFLICTS
        function trashStep(btn) {
            historyCaptureNow();
            btn.closest('.step-card').remove();
            updateStats();
        }

        function updateStepType(select) {
            const card = select.closest('.step-card');
            const type = select.value;
            const types = Object.keys(TYPE_COLORS).map(t => `type-${t}`);
            card.classList.remove(...types);
            card.classList.add(`type-${type}`);
            const selectStyles = Object.keys(TYPE_COLORS).map(t => `select-${t}`);
            select.classList.remove(...selectStyles);
            select.classList.add(`select-${type}`);
            updateStats();
        }

        function getTotals() {
            const activities = document.querySelectorAll('.activity-group');
            const classSize = parseInt(document.getElementById('global-class-size').value) || 1;
            const typeTime = { acquisition: 0, collaboration: 0, discussion: 0, investigation: 0, practice: 0, production: 0 };
            const timelineData = [];
            const detailedTimeline = [];
            let totalSecs = 0;
            let currentTimelineSecs = 0;

            activities.forEach((act, idx) => {
                const title = act.querySelector('.activity-title').value || `${translations[currentLang].md_untitled_activity} ${idx+1}`;
                let actSecs = 0;
                const activitySteps = [];
                const steps = act.querySelectorAll('.step-card');
                
                steps.forEach(step => {
                    const dur = Math.max(0, parseFloat(step.querySelector('.duration-input').value) || 0); // Prevent negative
                    const unit = parseFloat(step.querySelector('.duration-unit').value) || 60;
                    const secs = dur * unit;
                    const type = step.querySelector('.learning-type-select').value;
                    
                    const stepTitle = step.querySelector('.step-input-title').value || translations[currentLang].md_untitled_step;
                    activitySteps.push({
                        title: stepTitle,
                        type: type,
                        duration: secs,
                        learningTypeLabel: translations[currentLang][`type_${type}`],
                        groupMode: step.querySelector('.step-group-mode').value,
                        trainer: step.querySelector('.trainer-select').value,
                        place: step.querySelector('.place-select').value,
                        time: step.querySelector('.time-select').value
                    });

                    currentTimelineSecs += secs;
                    const mode = step.querySelector('.step-group-mode').value;
                    let stepGroupSize = mode === 'groups' ? (parseInt(step.querySelector('.step-group-size').value) || classSize) : classSize;
                    typeTime[type] += secs;
                    actSecs += secs;
                    totalSecs += secs;
                });
                timelineData.push({ title, duration: Math.round(actSecs / 60) });
                detailedTimeline.push({ title: title, duration: actSecs, steps: activitySteps });
            });
            return { totalSecs, detailedTimeline };
        }

        // Timeline label formatter (compact): m / h / j(d) / sem(w) / mo
        
        // Zoom de la visualisation temporelle (piste / règles)
        let timelineZoom = 1;

        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        function setTimelineZoom(z){
            timelineZoom = clamp(parseFloat(z) || 1, 0.5, 3);
            applyTimelineZoom();
        }

        function applyTimelineZoom(){
            const zr = document.getElementById('timeline-zoom-range');
            const zv = document.getElementById('timeline-zoom-value');
            if(zr) zr.value = String(timelineZoom);
            if(zv) zv.textContent = `${Math.round(timelineZoom * 100)}%`;

            // Preserve current relative scroll position when changing zoom
            const before = __getTimelineTracks();
            const beforeMax = before.maxScroll || 0;
            const beforeLeft = before.outers[0] ? (before.outers[0].scrollLeft || 0) : 0;
            const ratio = beforeMax > 0 ? (beforeLeft / beforeMax) : 0;

            // Stretch the inner content to create real horizontal overflow
            const pct = (timelineZoom * 100);
            document.querySelectorAll('#timeline-panel .timeline-zoom-outer').forEach(outer => {
                const inner = outer.querySelector(':scope > .timeline-inner');
                if(inner){
                    inner.style.minWidth = pct + '%';
                    inner.style.width = pct + '%';
                }
            });

            // Re-sync unified scrollbar after layout settles
            requestAnimationFrame(() => {
                const after = __getTimelineTracks();
                const afterMax = after.maxScroll || 0;
                const targetLeft = afterMax > 0 ? clamp(ratio * afterMax, 0, afterMax) : 0;

                __timelineHScroll.busy = true;
                const bar = document.getElementById('timeline-hscroll');
                if(bar) bar.scrollLeft = targetLeft;
                after.outers.forEach(o => { o.scrollLeft = targetLeft; });
                __timelineHScroll.busy = false;

                updateTimelineHScroll();
            });
        }

        
        const __timelineHScroll = { busy:false, ro:null };

        function __getTimelineTracks(){
            const outers = Array.from(document.querySelectorAll('#timeline-panel .timeline-zoom-outer'));
            let maxScrollWidth = 0;
            outers.forEach(o => { maxScrollWidth = Math.max(maxScrollWidth, o.scrollWidth); });
            const viewportWidth = outers[0] ? outers[0].clientWidth : 0;
            const maxScroll = Math.max(0, maxScrollWidth - viewportWidth);
            return { outers, maxScrollWidth, viewportWidth, maxScroll };
        }

        function updateTimelineHScrollThumb(){
            const bar = document.getElementById('timeline-hscroll');
            const thumb = document.getElementById('timeline-hscroll-thumb');
            if(!bar || !thumb) return;

            const { maxScrollWidth, viewportWidth, maxScroll, outers } = __getTimelineTracks();
            const trackW = bar.clientWidth || 0;

            if(!trackW || !maxScrollWidth || !viewportWidth || !outers.length){
                bar.classList.add('is-disabled');
                thumb.style.width = Math.max(36, Math.round(trackW * 0.4)) + 'px';
                thumb.style.left = '0px';
                return;
            }

            const scrollLeft = outers[0].scrollLeft || 0;

            if(maxScroll <= 1){
                bar.classList.add('is-disabled');
                const w = Math.max(36, Math.round((viewportWidth / maxScrollWidth) * trackW));
                thumb.style.width = w + 'px';
                thumb.style.left = '0px';
                return;
            }

            bar.classList.remove('is-disabled');

            const thumbW = Math.max(36, Math.round((viewportWidth / maxScrollWidth) * trackW));
            const maxThumbX = Math.max(0, trackW - thumbW);
            const x = maxThumbX * (scrollLeft / maxScroll);
            thumb.style.width = thumbW + 'px';
            thumb.style.left = Math.round(x) + 'px';
        }

        function updateTimelineHScroll(){
            const bar = document.getElementById('timeline-hscroll');
            const inner = document.getElementById('timeline-hscroll-inner');
            if(!bar || !inner) return;

            const { outers, maxScrollWidth } = __getTimelineTracks();
            if(!outers.length) { inner.style.width = '0px'; updateTimelineHScrollThumb(); return; }

            inner.style.width = Math.max(maxScrollWidth, bar.clientWidth) + 'px';

            if(!bar.dataset.bound){
                bar.dataset.bound = '1';
                bar.addEventListener('scroll', () => {
                    if(__timelineHScroll.busy) return;
                    const { outers } = __getTimelineTracks();
                    if(!outers.length) return;

                    __timelineHScroll.busy = true;
                    const x = bar.scrollLeft;
                    outers.forEach(o => { o.scrollLeft = x; });
                    __timelineHScroll.busy = false;
                    updateTimelineHScrollThumb();
                }, { passive:true });
            }

            outers.forEach(o => {
                if(o.dataset.hscrollBound) return;
                o.dataset.hscrollBound = '1';
                o.addEventListener('scroll', () => {
                    if(__timelineHScroll.busy) return;
                    __timelineHScroll.busy = true;
                    bar.scrollLeft = o.scrollLeft;
                    __timelineHScroll.busy = false;
                    updateTimelineHScrollThumb();
                }, { passive:true });
            });

            if(window.ResizeObserver && !__timelineHScroll.ro){
                __timelineHScroll.ro = new ResizeObserver(() => updateTimelineHScroll());
                __timelineHScroll.ro.observe(bar);
            }
            if(__timelineHScroll.ro){
                outers.forEach(o => __timelineHScroll.ro.observe(o));
            }

            if(!window.__timelineHScrollWindowResizeBound){
                window.__timelineHScrollWindowResizeBound = true;
                window.addEventListener('resize', () => updateTimelineHScroll());
            }

            updateTimelineHScrollThumb();
        }

        function initTimelineHScrollThumbDrag(){
            const bar = document.getElementById('timeline-hscroll');
            const thumb = document.getElementById('timeline-hscroll-thumb');
            if(!bar || !thumb || thumb.dataset.bound) return;
            thumb.dataset.bound = '1';

            let dragging = false;
            let startX = 0;
            let startScrollLeft = 0;

            const onMoveMouse = (e) => {
                if(!dragging) return;
                const { maxScroll } = __getTimelineTracks();
                if(maxScroll <= 0){
                    __timelineHScroll.busy = true;
                    bar.scrollLeft = 0;
                    const { outers } = __getTimelineTracks();
                    outers.forEach(o => { o.scrollLeft = 0; });
                    __timelineHScroll.busy = false;
                    updateTimelineHScrollThumb();
                    return;
                }
                const rect = bar.getBoundingClientRect();
                const trackW = rect.width || 1;
                const thumbW = thumb.getBoundingClientRect().width || 1;
                const maxThumbX = Math.max(1, trackW - thumbW);
                const dx = e.clientX - startX;
                const ratio = maxScroll / maxThumbX;
                const target = clamp(startScrollLeft + (dx * ratio), 0, maxScroll);

                __timelineHScroll.busy = true;
                bar.scrollLeft = target;
                const { outers } = __getTimelineTracks();
                outers.forEach(o => { o.scrollLeft = target; });
                __timelineHScroll.busy = false;
                updateTimelineHScrollThumb();
            };

            const endMouse = () => {
                dragging = false;
                document.removeEventListener('mousemove', onMoveMouse);
                document.removeEventListener('mouseup', endMouse);
            };

            thumb.addEventListener('mousedown', (e) => {
                e.preventDefault();
                dragging = true;
                startX = e.clientX;
                startScrollLeft = bar.scrollLeft || 0;
                document.addEventListener('mousemove', onMoveMouse);
                document.addEventListener('mouseup', endMouse);
            });

            const onMoveTouch = (e) => {
                if(!dragging) return;
                e.preventDefault();

                const clientX = e.touches[0].clientX;
                const { maxScroll } = __getTimelineTracks();
                if(maxScroll <= 0){
                    __timelineHScroll.busy = true;
                    bar.scrollLeft = 0;
                    const { outers } = __getTimelineTracks();
                    outers.forEach(o => { o.scrollLeft = 0; });
                    __timelineHScroll.busy = false;
                    updateTimelineHScrollThumb();
                    return;
                }
                const rect = bar.getBoundingClientRect();
                const trackW = rect.width || 1;
                const thumbW = thumb.getBoundingClientRect().width || 1;
                const maxThumbX = Math.max(1, trackW - thumbW);
                const dx = clientX - startX;
                const ratio = maxScroll / maxThumbX;
                const target = clamp(startScrollLeft + (dx * ratio), 0, maxScroll);

                __timelineHScroll.busy = true;
                bar.scrollLeft = target;
                const { outers } = __getTimelineTracks();
                outers.forEach(o => { o.scrollLeft = target; });
                __timelineHScroll.busy = false;
                updateTimelineHScrollThumb();
            };

            const endTouch = () => {
                dragging = false;
                document.removeEventListener('touchmove', onMoveTouch);
                document.removeEventListener('touchend', endTouch);
            };

            thumb.addEventListener('touchstart', (e) => {
                dragging = true;
                startX = e.touches[0].clientX;
                startScrollLeft = bar.scrollLeft || 0;
                document.addEventListener('touchmove', onMoveTouch, { passive:false });
                document.addEventListener('touchend', endTouch);
            }, { passive:true });

            bar.addEventListener('mousedown', (e) => {
                if(e.target === thumb) return;
                const { maxScroll } = __getTimelineTracks();
                if(maxScroll <= 0) return;

                const rect = bar.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const thumbW = thumb.getBoundingClientRect().width || 1;
                const trackW = bar.clientWidth || 0;
                const maxThumbX = Math.max(1, trackW - thumbW);
                const thumbX = clamp(clickX - (thumbW / 2), 0, maxThumbX);
                const target = clamp((thumbX / maxThumbX) * maxScroll, 0, maxScroll);

                __timelineHScroll.busy = true;
                bar.scrollLeft = target;
                const { outers } = __getTimelineTracks();
                outers.forEach(o => { o.scrollLeft = target; });
                __timelineHScroll.busy = false;
                updateTimelineHScrollThumb();
            });
        }

        function setupTimelineHScroll(){
            initTimelineHScrollThumbDrag();
            updateTimelineHScroll();
        }
function bumpTimelineZoom(delta) {
            const z = clamp((parseFloat(timelineZoom) || 1) + delta, 0.5, 3);
            setTimelineZoom(parseFloat(z.toFixed(1)));
        }

        function initTimelineZoomControls() {
            try {
                const zr = document.getElementById('timeline-zoom-range');
                const zi = document.getElementById('timeline-zoom-in');
                const zo = document.getElementById('timeline-zoom-out');
                const zreset = document.getElementById('timeline-zoom-reset');

                if (zr && !zr.dataset.bound) {
                    zr.addEventListener('input', (e) => setTimelineZoom(e.target.value));
                    zr.dataset.bound = '1';
                }
                if (zi && !zi.dataset.bound) {
                    zi.addEventListener('click', () => bumpTimelineZoom(0.1));
                    zi.dataset.bound = '1';
                }
                if (zo && !zo.dataset.bound) {
                    zo.addEventListener('click', () => bumpTimelineZoom(-0.1));
                    zo.dataset.bound = '1';
                }
                if (zreset && !zreset.dataset.bound) {
                    zreset.addEventListener('click', () => setTimelineZoom(1));
                    zreset.dataset.bound = '1';
                }

                // Applique le zoom courant (et met à jour l’affichage %)
                applyTimelineZoom();
            } catch (e) {
                // ignore
            }
        }

        function getTimelineContainerForRender(id) {
            const outer = document.getElementById(id);
            if (!outer) return null;
            const inner = outer.querySelector(':scope > .timeline-inner');
            return inner || outer;
        }

function formatTimelineDuration(secs) {
            const mins = Math.round((secs || 0) / 60);
            if (!mins || mins <= 0) return '0m';

            const MINS_PER_HOUR = 60;
            const MINS_PER_DAY = 1440;
            const MINS_PER_WEEK = 10080;     // 7 * 1440
            const MINS_PER_MONTH = 43200;    // 30 * 1440 (convention)

            const fmt = (val) => Number.isInteger(val) ? String(val) : String(parseFloat(val.toFixed(1)));

            if (mins >= MINS_PER_MONTH) {
                const mo = mins / MINS_PER_MONTH;
                return `${fmt(mo)}mo`;
            }
            if (mins >= MINS_PER_WEEK) {
                const w = mins / MINS_PER_WEEK;
                return `${fmt(w)}sem`;
            }
            if (mins >= MINS_PER_DAY) {
                const d = mins / MINS_PER_DAY;
                return `${fmt(d)}j`;
            }
            if (mins >= MINS_PER_HOUR) {
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return m === 0 ? `${h}h` : `${h}h${m}`;
            }
            return `${mins}m`;
        }

        // --- Export helpers (cohérence / robustesse) ---
        function el(id) { return document.getElementById(id); }
        function val(id) { return el(id)?.value || ''; }
        function txt(id) { return el(id)?.innerText || ''; }
                function fmtTotalDuration(totalSecs, t) {
            const secs = Math.max(0, Number(totalSecs || 0));
            if (!secs) return `0 ${t.unit_mins}`;
            if (secs >= 604800) return `${(secs / 604800).toFixed(1)} ${t.unit_weeks}`;
            if (secs >= 86400) return `${(secs / 86400).toFixed(1)} ${t.unit_days}`;
            if (secs >= 3600) {
                const h = Math.floor(secs / 3600);
                const m = Math.round((secs % 3600) / 60);
                return `${h}h ${m}m`;
            }
            return `${Math.round(secs / 60)} ${t.unit_mins}`;
        }

        function escapeRtf(s) {
            // RTF-safe text with robust Unicode support (accents, non‑ASCII, etc.)
            // - Escapes control characters \, {, }
            // - Normalises newlines to \par
            // - Encodes any non-ASCII character using \uN? (Unicode escape with fallback)
            const str = String(s ?? '');
            let out = '';
            for (let i = 0; i < str.length; i++) {
                let ch = str[i];

                // Handle surrogate pairs (code points > U+FFFF)
                const code = str.codePointAt(i);
                if (code > 0xFFFF) {
                    i++; // advance extra for surrogate pair
                }

                if (ch === '\\' || ch === '{' || ch === '}') {
                    out += '\\' + ch;
                    continue;
                }
                if (ch === '\r') continue;
                if (ch === '\n') { out += '\\par '; continue; }

                if (code <= 0x7F) {
                    // ASCII
                    out += String.fromCharCode(code);
                } else {
                    // RTF \u expects a signed 16-bit integer
                    let signed = code;
                    if (signed > 0x7FFF) signed = signed - 0x10000;
                    out += `\\u${signed}?`;
                }
            }
            return out;
        }

        
        function getDefaultDurationUnitKey() {
            const sel = document.getElementById('param-learning-unit');
            return (sel && sel.value) ? sel.value : 'mins';
        }

        function getDefaultDurationUnitSecs() {
            const key = getDefaultDurationUnitKey();
            return mapUnitToSecs(key);
        }

        function mapUnitToSecs(unit) {
            // Accept seconds values ("60", 60), or parameter keys ("mins", "hours", ...)
            const v = (unit ?? '').toString().trim();
            if (v === '') return 60;
            if (!isNaN(parseFloat(v)) && isFinite(parseFloat(v))) return parseFloat(v);

            if (v === 'mins' || v === 'min' || v === 'minute' || v === 'minutes') return 60;
            if (v === 'hours' || v === 'hour' || v === 'h' || v === 'heures' || v === 'heure') return 3600;
            if (v === 'days' || v === 'day' || v === 'd' || v === 'jours' || v === 'jour') return 86400;
            if (v === 'weeks' || v === 'week' || v === 'w' || v === 'semaines' || v === 'semaine') return 604800;
            // If months was selected in Parameters, default to weeks for per-field units
            if (v === 'months' || v === 'month' || v === 'mois') return 604800;

            return 60;
        }

// Debounced wrapper for heavy timeline/canvas recomputation (used by input events)
let __updateStatsDebounceTimer = null;
function updateStatsDebounced() {
  if (__updateStatsDebounceTimer) clearTimeout(__updateStatsDebounceTimer);
  __updateStatsDebounceTimer = setTimeout(() => {
    __updateStatsDebounceTimer = null;
    updateStats();
  }, 300);
}

function updateStats() {
            const totals = getTotals();
            let display = `0 ${translations[currentLang].unit_mins}`;
            if (totals.totalSecs >= 604800) display = `${(totals.totalSecs / 604800).toFixed(1)} ${translations[currentLang].unit_weeks}`;
            else if (totals.totalSecs >= 86400) display = `${(totals.totalSecs / 86400).toFixed(1)} ${translations[currentLang].unit_days}`;
            else if (totals.totalSecs >= 3600) {
                const h = Math.floor(totals.totalSecs / 3600);
                const m = Math.round((totals.totalSecs % 3600) / 60);
                display = `${h}h ${m}m`;
            } else if (totals.totalSecs > 0) display = `${Math.round(totals.totalSecs / 60)} ${translations[currentLang].unit_mins}`;
            
            const totalDurationEl = document.getElementById('total-duration');
            if (totalDurationEl) totalDurationEl.innerText = display;

            // Updated logic for synced time units
            const learningUnitSelect = document.getElementById('param-learning-unit');
            const learningUnit = learningUnitSelect.value;
            const learningUnitText = learningUnitSelect.options[learningUnitSelect.selectedIndex].text;
            
            // Sync UI text display
            document.getElementById('param-designed-unit-display').innerText = learningUnitText;
            
            // Update Header Target Time
            const targetVal = document.getElementById('param-learning-val').value || 0;
            const headerTargetTimeEl = document.getElementById('header-target-time');
            if (headerTargetTimeEl) headerTargetTimeEl.innerText = `${targetVal} ${learningUnitText}`;

            const designedInput = document.getElementById('param-designed-val');
            let divisor = 60;
            if (learningUnit === 'hours') divisor = 3600;
            if (learningUnit === 'days') divisor = 86400;
            if (learningUnit === 'weeks') divisor = 604800;
            if (learningUnit === 'months') divisor = 2592000; // 30 days
            
            let designedVal = totals.totalSecs / divisor;
            if (learningUnit === 'mins') designedVal = Math.round(designedVal);
            else designedVal = parseFloat(designedVal.toFixed(1)); 
            
            designedInput.value = designedVal;
            // Update designed time per moment (sum of contained activities), expressed in the moment unit
            document.querySelectorAll('.moment-group').forEach(momentEl => {
                let secs = 0;
                momentEl.querySelectorAll('.step-card').forEach(stepEl => {
                    const v = parseFloat(stepEl.querySelector('.duration-input')?.value) || 0;
                    const u = parseFloat(stepEl.querySelector('.duration-unit')?.value) || 60;
                    secs += v * u;
                });

                const unitSel = momentEl.querySelector('.moment-target-unit');
                const unitSecs = parseFloat(unitSel?.value) || getDefaultDurationUnitSecs();
                const unitText = unitSel?.options?.[unitSel.selectedIndex]?.text || translations[currentLang].unit_mins;

                const label = momentEl.querySelector('.moment-total-time');
                if (label) {
                    let v = secs / unitSecs;
                    // minutes: integer; others: 1 decimal
                    if (unitSecs === 60) v = Math.round(v);
                    else v = parseFloat(v.toFixed(1));
                    label.innerText = `${v} ${unitText}`;
                }
            });

            // DOM Elements for the two timelines
            const containerActivitiesPlanned = getTimelineContainerForRender('timeline-activities-planned');
            const labelsActivitiesPlanned = getTimelineContainerForRender('timeline-activities-planned-labels');
            const containerActivities = getTimelineContainerForRender('timeline-activities');
            const labelsActivities = getTimelineContainerForRender('timeline-activities-labels');
            const containerSteps = getTimelineContainerForRender('timeline-steps');
            const containerGrouping = getTimelineContainerForRender('timeline-grouping');
            const containerTrainer = getTimelineContainerForRender('timeline-trainer');
            const containerPlace = getTimelineContainerForRender('timeline-place');
            const containerTime = getTimelineContainerForRender('timeline-time');
            const containerRuler = getTimelineContainerForRender('timeline-ruler');
            
            // Clear all
            if (containerActivitiesPlanned) containerActivitiesPlanned.innerHTML = '';
            if (labelsActivitiesPlanned) labelsActivitiesPlanned.innerHTML = '';
            containerActivities.innerHTML = '';
            labelsActivities.innerHTML = '';
            containerSteps.innerHTML = '';
            containerGrouping.innerHTML = '';
            containerTrainer.innerHTML = '';
            containerPlace.innerHTML = '';
            containerTime.innerHTML = '';
            containerRuler.innerHTML = '';

            // Compute planned structure (target durations) per module
            const activityGroups = document.querySelectorAll('.activity-group');
            const plannedTimeline = [];
            let plannedTotalSecs = 0;

            activityGroups.forEach((act, idx) => {
                const title = act.querySelector('.activity-title')?.value || `${translations[currentLang].md_untitled_activity} ${idx + 1}`;
                const targetValRaw = parseFloat(act.querySelector('.activity-target-time')?.value);
                const targetVal = Math.max(0, isNaN(targetValRaw) ? 0 : targetValRaw);
                const targetUnitSecs = parseFloat(act.querySelector('.activity-target-unit')?.value) || 60;
                const targetSecs = targetVal * targetUnitSecs;

                const designedSecs = (totals.detailedTimeline[idx] && totals.detailedTimeline[idx].duration) ? totals.detailedTimeline[idx].duration : 0;

                // If target not set, fall back to designed duration so the planned track remains interpretable.
                const secs = targetSecs > 0 ? targetSecs : designedSecs;
                const isEstimated = targetSecs <= 0 && designedSecs > 0;

                plannedTimeline.push({ title, secs, targetSecs, isEstimated });
                plannedTotalSecs += secs;
            });

            const baseTotalSecs = Math.max(totals.totalSecs, plannedTotalSecs);

            if (baseTotalSecs > 0) {
                
                // --- TRACK 0: PLANNED STRUCTURE (TARGET DURATIONS) ---
                if (containerActivitiesPlanned && labelsActivitiesPlanned) {
                    plannedTimeline.forEach((activity, index) => {
                        if (activity.secs > 0) {
                            const actWidthPct = (activity.secs / baseTotalSecs) * 100;
                            const actEl = document.createElement('div');

                            const bgClass = index % 2 === 0 ? 'bg-slate-200' : 'bg-slate-300';
                            const patternClass = activity.isEstimated ? 'pattern-dots' : 'pattern-grid-dark';

                            actEl.className = `h-full border-r border-white last:border-0 relative group box-border ${bgClass} ${patternClass} hover:bg-slate-400 transition-colors flex items-center justify-center cursor-pointer`;
                            actEl.style.width = `${actWidthPct}%`;

                            const durationMins = Math.round(activity.secs / 60);

                            let tooltipText;
                            if (activity.targetSecs > 0) {
                                tooltipText = `<strong>${escapeHtml(activity.title)}</strong><br><span class="text-slate-300">${durationMins} ${translations[currentLang].unit_mins}</span>`;
                            } else if (activity.isEstimated) {
                                tooltipText = `<strong>${escapeHtml(activity.title)}</strong><br><span class="text-slate-300">${durationMins} ${translations[currentLang].unit_mins}</span><br><span class="opacity-80">${'Cible non renseignée'}</span>`;
                            } else {
                                tooltipText = `<strong>${escapeHtml(activity.title)}</strong><br><span class="opacity-80">${'Durée cible à définir'}</span>`;
                            }

                            actEl.onmouseenter = (e) => showTooltip(e, tooltipText, true);
                            actEl.onmousemove = (e) => updateTooltipPos(e);
                            actEl.onmouseleave = () => hideTooltip();
                        actEl.onclick = () => scrollToEditor(index);

                            let durationStr = `${durationMins}m`;
                            if (durationMins >= 60) {
                                const h = Math.floor(durationMins / 60);
                                const m = durationMins % 60;
                                durationStr = m === 0 ? `${h}h` : `${h}h${m}`;
                            }

                            const innerLabel = document.createElement('div');
                            innerLabel.className = 'timeline-duration-label text-[10px] font-bold text-slate-700 pointer-events-none select-none truncate px-1 opacity-90 group-hover:opacity-100 transition-opacity';
                            innerLabel.innerText = formatTimelineDuration(activity.secs);
                            if (actWidthPct > 4) {
                                actEl.appendChild(innerLabel);
                            }

                            containerActivitiesPlanned.appendChild(actEl);

                            const labelEl = document.createElement('div');
                            labelEl.style.width = `${actWidthPct}%`;
                            labelEl.className = 'px-1 truncate text-center border-r border-transparent last:border-0';

                            if (actWidthPct > 5) {
                                labelEl.innerText = `${escapeHtml(activity.title)}`;
                                labelEl.title = activity.title;
                            } else {
                                labelEl.innerText = '.';
                                labelEl.classList.add('text-transparent');
                            }
                            labelsActivitiesPlanned.appendChild(labelEl);
                        }
                    });
                }

                // --- TRACK 1: ACTIVITIES / MODULES (ALIGNED TO PLANNED) ---
                if (containerActivities && labelsActivities) {
                    plannedTimeline.forEach((planned, index) => {
                        const plannedSecs = planned && planned.secs ? planned.secs : 0;
                        const designedSecs = (totals.detailedTimeline[index] && totals.detailedTimeline[index].duration) ? totals.detailedTimeline[index].duration : 0;

                        if (plannedSecs <= 0 && designedSecs <= 0) return;

                        // Width is based on planned segment to ensure alignment with Track 0
                        const segmentSecsForWidth = plannedSecs > 0 ? plannedSecs : designedSecs;
                        const actWidthPct = (segmentSecsForWidth / baseTotalSecs) * 100;

                        // Fill ratio (designed within planned)
                        const ratio = plannedSecs > 0 ? Math.min(1, Math.max(0, designedSecs / plannedSecs)) : 1;

                        const actEl = document.createElement('div');

                        // Alternating colours (Slate) for the designed fill only
                        const bgClass = index % 2 === 0 ? 'bg-slate-400' : 'bg-slate-500';

                        actEl.className = 'h-full border-r border-white last:border-0 relative group box-border flex items-center justify-center cursor-pointer';
                        actEl.style.width = `${actWidthPct}%`;

                        // Missing part (only when a target is set and designed < planned)
                        const missingEl = document.createElement('div');
                        missingEl.className = 'absolute inset-0 timeline-missing-light';
                        if (!(plannedSecs > 0 && designedSecs < plannedSecs)) {
                            missingEl.style.display = 'none';
                        }

                        // Designed fill aligned to the left
                        const fillEl = document.createElement('div');
                        fillEl.className = `absolute left-0 top-0 bottom-0 ${bgClass} hover:bg-indigo-500 transition-colors`;
                        fillEl.style.width = `${ratio * 100}%`;

                        // Overrun alert (designed > planned)
                        const overEl = document.createElement('div');
                        overEl.className = 'absolute inset-0 timeline-alert-light pointer-events-none';
                        if (!(plannedSecs > 0 && designedSecs > plannedSecs)) {
                            overEl.style.display = 'none';
                        }

const tooltipText = `<strong>${escapeHtml(planned.title)}</strong><br><span class="text-slate-300">${formatTimelineDuration(designedSecs)}</span>`;
                        actEl.onmouseenter = (e) => showTooltip(e, tooltipText, true);
                        actEl.onmousemove = (e) => updateTooltipPos(e);
                        actEl.onmouseleave = () => hideTooltip();
                        actEl.onclick = () => scrollToEditor(index);

                        const innerLabel = document.createElement('div');
                        innerLabel.className = 'timeline-duration-label text-[10px] font-bold text-white pointer-events-none select-none truncate px-1 opacity-90 group-hover:opacity-100 transition-opacity relative z-10';
                        innerLabel.innerText = formatTimelineDuration(designedSecs);

                        actEl.appendChild(missingEl);
                        actEl.appendChild(fillEl);
                        actEl.appendChild(overEl);

                        if (actWidthPct > 4) {
                            actEl.appendChild(innerLabel);
                        }

                        containerActivities.appendChild(actEl);

                        const labelEl = document.createElement('div');
                        labelEl.style.width = `${actWidthPct}%`;
                        labelEl.className = 'px-1 truncate text-center border-r border-transparent last:border-0';

                        if (actWidthPct > 5) {
                            labelEl.innerText = `${escapeHtml(planned.title)}`;
                            labelEl.title = planned.title;
                        } else {
                            labelEl.innerText = '.';
                            labelEl.classList.add('text-transparent');
                        }
                        labelsActivities.appendChild(labelEl);
                    });
                }

// --- TRACK 2: LEARNING TYPES (STEPS) ---
                // Group segments by planned module so Track 2 aligns with Tracks 0/1.
                // Also show the same "Trop court / Trop long" alerts when designed duration diverges from planned.
                const t = translations[currentLang];

                // Standard Grey Colours
                const greySolid = '#64748b';   // Slate-500
                const greyStriped = '#94a3b8'; // Slate-400

                const makeModuleWrapper = (widthPct) => {
                    const wrap = document.createElement('div');
                    wrap.className = 'h-full border-r border-white last:border-0 relative group box-border overflow-visible';
                    wrap.style.width = `${widthPct}%`;
                    return wrap;
                };

                const makeFillContainer = (ratio) => {
                    const fill = document.createElement('div');
                    fill.className = 'absolute left-0 top-0 bottom-0 flex';
                    fill.style.width = `${Math.max(0, Math.min(1, ratio)) * 100}%`;
                    return fill;
                };

                // Helper to create simple blocks with patterns (for Regroupement / Formateur / Lieu / Temps).
                const createBlock = (widthPct, bgColor, patternClass, tooltip, onClick) => {
                    const el = document.createElement('div');
                    el.style.width = `${widthPct}%`;
                    el.style.backgroundColor = bgColor;
                    el.className = `h-full border-r border-white/20 last:border-0 hover:brightness-90 transition-all relative group cursor-pointer ${patternClass}`;
                    el.onmouseenter = (e) => showTooltip(e, tooltip, true);
                    el.onmousemove = (e) => updateTooltipPos(e);
                    el.onmouseleave = () => hideTooltip();
                    if (typeof onClick === 'function') el.onclick = onClick;
                    return el;
                };

                plannedTimeline.forEach((planned, index) => {
                    const plannedSecs = planned && planned.secs ? planned.secs : 0;
                    const activity = totals.detailedTimeline[index];
                    const designedSecs = (activity && activity.duration) ? activity.duration : 0;

                    if (plannedSecs <= 0 && designedSecs <= 0) return;

                    // Width is based on planned segment to ensure alignment with Track 0/1
                    const segmentSecsForWidth = plannedSecs > 0 ? plannedSecs : designedSecs;
                    const moduleWidthPct = (segmentSecsForWidth / baseTotalSecs) * 100;

                    // Fill ratio (designed within planned) – capped to 100% (overrun is shown via overlay)
                    const ratio = plannedSecs > 0 ? Math.min(1, Math.max(0, designedSecs / plannedSecs)) : 1;

                    // Module wrappers for each detail track
                    const stepsWrap = makeModuleWrapper(moduleWidthPct);
                    const groupingWrap = makeModuleWrapper(moduleWidthPct);
                    const trainerWrap = makeModuleWrapper(moduleWidthPct);
                    const placeWrap = makeModuleWrapper(moduleWidthPct);
                    const timeWrap = makeModuleWrapper(moduleWidthPct);

                    // Alerts on Track 2 (Learning types) – same behaviour as Track 1
                    const missingEl = document.createElement('div');
                    missingEl.className = 'absolute inset-0 timeline-missing-light';
                    if (!(plannedSecs > 0 && designedSecs < plannedSecs)) {
                        missingEl.style.display = 'none';
                    }

                    const overEl = document.createElement('div');
                    overEl.className = 'absolute inset-0 timeline-alert-light pointer-events-none';
                    if (!(plannedSecs > 0 && designedSecs > plannedSecs)) {
                        overEl.style.display = 'none';
                    }

                    const iconsEl = document.createElement('div');
                    iconsEl.className = 'timeline-alert-icons';
                    if (plannedSecs > 0 && designedSecs !== plannedSecs) {
                        iconsEl.innerText = (designedSecs < plannedSecs) ? 'Trop court !' : 'Trop long !';
                    } else {
                        iconsEl.style.display = 'none';
                    }

                    const tooltipTextModule = `<strong>${escapeHtml(planned.title)}</strong><br><span class="text-slate-300">${formatTimelineDuration(designedSecs)}</span>`;
                    stepsWrap.onmouseenter = (e) => showTooltip(e, tooltipTextModule, true);
                    stepsWrap.onmousemove = (e) => updateTooltipPos(e);
                    stepsWrap.onmouseleave = () => hideTooltip();

                    stepsWrap.appendChild(missingEl);
                    stepsWrap.appendChild(overEl);
                    stepsWrap.appendChild(iconsEl);

                    // Fill containers (only the designed portion is filled with step-level segments)
                    const stepsFill = makeFillContainer(ratio);
                    const groupingFill = makeFillContainer(ratio);
                    const trainerFill = makeFillContainer(ratio);
                    const placeFill = makeFillContainer(ratio);
                    const timeFill = makeFillContainer(ratio);

                    // When there is no designed time, we still append empty wrappers to preserve alignment.
                    if (activity && Array.isArray(activity.steps) && activity.steps.length && designedSecs > 0) {
                        activity.steps.forEach((step, stepIdx) => {
                            if (!(step && step.duration > 0)) return;
                            const stepPctWithinDesigned = (step.duration / designedSecs) * 100;

                            // Track 2 – Learning types (coloured by pedagogical type)
                            const stepEl = document.createElement('div');
                            stepEl.style.backgroundColor = TYPE_COLORS[step.type];
                            stepEl.style.width = `${stepPctWithinDesigned}%`;
                            stepEl.className = 'h-full border-r border-white/20 last:border-0 hover:brightness-90 transition-all relative group cursor-pointer';

                            const sDur = Math.round(step.duration / 60);
                            const tooltipText = `<strong>${escapeHtml(step.title)}</strong><br><span class="text-slate-300">${escapeHtml(step.learningTypeLabel)}</span><br><span class="text-slate-300">${sDur}m</span>`;
                            stepEl.onmouseenter = (e) => showTooltip(e, tooltipText, true);
                            stepEl.onmousemove = (e) => updateTooltipPos(e);
                            stepEl.onmouseleave = () => hideTooltip();
                            stepsFill.appendChild(stepEl);

                            // Grouping (Stripes for Groups)
                            const grpColor = step.groupMode === 'class' ? greySolid : greyStriped;
                            const grpPattern = step.groupMode === 'groups' ? 'pattern-stripes' : '';
                            const grpLabel = step.groupMode === 'groups' ? t.opt_groups : (step.groupMode === 'individual' ? t.opt_individual : t.opt_whole_class);
                            groupingFill.appendChild(createBlock(stepPctWithinDesigned, grpColor, grpPattern, `<strong>${grpLabel}</strong><br><span class="text-slate-300">${sDur}m</span>`, () => scrollToEditor(index, stepIdx)));

                            // Trainer (Stripes for Absent)
                            const trainerColor = step.trainer === 'present' ? greySolid : greyStriped;
                            const trainerPattern = step.trainer === 'absent' ? 'pattern-stripes' : '';
                            const trainerLabel = step.trainer === 'present' ? t.opt_present : t.opt_absent;
                            trainerFill.appendChild(createBlock(stepPctWithinDesigned, trainerColor, trainerPattern, `<strong>${trainerLabel}</strong><br><span class="text-slate-300">${sDur}m</span>`, () => scrollToEditor(index, stepIdx)));

                            // Place (Stripes for Online / Hybrid)
                            const placeLabel = (step.place === 'situ') ? t.opt_insitu : (step.place === 'online') ? t.opt_online : t.opt_hybrid;
                            const placeColor = (step.place === 'situ') ? greySolid : greyStriped;
                            const placePattern = (step.place === 'situ') ? '' : 'pattern-stripes';
                            placeFill.appendChild(createBlock(stepPctWithinDesigned, placeColor, placePattern, `<strong>${placeLabel}</strong><br><span class="text-slate-300">${sDur}m</span>`, () => scrollToEditor(index, stepIdx)));

                            // Time (Stripes for Asynchronous)
                            const timeLabel = (step.time === 'sync') ? t.opt_sync : t.opt_async;
                            const timeColor = (step.time === 'sync') ? greySolid : greyStriped;
                            const timePattern = (step.time === 'sync') ? '' : 'pattern-stripes';
                            timeFill.appendChild(createBlock(stepPctWithinDesigned, timeColor, timePattern, `<strong>${timeLabel}</strong><br><span class="text-slate-300">${sDur}m</span>`, () => scrollToEditor(index, stepIdx)));
                        });
                    }

                    stepsWrap.appendChild(stepsFill);
                    groupingWrap.appendChild(groupingFill);
                    trainerWrap.appendChild(trainerFill);
                    placeWrap.appendChild(placeFill);
                    timeWrap.appendChild(timeFill);

                    containerSteps.appendChild(stepsWrap);
                    containerGrouping.appendChild(groupingWrap);
                    containerTrainer.appendChild(trainerWrap);
                    containerPlace.appendChild(placeWrap);
                    containerTime.appendChild(timeWrap);
                });

                // --- RULER ---
                const totalMins = baseTotalSecs / 60;
                let interval = 0;
                const roughStep = totalMins / 8;
                const magnitudes = [1, 5, 10, 15, 30, 60, 120, 240, 480, 720, 1440, 2880, 10080];
                interval = magnitudes.reduce((prev, curr) => Math.abs(curr - roughStep) < Math.abs(prev - roughStep) ? curr : prev);
                if (totalMins / interval > 15) interval *= 2;

                for (let t = 0; t <= totalMins; t += interval) {
                    const leftPct = (t / totalMins) * 100;
                    if (leftPct > 100.1) break; 
                    const tick = document.createElement('div');
                    tick.className = 'timeline-ruler-tick absolute w-px bg-slate-300';
                    tick.style.left = `${leftPct}%`;
                    containerRuler.appendChild(tick);
                    
                    const label = document.createElement('div');
                    label.className = 'timeline-ruler-label absolute text-slate-500 font-mono transform -translate-x-1/2 whitespace-nowrap';
                    label.style.left = `${leftPct}%`;
                    
                    let text = '';
                    if (t === 0) text = '0';
                    else {
                        if (interval >= 1440) {
                             const days = t / 1440;
                             text = `${Number.isInteger(days) ? days : days.toFixed(1)}${'j'}`;
                        } else if (interval >= 60) {
                            const h = Math.floor(t/60);
                            const m = t % 60;
                            text = m === 0 ? `${h}h` : `${h}h${m}`;
                        } else {
                            text = `${t}m`;
                        }
                    }
                    
                    if (leftPct > 95) { label.classList.remove('-translate-x-1/2'); label.classList.add('-translate-x-full'); }
                    else if (leftPct < 5) { label.classList.remove('-translate-x-1/2'); }
                    
                    label.innerText = text;
                    containerRuler.appendChild(label);
                }
            }

            // Update Individual Activity Timeline Bars
            totals.detailedTimeline.forEach((actData, index) => {
                if (index < activityGroups.length) {
                    const group = activityGroups[index];
                    const bar = group.querySelector('.activity-type-bar');
                    const label = group.querySelector('.activity-total-time');
	                    const designedBadge = group.querySelector('.activity-designed-badge');
	                    const targetVal = group.querySelector('.activity-target-time');
	                    const targetUnitSel = group.querySelector('.activity-target-unit');
	                    const compareEl = group.querySelector('.module-time-compare');
                    
                    if (bar && label) {
                        bar.innerHTML = '';
                        // Update label
                        const mins = Math.round(actData.duration / 60);
                        let durationText = `${mins}m`;
                        if (mins >= 60) {
                             const h = Math.floor(mins / 60);
                             const m = mins % 60;
                             durationText = m === 0 ? `${h}h` : `${h}h${m}`;
                        }
	                        label.innerText = durationText;

	                        // Module designed duration alert: if target is set and differs, tint the designed badge
	                        if (designedBadge) {
	                          designedBadge.classList.remove('duration-alert-light');
	                          const tv = targetVal ? parseFloat(targetVal.value) : 0;
	                          const tu = targetUnitSel ? parseInt(targetUnitSel.value, 10) : 60;
	                          const targetSecs = (isNaN(tv) ? 0 : tv) * (isNaN(tu) ? 60 : tu);
	                          if (targetSecs > 0 && Math.round(actData.duration) !== Math.round(targetSecs)) {
	                            designedBadge.classList.add('duration-alert-light');
	                          }
	                          // Comparison symbol between target and designed at module level
	                          if (compareEl) {
	                            if (targetSecs > 0) {
	                              const a = Math.round(targetSecs);
	                              const b = Math.round(actData.duration);
	                              const sym = (a === b) ? '=' : (a < b ? '<' : '>');
				      compareEl.textContent = sym;
				      compareEl.classList.toggle('text-red-600', sym === '<' || sym === '>');
				    } else {
				      compareEl.textContent = '';
				      compareEl.classList.remove('text-red-600');
				    }
	                          }
	                        }

                        // Update bar
                        if (actData.duration > 0) {
                            actData.steps.forEach(step => {
                                if (step.duration > 0) {
                                    const pct = (step.duration / actData.duration) * 100;
                                    const el = document.createElement('div');
                                    el.style.width = `${pct}%`;
                                    el.style.backgroundColor = TYPE_COLORS[step.type];
                                    el.className = 'h-full hover:brightness-90 transition-all border-r border-white/20 last:border-0';
                                    el.title = `${escapeHtml(step.title)}: ${Math.round(step.duration/60)}m (${escapeHtml(step.learningTypeLabel)})`;
                                    bar.appendChild(el);
                                }
                            });
                        }
                    }
                }
            });
            updateFocusButtons();
        }
        
        function handleExport(select) {
            const value = select.value;
            select.value = ""; // Reset dropdown
            
            if (value === 'markdown') {
                exportMarkdown();
            } else if (value === 'pdf') {
                window.print();
            } else if (value === 'richtext') {
                exportRichText();
            } else if (value === 'rtf') {
                exportRTF();
            } else if (value === 'csv') {
                exportCSV();
            }
        }
        


        function exportCSV() {
            // CSV export: modules, moments and activities (activity cards) only.
            // Includes module/moment descriptions and all activity dropdowns + text fields (objectif/tâches/notes).
            const t = translations[currentLang] || translations.fr;

            const lines = [];
            const header = [
                'Module #',
                'Module titre',
                'Module description',
                'Module durée cible',
                'Moment #',
                'Moment titre',
                'Moment description',
                'Moment durée cible',
                'Activité #',
                'Activité titre',
                'Objectif',
                'Tâches',
                'Notes',
                "Type d'apprentissage",
                'Regroupement',
                'Taille groupe',
                'Détails regroupement',
                'Lieu',
                'Temps',
                'Présence formateur',
                'Durée (min)'
            ];
            lines.push(header);

            const esc = (v) => {
                const s = (v === null || v === undefined) ? '' : String(v);
                const needs = /[",\n\r]/.test(s);
                const q = s.replace(/"/g, '""');
                return needs ? `"${q}"` : q;
            };

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = unitEl?.selectedOptions?.[0]?.innerText || '';
                if (!v) return '';
                return `${v} ${u}`.trim();
            };

            const getSelectedText = (selectEl) => {
                const opt = selectEl && selectEl.selectedOptions ? selectEl.selectedOptions[0] : null;
                return opt ? (opt.innerText || opt.textContent || '').trim() : '';
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = getSelectedText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return { txt, sizeVal, detailsVal };
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            let moduleIdx = 0;
            document.querySelectorAll('.activity-group').forEach((moduleEl) => {
                moduleIdx += 1;
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim();
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                const moments = moduleEl.querySelectorAll('.moment-group');
                if (moments && moments.length) {
                    let momentIdx = 0;
                    moments.forEach((momentEl) => {
                        momentIdx += 1;
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                        const steps = momentEl.querySelectorAll('.step-card');
                        let activityIdx = 0;

                        if (steps && steps.length) {
                            steps.forEach((stepEl) => {
                                activityIdx += 1;
                                const stepTitle = (stepEl.querySelector('.step-input-title')?.value || '').trim();
                                const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                                const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                                const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                                const typeTxt = getSelectedText(stepEl.querySelector('.learning-type-select'));
                                const placeTxt = getSelectedText(stepEl.querySelector('.place-select'));
                                const timeTxt = getSelectedText(stepEl.querySelector('.time-select'));
                                const trainerTxt = getSelectedText(stepEl.querySelector('.trainer-select'));

                                const grouping = getGroupingText(stepEl);
                                const mins = getStepMinutes(stepEl);

                                lines.push([
                                    moduleIdx,
                                    moduleTitle,
                                    moduleDesc,
                                    moduleTarget,
                                    momentIdx,
                                    momentTitle,
                                    momentDesc,
                                    momentTarget,
                                    activityIdx,
                                    stepTitle,
                                    objective,
                                    tasks,
                                    notes,
                                    typeTxt,
                                    grouping.txt,
                                    grouping.sizeVal,
                                    grouping.detailsVal,
                                    placeTxt,
                                    timeTxt,
                                    trainerTxt,
                                    mins
                                ]);
                            });
                        } else {
                            // moment with no activities
                            lines.push([
                                moduleIdx, moduleTitle, moduleDesc, moduleTarget,
                                momentIdx, momentTitle, momentDesc, momentTarget,
                                '', '', '', '', '', '', '', '', '', '', '', '', ''
                            ]);
                        }
                    });
                } else {
                    // module with no moments
                    lines.push([moduleIdx, moduleTitle, moduleDesc, moduleTarget, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                }
            });

            const csv = lines.map((row) => row.map(esc).join(',')).join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `learning-design_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        }



        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        const groupModeEl = step.querySelector('.step-group-mode');
                        const groupModeVal = groupModeEl ? groupModeEl.value : '';
                        const groupModeTxt = groupModeEl && groupModeEl.selectedOptions[0] ? (groupModeEl.selectedOptions[0].innerText || '').trim() : '';
                        const groupSizeVal = (step.querySelector('.step-group-size')?.value || '').toString().trim();
                        const groupDetailsVal = (step.querySelector('.step-group-details')?.value || '').toString().trim();
                        let groupInfo = groupModeTxt;
                        if (groupModeVal === 'groups' && groupSizeVal) groupInfo = `${groupModeTxt} (${groupSizeVal})`;
                        if (groupDetailsVal) groupInfo = groupInfo ? `${groupInfo} — ${groupDetailsVal}` : groupDetailsVal;
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `

<!-- Modèles : Export -->


</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            // CSV export: modules, moments and activities (activity cards) only.
            // Includes module/moment descriptions and all activity dropdowns + text fields (objectif/tâches/notes).
            const t = translations[currentLang] || translations.fr;

            const lines = [];
            const header = [
                'Module #',
                'Module titre',
                'Module description',
                'Module durée cible',
                'Moment #',
                'Moment titre',
                'Moment description',
                'Moment durée cible',
                'Activité #',
                'Activité titre',
                'Objectif',
                'Tâches',
                'Notes',
                "Type d'apprentissage",
                'Regroupement',
                'Taille groupe',
                'Détails regroupement',
                'Lieu',
                'Temps',
                'Présence formateur',
                'Durée (min)'
            ];
            lines.push(header);

            const esc = (v) => {
                const s = (v === null || v === undefined) ? '' : String(v);
                const needs = /[",\n\r]/.test(s);
                const q = s.replace(/"/g, '""');
                return needs ? `"${q}"` : q;
            };

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = unitEl?.selectedOptions?.[0]?.innerText || '';
                if (!v) return '';
                return `${v} ${u}`.trim();
            };

            const getSelectedText = (selectEl) => {
                const opt = selectEl && selectEl.selectedOptions ? selectEl.selectedOptions[0] : null;
                return opt ? (opt.innerText || opt.textContent || '').trim() : '';
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = getSelectedText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return { txt, sizeVal, detailsVal };
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            let moduleIdx = 0;
            document.querySelectorAll('.activity-group').forEach((moduleEl) => {
                moduleIdx += 1;
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim();
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                const moments = moduleEl.querySelectorAll('.moment-group');
                if (moments && moments.length) {
                    let momentIdx = 0;
                    moments.forEach((momentEl) => {
                        momentIdx += 1;
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                        const steps = momentEl.querySelectorAll('.step-card');
                        let activityIdx = 0;

                        if (steps && steps.length) {
                            steps.forEach((stepEl) => {
                                activityIdx += 1;
                                const stepTitle = (stepEl.querySelector('.step-input-title')?.value || '').trim();
                                const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                                const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                                const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                                const typeTxt = getSelectedText(stepEl.querySelector('.learning-type-select'));
                                const placeTxt = getSelectedText(stepEl.querySelector('.place-select'));
                                const timeTxt = getSelectedText(stepEl.querySelector('.time-select'));
                                const trainerTxt = getSelectedText(stepEl.querySelector('.trainer-select'));

                                const grouping = getGroupingText(stepEl);
                                const mins = getStepMinutes(stepEl);

                                lines.push([
                                    moduleIdx,
                                    moduleTitle,
                                    moduleDesc,
                                    moduleTarget,
                                    momentIdx,
                                    momentTitle,
                                    momentDesc,
                                    momentTarget,
                                    activityIdx,
                                    stepTitle,
                                    objective,
                                    tasks,
                                    notes,
                                    typeTxt,
                                    grouping.txt,
                                    grouping.sizeVal,
                                    grouping.detailsVal,
                                    placeTxt,
                                    timeTxt,
                                    trainerTxt,
                                    mins
                                ]);
                            });
                        } else {
                            // moment with no activities
                            lines.push([
                                moduleIdx, moduleTitle, moduleDesc, moduleTarget,
                                momentIdx, momentTitle, momentDesc, momentTarget,
                                '', '', '', '', '', '', '', '', '', '', '', '', ''
                            ]);
                        }
                    });
                } else {
                    // module with no moments
                    lines.push([moduleIdx, moduleTitle, moduleDesc, moduleTarget, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                }
            });

            const csv = lines.map((row) => row.map(esc).join(',')).join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `learning-design_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        }



        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        const groupModeEl = step.querySelector('.step-group-mode');
                        const groupModeVal = groupModeEl ? groupModeEl.value : '';
                        const groupModeTxt = groupModeEl && groupModeEl.selectedOptions[0] ? (groupModeEl.selectedOptions[0].innerText || '').trim() : '';
                        const groupSizeVal = (step.querySelector('.step-group-size')?.value || '').toString().trim();
                        const groupDetailsVal = (step.querySelector('.step-group-details')?.value || '').toString().trim();
                        let groupInfo = groupModeTxt;
                        if (groupModeVal === 'groups' && groupSizeVal) groupInfo = `${groupModeTxt} (${groupSizeVal})`;
                        if (groupDetailsVal) groupInfo = groupInfo ? `${groupInfo} — ${groupDetailsVal}` : groupDetailsVal;
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRTF() {
            const t = translations[currentLang] || translations.fr;
            const totals = getTotals();

            const selText = (el) => (el && el.selectedOptions && el.selectedOptions[0]) ? (el.selectedOptions[0].innerText || '').trim() : '';
            const esc = (s) => escapeRTF((s || '').toString());

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = selText(unitEl);
                return v ? `${v} ${u}`.trim() : '';
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = selText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return txt;
            };

            let rtf = '{\\rtf1\\ansi\\deff0\n';
            rtf += `{\\b ${esc(t.md_title || 'Plan de formation')}}\\par\n\\par\n`;

            rtf += `{\\b ${esc(t.md_metadata || 'Métadonnées')}}\\par\n`;
            rtf += `${esc(t.label_course_name || 'Nom de la formation')}: ${esc(document.getElementById('param-name')?.value || '')}\\par\n`;
            rtf += `${esc(t.label_authors || 'Auteurs')}: ${esc(document.getElementById('param-authors')?.value || '')}\\par\n`;
            rtf += `${esc(t.label_mode || 'Modalité')}: ${esc(selText(document.getElementById('param-mode')))}\\par\n`;
            rtf += `${esc(t.label_level || 'Niveau')}: ${esc(selText(document.getElementById('param-level')))}\\par\n`;
            rtf += `${esc(t.label_class_size || 'Taille du groupe')}: ${esc(document.getElementById('global-class-size')?.value || '')}\\par\n`;
            rtf += `${esc(t.label_total_time || 'Temps total')}: ${esc(fmtTotalDuration(totals.totalSecs, t))}\\par\n`;
            rtf += `${esc(t.label_learning_time || "Temps d'apprentissage (cible)")}: ${esc(fmtTarget(document.getElementById('param-learning-time'), document.getElementById('param-learning-unit')))}\\par\n`;
            rtf += `${esc(t.label_designed_time || 'Temps conçu (planifié)')}: ${esc(fmtTarget(document.getElementById('param-designed-time'), document.getElementById('param-designed-unit')))}\\par\n`;
            rtf += `Horodatage d'export: ${esc(new Date().toISOString())}\\par\n\\par\n`;

            rtf += `{\\b ${esc(t.md_key_info || 'Informations clés')}}\\par\n`;
            rtf += `{\\b ${esc(t.label_objectives || 'Objectifs')}}\\par\n${esc(document.getElementById('param-aims')?.value || '')}\\par\n\\par\n`;
            rtf += `{\\b ${esc(t.label_outcomes_text || "Résultats d'apprentissage")}}\\par\n${esc(document.getElementById('param-outcomes-text')?.value || '')}\\par\n\\par\n`;

            rtf += `{\\b ${esc(t.label_outcomes || "Résultats d'apprentissage (Bloom)")}}\\par\n`;
            document.querySelectorAll('#outcomes-list li').forEach((li) => {
                const level = (li.querySelector('select')?.value || '').trim();
                const txt = (li.querySelector('input')?.value || '').trim();
                if (txt) rtf += `- ${esc(level)} ${esc(txt)}\\par\n`;
            });
            rtf += '\\par\n';

            rtf += `{\\b ${esc(t.label_description || 'Description générale')}}\\par\n${esc(document.getElementById('param-description')?.value || '')}\\par\n\\par\n`;
            rtf += `{\\b ${esc(t.label_target_audience || 'Public cible')}}\\par\n${esc(document.getElementById('param-audience')?.value || '')}\\par\n\\par\n`;
            rtf += `{\\b ${esc(t.label_prerequisites || 'Prérequis')}}\\par\n${esc(document.getElementById('param-prereq')?.value || '')}\\par\n\\par\n`;

            rtf += `{\\b ${esc(t.md_structure || 'Structure pédagogique')}}\\par\n\\par\n`;

            document.querySelectorAll('.activity-group').forEach((moduleEl, mi) => {
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim() || `Module ${mi+1}`;
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                rtf += `{\\b Module ${mi+1}: ${esc(moduleTitle)}}\\par\n`;
                if (moduleTarget) rtf += `Durée cible: ${esc(moduleTarget)}\\par\n`;
                if (moduleDesc) rtf += `Description: ${esc(moduleDesc)}\\par\n`;
                rtf += '\\par\n';

                moduleEl.querySelectorAll('.moment-group').forEach((momentEl, mo) => {
                    const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim() || `Moment ${mo+1}`;
                    const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                    const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                    rtf += `{\\b Moment ${mi+1}.${mo+1}: ${esc(momentTitle)}}\\par\n`;
                    if (momentTarget) rtf += `Durée cible: ${esc(momentTarget)}\\par\n`;
                    if (momentDesc) rtf += `Description: ${esc(momentDesc)}\\par\n`;
                    rtf += '\\par\n';

                    const steps = momentEl.querySelectorAll('.step-card');
                    if (!steps || steps.length === 0) {
                        rtf += `(Aucune activité)\\par\n\\par\n`;
                        return;
                    }

                    steps.forEach((stepEl, si) => {
                        const title = (stepEl.querySelector('.step-input-title')?.value || '').trim() || `Activité ${si+1}`;
                        const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                        const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                        const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                        const typeTxt = selText(stepEl.querySelector('.learning-type-select'));
                        const groupingTxt = getGroupingText(stepEl);
                        const placeTxt = selText(stepEl.querySelector('.place-select'));
                        const timeTxt = selText(stepEl.querySelector('.time-select'));
                        const trainerTxt = selText(stepEl.querySelector('.trainer-select'));
                        const mins = getStepMinutes(stepEl);

                        rtf += `{\\b Activité ${mi+1}.${mo+1}.${si+1}: ${esc(title)}}\\par\n`;
                        rtf += `Durée: ${esc(mins)} min\\par\n`;
                        rtf += `Type d'apprentissage: ${esc(typeTxt)}\\par\n`;
                        rtf += `Regroupement: ${esc(groupingTxt)}\\par\n`;
                        rtf += `Lieu: ${esc(placeTxt)}\\par\n`;
                        rtf += `Temps: ${esc(timeTxt)}\\par\n`;
                        rtf += `Présence formateur: ${esc(trainerTxt)}\\par\n\\par\n`;
                        rtf += `{\\b Objectif:}\\par\n${esc(objective)}\\par\n\\par\n`;
                        rtf += `{\\b Tâches:}\\par\n${esc(tasks)}\\par\n\\par\n`;
                        rtf += `{\\b Notes:}\\par\n${esc(notes)}\\par\n\\par\n`;
                    });
                });
            });

            rtf += '}';
            downloadText(rtf, 'application/rtf;charset=utf-8', `learning-design_${new Date().toISOString().slice(0,10)}.rtf`);
        }

function exportCSV() {
            // CSV export: modules, moments and activities (activity cards) only.
            // Includes module/moment descriptions and all activity dropdowns + text fields (objectif/tâches/notes).
            const t = translations[currentLang] || translations.fr;

            const lines = [];
            const header = [
                'Module #',
                'Module titre',
                'Module description',
                'Module durée cible',
                'Moment #',
                'Moment titre',
                'Moment description',
                'Moment durée cible',
                'Activité #',
                'Activité titre',
                'Objectif',
                'Tâches',
                'Notes',
                "Type d'apprentissage",
                'Regroupement',
                'Taille groupe',
                'Détails regroupement',
                'Lieu',
                'Temps',
                'Présence formateur',
                'Durée (min)'
            ];
            lines.push(header);

            const esc = (v) => {
                const s = (v === null || v === undefined) ? '' : String(v);
                const needs = /[",\n\r]/.test(s);
                const q = s.replace(/"/g, '""');
                return needs ? `"${q}"` : q;
            };

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = unitEl?.selectedOptions?.[0]?.innerText || '';
                if (!v) return '';
                return `${v} ${u}`.trim();
            };

            const getSelectedText = (selectEl) => {
                const opt = selectEl && selectEl.selectedOptions ? selectEl.selectedOptions[0] : null;
                return opt ? (opt.innerText || opt.textContent || '').trim() : '';
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = getSelectedText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return { txt, sizeVal, detailsVal };
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            let moduleIdx = 0;
            document.querySelectorAll('.activity-group').forEach((moduleEl) => {
                moduleIdx += 1;
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim();
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                const moments = moduleEl.querySelectorAll('.moment-group');
                if (moments && moments.length) {
                    let momentIdx = 0;
                    moments.forEach((momentEl) => {
                        momentIdx += 1;
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                        const steps = momentEl.querySelectorAll('.step-card');
                        let activityIdx = 0;

                        if (steps && steps.length) {
                            steps.forEach((stepEl) => {
                                activityIdx += 1;
                                const stepTitle = (stepEl.querySelector('.step-input-title')?.value || '').trim();
                                const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                                const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                                const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                                const typeTxt = getSelectedText(stepEl.querySelector('.learning-type-select'));
                                const placeTxt = getSelectedText(stepEl.querySelector('.place-select'));
                                const timeTxt = getSelectedText(stepEl.querySelector('.time-select'));
                                const trainerTxt = getSelectedText(stepEl.querySelector('.trainer-select'));

                                const grouping = getGroupingText(stepEl);
                                const mins = getStepMinutes(stepEl);

                                lines.push([
                                    moduleIdx,
                                    moduleTitle,
                                    moduleDesc,
                                    moduleTarget,
                                    momentIdx,
                                    momentTitle,
                                    momentDesc,
                                    momentTarget,
                                    activityIdx,
                                    stepTitle,
                                    objective,
                                    tasks,
                                    notes,
                                    typeTxt,
                                    grouping.txt,
                                    grouping.sizeVal,
                                    grouping.detailsVal,
                                    placeTxt,
                                    timeTxt,
                                    trainerTxt,
                                    mins
                                ]);
                            });
                        } else {
                            // moment with no activities
                            lines.push([
                                moduleIdx, moduleTitle, moduleDesc, moduleTarget,
                                momentIdx, momentTitle, momentDesc, momentTarget,
                                '', '', '', '', '', '', '', '', '', '', '', '', ''
                            ]);
                        }
                    });
                } else {
                    // module with no moments
                    lines.push([moduleIdx, moduleTitle, moduleDesc, moduleTarget, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                }
            });

            const csv = lines.map((row) => row.map(esc).join(',')).join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `learning-design_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        }



        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        const groupModeEl = step.querySelector('.step-group-mode');
                        const groupModeVal = groupModeEl ? groupModeEl.value : '';
                        const groupModeTxt = groupModeEl && groupModeEl.selectedOptions[0] ? (groupModeEl.selectedOptions[0].innerText || '').trim() : '';
                        const groupSizeVal = (step.querySelector('.step-group-size')?.value || '').toString().trim();
                        const groupDetailsVal = (step.querySelector('.step-group-details')?.value || '').toString().trim();
                        let groupInfo = groupModeTxt;
                        if (groupModeVal === 'groups' && groupSizeVal) groupInfo = `${groupModeTxt} (${groupSizeVal})`;
                        if (groupDetailsVal) groupInfo = groupInfo ? `${groupInfo} — ${groupDetailsVal}` : groupDetailsVal;
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            // CSV export: modules, moments and activities (activity cards) only.
            // Includes module/moment descriptions and all activity dropdowns + text fields (objectif/tâches/notes).
            const t = translations[currentLang] || translations.fr;

            const lines = [];
            const header = [
                'Module #',
                'Module titre',
                'Module description',
                'Module durée cible',
                'Moment #',
                'Moment titre',
                'Moment description',
                'Moment durée cible',
                'Activité #',
                'Activité titre',
                'Objectif',
                'Tâches',
                'Notes',
                "Type d'apprentissage",
                'Regroupement',
                'Taille groupe',
                'Détails regroupement',
                'Lieu',
                'Temps',
                'Présence formateur',
                'Durée (min)'
            ];
            lines.push(header);

            const esc = (v) => {
                const s = (v === null || v === undefined) ? '' : String(v);
                const needs = /[",\n\r]/.test(s);
                const q = s.replace(/"/g, '""');
                return needs ? `"${q}"` : q;
            };

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = unitEl?.selectedOptions?.[0]?.innerText || '';
                if (!v) return '';
                return `${v} ${u}`.trim();
            };

            const getSelectedText = (selectEl) => {
                const opt = selectEl && selectEl.selectedOptions ? selectEl.selectedOptions[0] : null;
                return opt ? (opt.innerText || opt.textContent || '').trim() : '';
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = getSelectedText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return { txt, sizeVal, detailsVal };
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            let moduleIdx = 0;
            document.querySelectorAll('.activity-group').forEach((moduleEl) => {
                moduleIdx += 1;
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim();
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                const moments = moduleEl.querySelectorAll('.moment-group');
                if (moments && moments.length) {
                    let momentIdx = 0;
                    moments.forEach((momentEl) => {
                        momentIdx += 1;
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                        const steps = momentEl.querySelectorAll('.step-card');
                        let activityIdx = 0;

                        if (steps && steps.length) {
                            steps.forEach((stepEl) => {
                                activityIdx += 1;
                                const stepTitle = (stepEl.querySelector('.step-input-title')?.value || '').trim();
                                const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                                const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                                const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                                const typeTxt = getSelectedText(stepEl.querySelector('.learning-type-select'));
                                const placeTxt = getSelectedText(stepEl.querySelector('.place-select'));
                                const timeTxt = getSelectedText(stepEl.querySelector('.time-select'));
                                const trainerTxt = getSelectedText(stepEl.querySelector('.trainer-select'));

                                const grouping = getGroupingText(stepEl);
                                const mins = getStepMinutes(stepEl);

                                lines.push([
                                    moduleIdx,
                                    moduleTitle,
                                    moduleDesc,
                                    moduleTarget,
                                    momentIdx,
                                    momentTitle,
                                    momentDesc,
                                    momentTarget,
                                    activityIdx,
                                    stepTitle,
                                    objective,
                                    tasks,
                                    notes,
                                    typeTxt,
                                    grouping.txt,
                                    grouping.sizeVal,
                                    grouping.detailsVal,
                                    placeTxt,
                                    timeTxt,
                                    trainerTxt,
                                    mins
                                ]);
                            });
                        } else {
                            // moment with no activities
                            lines.push([
                                moduleIdx, moduleTitle, moduleDesc, moduleTarget,
                                momentIdx, momentTitle, momentDesc, momentTarget,
                                '', '', '', '', '', '', '', '', '', '', '', '', ''
                            ]);
                        }
                    });
                } else {
                    // module with no moments
                    lines.push([moduleIdx, moduleTitle, moduleDesc, moduleTarget, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                }
            });

            const csv = lines.map((row) => row.map(esc).join(',')).join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `learning-design_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        }



        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        const groupModeEl = step.querySelector('.step-group-mode');
                        const groupModeVal = groupModeEl ? groupModeEl.value : '';
                        const groupModeTxt = groupModeEl && groupModeEl.selectedOptions[0] ? (groupModeEl.selectedOptions[0].innerText || '').trim() : '';
                        const groupSizeVal = (step.querySelector('.step-group-size')?.value || '').toString().trim();
                        const groupDetailsVal = (step.querySelector('.step-group-details')?.value || '').toString().trim();
                        let groupInfo = groupModeTxt;
                        if (groupModeVal === 'groups' && groupSizeVal) groupInfo = `${groupModeTxt} (${groupSizeVal})`;
                        if (groupDetailsVal) groupInfo = groupInfo ? `${groupInfo} — ${groupDetailsVal}` : groupDetailsVal;
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRTF() {
            const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);

            const courseName = (document.getElementById('param-name')?.value || '').trim();

            function readDurationSecs(card) {
                const val = parseFloat(card.querySelector('.duration-input')?.value || '0');
                const unit = card.querySelector('.duration-unit')?.value || 'min';
                return toSeconds(val, unit);
            }

            let rtf = '{\\rtf1\\ansi\\deff0' +
                '{\\fonttbl{\\f0 Segoe UI;}{\\f1 Arial;}}' +
                '\\fs28\\b ' + escapeRtf(t.rtf_title) + '\\b0\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Métadonnées') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_course_name) + ':\\b0 ' + escapeRtf(courseName) + '\\par' +
                '\\b ' + escapeRtf(t.label_authors) + ':\\b0 ' + escapeRtf(document.getElementById('param-authors')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_mode) + ':\\b0 ' + escapeRtf(document.getElementById('param-mode')?.selectedOptions[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_level) + ':\\b0 ' + escapeRtf(document.getElementById('param-level')?.selectedOptions[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_class_size) + ':\\b0 ' + escapeRtf(document.getElementById('global-class-size')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_total_time) + ':\\b0 ' + escapeRtf(totalDuration) + '\\par' +
                '\\b ' + escapeRtf(t.label_learning_time) + ':\\b0 ' + escapeRtf((document.getElementById('param-learning-val')?.value || '') + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions[0]?.innerText || '')) + '\\par' +
                '\\b ' + escapeRtf(t.label_designed_time) + ':\\b0 ' + escapeRtf((document.getElementById('param-designed-val')?.value || '') + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions[0]?.innerText || '')) + '\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Informations clés') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_description) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-description')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_target_audience) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-target-audience')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_prerequisites) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-prerequisites')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_aims) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-aims')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes_text) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-outcomes-text')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes) + ':\\b0\\par ';

            document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text')?.innerText || '';
                const level = li.querySelector('.outcome-bloom-level')?.value || '';
                const sub = li.querySelector('.outcome-bloom-sub')?.value || '';
                let bloomPrefix = '';
                if (level) {
                    bloomPrefix = '[' + (t[`bloom_${level}`] || level.toUpperCase());
                    if (sub) bloomPrefix += ' - ' + (t[`bloom_sub_${sub}`] || sub);
                    bloomPrefix += '] ';
                }
                rtf += '\\bullet ' + escapeRtf(bloomPrefix + text) + '\\par ';
            });

            rtf += '\\par\\fs24\\b ' + escapeRtf('Structure pédagogique') + '\\b0\\par\\fs20 ';

            const moduleCards = document.querySelectorAll('#modules-container .module-card');
            moduleCards.forEach((moduleCard, mIdx) => {
                const mTitle = moduleCard.querySelector('.module-title')?.value || `Module ${mIdx+1}`;
                rtf += '\\par\\b ' + escapeRtf(`MODULE ${mIdx+1} — `) + escapeRtf(mTitle) + '\\b0\\par ';

                const actCards = moduleCard.querySelectorAll('.activity-card');
                actCards.forEach((actCard, aIdx) => {
                    const aTitle = actCard.querySelector('.activity-title')?.value || `Activité ${aIdx+1}`;
                    const aDesc = actCard.querySelector('.activity-description')?.value || '';
                    const aTgtVal = actCard.querySelector('.activity-target-time')?.value || '';
                    const aTgtUnit = actCard.querySelector('.activity-target-unit')?.selectedOptions[0]?.innerText || '';

                    rtf += '\\par\\b ' + escapeRtf(`  Activité ${mIdx+1}.${aIdx+1} — `) + escapeRtf(aTitle) + '\\b0\\par ';
                    if (aDesc.trim()) rtf += escapeRtf('  ' + aDesc) + '\\par ';
                    if (String(aTgtVal).trim()) rtf += escapeRtf(`  Durée cible : ${aTgtVal} ${aTgtUnit}`) + '\\par ';

                    const moments = actCard.querySelectorAll('.moment-card');
                    moments.forEach((momentCard, moIdx) => {
                        const moTitle = momentCard.querySelector('.moment-title')?.value || `Moment ${moIdx+1}`;
                        const moTgtVal = momentCard.querySelector('.moment-target-time')?.value || '';
                        const moTgtUnit = momentCard.querySelector('.moment-target-unit')?.selectedOptions[0]?.innerText || '';
                        const stepCards = momentCard.querySelectorAll('.step-card');
                        const momentSecs = sumDurationCardsToSecs(stepCards);

                        rtf += '\\par\\b ' + escapeRtf(`    Moment ${mIdx+1}.${aIdx+1}.${moIdx+1} — `) + escapeRtf(moTitle) + '\\b0\\par ';
                        rtf += escapeRtf(`    Durée conçue : ${formatTimelineDuration(momentSecs)}`) + '\\par ';
                        if (String(moTgtVal).trim()) rtf += escapeRtf(`    Durée cible : ${moTgtVal} ${moTgtUnit}`) + '\\par ';

                        stepCards.forEach((stepCard, sIdx) => {
                            const sTitle = stepCard.querySelector('.step-input-title')?.value || `Étape ${sIdx+1}`;
                            const sObjective = stepCard.querySelector('.step-input-objective')?.value || '';
                            const sTasks = stepCard.querySelector('.step-input-tasks')?.value || '';
                            const sNotes = stepCard.querySelector('.step-input-notes')?.value || '';
                            const sSecs = readDurationSecs(stepCard);

                            const lt = stepCard.querySelector('.learning-type-select')?.selectedOptions[0]?.innerText || '';
                            const grpMode = stepCard.querySelector('.step-group-mode')?.selectedOptions[0]?.innerText || '';
                            const place = stepCard.querySelector('.place-select')?.selectedOptions[0]?.innerText || '';
                            const time = stepCard.querySelector('.time-select')?.selectedOptions[0]?.innerText || '';
                            const trainer = stepCard.querySelector('.trainer-select')?.selectedOptions[0]?.innerText || '';

                            rtf += '\\par\\b ' + escapeRtf(`      Étape ${mIdx+1}.${aIdx+1}.${moIdx+1}.${sIdx+1} — `) + escapeRtf(sTitle) + '\\b0\\par ';
                            rtf += escapeRtf(`      Durée conçue : ${formatTimelineDuration(sSecs)}`) + '\\par ';
                            if (lt) rtf += escapeRtf(`      Type d'apprentissage : ${lt}`) + '\\par ';
                            if (grpMode) rtf += escapeRtf(`      Regroupement : ${grpMode}`) + '\\par ';
                            if (place) rtf += escapeRtf(`      Lieu : ${place}`) + '\\par ';
                            if (time) rtf += escapeRtf(`      Temps : ${time}`) + '\\par ';
                            if (trainer) rtf += escapeRtf(`      Présence formateur : ${trainer}`) + '\\par ';

                            if (sObjective.trim()) rtf += escapeRtf('      Objectif : ' + sObjective) + '\\par ';
                            if (sTasks.trim()) rtf += escapeRtf('      Tâches : ' + sTasks) + '\\par ';
                            if (sNotes.trim()) rtf += escapeRtf('      Notes : ' + sNotes) + '\\par ';
                        });
                    });
                });
            });

            rtf += '}';

            const blob = new Blob([rtf], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.rtf';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        let groupInfo = groupMode === 'groups' ? `${t.md_format_groups} ${step.querySelector('.step-group-size').value}` : (groupMode === 'individual' ? t.md_format_individual : t.md_format_whole);
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRTF() {
            const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);

            const courseName = (document.getElementById('param-name')?.value || '').trim();

            function readDurationSecs(card) {
                const val = parseFloat(card.querySelector('.duration-input')?.value || '0');
                const unit = card.querySelector('.duration-unit')?.value || 'min';
                return toSeconds(val, unit);
            }

            let rtf = '{\\rtf1\\ansi\\deff0' +
                '{\\fonttbl{\\f0 Segoe UI;}{\\f1 Arial;}}' +
                '\\fs28\\b ' + escapeRtf(t.rtf_title) + '\\b0\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Métadonnées') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_course_name) + ':\\b0 ' + escapeRtf(courseName) + '\\par' +
                '\\b ' + escapeRtf(t.label_authors) + ':\\b0 ' + escapeRtf(document.getElementById('param-authors')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_mode) + ':\\b0 ' + escapeRtf(document.getElementById('param-mode')?.selectedOptions[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_level) + ':\\b0 ' + escapeRtf(document.getElementById('param-level')?.selectedOptions[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_class_size) + ':\\b0 ' + escapeRtf(document.getElementById('global-class-size')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_total_time) + ':\\b0 ' + escapeRtf(totalDuration) + '\\par' +
                '\\b ' + escapeRtf(t.label_learning_time) + ':\\b0 ' + escapeRtf((document.getElementById('param-learning-val')?.value || '') + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions[0]?.innerText || '')) + '\\par' +
                '\\b ' + escapeRtf(t.label_designed_time) + ':\\b0 ' + escapeRtf((document.getElementById('param-designed-val')?.value || '') + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions[0]?.innerText || '')) + '\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Informations clés') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_description) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-description')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_target_audience) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-target-audience')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_prerequisites) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-prerequisites')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_aims) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-aims')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes_text) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-outcomes-text')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes) + ':\\b0\\par ';

            document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text')?.innerText || '';
                const level = li.querySelector('.outcome-bloom-level')?.value || '';
                const sub = li.querySelector('.outcome-bloom-sub')?.value || '';
                let bloomPrefix = '';
                if (level) {
                    bloomPrefix = '[' + (t[`bloom_${level}`] || level.toUpperCase());
                    if (sub) bloomPrefix += ' - ' + (t[`bloom_sub_${sub}`] || sub);
                    bloomPrefix += '] ';
                }
                rtf += '\\bullet ' + escapeRtf(bloomPrefix + text) + '\\par ';
            });

            rtf += '\\par\\fs24\\b ' + escapeRtf('Structure pédagogique') + '\\b0\\par\\fs20 ';

            const moduleCards = document.querySelectorAll('#modules-container .module-card');
            moduleCards.forEach((moduleCard, mIdx) => {
                const mTitle = moduleCard.querySelector('.module-title')?.value || `Module ${mIdx+1}`;
                rtf += '\\par\\b ' + escapeRtf(`MODULE ${mIdx+1} — `) + escapeRtf(mTitle) + '\\b0\\par ';

                const actCards = moduleCard.querySelectorAll('.activity-card');
                actCards.forEach((actCard, aIdx) => {
                    const aTitle = actCard.querySelector('.activity-title')?.value || `Activité ${aIdx+1}`;
                    const aDesc = actCard.querySelector('.activity-description')?.value || '';
                    const aTgtVal = actCard.querySelector('.activity-target-time')?.value || '';
                    const aTgtUnit = actCard.querySelector('.activity-target-unit')?.selectedOptions[0]?.innerText || '';

                    rtf += '\\par\\b ' + escapeRtf(`  Activité ${mIdx+1}.${aIdx+1} — `) + escapeRtf(aTitle) + '\\b0\\par ';
                    if (aDesc.trim()) rtf += escapeRtf('  ' + aDesc) + '\\par ';
                    if (String(aTgtVal).trim()) rtf += escapeRtf(`  Durée cible : ${aTgtVal} ${aTgtUnit}`) + '\\par ';

                    const moments = actCard.querySelectorAll('.moment-card');
                    moments.forEach((momentCard, moIdx) => {
                        const moTitle = momentCard.querySelector('.moment-title')?.value || `Moment ${moIdx+1}`;
                        const moTgtVal = momentCard.querySelector('.moment-target-time')?.value || '';
                        const moTgtUnit = momentCard.querySelector('.moment-target-unit')?.selectedOptions[0]?.innerText || '';
                        const stepCards = momentCard.querySelectorAll('.step-card');
                        const momentSecs = sumDurationCardsToSecs(stepCards);

                        rtf += '\\par\\b ' + escapeRtf(`    Moment ${mIdx+1}.${aIdx+1}.${moIdx+1} — `) + escapeRtf(moTitle) + '\\b0\\par ';
                        rtf += escapeRtf(`    Durée conçue : ${formatTimelineDuration(momentSecs)}`) + '\\par ';
                        if (String(moTgtVal).trim()) rtf += escapeRtf(`    Durée cible : ${moTgtVal} ${moTgtUnit}`) + '\\par ';

                        stepCards.forEach((stepCard, sIdx) => {
                            const sTitle = stepCard.querySelector('.step-input-title')?.value || `Étape ${sIdx+1}`;
                            const sObjective = stepCard.querySelector('.step-input-objective')?.value || '';
                            const sTasks = stepCard.querySelector('.step-input-tasks')?.value || '';
                            const sNotes = stepCard.querySelector('.step-input-notes')?.value || '';
                            const sSecs = readDurationSecs(stepCard);

                            const lt = stepCard.querySelector('.learning-type-select')?.selectedOptions[0]?.innerText || '';
                            const grpMode = stepCard.querySelector('.step-group-mode')?.selectedOptions[0]?.innerText || '';
                            const place = stepCard.querySelector('.place-select')?.selectedOptions[0]?.innerText || '';
                            const time = stepCard.querySelector('.time-select')?.selectedOptions[0]?.innerText || '';
                            const trainer = stepCard.querySelector('.trainer-select')?.selectedOptions[0]?.innerText || '';

                            rtf += '\\par\\b ' + escapeRtf(`      Étape ${mIdx+1}.${aIdx+1}.${moIdx+1}.${sIdx+1} — `) + escapeRtf(sTitle) + '\\b0\\par ';
                            rtf += escapeRtf(`      Durée conçue : ${formatTimelineDuration(sSecs)}`) + '\\par ';
                            if (lt) rtf += escapeRtf(`      Type d'apprentissage : ${lt}`) + '\\par ';
                            if (grpMode) rtf += escapeRtf(`      Regroupement : ${grpMode}`) + '\\par ';
                            if (place) rtf += escapeRtf(`      Lieu : ${place}`) + '\\par ';
                            if (time) rtf += escapeRtf(`      Temps : ${time}`) + '\\par ';
                            if (trainer) rtf += escapeRtf(`      Présence formateur : ${trainer}`) + '\\par ';

                            if (sObjective.trim()) rtf += escapeRtf('      Objectif : ' + sObjective) + '\\par ';
                            if (sTasks.trim()) rtf += escapeRtf('      Tâches : ' + sTasks) + '\\par ';
                            if (sNotes.trim()) rtf += escapeRtf('      Notes : ' + sNotes) + '\\par ';
                        });
                    });
                });
            });

            rtf += '}';

            const blob = new Blob([rtf], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.rtf';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMarkdown() {
            const t = translations[currentLang] || translations.fr;
            const totals = getTotals();

            const selText = (el) => (el && el.selectedOptions && el.selectedOptions[0]) ? (el.selectedOptions[0].innerText || '').trim() : '';
            const val = (id) => (document.getElementById(id)?.value || '').toString().trim();

            const fmtTarget = (timeIdOrEl, unitIdOrEl) => {
                const timeEl = typeof timeIdOrEl === 'string' ? document.getElementById(timeIdOrEl) : timeIdOrEl;
                const unitEl = typeof unitIdOrEl === 'string' ? document.getElementById(unitIdOrEl) : unitIdOrEl;
                const v = (timeEl?.value || '').toString().trim();
                const u = selText(unitEl);
                return v ? `${v} ${u}`.trim() : '';
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = selText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return txt;
            };

            let md = `# ${t.md_title || 'Plan de formation'}\n\n`;

            md += `## ${t.md_metadata || 'Métadonnées'}\n`;
            md += `- **${t.label_course_name || 'Nom de la formation'} :** ${val('param-name')}\n`;
            md += `- **${t.label_authors || 'Auteurs'} :** ${val('param-authors')}\n`;
            md += `- **${t.label_mode || 'Modalité'} :** ${selText(document.getElementById('param-mode'))}\n`;
            md += `- **${t.label_level || 'Niveau'} :** ${selText(document.getElementById('param-level'))}\n`;
            md += `- **${t.label_class_size || 'Taille du groupe'} :** ${val('global-class-size')}\n`;
            md += `- **${t.label_total_time || 'Temps total'} :** ${fmtTotalDuration(totals.totalSecs, t)}\n`;
            md += `- **${t.label_learning_time || "Temps d'apprentissage (cible)"} :** ${fmtTarget('param-learning-time','param-learning-unit')}\n`;
            md += `- **${t.label_designed_time || 'Temps conçu (planifié)'} :** ${fmtTarget('param-designed-time','param-designed-unit')}\n`;
            md += `- **Horodatage d'export :** ${new Date().toISOString()}\n\n`;

            md += `## ${t.md_key_info || 'Informations clés'}\n\n`;
            md += `### ${t.label_objectives || 'Objectifs'}\n${val('param-aims')}\n\n`;
            md += `### ${t.label_outcomes_text || "Résultats d'apprentissage"}\n${val('param-outcomes-text')}\n\n`;

            // Bloom outcomes (list)
            md += `### ${t.label_outcomes || "Résultats d'apprentissage (Bloom)"}\n`;
            document.querySelectorAll('#outcomes-list li').forEach((li) => {
                const level = (li.querySelector('select')?.value || '').trim();
                const txt = (li.querySelector('input')?.value || '').trim();
                if (txt) md += `- **${level}** ${txt}\n`;
            });
            md += `\n`;

            md += `### ${t.label_description || 'Description générale'}\n${val('param-description')}\n\n`;
            md += `### ${t.label_target_audience || 'Public cible'}\n${val('param-audience')}\n\n`;
            md += `### ${t.label_prerequisites || 'Prérequis'}\n${val('param-prereq')}\n\n`;

            md += `## ${t.md_structure || 'Structure pédagogique'}\n\n`;

            document.querySelectorAll('.activity-group').forEach((moduleEl, mi) => {
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim() || `Module ${mi+1}`;
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                md += `### Module ${mi+1} — ${moduleTitle}\n`;
                if (moduleTarget) md += `- **Durée cible :** ${moduleTarget}\n`;
                if (moduleDesc) md += `- **Description :** ${moduleDesc}\n`;
                md += `\n`;

                moduleEl.querySelectorAll('.moment-group').forEach((momentEl, mo) => {
                    const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim() || `Moment ${mo+1}`;
                    const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                    const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                    md += `#### Moment ${mi+1}.${mo+1} — ${momentTitle}\n`;
                    if (momentTarget) md += `- **Durée cible :** ${momentTarget}\n`;
                    if (momentDesc) md += `- **Description :** ${momentDesc}\n`;
                    md += `\n`;

                    const steps = momentEl.querySelectorAll('.step-card');
                    if (!steps || steps.length === 0) {
                        md += `*(Aucune activité)*\n\n`;
                        return;
                    }

                    steps.forEach((stepEl, si) => {
                        const title = (stepEl.querySelector('.step-input-title')?.value || '').trim() || `Activité ${si+1}`;
                        const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                        const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                        const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                        const typeTxt = selText(stepEl.querySelector('.learning-type-select'));
                        const groupingTxt = getGroupingText(stepEl);
                        const placeTxt = selText(stepEl.querySelector('.place-select'));
                        const timeTxt = selText(stepEl.querySelector('.time-select'));
                        const trainerTxt = selText(stepEl.querySelector('.trainer-select'));
                        const mins = getStepMinutes(stepEl);

                        md += `##### Activité ${mi+1}.${mo+1}.${si+1} — ${title}\n`;
                        md += `- **Durée :** ${mins} min\n`;
                        md += `- **Type d'apprentissage :** ${typeTxt}\n`;
                        md += `- **Regroupement :** ${groupingTxt}\n`;
                        md += `- **Lieu :** ${placeTxt}\n`;
                        md += `- **Temps :** ${timeTxt}\n`;
                        md += `- **Présence formateur :** ${trainerTxt}\n`;
                        md += `\n`;
                        md += `**Objectif :**\n${objective || ''}\n\n`;
                        md += `**Tâches :**\n${tasks || ''}\n\n`;
                        md += `**Notes :**\n${notes || ''}\n\n`;
                    });
                });
            });

            downloadText(md, 'text/markdown;charset=utf-8', `learning-design_${new Date().toISOString().slice(0,10)}.md`);
        }

function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        const groupModeEl = step.querySelector('.step-group-mode');
                        const groupModeVal = groupModeEl ? groupModeEl.value : '';
                        const groupModeTxt = groupModeEl && groupModeEl.selectedOptions[0] ? (groupModeEl.selectedOptions[0].innerText || '').trim() : '';
                        const groupSizeVal = (step.querySelector('.step-group-size')?.value || '').toString().trim();
                        const groupDetailsVal = (step.querySelector('.step-group-details')?.value || '').toString().trim();
                        let groupInfo = groupModeTxt;
                        if (groupModeVal === 'groups' && groupSizeVal) groupInfo = `${groupModeTxt} (${groupSizeVal})`;
                        if (groupDetailsVal) groupInfo = groupInfo ? `${groupInfo} — ${groupDetailsVal}` : groupDetailsVal;
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            // CSV export: modules, moments and activities (activity cards) only.
            // Includes module/moment descriptions and all activity dropdowns + text fields (objectif/tâches/notes).
            const t = translations[currentLang] || translations.fr;

            const lines = [];
            const header = [
                'Module #',
                'Module titre',
                'Module description',
                'Module durée cible',
                'Moment #',
                'Moment titre',
                'Moment description',
                'Moment durée cible',
                'Activité #',
                'Activité titre',
                'Objectif',
                'Tâches',
                'Notes',
                "Type d'apprentissage",
                'Regroupement',
                'Taille groupe',
                'Détails regroupement',
                'Lieu',
                'Temps',
                'Présence formateur',
                'Durée (min)'
            ];
            lines.push(header);

            const esc = (v) => {
                const s = (v === null || v === undefined) ? '' : String(v);
                const needs = /[",\n\r]/.test(s);
                const q = s.replace(/"/g, '""');
                return needs ? `"${q}"` : q;
            };

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = unitEl?.selectedOptions?.[0]?.innerText || '';
                if (!v) return '';
                return `${v} ${u}`.trim();
            };

            const getSelectedText = (selectEl) => {
                const opt = selectEl && selectEl.selectedOptions ? selectEl.selectedOptions[0] : null;
                return opt ? (opt.innerText || opt.textContent || '').trim() : '';
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeTxt = getSelectedText(modeEl);
                const modeVal = modeEl ? modeEl.value : '';
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();
                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return { txt, sizeVal, detailsVal };
            };

            const getStepMinutes = (stepEl) => {
                const v = parseFloat(stepEl.querySelector('.duration-input')?.value || 0);
                const unitSecs = parseFloat(stepEl.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unitSecs) ? unitSecs : 60);
                return Math.round((secs / 60) * 100) / 100;
            };

            let moduleIdx = 0;
            document.querySelectorAll('.activity-group').forEach((moduleEl) => {
                moduleIdx += 1;
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim();
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                const moments = moduleEl.querySelectorAll('.moment-group');
                if (moments && moments.length) {
                    let momentIdx = 0;
                    moments.forEach((momentEl) => {
                        momentIdx += 1;
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                        const steps = momentEl.querySelectorAll('.step-card');
                        let activityIdx = 0;

                        if (steps && steps.length) {
                            steps.forEach((stepEl) => {
                                activityIdx += 1;
                                const stepTitle = (stepEl.querySelector('.step-input-title')?.value || '').trim();
                                const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                                const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                                const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                                const typeTxt = getSelectedText(stepEl.querySelector('.learning-type-select'));
                                const placeTxt = getSelectedText(stepEl.querySelector('.place-select'));
                                const timeTxt = getSelectedText(stepEl.querySelector('.time-select'));
                                const trainerTxt = getSelectedText(stepEl.querySelector('.trainer-select'));

                                const grouping = getGroupingText(stepEl);
                                const mins = getStepMinutes(stepEl);

                                lines.push([
                                    moduleIdx,
                                    moduleTitle,
                                    moduleDesc,
                                    moduleTarget,
                                    momentIdx,
                                    momentTitle,
                                    momentDesc,
                                    momentTarget,
                                    activityIdx,
                                    stepTitle,
                                    objective,
                                    tasks,
                                    notes,
                                    typeTxt,
                                    grouping.txt,
                                    grouping.sizeVal,
                                    grouping.detailsVal,
                                    placeTxt,
                                    timeTxt,
                                    trainerTxt,
                                    mins
                                ]);
                            });
                        } else {
                            // moment with no activities
                            lines.push([
                                moduleIdx, moduleTitle, moduleDesc, moduleTarget,
                                momentIdx, momentTitle, momentDesc, momentTarget,
                                '', '', '', '', '', '', '', '', '', '', '', '', ''
                            ]);
                        }
                    });
                } else {
                    // module with no moments
                    lines.push([moduleIdx, moduleTitle, moduleDesc, moduleTarget, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                }
            });

            const csv = lines.map((row) => row.map(esc).join(',')).join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `learning-design_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        }



        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        const groupModeEl = step.querySelector('.step-group-mode');
                        const groupModeVal = groupModeEl ? groupModeEl.value : '';
                        const groupModeTxt = groupModeEl && groupModeEl.selectedOptions[0] ? (groupModeEl.selectedOptions[0].innerText || '').trim() : '';
                        const groupSizeVal = (step.querySelector('.step-group-size')?.value || '').toString().trim();
                        const groupDetailsVal = (step.querySelector('.step-group-details')?.value || '').toString().trim();
                        let groupInfo = groupModeTxt;
                        if (groupModeVal === 'groups' && groupSizeVal) groupInfo = `${groupModeTxt} (${groupSizeVal})`;
                        if (groupDetailsVal) groupInfo = groupInfo ? `${groupInfo} — ${groupDetailsVal}` : groupDetailsVal;
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRTF() {
            const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);

            const courseName = (document.getElementById('param-name')?.value || '').trim();

            function readDurationSecs(card) {
                const val = parseFloat(card.querySelector('.duration-input')?.value || '0');
                const unit = card.querySelector('.duration-unit')?.value || 'min';
                return toSeconds(val, unit);
            }

            let rtf = '{\\rtf1\\ansi\\deff0' +
                '{\\fonttbl{\\f0 Segoe UI;}{\\f1 Arial;}}' +
                '\\fs28\\b ' + escapeRtf(t.rtf_title) + '\\b0\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Métadonnées') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_course_name) + ':\\b0 ' + escapeRtf(courseName) + '\\par' +
                '\\b ' + escapeRtf(t.label_authors) + ':\\b0 ' + escapeRtf(document.getElementById('param-authors')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_mode) + ':\\b0 ' + escapeRtf(document.getElementById('param-mode')?.selectedOptions[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_level) + ':\\b0 ' + escapeRtf(document.getElementById('param-level')?.selectedOptions[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_class_size) + ':\\b0 ' + escapeRtf(document.getElementById('global-class-size')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_total_time) + ':\\b0 ' + escapeRtf(totalDuration) + '\\par' +
                '\\b ' + escapeRtf(t.label_learning_time) + ':\\b0 ' + escapeRtf((document.getElementById('param-learning-val')?.value || '') + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions[0]?.innerText || '')) + '\\par' +
                '\\b ' + escapeRtf(t.label_designed_time) + ':\\b0 ' + escapeRtf((document.getElementById('param-designed-val')?.value || '') + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions[0]?.innerText || '')) + '\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Informations clés') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_description) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-description')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_target_audience) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-target-audience')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_prerequisites) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-prerequisites')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_aims) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-aims')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes_text) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-outcomes-text')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes) + ':\\b0\\par ';

            document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text')?.innerText || '';
                const level = li.querySelector('.outcome-bloom-level')?.value || '';
                const sub = li.querySelector('.outcome-bloom-sub')?.value || '';
                let bloomPrefix = '';
                if (level) {
                    bloomPrefix = '[' + (t[`bloom_${level}`] || level.toUpperCase());
                    if (sub) bloomPrefix += ' - ' + (t[`bloom_sub_${sub}`] || sub);
                    bloomPrefix += '] ';
                }
                rtf += '\\bullet ' + escapeRtf(bloomPrefix + text) + '\\par ';
            });

            rtf += '\\par\\fs24\\b ' + escapeRtf('Structure pédagogique') + '\\b0\\par\\fs20 ';

            const moduleCards = document.querySelectorAll('#modules-container .module-card');
            moduleCards.forEach((moduleCard, mIdx) => {
                const mTitle = moduleCard.querySelector('.module-title')?.value || `Module ${mIdx+1}`;
                rtf += '\\par\\b ' + escapeRtf(`MODULE ${mIdx+1} — `) + escapeRtf(mTitle) + '\\b0\\par ';

                const actCards = moduleCard.querySelectorAll('.activity-card');
                actCards.forEach((actCard, aIdx) => {
                    const aTitle = actCard.querySelector('.activity-title')?.value || `Activité ${aIdx+1}`;
                    const aDesc = actCard.querySelector('.activity-description')?.value || '';
                    const aTgtVal = actCard.querySelector('.activity-target-time')?.value || '';
                    const aTgtUnit = actCard.querySelector('.activity-target-unit')?.selectedOptions[0]?.innerText || '';

                    rtf += '\\par\\b ' + escapeRtf(`  Activité ${mIdx+1}.${aIdx+1} — `) + escapeRtf(aTitle) + '\\b0\\par ';
                    if (aDesc.trim()) rtf += escapeRtf('  ' + aDesc) + '\\par ';
                    if (String(aTgtVal).trim()) rtf += escapeRtf(`  Durée cible : ${aTgtVal} ${aTgtUnit}`) + '\\par ';

                    const moments = actCard.querySelectorAll('.moment-card');
                    moments.forEach((momentCard, moIdx) => {
                        const moTitle = momentCard.querySelector('.moment-title')?.value || `Moment ${moIdx+1}`;
                        const moTgtVal = momentCard.querySelector('.moment-target-time')?.value || '';
                        const moTgtUnit = momentCard.querySelector('.moment-target-unit')?.selectedOptions[0]?.innerText || '';
                        const stepCards = momentCard.querySelectorAll('.step-card');
                        const momentSecs = sumDurationCardsToSecs(stepCards);

                        rtf += '\\par\\b ' + escapeRtf(`    Moment ${mIdx+1}.${aIdx+1}.${moIdx+1} — `) + escapeRtf(moTitle) + '\\b0\\par ';
                        rtf += escapeRtf(`    Durée conçue : ${formatTimelineDuration(momentSecs)}`) + '\\par ';
                        if (String(moTgtVal).trim()) rtf += escapeRtf(`    Durée cible : ${moTgtVal} ${moTgtUnit}`) + '\\par ';

                        stepCards.forEach((stepCard, sIdx) => {
                            const sTitle = stepCard.querySelector('.step-input-title')?.value || `Étape ${sIdx+1}`;
                            const sObjective = stepCard.querySelector('.step-input-objective')?.value || '';
                            const sTasks = stepCard.querySelector('.step-input-tasks')?.value || '';
                            const sNotes = stepCard.querySelector('.step-input-notes')?.value || '';
                            const sSecs = readDurationSecs(stepCard);

                            const lt = stepCard.querySelector('.learning-type-select')?.selectedOptions[0]?.innerText || '';
                            const grpMode = stepCard.querySelector('.step-group-mode')?.selectedOptions[0]?.innerText || '';
                            const place = stepCard.querySelector('.place-select')?.selectedOptions[0]?.innerText || '';
                            const time = stepCard.querySelector('.time-select')?.selectedOptions[0]?.innerText || '';
                            const trainer = stepCard.querySelector('.trainer-select')?.selectedOptions[0]?.innerText || '';

                            rtf += '\\par\\b ' + escapeRtf(`      Étape ${mIdx+1}.${aIdx+1}.${moIdx+1}.${sIdx+1} — `) + escapeRtf(sTitle) + '\\b0\\par ';
                            rtf += escapeRtf(`      Durée conçue : ${formatTimelineDuration(sSecs)}`) + '\\par ';
                            if (lt) rtf += escapeRtf(`      Type d'apprentissage : ${lt}`) + '\\par ';
                            if (grpMode) rtf += escapeRtf(`      Regroupement : ${grpMode}`) + '\\par ';
                            if (place) rtf += escapeRtf(`      Lieu : ${place}`) + '\\par ';
                            if (time) rtf += escapeRtf(`      Temps : ${time}`) + '\\par ';
                            if (trainer) rtf += escapeRtf(`      Présence formateur : ${trainer}`) + '\\par ';

                            if (sObjective.trim()) rtf += escapeRtf('      Objectif : ' + sObjective) + '\\par ';
                            if (sTasks.trim()) rtf += escapeRtf('      Tâches : ' + sTasks) + '\\par ';
                            if (sNotes.trim()) rtf += escapeRtf('      Notes : ' + sNotes) + '\\par ';
                        });
                    });
                });
            });

            rtf += '}';

            const blob = new Blob([rtf], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.rtf';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRichText() {
             const t = translations[currentLang];
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            let html = `
            <!DOCTYPE html>
            <html lang="${currentLang}">
            <head>
                <meta charset="UTF-8">
                <title>${t.rtf_title}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                    h2 { color: #4f46e5; margin-top: 30px; border-left: 4px solid #4f46e5; padding-left: 10px; }
                    h3 { color: #6b7280; margin-top: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.05em; }
                    h4 { color: #374151; margin-top: 15px; margin-bottom: 5px; }
                    ul { list-style-type: none; padding-left: 0; }
                    li { margin-bottom: 5px; }
                    .meta-item { margin-bottom: 5px; }
                    .meta-label { font-weight: bold; color: #555; }
                    .activity-block { margin-bottom: 40px; border: none; border-radius: 8px; padding: 20px; background-color: #f8fafc; }
                    .step-block { margin-left: 20px; margin-bottom: 20px; padding: 15px; background-color: white; border-left: 4px solid #cbd5e1; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; margin-right: 5px; }
                    .task-box { background-color: #f1f5f9; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
                    
                    .type-acquisition { border-color: #a1f5ed; } .bg-none { background-color: #e5e7eb; }
 .bg-acquisition { background-color: #7dded6; color: #0f766e; }
                    .type-collaboration { border-color: #ffd966; } .bg-collaboration { background-color: #f0c953; color: #854d0e; }
                    .type-discussion { border-color: #7aaeea; } .bg-discussion { background-color: #6a9bd6; color: #1e40af; }
                    .type-investigation { border-color: #f8807f; } .bg-investigation { background-color: #e06e6d; color: #991b1b; }
                    .type-practice { border-color: #bb98dc; } .bg-practice { background-color: #a582c6; color: #6b21a8; }
                    .type-production { border-color: #bdea75; } .bg-production { background-color: #a6d15e; color: #3f6212; }
                

  
  #timeline-panel #timeline-activities{ overflow: visible !important; }

</style>
            </head>
            <body>
                <h1>${t.rtf_title}</h1>
                
                <h2>Métadonnées</h2>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_course_name}:</span> ${document.getElementById('param-name').value}</div>                <div class="meta-item"><span class="meta-label">${t.label_authors}:</span> ${document.getElementById('param-authors').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_mode}:</span> ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_level}:</span> ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_class_size}:</span> ${document.getElementById('global-class-size').value}</div>
                <div class="meta-item"><span class="meta-label">${t.label_total_time}:</span> ${totalDuration}</div>
                <div class="meta-item"><span class="meta-label">${t.label_learning_time}:</span> ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                <div class="meta-item"><span class="meta-label">${t.label_designed_time}:</span> ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}</div>
                
                <h2>Informations clés</h2>
                <h3>${t.label_description}</h3>
                <p>${document.getElementById('param-description').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_target_audience}</h3>
                <p>${(document.getElementById('param-target-audience')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_prerequisites}</h3>
                <p>${(document.getElementById('param-prerequisites')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_aims}</h3>
                <p>${document.getElementById('param-aims').value.replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes_text}</h3>
                <p>${(document.getElementById('param-outcomes-text')?.value || '').replace(/\n/g, '<br>')}</p>

                <h3>${t.label_outcomes}</h3>
                <ul>`;
                
document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                let bloomText = "";
                if(level) {
                    bloomText += `<strong>[${t[`bloom_${level}`] || level.toUpperCase()}`;
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "]</strong> ";
                }
                html += `<li>${bloomText}${text}</li>`;
            });

            html += `</ul>

                `;

            html += `<h2>Structure pédagogique</h2>`;

            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                // Prefix "Module" (FR) without altering any existing translation strings
                let modPrefix = t.md_untitled_activity;
                modPrefix = modPrefix.replace(' sans titre', '');

                html += `<div class="activity-block">
                    <h3 style="color: #1e293b; font-size: 1.2em; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px;">${modPrefix} ${aIdx + 1}: ${moduleTitle}</h3>
                    ${moduleDesc ? `<p><em>${moduleDesc}</em></p>` : ''}`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 6px;"><strong>Durée cible :</strong> ${moduleTgtVal} ${moduleTgtUnitTxt}</div>`;
                }


                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepsNodeList, momentNumberPrefix) => {
                    stepsNodeList.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const groupMode = step.querySelector('.step-group-mode').value;
                        let groupInfo = groupMode === 'groups' ? `${t.md_format_groups} ${step.querySelector('.step-group-size').value}` : (groupMode === 'individual' ? t.md_format_individual : t.md_format_whole);
                        const objective = step.querySelector('.step-input-objective').value || "";
                        const tasks = step.querySelector('.step-input-tasks').value || "";
                        const notes = step.querySelector('.step-input-notes').value || "";
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`];
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const durVal = step.querySelector('.duration-input').value;
                        const durUnitTxt = step.querySelector('.duration-unit').selectedOptions[0].innerText;
                        const duration = `${durVal} ${durUnitTxt}`;

                        const activityNumber = `${momentNumberPrefix}.${sIdx + 1}`;

                        html += `<div class="step-block type-${typeKey}">
                            <h4>${activityNumber}. ${stepTitle} <span class="tag bg-${typeKey}" style="float: right;">${typeLabel}</span></h4>
                            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">
                                <strong>Durée :</strong> ${duration} | 
                                <strong>Regroupement :</strong> ${groupInfo} | 
                                <strong>Modalité :</strong> ${trainerText}, ${placeText}, ${timeText}
                            </div>
                            ${objective ? `<div class="task-box"><strong>Objectif de l'activité:</strong><br>${objective.replace(/\n/g, '<br>')}</div>` : ''}
                            ${tasks ? `<div class="task-box"><strong>${t.label_tasks}:</strong><br>${tasks.replace(/\n/g, '<br>')}</div>` : ''}
                            ${notes ? `<div style="margin-top: 10px; font-size: 0.9em; color: #475569;"><strong>${t.label_notes}:</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>`;
                    });
                };

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);

                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;
                        html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mTgtVal) {
                            html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal} ${mTgtUnitTxt}</div>`;
                        }

                        if (mDesc) {
                            html += `<div style="margin-top: 6px;"><strong>Description :</strong><br>${escapeHtml(mDesc).replace(/\n/g,'<br>')}</div>`;
                        }
                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for a complete structure
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;
                    html += `<h3 style="margin-top: 18px; color: #334155; font-size: 1.05em;">Moment ${momentPrefix} <span style="font-weight: normal; color:#64748b;">(${formatTimelineDuration(momentSecs)})</span></h3>`;
                    const mTgtVal0 = (activity.querySelector('.moment-target-time')?.value || '').trim();
                    const mTgtUnitTxt0 = activity.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                    if (mTgtVal0) {
                        html += `<div style="font-size: 0.9em; color: #64748b; margin-top: 4px; margin-bottom: 6px;"><strong>Durée cible :</strong> ${mTgtVal0} ${mTgtUnitTxt0}</div>`;
                    }
                    renderSteps(stepCards, momentPrefix);
                }

                html += `</div>`;
            });

            html += `
</body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportRTF() {
            const t = translations[currentLang] || translations.fr;
            const totals = getTotals();
            const totalDuration = fmtTotalDuration(totals.totalSecs, t);
            const courseName = (document.getElementById('param-name')?.value || '').trim();

            const readDurationSecs = (card) => {
                const v = parseFloat(card.querySelector('.duration-input')?.value || '0');
                const unit = parseFloat(card.querySelector('.duration-unit')?.value || 60);
                const secs = (Number.isFinite(v) ? v : 0) * (Number.isFinite(unit) ? unit : 60);
                return secs;
            };

            const fmtTarget = (timeEl, unitEl) => {
                const v = (timeEl?.value || '').toString().trim();
                const u = unitEl?.selectedOptions?.[0]?.innerText || '';
                if (!v) return '';
                return `${v} ${u}`.trim();
            };

            const getSelectedText = (selectEl) => {
                const opt = selectEl && selectEl.selectedOptions ? selectEl.selectedOptions[0] : null;
                return opt ? (opt.innerText || opt.textContent || '').trim() : '';
            };

            const getGroupingText = (stepEl) => {
                const modeEl = stepEl.querySelector('.step-group-mode');
                const modeVal = modeEl ? modeEl.value : '';
                const modeTxt = getSelectedText(modeEl);
                const sizeVal = (stepEl.querySelector('.step-group-size')?.value || '').toString().trim();
                const detailsVal = (stepEl.querySelector('.step-group-details')?.value || '').toString().trim();

                let txt = modeTxt;
                if (modeVal === 'groups' && sizeVal) txt = `${modeTxt} (${sizeVal})`;
                if (detailsVal) txt = txt ? `${txt} — ${detailsVal}` : detailsVal;
                return txt.trim();
            };

            const sumStepsToSecs = (stepCards) => {
                let secs = 0;
                stepCards.forEach(step => { secs += readDurationSecs(step); });
                return secs;
            };

            // RTF header: use ANSI for compatibility but encode all non-ASCII via \uN? (escapeRtf)
            let rtf = '{\\rtf1\\ansi\\ansicpg1252\\uc1\\deff0' +
                '{\\fonttbl{\\f0 Segoe UI;}{\\f1 Arial;}}' +
                '\\fs28\\b ' + escapeRtf(t.rtf_title) + '\\b0\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Métadonnées') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_course_name) + ':\\b0 ' + escapeRtf(courseName) + '\\par' +
                '\\b ' + escapeRtf(t.label_authors) + ':\\b0 ' + escapeRtf(document.getElementById('param-authors')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_mode) + ':\\b0 ' + escapeRtf(document.getElementById('param-mode')?.selectedOptions?.[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_level) + ':\\b0 ' + escapeRtf(document.getElementById('param-level')?.selectedOptions?.[0]?.innerText || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_class_size) + ':\\b0 ' + escapeRtf(document.getElementById('global-class-size')?.value || '') + '\\par' +
                '\\b ' + escapeRtf(t.label_total_time) + ':\\b0 ' + escapeRtf(totalDuration) + '\\par' +
                '\\b ' + escapeRtf(t.label_learning_time) + ':\\b0 ' + escapeRtf(((document.getElementById('param-learning-val')?.value || '').toString().trim()) + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions?.[0]?.innerText || '')) + '\\par' +
                '\\b ' + escapeRtf(t.label_designed_time) + ':\\b0 ' + escapeRtf(((document.getElementById('param-designed-val')?.value || '').toString().trim()) + ' ' + (document.getElementById('param-learning-unit')?.selectedOptions?.[0]?.innerText || '')) + '\\par\\par' +

                '\\fs24\\b ' + escapeRtf('Informations clés') + '\\b0\\par' +
                '\\fs20 ' +
                '\\b ' + escapeRtf(t.label_description) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-description')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_target_audience) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-target-audience')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_prerequisites) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-prerequisites')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_aims) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-aims')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes_text) + ':\\b0\\par ' + escapeRtf(document.getElementById('param-outcomes-text')?.value || '') + '\\par\\par' +
                '\\b ' + escapeRtf(t.label_outcomes) + ':\\b0\\par ';

            // Outcomes list
            document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text')?.innerText || '';
                const level = li.querySelector('.outcome-bloom-level')?.value || '';
                const sub = li.querySelector('.outcome-bloom-sub')?.value || '';
                let bloomPrefix = '';
                if (level) {
                    bloomPrefix = '[' + (t[`bloom_${level}`] || level.toUpperCase());
                    if (sub) bloomPrefix += ' - ' + (t[`bloom_sub_${sub}`] || sub);
                    bloomPrefix += '] ';
                }
                rtf += '\\bullet ' + escapeRtf(bloomPrefix + text) + '\\par ';
            });

            rtf += '\\par\\fs24\\b ' + escapeRtf('Structure pédagogique') + '\\b0\\par\\fs20 ';

            // Modules designed (current structure)
            let moduleIdx = 0;
            document.querySelectorAll('.activity-group').forEach((moduleEl) => {
                moduleIdx += 1;
                const moduleTitle = (moduleEl.querySelector('.activity-title')?.value || '').trim() || `${t.md_module} ${moduleIdx}`;
                const moduleDesc = (moduleEl.querySelector('.activity-description')?.value || '').trim();
                const moduleTarget = fmtTarget(moduleEl.querySelector('.activity-target-time'), moduleEl.querySelector('.activity-target-unit'));

                rtf += '\\par\\b ' + escapeRtf(`MODULE ${moduleIdx} — `) + escapeRtf(moduleTitle) + '\\b0\\par ';
                if (moduleTarget) rtf += escapeRtf(`Durée cible : ${moduleTarget}`) + '\\par ';
                if (moduleDesc) rtf += escapeRtf(`Description : ${moduleDesc}`) + '\\par ';

                const momentEls = moduleEl.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                const renderSteps = (stepCards, prefix) => {
                    stepCards.forEach((stepEl, sIdx) => {
                        const stepTitle = (stepEl.querySelector('.step-input-title')?.value || '').trim() || `${t.md_step} ${sIdx + 1}`;
                        const objective = (stepEl.querySelector('.step-input-objective')?.value || '').trim();
                        const tasks = (stepEl.querySelector('.step-input-tasks')?.value || '').trim();
                        const notes = (stepEl.querySelector('.step-input-notes')?.value || '').trim();

                        const sSecs = readDurationSecs(stepEl);
                        const lt = getSelectedText(stepEl.querySelector('.learning-type-select'));
                        const grouping = getGroupingText(stepEl);
                        const place = getSelectedText(stepEl.querySelector('.place-select'));
                        const time = getSelectedText(stepEl.querySelector('.time-select'));
                        const trainer = getSelectedText(stepEl.querySelector('.trainer-select'));

                        const stepPrefix = `${prefix}.${sIdx + 1}`;
                        rtf += '\\par\\b ' + escapeRtf(`      Activité ${stepPrefix} — `) + escapeRtf(stepTitle) + '\\b0\\par ';
                        rtf += escapeRtf(`      Durée conçue : ${formatTimelineDuration(sSecs)}`) + '\\par ';
                        if (lt) rtf += escapeRtf(`      Type d'apprentissage : ${lt}`) + '\\par ';
                        if (grouping) rtf += escapeRtf(`      Regroupement : ${grouping}`) + '\\par ';
                        if (trainer || place || time) {
                            const parts = [];
                            if (trainer) parts.push(`Présence formateur : ${trainer}`);
                            if (place) parts.push(`Lieu : ${place}`);
                            if (time) parts.push(`Temps : ${time}`);
                            rtf += escapeRtf(`      Modalité : ${parts.join(' | ')}`) + '\\par ';
                        }
                        if (objective) rtf += escapeRtf(`      Objectif : ${objective}`) + '\\par ';
                        if (tasks) rtf += escapeRtf(`      Tâches : ${tasks}`) + '\\par ';
                        if (notes) rtf += escapeRtf(`      Notes : ${notes}`) + '\\par ';
                    });
                };

                if (hasMoments) {
                    momentEls.forEach((momentEl, moIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const momentDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        const momentTarget = fmtTarget(momentEl.querySelector('.moment-target-time'), momentEl.querySelector('.moment-target-unit'));

                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = sumStepsToSecs(stepCards);
                        const momentPrefix = `${moduleIdx}.${moIdx + 1}`;

                        rtf += '\\par\\b ' + escapeRtf(`  Moment ${momentPrefix}`) + escapeRtf(momentTitle ? ` — ${momentTitle}` : '') + '\\b0\\par ';
                        rtf += escapeRtf(`  Durée conçue : ${formatTimelineDuration(momentSecs)}`) + '\\par ';
                        if (momentTarget) rtf += escapeRtf(`  Durée cible : ${momentTarget}`) + '\\par ';
                        if (momentDesc) rtf += escapeRtf(`  Description : ${momentDesc}`) + '\\par ';

                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    // Legacy designs (no moments): export as a single moment for completeness
                    const stepCards = moduleEl.querySelectorAll('.step-card');
                    const momentSecs = sumStepsToSecs(stepCards);
                    const momentPrefix = `${moduleIdx}.1`;

                    rtf += '\\par\\b ' + escapeRtf(`  Moment ${momentPrefix}`) + '\\b0\\par ';
                    rtf += escapeRtf(`  Durée conçue : ${formatTimelineDuration(momentSecs)}`) + '\\par ';

                    const legacyTarget = fmtTarget(moduleEl.querySelector('.moment-target-time'), moduleEl.querySelector('.moment-target-unit'));
                    if (legacyTarget) rtf += escapeRtf(`  Durée cible : ${legacyTarget}`) + '\\par ';

                    renderSteps(stepCards, momentPrefix);
                }
            });

            rtf += '}';

            const blob = new Blob([rtf], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.rtf';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMarkdown() {
            const data = getTotals();
            const t = translations[currentLang];
            let md = `# ${t.md_title}\n\n`;
            md += `## métadonnées\n`;
            md += `- **${t.label_course_name}:** ${document.getElementById('param-name').value}\n`;
            md += `- **${t.label_authors}:** ${document.getElementById('param-authors').value}\n`;
            md += `- **${t.label_mode}:** ${document.getElementById('param-mode').selectedOptions[0]?.innerText || ''}\n`;
            md += `- **${t.label_level}:** ${document.getElementById('param-level').selectedOptions[0]?.innerText || ''}\n`;
            md += `- **${t.label_class_size}:** ${document.getElementById('global-class-size').value}\n`;
            md += `- **${t.label_total_time}:** ${fmtTotalDuration(data.totalSecs, t)}\n`;
            md += `- **${t.label_learning_time}:** ${document.getElementById('param-learning-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}\n`;
            md += `- **${t.label_designed_time}:** ${document.getElementById('param-designed-val').value} ${document.getElementById('param-learning-unit').selectedOptions[0]?.innerText || ''}\n`; 
md += `- **Horodatage d'export :** ${new Date().toISOString()}\n\n`;
            
            md += `## informations_clés\n`;
            md += `### ${t.label_target_audience}\n${document.getElementById('param-target-audience')?.value || ''}\n\n`;
            md += `### ${t.label_prerequisites}\n${document.getElementById('param-prerequisites')?.value || ''}\n\n`;
            md += `### ${t.label_aims}\n${document.getElementById('param-aims').value}\n\n`;
            md += `### ${t.label_outcomes_text}\n${document.getElementById('param-outcomes-text')?.value || ''}\n\n`;
            md += `### ${t.label_outcomes}\n`;
            document.querySelectorAll('#outcomes-list li').forEach(li => {
                const text = li.querySelector('.outcome-text').innerText;
                const level = li.querySelector('.outcome-bloom-level').value;
                const sub = li.querySelector('.outcome-bloom-sub').value;
                
                let bloomText = "";
                if(level) {
                    bloomText += "[" + (t[`bloom_${level}`] || level.toUpperCase());
                    if(sub) bloomText += ` - ${t[`bloom_sub_${sub}`] || sub}`;
                    bloomText += "] ";
                }
                
                md += `- ${bloomText}${text}\n`;
            });
            md += `\n### ${t.label_description}\n${document.getElementById('param-description').value}\n\n`;

            md += `## structure_pédagogique

`;
            document.querySelectorAll('.activity-group').forEach((activity, aIdx) => {
                const moduleTitle = activity.querySelector('.activity-title').value || t.md_untitled_activity;
                const moduleDesc = activity.querySelector('.activity-description').value;

                md += `### MODULE ${aIdx + 1} : ${moduleTitle.toUpperCase()}

`;
                if (moduleDesc) md += `> ${moduleDesc}

`;

                const moduleTgtVal = (activity.querySelector('.activity-target-time')?.value || '').trim();
                const moduleTgtUnitTxt = activity.querySelector('.activity-target-unit')?.selectedOptions?.[0]?.innerText || '';
                if (moduleTgtVal) {
                    md += `- **Durée cible :** ${moduleTgtVal} ${moduleTgtUnitTxt}
`;
                    md += `
`;
                }

                const calcMomentSecs = (stepCards) => {
                    let secs = 0;
                    stepCards.forEach(step => {
                        const v = parseFloat(step.querySelector('.duration-input')?.value) || 0;
                        const u = parseFloat(step.querySelector('.duration-unit')?.value) || 60;
                        secs += (v * u);
                    });
                    return secs;
                };

                const renderSteps = (stepCards, momentPrefix) => {
                    stepCards.forEach((step, sIdx) => {
                        const stepTitle = step.querySelector('.step-input-title').value || t.md_untitled_step;
                        const typeKey = step.querySelector('.learning-type-select').value;
                        const typeLabel = t[`type_${typeKey}`] || "";
                        const groupMode = step.querySelector('.step-group-mode').value;
                        let groupInfo = groupMode === 'groups' ? `${t.md_format_groups} ${step.querySelector('.step-group-size').value}` : (groupMode === 'individual' ? t.md_format_individual : t.md_format_whole);
                        const trainerText = step.querySelector('.trainer-select').selectedOptions[0].innerText;
                        const placeText = step.querySelector('.place-select').selectedOptions[0].innerText;
                        const timeText = step.querySelector('.time-select').selectedOptions[0].innerText;

                        const objective = step.querySelector('.step-input-objective').value || "Non renseigné";
                        const tasks = step.querySelector('.step-input-tasks').value || "Non renseigné";
                        const notes = step.querySelector('.step-input-notes').value || "Non renseigné";

                        const activityNum = `${momentPrefix}.${sIdx + 1}`;

                        md += `##### ACTIVITÉ ${activityNum} : ${stepTitle}
`;
                        md += `- **Type :** ${typeLabel}
`;
                        md += `- **Durée :** ${step.querySelector('.duration-input').value} ${step.querySelector('.duration-unit').selectedOptions[0].innerText}
`;
                        md += `- **Regroupement :** ${groupInfo}
`;
                        md += `- **Modalité :** ${trainerText}, ${placeText}, ${timeText}
`;
                        md += `- **Objectif de l'activité :** ${objective}

`;
                        md += `**Ce que les apprenants doivent faire :**
${tasks}

`;
                        md += `**Notes pédagogiques :**
${notes}

`;
                    });
                };

                const momentEls = activity.querySelectorAll('.moment-group');
                const hasMoments = momentEls && momentEls.length > 0;

                if (hasMoments) {
                    momentEls.forEach((momentEl, mIdx) => {
                        const momentTitle = (momentEl.querySelector('.moment-title')?.value || '').trim();
                        const stepCards = momentEl.querySelectorAll('.step-card');
                        const momentSecs = calcMomentSecs(stepCards);
                        const momentPrefix = `${aIdx + 1}.${mIdx + 1}`;

                        md += `#### MOMENT ${momentPrefix}${momentTitle ? ` : ${momentTitle}` : ''}
`;
                        md += `- **Durée conçue :** ${formatTimelineDuration(momentSecs)}
`;

                        const mTgtVal = (momentEl.querySelector('.moment-target-time')?.value || '').trim();
                        const mTgtUnitTxt = momentEl.querySelector('.moment-target-unit')?.selectedOptions?.[0]?.innerText || '';
                        if (mTgtVal) md += `- **Durée cible :** ${mTgtVal} ${mTgtUnitTxt}
`;
                        const mDesc = (momentEl.querySelector('.moment-description')?.value || '').trim();
                        if (mDesc) md += `- **Description :**\n${mDesc}\n`;
                        md += `

`;

                        renderSteps(stepCards, momentPrefix);
                    });
                } else {
                    
                    const stepCards = activity.querySelectorAll('.step-card');
                    const momentSecs = calcMomentSecs(stepCards);
                    const momentPrefix = `${aIdx + 1}.1`;

                    md += `#### MOMENT ${momentPrefix}
`;
                    md += `- **Durée conçue :** ${formatTimelineDuration(momentSecs)}

`;

                    renderSteps(stepCards, momentPrefix);
                }

                md += `
---

`;
            });
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'profil_conception_pedagogique.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        

        
        function isHighContrastEnabled() {
            return document.body.classList.contains('hc');
        }

        function setHighContrastEnabled(enabled) {
            document.body.classList.toggle('hc', !!enabled);
            try {
                localStorage.setItem('ld_palette', enabled ? 'hc' : 'standard');
            } catch (e) {
                
            }
            updateContrastToggleUI();
            
            updateStats();
}

        function updateContrastToggleUI() {
            const btn = document.getElementById('contrast-toggle-btn');
            const txt = document.getElementById('contrast-btn-text');
            if (!btn || !txt) return;
            const enabled = isHighContrastEnabled();
            btn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
            btn.title = enabled ? "Passer à la palette standard" : "Passer au haut contraste";
            txt.textContent = enabled ? "HC" : "STD";
        }

        function toggleHighContrast(evt) {
            if (evt) { evt.preventDefault(); evt.stopPropagation(); }
            setHighContrastEnabled(!isHighContrastEnabled());
        }

/* --- Autosave (LocalStorage) --- */
const AUTOSAVE_KEY = 'ld_autosave_project_v1';
let __autosaveTimer = null;
let __autosaveSuspended = false;

function scheduleAutosave() {
    if (__autosaveSuspended) return;
    // Ignore changes during print, etc. Keep lightweight.
    if (__autosaveTimer) clearTimeout(__autosaveTimer);
    __autosaveTimer = setTimeout(() => {
        try {
            const project = buildExportProjectData();
            const payload = {
                savedAt: new Date().toISOString(),
                project
            };
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(payload));
        } catch (e) {
            // If storage is unavailable/quota exceeded, fail silently (no UI change).
        }
    }, 2000);
}

function hasAutosave() {
    try { return !!localStorage.getItem(AUTOSAVE_KEY); } catch (e) { return false; }
}

function getAutosavePayload() {
    try {
        const raw = localStorage.getItem(AUTOSAVE_KEY);
        return raw ? JSON.parse(raw) : null;
    } catch (e) {
        return null;
    }
}

function clearAutosave() {
    try { localStorage.removeItem(AUTOSAVE_KEY); } catch (e) {}
}

function isLikelyEmptyProject() {
    const hasModules = document.querySelectorAll('.activity-group').length > 0;
    const hasAnyStep = document.querySelectorAll('.step-card').length > 0;
    const name = (document.getElementById('param-name')?.value || '').trim();
    const desc = (document.getElementById('param-description')?.value || '').trim();
    // If the tool auto-creates an empty module, treat it as empty unless there is any meaningful content.
    return (!hasAnyStep) && (!name) && (!desc);
}

function maybeRestoreAutosave() {
    const payload = getAutosavePayload();
    if (!payload || !payload.project) return false;

    const t = translations[currentLang] || translations.fr || {};
    const savedAt = payload.savedAt ? new Date(payload.savedAt) : null;
    const savedAtTxt = savedAt && !isNaN(savedAt.getTime())
        ? savedAt.toLocaleString()
        : (payload.savedAt || '');

    // Use browser-native confirm to avoid any interface changes.
    const msg = (t.autosave_restore_prompt || "Une sauvegarde automatique a été trouvée ({{date}}). Voulez-vous la restaurer ?")
        .replace('{{date}}', savedAtTxt || '—');

    const restore = window.confirm(msg);
    if (!restore) return false;

    __autosaveSuspended = true;
    try {
        loadProjectFromObject(payload.project);
    } finally {
        // Re-enable autosave after the restore batch has settled
        setTimeout(() => { __autosaveSuspended = false; }, 0);
    }
    return true;
}

function initAutosaveWatchers() {
    // Input-level changes
    document.addEventListener('input', scheduleAutosave, true);
    document.addEventListener('change', scheduleAutosave, true);

    // Structural changes (add/remove/reorder)
    const watchRoot = document.getElementById('activities-root') || document.body;
    try {
        const mo = new MutationObserver(() => scheduleAutosave());
        mo.observe(watchRoot, { childList: true, subtree: true });
    } catch (e) {
        // no-op
    }
}

/* --- Undo/Redo (History Snapshots) --- */
const HISTORY_LIMIT = 50;
let __undoStack = [];
let __redoStack = [];
let __historyDebounce = null;
let __isApplyingHistory = false;
let __pendingDragSnapshot = null;

function snapshotProject() {
    try { return JSON.stringify(buildExportProjectData()); } catch (e) { return null; }
}

function pushUndoSnapshot(snapshot) {
    if (!snapshot) return;
    const last = __undoStack.length ? __undoStack[__undoStack.length - 1] : null;
    if (snapshot === last) return;
    __undoStack.push(snapshot);
    if (__undoStack.length > HISTORY_LIMIT) __undoStack.shift();
    // Any new user change invalidates redo history
    __redoStack = [];
}

function historyCaptureNow() {
    if (__isApplyingHistory) return;
    pushUndoSnapshot(snapshotProject());
}

function scheduleHistoryCapture() {
    if (__isApplyingHistory) return;
    if (__historyDebounce) clearTimeout(__historyDebounce);
    __historyDebounce = setTimeout(() => {
        __historyDebounce = null;
        historyCaptureNow();
    }, 2000);
}

function applySnapshot(snapshotStr) {
    if (!snapshotStr) return;
    let obj = null;
    try { obj = JSON.parse(snapshotStr); } catch (e) { return; }
    __isApplyingHistory = true;
    try {
        loadProjectFromObject(obj);
        updateEmptyState();
        updateStats();
        scheduleAutosave(); // keep autosave consistent with restored state
    } finally {
        // let DOM settle before re-enabling capture (avoids MutationObserver noise)
        setTimeout(() => { __isApplyingHistory = false; }, 0);
    }
}

function undo() {
    if (__undoStack.length <= 1) return; // keep at least initial state
    const current = __undoStack.pop();
    __redoStack.push(current);
    const previous = __undoStack[__undoStack.length - 1];
    applySnapshot(previous);
}

function redo() {
    if (!__redoStack.length) return;
    const next = __redoStack.pop();
    __undoStack.push(next);
    applySnapshot(next);
}

function isEditableTarget(el) {
    if (!el) return false;
    const t = (el.tagName || '').toLowerCase();
    if (t === 'input' || t === 'textarea' || t === 'select') return true;
    return !!el.isContentEditable;
}

function initHistoryWatchers() {
    // Capture text/field changes after inactivity (debounced)
    document.addEventListener('input', scheduleHistoryCapture, true);
    document.addEventListener('change', scheduleHistoryCapture, true);

    // Structural mutations: capture after debounce (covers programmatic edits)
    const watchRoot = document.getElementById('activities-root') || document.body;
    try {
        const mo = new MutationObserver(() => scheduleHistoryCapture());
        mo.observe(watchRoot, { childList: true, subtree: true });
    } catch (e) {
        // no-op
    }

    // Keyboard shortcuts (avoid overriding native text undo in inputs/textarea)
    document.addEventListener('keydown', (e) => {
        const isMac = /Mac|iPhone|iPad|iPod/i.test(navigator.platform);
        const mod = isMac ? e.metaKey : e.ctrlKey;
        if (!mod) return;

        const key = (e.key || '').toLowerCase();
        const editable = isEditableTarget(document.activeElement);

        // Ctrl/Cmd+Z => undo (only when not editing a field)
        if (key === 'z' && !e.shiftKey && !editable) {
            e.preventDefault();
            undo();
            return;
        }

        // Ctrl/Cmd+Shift+Z => redo (common on macOS)
        if (key === 'z' && e.shiftKey && !editable) {
            e.preventDefault();
            redo();
            return;
        }

        // Ctrl/Cmd+Y => redo (common on Windows)
        if (key === 'y' && !editable) {
            e.preventDefault();
            redo();
            return;
        }
    }, true);
}

function initHistory() {
    __undoStack = [];
    __redoStack = [];
    historyCaptureNow(); // initial state
}
/* --- End Undo/Redo --- */

window.onload = () => {
            applyTranslations();
            renderBloomOptions(document.getElementById('new-bloom-level'));

            initTimelineZoomControls();

            
            try {
                const pref = localStorage.getItem('ld_palette');
                if (pref === 'standard') document.body.classList.remove('hc');
                if (pref === 'hc') document.body.classList.add('hc');
            } catch (e) {
                
            }
            
            // Autosave: offer restore if available; otherwise start with a fresh module
            let restored = false;
            if (hasAutosave()) {
                // If the page starts empty, restore without additional checks; otherwise still allow restore.
                restored = maybeRestoreAutosave();
            }
            if (!restored) {
                addActivity();
            }

            initAutosaveWatchers();
            initHistory();
            initHistoryWatchers();
updateContrastToggleUI();
        };
  
document.addEventListener('DOMContentLoaded', setupTimelineHScroll);

/* --- Charts panel (non-intrusive) --- */
(function () {
  const rootEl = document.getElementById('activities-root');

  function getSelectedLabel(selectEl) {
    const opt = selectEl && selectEl.options ? selectEl.options[selectEl.selectedIndex] : null;
    const txt = opt ? (opt.textContent || '').trim() : '';
    const val = (selectEl && selectEl.value ? String(selectEl.value).trim() : '');
    return txt || val || '—';
  }

  function getStepDurationSecs(stepCard) {
  if (!stepCard) return 0;
  const v = Math.max(0, parseFloat(stepCard.querySelector('.duration-input')?.value) || 0);
  const u = Math.max(0, parseFloat(stepCard.querySelector('.duration-unit')?.value) || 0);
  // unit is stored as seconds-per-unit in option value (e.g., 60 for minutes)
  const secs = v * (u || 60);
  return Number.isFinite(secs) ? secs : 0;
}

// Count occurrences (kept for potential future use)
// Sum designed duration (seconds) by a select's chosen label, using the enclosing step card duration.
function tallyDuration(selector) {
  const sums = new Map();
  document.querySelectorAll(selector).forEach((el) => {
    if (!el) return;
    const val = (el.value ?? '').toString().trim();
    if (!val) return;
    const label = (el.tagName === 'SELECT') ? getSelectedLabel(el) : val;
    const stepCard = el.closest('.step-card');
    const secs = getStepDurationSecs(stepCard);
    if (secs <= 0) return;
    sums.set(label, (sums.get(label) || 0) + secs);
  });
  return sums;
}
function tallyDurationMeta(selector, kind) {
  const sums = new Map();
  document.querySelectorAll(selector).forEach((el) => {
    if (!el) return;
    const val = (el.value ?? '').toString().trim();
    if (!val) return;

    const label = (el.tagName === 'SELECT') ? getSelectedLabel(el) : val;
    const stepCard = el.closest('.step-card');
    const secs = getStepDurationSecs(stepCard);
    if (secs <= 0) return;

    const meta = getHistogramBarMeta(kind, val);
    const prev = sums.get(label) || { secs: 0, color: meta.color, pattern: meta.pattern };
    prev.secs += secs;
    // Keep initial style chosen for this label
    sums.set(label, prev);
  });

  return Array.from(sums.entries()).map(([label, obj]) => ({
    label,
    secs: obj.secs || 0,
    color: obj.color,
    pattern: obj.pattern
  }));
}

function getHistogramBarMeta(kind, val) {
  // These match the legend logic and the "Visualisations des séquences" tracks:
  // plein = greySolid, rayé = greyStriped + stripes.
  const greySolid = '#64748b';   // slate-500
  const greyStriped = '#94a3b8'; // slate-400

  const k = (kind || '').toLowerCase();
  const v = (val || '').toLowerCase();

  if (k === 'group') {
    if (v === 'class') return { color: greySolid, pattern: '' };
    if (v === 'groups') return { color: greyStriped, pattern: 'stripes' };
    if (v === 'individual') return { color: greySolid, pattern: 'dots' };
    return { color: greyStriped, pattern: 'stripes' };
  }

  if (k === 'place') {
    // timeline legend: plein = présentiel, rayé = en ligne (hybride treated as rayé in timeline)
    if (v === 'situ') return { color: greySolid, pattern: '' };
    return { color: greyStriped, pattern: 'stripes' };
  }

  if (k === 'time') {
    // timeline legend: plein = synchrone, rayé = asynchrone
    if (v === 'sync') return { color: greySolid, pattern: '' };
    return { color: greyStriped, pattern: 'stripes' };
  }

  if (k === 'trainer') {
    // timeline legend: plein = présent, rayé = absent
    if (v === 'present') return { color: greySolid, pattern: '' };
    return { color: greyStriped, pattern: 'stripes' };
  }

  return { color: greySolid, pattern: '' };
}


  function clearCanvas(ctx, w, h) {
    ctx.clearRect(0, 0, w, h);
  }

    function palette(n) {
    // deterministic greys-to-blues palette
    const cols = [];
    for (let i = 0; i < n; i++) {
      const t = n <= 1 ? 0.5 : i / (n - 1);
      const r = Math.round(30 + 50 * (1 - t));
      const g = Math.round(80 + 80 * (1 - t));
      const b = Math.round(180 + 60 * t);
      cols.push(`rgb(${r},${g},${b})`);
    }
    return cols;
  }

    function drawPie(canvasId, countsMap) {
    const c = document.getElementById(canvasId);
    if (!c) return;
    const ctx = c.getContext('2d');
    const w = c.width = c.clientWidth || c.width;
    const h = c.height = c.getAttribute('height') ? parseInt(c.getAttribute('height'), 10) : (c.clientHeight || 180);
    clearCanvas(ctx, w, h);

    const entries = Array.from(countsMap.entries()).sort((a, b) => b[1] - a[1]);
    if (!entries.length) {
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Aucune donnée', 10, 20);
      // Clear legend if present
      if (canvasId === 'chart-learning-types') {
        const lg = document.getElementById('chart-learning-types-legend');
        if (lg) lg.innerHTML = '';
      }
      return;
    }

    const total = entries.reduce((s, [, v]) => s + v, 0);
    if (total <= 0) {
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Aucune donnée', 10, 20);
      if (canvasId === 'chart-learning-types') {
        const lg = document.getElementById('chart-learning-types-legend');
        if (lg) lg.innerHTML = '';
      }
      return;
    }

    function learningTypeColor(label) {
      const k = (label || '').toString().toLowerCase();
      if (k.includes('acquisition')) return '#a1f5ed';
      if (k.includes('collaboration')) return '#ffd966';
      if (k.includes('discussion')) return '#7aaeea';
      if (k.includes('investigation') || k.includes('enquête') || k.includes('enquete')) return '#f8807f';
      if (k.includes('practice') || k.includes('pratique')) return '#bb98dc';
      if (k.includes('production')) return '#bdea75';
      if (k.includes('none') || k.includes('aucun') || k.includes('—')) return '#e5e7eb';
      return '#cbd5e1';
    }

    const cols = (canvasId === 'chart-learning-types')
      ? entries.map(([label]) => learningTypeColor(label))
      : palette(entries.length);

    // Draw pie only (legend is rendered as text beside the canvas for accessibility and to avoid overlap)
    const cx = w * 0.5;
    const cy = h * 0.5;

    // Make the pie large within its own canvas (the canvas itself is 50% of the dedicated frame)
    let radius = Math.min(w, h) * 0.44;
    radius = Math.max(24, Math.min(radius, (w / 2) - 10, (h / 2) - 10));

    let angle = -Math.PI / 2;
    entries.forEach(([label, value], i) => {
      const slice = (value / total) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.fillStyle = cols[i];
      ctx.arc(cx, cy, radius, angle, angle + slice);
      ctx.closePath();
      ctx.fill();
      angle += slice;
    });

    // Update legend as text in a dedicated DOM container (never overlaps the pie)
    if (canvasId === 'chart-learning-types') {
      const lg = document.getElementById('chart-learning-types-legend');
      if (lg) {
        const legendItems = entries.map(([label, value], i) => {
          const pct = (value / total) * 100;
          const pctStr = (pct >= 9.95 || pct === 0) ? `${Math.round(pct)}%` : `${pct.toFixed(1)}%`;
          const safeLabel = (label || '—').toString();
          return `
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <span class="inline-block w-3 h-3 rounded-sm border border-slate-200 flex-none" style="background:${cols[i]}"></span>
                <span class="truncate">${safeLabel}</span>
              </div>
              <div class="text-slate-900 font-semibold tabular-nums flex-none">${pctStr}</div>
            </div>
          `;
        }).join('');
        lg.innerHTML = legendItems;
      }
    }
  }

  function drawBars(canvasId, rows) {
  const c = document.getElementById(canvasId);
  if (!c) return;
  const ctx = c.getContext('2d');
  const w = (c.width = c.clientWidth || c.width);
  const h = (c.height = c.getAttribute('height') ? parseInt(c.getAttribute('height'), 10) : (c.clientHeight || 180));
  clearCanvas(ctx, w, h);

  const entries = (rows || []).slice().sort((a, b) => (b.secs || 0) - (a.secs || 0));
  if (!entries.length) {
    ctx.fillStyle = '#94a3b8';
    ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('Aucune donnée', 10, 20);
    return;
  }

  const pad = 10;
  const rowH = 22;
  const top = pad + 8;

  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.textBaseline = 'middle';

  const total = entries.reduce((acc, e) => acc + (e.secs || 0), 0);

  // Measure label widths
  let maxLabelPx = 0;
  entries.forEach((e) => { maxLabelPx = Math.max(maxLabelPx, ctx.measureText(e.label || '').width); });

  // Fixed right column for values
  const valueExample = '100%';
  const valueW = ctx.measureText(valueExample).width;
  const valueX = w - pad - valueW;

  // Keep label column generous so labels never sit under bars
  const labelW = Math.min(Math.max(110, maxLabelPx + 16), Math.min(260, w * 0.48));
  const barX = pad + labelW + 10;
  const barW = Math.max(30, (valueX - 10) - barX);

  function fitText(text, maxWidth) {
    const s = (text || '').toString();
    if (ctx.measureText(s).width <= maxWidth) return s;
    let lo = 0, hi = s.length;
    while (lo < hi) {
      const mid = Math.floor((lo + hi) / 2);
      const t = s.slice(0, mid) + '…';
      if (ctx.measureText(t).width <= maxWidth) lo = mid + 1;
      else hi = mid;
    }
    const cut = Math.max(1, lo - 1);
    return s.slice(0, cut) + '…';
  }

  function roundRectPath(x, y, ww, hh, r) {
    const rr = Math.max(0, Math.min(r, hh / 2, ww / 2));
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + ww, y, x + ww, y + hh, rr);
    ctx.arcTo(x + ww, y + hh, x, y + hh, rr);
    ctx.arcTo(x, y + hh, x, y, rr);
    ctx.arcTo(x, y, x + ww, y, rr);
    ctx.closePath();
  }

  function drawTrack(x, y, ww, hh) {
    // Track background + border (matches timeline bars: bg-slate-100 + border-slate-200 + rounded)
    ctx.save();
    roundRectPath(x, y, ww, hh, 7);
    ctx.fillStyle = '#f1f5f9'; // slate-100
    ctx.fill();
    ctx.strokeStyle = '#e2e8f0'; // slate-200
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
  }

  function drawFill(x, y, ww, hh, color, pattern) {
    if (ww <= 0.5) return;

    ctx.save();
    roundRectPath(x, y, ww, hh, 7);
    ctx.clip();

    // Base fill
    ctx.fillStyle = color || '#64748b';
    ctx.fillRect(x, y, ww, hh);

    // Overlay patterns to mimic "plein / rayé" style from Visualisations des séquences
    if (pattern === 'stripes') {
      ctx.strokeStyle = 'rgba(255,255,255,0.45)';
      ctx.lineWidth = 2;
      const step = 8;
      // diagonal stripes
      for (let i = -hh; i < ww + hh; i += step) {
        ctx.beginPath();
        ctx.moveTo(x + i, y + hh);
        ctx.lineTo(x + i + hh, y);
        ctx.stroke();
      }
    } else if (pattern === 'dots') {
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      const step = 8;
      for (let yy = y + 4; yy < y + hh; yy += step) {
        for (let xx = x + 4; xx < x + ww; xx += step) {
          ctx.beginPath();
          ctx.arc(xx, yy, 1.3, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }

    ctx.restore();

    // Subtle separator line at end of filled portion (like segment boundaries)
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x + ww + 0.5, y + 2);
    ctx.lineTo(x + ww + 0.5, y + hh - 2);
    ctx.stroke();
    ctx.restore();
  }

  const maxRows = Math.floor((h - pad * 2) / rowH);
  entries.slice(0, maxRows).forEach((e, i) => {
    const yMid = top + i * rowH + rowH / 2;
    const trackH = 12;
    const trackY = yMid - trackH / 2;

    // Label
    ctx.fillStyle = '#334155'; // slate-700
    ctx.fillText(fitText(e.label || '', labelW - 8), pad, yMid);

    // Track and fill
    drawTrack(barX, trackY, barW, trackH);

    const pct = total > 0 ? (e.secs / total) * 100 : 0;
    const bw = Math.round((barW * pct) / 100);

    drawFill(barX, trackY, bw, trackH, e.color, e.pattern);

    // Value column (right-aligned, never overlaps bars)
    ctx.fillStyle = '#0f172a';
    const pctStr = (pct >= 9.95 || pct === 0) ? `${Math.round(pct)}%` : `${pct.toFixed(1)}%`;
    ctx.fillText(pctStr, valueX, yMid);
  });
}

function updateCharts() {
    drawPie('chart-learning-types', tallyDuration('.learning-type-select'));
    drawBars('chart-group-modes', tallyDurationMeta('.step-group-mode', 'group'));
    drawBars('chart-place-modes', tallyDurationMeta('.place-select', 'place'));
    drawBars('chart-time-modes', tallyDurationMeta('.time-select', 'time'));
    drawBars('chart-trainer-presence', tallyDurationMeta('.trainer-select', 'trainer'));
  }

  // Update on value changes (delegated, minimal footprint)
  document.addEventListener('change', (e) => {
    const t = e.target;
    if (!t) return;
    if (t.matches('.learning-type-select, .step-group-mode, .place-select, .time-select, .trainer-select')) {
      updateCharts();
    }
  }, true);

  // Update on DOM changes (activities added/removed)
  if (rootEl && window.MutationObserver) {
    const mo = new MutationObserver(() => updateCharts());
    mo.observe(rootEl, { childList: true, subtree: true });
  }

  // Initial render (after current call stack so layout has widths)
  setTimeout(updateCharts, 0);
})();



// ------------------------------
// Namespaces (organisation layer)
// ------------------------------
// This groups existing global functions under window.App.* without changing the UI
// or breaking inline event handlers that still reference legacy global names.
(function initNamespaces(){
  window.App = window.App || {};
  const App = window.App;

  const ensure = (k) => (App[k] = App[k] || {});
  const UI = ensure('UI');
  const Data = ensure('Data');
  const Export = ensure('Export');
  const Timeline = ensure('Timeline');
  const History = ensure('History');
  ensure('State');

  const pick = (target, mapping) => {
    for (const [name, fn] of Object.entries(mapping)) {
      if (typeof fn === 'function') target[name] = fn;
    }
  };

  // UI helpers (tooltips, focus, highlighting, contrast)
  pick(UI, {
    showTooltip,
    hideTooltip,
    updateTooltipPos,
    flashHighlight,
    scrollToEditor,
    updateFocusButtons,
    setHighContrastEnabled,
    updateContrastToggleUI,
    showJsErrorBanner
  });

  // Timeline rendering / stats
  pick(Timeline, {
    updateStats,
    updateStatsDebounced,
    getTotals,
    formatTimelineDuration,
    applyTimelineZoom,
    setTimelineZoom,
    bumpTimelineZoom,
    setupTimelineHScroll,
    updateTimelineHScroll,
    updateTimelineHScrollThumb
  });

  // Data (snapshot/restore/autosave)
  pick(Data, {
    snapshotProject,
    applySnapshot,
    buildExportProjectData,
    addActivityFromData,
    addStepToContainerFromData,
    saveProject,
    getAutosavePayload,
    hasAutosave,
    clearAutosave,
    scheduleAutosave
  });

  // History (undo/redo)
  pick(History, {
    undo,
    redo,
    scheduleHistoryCapture,
    historyCaptureNow
  });

  // Export routing
  pick(Export, {
    handleExport
  });

  // Seal namespaces to reduce accidental mutation.
  try {
    Object.seal(UI);
    Object.seal(Data);
    Object.seal(Export);
    Object.seal(Timeline);
    Object.seal(History);
  } catch (_) {}
})();



// =========================
// Modèles (templates) - Export / Import
// =========================
(function initTemplatesFeature() {
  const $ = (id) => document.getElementById(id);

  const root = document.getElementById('activities-root');

  let loadedTemplate = null; // {type, payload}

  function ensureInBody(el) {
    if (!el) return;
    try {
      if (!document.body.contains(el)) document.body.appendChild(el);
    } catch (_) {}
  }

  function show(el) {
    if (!el) return;
    ensureInBody(el);
    el.classList.remove('hidden');
    // Force visible display immediately (avoid "affichage retardé" sur certains WebView)
    const disp = el.dataset && el.dataset.display ? el.dataset.display : (el.classList.contains('items-center') ? 'flex' : 'block');
    el.style.display = disp;
    el.style.visibility = 'visible';
    el.style.pointerEvents = 'auto';
    // Force reflow to commit styles before returning
    void el.offsetHeight;
  }

  function hide(el) {
    if (!el) return;
    el.classList.add('hidden');
    el.style.display = 'none';
  }
  function setError(id, msg) {
    const el = $(id);
    if (!el) return;
    if (msg) { el.textContent = msg; show(el); } else { el.textContent = ''; hide(el); }
  }

  function safeText(v, fallback) {
    const s = (v ?? '').toString().trim();
    return s ? s : fallback;
  }

  function listModules() {
    return Array.from(document.querySelectorAll('.activity-group'));
  }

  function listMoments() {
    const modules = listModules();
    const out = [];
    modules.forEach((modEl, mi) => {
      const mt = safeText(modEl.querySelector('.activity-title')?.value, `Module ${mi + 1}`);
      const moments = Array.from(modEl.querySelectorAll('.moment-group'));
      moments.forEach((momEl, mosi) => {
        const tt = safeText(momEl.querySelector('.moment-title')?.value, `Moment ${mosi + 1}`);
        out.push({ modIndex: mi, momentIndex: mosi, modTitle: mt, momentTitle: tt, el: momEl, moduleEl: modEl });
      });
    });
    return out;
  }

  function listActivities() {
    const moments = listMoments();
    const out = [];
    moments.forEach((m) => {
      const steps = Array.from(m.el.querySelectorAll('.step-card'));
      steps.forEach((stepEl, si) => {
        const st = safeText(stepEl.querySelector('.step-input-title')?.value, `Activité ${si + 1}`);
        out.push({
          modIndex: m.modIndex, momentIndex: m.momentIndex, stepIndex: si,
          label: `${m.modTitle} — ${m.momentTitle} — ${st}`,
          el: stepEl, momentEl: m.el, moduleEl: m.moduleEl
        });
      });
    });
    return out;
  }

  function buildStepDataFromEl(stepEl) {
    return {
      title: stepEl.querySelector('.step-input-title')?.value || "",
      type: stepEl.querySelector('.learning-type-select')?.value || "acquisition",
      duration: parseFloat(stepEl.querySelector('.duration-input')?.value || "0") || 0,
      unit: stepEl.querySelector('.duration-unit')?.value || getDefaultDurationUnitKey?.() || "60"
    };
  }

  function buildMomentDataFromEl(momentEl) {
    const stepsContainer = momentEl.querySelector('.activity-steps-container');
    const stepEls = stepsContainer ? Array.from(stepsContainer.querySelectorAll('.step-card')) : [];
    return {
      title: momentEl.querySelector('.moment-title')?.value || "",
      description: momentEl.querySelector('.moment-description')?.value || "",
      targetTime: momentEl.querySelector('.moment-target-time')?.value || "",
      targetUnit: momentEl.querySelector('.moment-target-unit')?.value || (typeof getDefaultDurationUnitSecs === 'function' ? getDefaultDurationUnitSecs() : "60"),
      steps: stepEls.map(buildStepDataFromEl)
    };
  }

  function buildModuleDataFromEl(modEl) {
    const momentsRoot = modEl.querySelector('.activity-moments-container');
    const momentEls = momentsRoot ? Array.from(momentsRoot.querySelectorAll('.moment-group')) : [];
    return {
      title: modEl.querySelector('.activity-title')?.value || "",
      description: modEl.querySelector('.activity-description')?.value || "",
      targetTime: modEl.querySelector('.activity-target-time')?.value || "",
      targetUnit: modEl.querySelector('.activity-target-unit')?.value || (typeof getDefaultDurationUnitKey === 'function' ? getDefaultDurationUnitKey() : "60"),
      moments: momentEls.map(buildMomentDataFromEl)
    };
  }

  function downloadJSON(filename, obj) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 0);
  }

  function populateExportItems() {
    const type = $('template-export-type')?.value || 'module';
    const sel = $('template-export-item');
    if (!sel) return;
    sel.innerHTML = '';
    if (type === 'module') {
      const mods = listModules();
      mods.forEach((modEl, i) => {
        const label = safeText(modEl.querySelector('.activity-title')?.value, `Module ${i + 1}`);
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ modIndex: i });
        opt.textContent = label;
        sel.appendChild(opt);
      });
    } else if (type === 'moment') {
      const moms = listMoments();
      moms.forEach((m) => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ modIndex: m.modIndex, momentIndex: m.momentIndex });
        opt.textContent = `${m.modTitle} — ${m.momentTitle}`;
        sel.appendChild(opt);
      });
    } else {
      const acts = listActivities();
      acts.forEach((a) => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ modIndex: a.modIndex, momentIndex: a.momentIndex, stepIndex: a.stepIndex });
        opt.textContent = a.label;
        sel.appendChild(opt);
      });
    }
  }

  function openExport() {
    setError('template-export-error', '');
    populateExportItems();
    show($('template-export-modal'));
  }
  function closeExport() { hide($('template-export-modal')); }

  function openImport() {
    setError('template-import-error', '');
    const _tplLab = $('template-import-filelabel');
    if (_tplLab) _tplLab.textContent = '';
    loadedTemplate = null;
    hide($('template-import-placements'));
    hide($('tpl-place-module')); hide($('tpl-place-moment')); hide($('tpl-place-activity'));
    show($('template-import-modal'));
  }
  function closeImport() { hide($('template-import-modal')); }

  // API publique (utilisée par les attributs onclick des boutons "Modèles")
  // On expose volontairement des wrappers stables afin d'éviter toute dépendance au routeur global.
  function openTemplateExportModal() { return openExport(); }
  function openTemplateImportModal() { return openImport(); }
  window.__realOpenTemplateExport = openTemplateExportModal;
  window.__realOpenTemplateImport = openTemplateImportModal;
  if (typeof window.__flushPendingTemplateModal === 'function') window.__flushPendingTemplateModal();


  function exportTemplateNow() {
    setError('template-export-error', '');
    const type = $('template-export-type')?.value || 'module';
    const itemVal = $('template-export-item')?.value;
    if (!itemVal) { setError('template-export-error', "Aucun élément sélectionné."); return; }

    let path;
    try { path = JSON.parse(itemVal); } catch { setError('template-export-error', "Sélection invalide."); return; }

    let payload;
    try {
      if (type === 'module') {
        const modEl = listModules()[path.modIndex];
        if (!modEl) throw new Error("Module introuvable.");
        payload = buildModuleDataFromEl(modEl);
      } else if (type === 'moment') {
        const modEl = listModules()[path.modIndex];
        const momentEl = modEl?.querySelectorAll('.moment-group')?.[path.momentIndex];
        if (!momentEl) throw new Error("Moment introuvable.");
        payload = buildMomentDataFromEl(momentEl);
      } else {
        const modEl = listModules()[path.modIndex];
        const momentEl = modEl?.querySelectorAll('.moment-group')?.[path.momentIndex];
        const stepEl = momentEl?.querySelectorAll('.step-card')?.[path.stepIndex];
        if (!stepEl) throw new Error("Activité introuvable.");
        payload = buildStepDataFromEl(stepEl);
      }
    } catch (e) {
      setError('template-export-error', e?.message || "Erreur lors de l’export.");
      return;
    }

    const tpl = {
      templateVersion: "1.0",
      exportedAt: new Date().toISOString(),
      type,
      payload
    };
    const fn = `modele_${type}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    downloadJSON(fn, tpl);
    closeExport();
  }

  function populateModuleAfterSelect() {
    const sel = $('tpl-module-after');
    if (!sel) return;
    sel.innerHTML = '';
    listModules().forEach((modEl, i) => {
      const label = safeText(modEl.querySelector('.activity-title')?.value, `Module ${i + 1}`);
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = label;
      sel.appendChild(opt);
    });
  }

  function populateMomentPlacement() {
    const modSel = $('tpl-moment-module');
    const afterSel = $('tpl-moment-after');
    if (!modSel || !afterSel) return;

    modSel.innerHTML = '';
    listModules().forEach((modEl, i) => {
      const label = safeText(modEl.querySelector('.activity-title')?.value, `Module ${i + 1}`);
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = label;
      modSel.appendChild(opt);
    });

    const fillAfter = () => {
      afterSel.innerHTML = '';
      const mi = parseInt(modSel.value || "0", 10);
      const modEl = listModules()[mi];
      const moments = modEl ? Array.from(modEl.querySelectorAll('.moment-group')) : [];
      moments.forEach((momEl, j) => {
        const label = safeText(momEl.querySelector('.moment-title')?.value, `Moment ${j + 1}`);
        const opt = document.createElement('option');
        opt.value = String(j);
        opt.textContent = label;
        afterSel.appendChild(opt);
      });
    };
    modSel.onchange = fillAfter;
    fillAfter();
  }

  function populateActivityPlacement() {
    const modSel = $('tpl-act-module');
    const momSel = $('tpl-act-moment');
    const afterSel = $('tpl-act-after');
    if (!modSel || !momSel || !afterSel) return;

    modSel.innerHTML = '';
    listModules().forEach((modEl, i) => {
      const label = safeText(modEl.querySelector('.activity-title')?.value, `Module ${i + 1}`);
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = label;
      modSel.appendChild(opt);
    });

    const fillMoments = () => {
      momSel.innerHTML = '';
      const mi = parseInt(modSel.value || "0", 10);
      const modEl = listModules()[mi];
      const moments = modEl ? Array.from(modEl.querySelectorAll('.moment-group')) : [];
      moments.forEach((momEl, j) => {
        const label = safeText(momEl.querySelector('.moment-title')?.value, `Moment ${j + 1}`);
        const opt = document.createElement('option');
        opt.value = String(j);
        opt.textContent = label;
        momSel.appendChild(opt);
      });
      fillAfter();
    };

    const fillAfter = () => {
      afterSel.innerHTML = '';
      const mi = parseInt(modSel.value || "0", 10);
      const mosi = parseInt(momSel.value || "0", 10);
      const modEl = listModules()[mi];
      const momEl = modEl ? Array.from(modEl.querySelectorAll('.moment-group'))[mosi] : null;
      const steps = momEl ? Array.from(momEl.querySelectorAll('.step-card')) : [];
      steps.forEach((stepEl, k) => {
        const label = safeText(stepEl.querySelector('.step-input-title')?.value, `Activité ${k + 1}`);
        const opt = document.createElement('option');
        opt.value = String(k);
        opt.textContent = label;
        afterSel.appendChild(opt);
      });
    };

    modSel.onchange = fillMoments;
    momSel.onchange = fillAfter;
    fillMoments();
  }

  function applyPlacementUI(type) {
    const _tplType = $('template-import-type');
    if (_tplType) _tplType.textContent = type === 'module' ? 'Module' : (type === 'moment' ? 'Moment' : 'Activité');

    hide($('tpl-place-module')); hide($('tpl-place-moment')); hide($('tpl-place-activity'));

    if (type === 'module') {
      populateModuleAfterSelect();
      show($('tpl-place-module'));
    } else if (type === 'moment') {
      populateMomentPlacement();
      show($('tpl-place-moment'));
    } else {
      populateActivityPlacement();
      show($('tpl-place-activity'));
    }

    show($('template-import-placements'));
  }

  function readTemplateFile(file) {
    setError('template-import-error', '');
    if (!file) return;
    const label = $('template-import-filelabel');
    if (label) label.textContent = file.name;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(reader.result);
        if (!obj || typeof obj !== 'object') throw new Error("Fichier invalide.");
        if (!obj.type || !obj.payload) throw new Error("Modèle invalide (type/payload manquants).");
        if (!['module', 'moment', 'activity'].includes(obj.type)) throw new Error("Type de modèle inconnu.");
        loadedTemplate = { type: obj.type, payload: obj.payload };
        applyPlacementUI(obj.type);
      } catch (e) {
        loadedTemplate = null;
        hide($('template-import-placements'));
        setError('template-import-error', e?.message || "Impossible de lire le modèle.");
      }
    };
    reader.readAsText(file);
  }

  function insertModule(payload, position, afterIndex) {
    if (typeof addActivityFromData !== 'function') throw new Error("Fonction d’ajout de module introuvable.");
    addActivityFromData(payload);
    const newEl = root?.lastElementChild;
    if (!newEl) return;

    const modules = listModules();
    const targetIndex = (() => {
      if (position === 'start') return 0;
      if (position === 'end') return modules.length - 1; // already end
      if (position === 'after') return Math.min((afterIndex ?? 0) + 1, modules.length - 1);
      return modules.length - 1;
    })();

    // If already at end and target is end, nothing to do
    if (position === 'end') return;

    const ref = root.children[targetIndex];
    if (ref && ref !== newEl) root.insertBefore(newEl, ref);
  }

  function insertMoment(payload, moduleIndex, position, afterMomentIndex) {
    const modules = listModules();
    const modEl = modules[moduleIndex];
    if (!modEl) throw new Error("Module cible introuvable.");
    const momentsRoot = modEl.querySelector('.activity-moments-container');
    if (!momentsRoot) throw new Error("Conteneur de moments introuvable.");
    if (!window.momentTemplate) {
      // momentTemplate is a const in the outer scope, but in some builds it is not global; fallback to DOM lookup
    }
    const tpl = document.getElementById('moment-template');
    if (!tpl) throw new Error("Template de moment introuvable.");
    const clone = tpl.content.cloneNode(true);
    const momentEl = clone.querySelector('.moment-group') || clone.firstElementChild;
    // Fill fields
    momentEl.querySelector('.moment-title').value = payload.title || "";
    momentEl.querySelector('.moment-description').value = payload.description || "";
    momentEl.querySelector('.moment-target-time').value = payload.targetTime || "";
    const unitSel = momentEl.querySelector('.moment-target-unit');
    if (unitSel) unitSel.value = payload.targetUnit || (typeof getDefaultDurationUnitSecs === 'function' ? getDefaultDurationUnitSecs() : "60");

    const stepsContainer = momentEl.querySelector('.activity-steps-container');
    if (stepsContainer) {
      stepsContainer.innerHTML = '';
      if (Array.isArray(payload.steps)) {
        payload.steps.forEach(s => {
          if (typeof addStepToContainerFromData === 'function') addStepToContainerFromData(stepsContainer, s);
        });
      }
      if (typeof initSortableSteps === 'function') initSortableSteps(stepsContainer);
    }

    // Insert at right place
    const existing = Array.from(momentsRoot.querySelectorAll('.moment-group'));
    if (position === 'start') {
      momentsRoot.insertBefore(momentEl, existing[0] || null);
    } else if (position === 'after') {
      const ref = existing[afterMomentIndex] || null;
      if (ref && ref.nextSibling) momentsRoot.insertBefore(momentEl, ref.nextSibling);
      else momentsRoot.appendChild(momentEl);
    } else {
      momentsRoot.appendChild(momentEl);
    }

    if (typeof updateMomentIndexes === 'function') updateMomentIndexes(modEl);
  }

  function insertActivity(payload, moduleIndex, momentIndex, position, afterStepIndex) {
    const modules = listModules();
    const modEl = modules[moduleIndex];
    if (!modEl) throw new Error("Module cible introuvable.");
    const momentEl = Array.from(modEl.querySelectorAll('.moment-group'))[momentIndex];
    if (!momentEl) throw new Error("Moment cible introuvable.");
    const stepsContainer = momentEl.querySelector('.activity-steps-container');
    if (!stepsContainer) throw new Error("Conteneur d’activités introuvable.");

    const tpl = document.getElementById('step-template');
    if (!tpl) throw new Error("Template d’activité introuvable.");
    const clone = tpl.content.cloneNode(true);
    const stepEl = clone.querySelector('.step-card') || clone.firstElementChild;

    stepEl.querySelector('.step-input-title').value = payload.title || "";
    stepEl.querySelector('.learning-type-select').value = payload.type || "acquisition";
    stepEl.querySelector('.duration-input').value = payload.duration || 0;
    stepEl.querySelector('.duration-unit').value = payload.unit || (typeof getDefaultDurationUnitKey === 'function' ? getDefaultDurationUnitKey() : "60");

    const existing = Array.from(stepsContainer.querySelectorAll('.step-card'));
    if (position === 'start') {
      stepsContainer.insertBefore(stepEl, existing[0] || null);
    } else if (position === 'after') {
      const ref = existing[afterStepIndex] || null;
      if (ref && ref.nextSibling) stepsContainer.insertBefore(stepEl, ref.nextSibling);
      else stepsContainer.appendChild(stepEl);
    } else {
      stepsContainer.appendChild(stepEl);
    }

    if (typeof initSortableSteps === 'function') initSortableSteps(stepsContainer);
    if (typeof updateMomentIndexes === 'function') updateMomentIndexes(modEl);
  }

  function doImport() {
    setError('template-import-error', '');
    if (!loadedTemplate) { setError('template-import-error', "Aucun modèle chargé."); return; }

    try {
      if (loadedTemplate.type === 'module') {
        const pos = $('tpl-module-position')?.value || 'end';
        const afterIndex = parseInt($('tpl-module-after')?.value || "0", 10);
        insertModule(loadedTemplate.payload, pos, afterIndex);
      } else if (loadedTemplate.type === 'moment') {
        const modIndex = parseInt($('tpl-moment-module')?.value || "0", 10);
        const pos = $('tpl-moment-position')?.value || 'end';
        const afterIndex = parseInt($('tpl-moment-after')?.value || "0", 10);
        insertMoment(loadedTemplate.payload, modIndex, pos, afterIndex);
      } else {
        const modIndex = parseInt($('tpl-act-module')?.value || "0", 10);
        const momIndex = parseInt($('tpl-act-moment')?.value || "0", 10);
        const pos = $('tpl-act-position')?.value || 'end';
        const afterIndex = parseInt($('tpl-act-after')?.value || "0", 10);
        insertActivity(loadedTemplate.payload, modIndex, momIndex, pos, afterIndex);
      }

      if (typeof updateStats === 'function') updateStats();
      closeImport();
    } catch (e) {
      setError('template-import-error', e?.message || "Erreur lors de l’import.");
    }
  }


  // Expose minimal API for environments where click listeners are neutralised
  window.__realOpenTemplateExport = openExport;
  window.__realOpenTemplateImport = openImport;
  if (typeof window.__flushPendingTemplateModal === 'function') window.__flushPendingTemplateModal();

  // Assure un déclenchement immédiat des boutons Modèles, même si un routeur global intercepte les clics.
  // Strictement limité aux IDs des boutons Modèles pour éviter toute interférence avec les autres actions.

  // Bind UI (direct, no interaction with the global router)
  function bind() {
    // Toolbar buttons
    $('btn-template-export')?.addEventListener('click', openExport);
    $('btn-template-import')?.addEventListener('click', openImport);


// Export modal controls
    $('template-export-close')?.addEventListener('click', closeExport);
    $('template-export-cancel')?.addEventListener('click', closeExport);
    $('template-export-do')?.addEventListener('click', exportTemplateNow);
    $('template-export-type')?.addEventListener('change', populateExportItems);

    // Import modal controls
    $('template-import-close')?.addEventListener('click', closeImport);
    $('template-import-cancel')?.addEventListener('click', closeImport);
    $('template-import-do')?.addEventListener('click', doImport);
    $('template-import-pick')?.addEventListener('click', () => $('template-file-input')?.click());

    // File input
    $('template-file-input')?.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      readTemplateFile(f);
      e.target.value = '';
    });

    // Hide "after" selectors when not needed
    $('tpl-module-position')?.addEventListener('change', () => {
      const isAfter = $('tpl-module-position').value === 'after';
      $('tpl-module-after').disabled = !isAfter;
    });
    $('tpl-moment-position')?.addEventListener('change', () => {
      const isAfter = $('tpl-moment-position').value === 'after';
      $('tpl-moment-after').disabled = !isAfter;
    });
    $('tpl-act-position')?.addEventListener('change', () => {
      const isAfter = $('tpl-act-position').value === 'after';
      $('tpl-act-after').disabled = !isAfter;
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind, { once: true });
  } else {
    bind();
  }
})();

</script>
<div id="js-error-banner" style="display:none; position:fixed; bottom:12px; left:12px; right:12px; z-index:9999; background:#fee2e2; color:#7f1d1d; padding:8px 10px; border:1px solid #fecaca; border-radius:10px; font-size:12px; line-height:1.2; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; box-shadow:0 10px 30px rgba(15,23,42,0.15);">
<div style="display:flex; gap:10px; align-items:flex-start;">
<div style="flex:1;">
<div style="font-weight:700; margin-bottom:3px;">
      Erreur
     </div>
<div data-js-error-text="">
      Une erreur est survenue.
     </div>
</div>
<button aria-label="Fermer" onclick="document.getElementById('js-error-banner').style.display='none'" style="background:transparent; border:0; color:#7f1d1d; font-weight:700; cursor:pointer; padding:0 6px; line-height:1;" type="button">
     ×
    </button>
</div>
</div>
<!-- Modèles : Export / Import (DOM réel) -->
<div class="hidden fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4 no-print" data-display="flex" id="template-export-modal">
<div class="bg-white w-full max-w-xl rounded-xl shadow-xl border border-slate-200 overflow-hidden">
<div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
<div>
<div class="text-sm font-semibold text-slate-800">Exporter un modèle</div>
<div class="text-xs text-slate-500">Choisissez précisément l’élément à exporter.</div>
</div>
<button class="text-slate-500 hover:text-slate-800 px-2 py-1 rounded" id="template-export-close" type="button">✕</button>
</div>
<div class="p-4 space-y-4">
<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="text-xs font-medium text-slate-700">Niveau</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="template-export-type">
<option value="module">Module</option>
<option value="moment">Moment</option>
<option value="activity">Activité</option>
</select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Élément</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="template-export-item"></select>
</div>
</div>
<div class="flex items-center justify-end gap-2 pt-2">
<button class="px-3 py-1.5 rounded-md border border-slate-300 text-sm text-slate-700 hover:bg-slate-50" id="template-export-cancel" type="button">Annuler</button>
<button class="px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm hover:bg-indigo-700" id="template-export-do" type="button">Exporter</button>
</div>
<div class="hidden text-sm text-red-600" id="template-export-error"></div>
</div>
</div>
</div>
<!-- Modèles : Import -->
<div class="hidden fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4 no-print" data-display="flex" id="template-import-modal">
<div class="bg-white w-full max-w-2xl rounded-xl shadow-xl border border-slate-200 overflow-hidden">
<div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
<div>
<div class="text-sm font-semibold text-slate-800">Importer un modèle</div>
<div class="text-xs text-slate-500">Choisissez précisément où insérer le modèle.</div>
</div>
<button class="text-slate-500 hover:text-slate-800 px-2 py-1 rounded" id="template-import-close" type="button">✕</button>
</div>
<div class="p-4 space-y-4">
<div class="flex items-center gap-2">
<button class="px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm hover:bg-indigo-700" id="template-import-pick" type="button">Choisir un fichier…</button>
<div class="text-sm text-slate-600 truncate" id="template-import-filelabel"></div>
</div>
<div class="hidden space-y-3" id="template-import-placements">
<div class="text-xs text-slate-500">Type détecté : <span class="font-semibold text-slate-700" id="template-import-type"></span></div>
<!-- Placement module -->
<div class="hidden border border-slate-200 rounded-lg p-3" id="tpl-place-module">
<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="text-xs font-medium text-slate-700">Position</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-module-position">
<option value="start">Au début</option>
<option value="end">À la fin</option>
<option value="after">Après…</option>
</select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Module de référence</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-module-after"></select>
</div>
</div>
</div>
<!-- Placement moment -->
<div class="hidden border border-slate-200 rounded-lg p-3" id="tpl-place-moment">
<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
<div>
<label class="text-xs font-medium text-slate-700">Module cible</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-moment-module"></select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Position</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-moment-position">
<option value="start">Au début</option>
<option value="end">À la fin</option>
<option value="after">Après…</option>
</select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Moment de référence</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-moment-after"></select>
</div>
</div>
</div>
<!-- Placement activité -->
<div class="hidden border border-slate-200 rounded-lg p-3" id="tpl-place-activity">
<div class="grid grid-cols-1 md:grid-cols-4 gap-3">
<div>
<label class="text-xs font-medium text-slate-700">Module cible</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-act-module"></select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Moment cible</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-act-moment"></select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Position</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-act-position">
<option value="start">Au début</option>
<option value="end">À la fin</option>
<option value="after">Après…</option>
</select>
</div>
<div>
<label class="text-xs font-medium text-slate-700">Activité de référence</label>
<select class="mt-1 w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm" id="tpl-act-after"></select>
</div>
</div>
</div>
<div class="flex items-center justify-end gap-2 pt-2">
<button class="px-3 py-1.5 rounded-md border border-slate-300 text-sm text-slate-700 hover:bg-slate-50" id="template-import-cancel" type="button">Annuler</button>
<button class="px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm hover:bg-indigo-700" id="template-import-do" type="button">Importer</button>
</div>
<div class="hidden text-sm text-red-600" id="template-import-error"></div>
</div>
</div>
</div>
</div>
<!-- Fin Modèles (DOM réel) -->
</body>
</html>
