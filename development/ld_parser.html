<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOCX → Intermediate JSON (MVP) – Hybrid Parser + GenAI</title>

  <!-- Material-style typography & icons (loads from Google CDN) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    /* ===== Material 3-inspired tokens (CSS-only) ===== */
    :root{
      --md-sys-color-primary:#6750A4;
      --md-sys-color-on-primary:#FFFFFF;
      --md-sys-color-primary-container:#EADDFF;
      --md-sys-color-on-primary-container:#21005D;

      --md-sys-color-secondary:#625B71;
      --md-sys-color-on-secondary:#FFFFFF;
      --md-sys-color-secondary-container:#E8DEF8;
      --md-sys-color-on-secondary-container:#1D192B;

      --md-sys-color-error:#B3261E;

      --md-sys-color-background:#FFFBFE;
      --md-sys-color-on-background:#1C1B1F;

      --md-sys-color-surface:#FFFBFE;
      --md-sys-color-on-surface:#1C1B1F;
      --md-sys-color-surface-variant:#E7E0EC;
      --md-sys-color-on-surface-variant:#49454F;

      --md-sys-color-outline:#79747E;
      --md-sys-color-outline-variant:#CAC4D0;

      --md-sys-elevation-1: 0 1px 2px rgba(0,0,0,.20), 0 1px 3px rgba(0,0,0,.10);
      --md-sys-elevation-2: 0 2px 6px rgba(0,0,0,.18), 0 1px 2px rgba(0,0,0,.10);

      --md-sys-shape-corner-lg: 16px;
      --md-sys-shape-corner-md: 12px;

      --md-sys-state-hover: rgba(103,80,164,.08);
      --md-sys-state-focus: rgba(103,80,164,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: var(--md-sys-color-background);
      color: var(--md-sys-color-on-background);
    }

    /* ===== Top app bar ===== */
    .appbar{
      position:sticky; top:0; z-index:10;
      background: var(--md-sys-color-surface);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      box-shadow: var(--md-sys-elevation-1);
    }
    .appbar-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .appbar-title{display:flex; align-items:center; gap:10px; min-width:0;}
    .appbar-title .icon{
      width:40px; height:40px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      flex:0 0 auto;
    }
    .appbar-title h1{
      margin:0;
      font-size: 22px;
      font-weight: 700;
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .appbar-sub{
      margin:0;
      font-size: 13px;
      color: var(--md-sys-color-on-surface-variant);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .appbar-meta{display:flex; align-items:center; gap:10px; flex:0 0 auto;}

    /* ===== Layout ===== */
    .wrap{max-width: 1120px; margin: 0 auto; padding: 18px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px;}
    @media(min-width: 980px){ .grid.two{grid-template-columns: 1fr 1fr;} }

    /* ===== Cards ===== */
    .card{
      background: var(--md-sys-color-surface);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: var(--md-sys-shape-corner-lg);
      box-shadow: var(--md-sys-elevation-1);
      padding: 16px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .1px;
    }
    .muted{color: var(--md-sys-color-on-surface-variant)}
    .small{font-size: 12px; color: var(--md-sys-color-on-surface-variant)}
    .hr{height:1px; background: var(--md-sys-color-outline-variant); margin: 12px 0}

    /* ===== Status chip ===== */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: rgba(103,80,164,.06);
      color: var(--md-sys-color-on-surface);
      font-size: 12px;
      user-select:none;
    }
    .chip .dot{width:10px; height:10px; border-radius:999px; background: var(--md-sys-color-outline);}
    .chip.ok{background: rgba(65,145,112,.08)} .chip.ok .dot{background:#2E7D32}
    .chip.warn{background: rgba(255,193,7,.10)} .chip.warn .dot{background:#F9A825}
    .chip.bad{background: rgba(179,38,30,.10)} .chip.bad .dot{background: var(--md-sys-color-error)}

    /* ===== Buttons ===== */
    .btn-row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button{
      appearance:none;
      border: none;
      border-radius: 999px;
      font: 500 14px/1 Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      padding: 10px 14px;
      height: 40px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, box-shadow .15s ease, transform .05s ease;
      outline: none;
      white-space:nowrap;
    }
    button:active{transform: translateY(0.5px)}
    button:disabled{opacity:.45; cursor:not-allowed}

    .btn-filled{
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      box-shadow: var(--md-sys-elevation-1);
    }
    .btn-filled:hover{background: color-mix(in srgb, var(--md-sys-color-primary) 92%, black)}
    .btn-filled:focus-visible{box-shadow: 0 0 0 3px var(--md-sys-state-focus), var(--md-sys-elevation-1)}

    .btn-outlined{
      background: transparent;
      color: var(--md-sys-color-primary);
      border: 1px solid var(--md-sys-color-outline);
    }
    .btn-outlined:hover{background: var(--md-sys-state-hover)}
    .btn-outlined:focus-visible{box-shadow: 0 0 0 3px var(--md-sys-state-focus)}

    .btn-tonal{
      background: var(--md-sys-color-secondary-container);
      color: var(--md-sys-color-on-secondary-container);
    }
    .btn-tonal:hover{background: color-mix(in srgb, var(--md-sys-color-secondary-container) 88%, black)}
    .btn-tonal:focus-visible{box-shadow: 0 0 0 3px var(--md-sys-state-focus)}

    .ms{
      font-family: "Material Symbols Outlined";
      font-weight: 400;
      font-style: normal;
      font-size: 18px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: "liga";
      -webkit-font-smoothing: antialiased;
    }

    /* ===== Inputs ===== */
    .field label{
      display:block;
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
      margin-bottom: 6px;
    }
    .file-row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding: 10px;
      border: 1px dashed var(--md-sys-color-outline-variant);
      border-radius: var(--md-sys-shape-corner-md);
      background: rgba(103,80,164,.04);
    }
    .file-name{
      color: var(--md-sys-color-on-surface-variant);
      font-size: 13px;
      flex: 1 1 auto;
      min-width: 220px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    input[type=file]{display:none}

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: rgba(0,0,0,.03);
      color: var(--md-sys-color-on-surface-variant);
    }

    textarea{
      width:100%;
      min-height: 240px;
      padding: 12px 12px;
      border-radius: var(--md-sys-shape-corner-md);
      border: 1px solid var(--md-sys-color-outline-variant);
      background: rgba(0,0,0,.02);
      color: var(--md-sys-color-on-surface);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.45;
      outline: none;
    }
    textarea:focus{
      border-color: var(--md-sys-color-primary);
      box-shadow: 0 0 0 3px var(--md-sys-state-focus);
      background: #fff;
    }

    /* Preview tables */
    table{width:100%; border-collapse:collapse; margin-top:8px; font-size: 13px}
    th,td{padding:8px 10px; border-bottom:1px solid var(--md-sys-color-outline-variant); vertical-align:top}
    th{color: var(--md-sys-color-on-surface-variant); font-weight: 700; text-align:left}
    .pill{
      display:inline-flex; align-items:center;
      padding: 2px 10px;
      border-radius: 999px;
      border:1px solid var(--md-sys-color-outline-variant);
      background: rgba(0,0,0,.02);
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
    }
    .footer{
      margin-top: 16px;
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
    }
  
    /* ===== Stepper / visual workflow cues ===== */
    .stepper{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 8px;
    }
    .step{
      display:flex;
      gap:12px;
      padding: 12px 12px;
      border-radius: var(--md-sys-shape-corner-md);
      border: 1px solid var(--md-sys-color-outline-variant);
      background: rgba(0,0,0,.015);
    }
    .step:hover{ background: rgba(103,80,164,.035); }
    .step-left{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding-top: 2px;
      width: 30px;
      flex:0 0 auto;
    }
    .step-icon{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: #fff;
      color: var(--md-sys-color-on-surface-variant);
      font-size: 12px;
      font-weight: 700;
    }
    .step.done .step-icon{
      background: rgba(103,80,164,.10);
      border-color: rgba(103,80,164,.35);
      color: var(--md-sys-color-primary);
    }
    .step.active{
      border-color: rgba(103,80,164,.40);
      box-shadow: 0 0 0 3px var(--md-sys-state-focus);
      background: rgba(103,80,164,.05);
    }
    .step-line{
      width: 2px;
      flex: 1 1 auto;
      background: var(--md-sys-color-outline-variant);
      border-radius: 999px;
    }
    .step.done .step-line{ background: rgba(103,80,164,.35); }
    .step-content{ flex:1 1 auto; min-width:0; }
    .step-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 0;
      font-weight: 700;
      font-size: 14px;
    }
    .step-desc{ margin:6px 0 0 0; color: var(--md-sys-color-on-surface-variant); font-size: 12px; }
    .step-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .step-note{
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px dashed var(--md-sys-color-outline-variant);
      border-radius: var(--md-sys-shape-corner-md);
      background: rgba(0,0,0,.01);
    }
    .step-check{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      color: var(--md-sys-color-on-surface-variant);
      font-size: 12px;
    }
    .step-check input{ width:16px; height:16px; accent-color: var(--md-sys-color-primary); }
    .callout{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 12px 12px;
      border-radius: var(--md-sys-shape-corner-md);
      background: rgba(103,80,164,.06);
      border: 1px solid rgba(103,80,164,.18);
      color: var(--md-sys-color-on-surface);
      margin-top: 10px;
    }
    .callout .ms{ margin-top: 2px; color: var(--md-sys-color-primary); }

  </style>
</head>

<body>
  <div class="appbar">
    <div class="appbar-inner">
      <div class="appbar-title">
        <div class="icon" aria-hidden="true"><span class="ms">description</span></div>
        <div style="min-width:0">
          <h1>DOCX → Intermediate JSON</h1>
          <p class="appbar-sub">Deterministic parsing → GenAI transform → validation/repair</p>
        </div>
      </div>

      <div class="appbar-meta">
        <div id="statusChip" class="chip">
          <span id="statusDot" class="dot"></span>
          <span id="statusText">Idle</span>
        </div>
        <div class="pill" title="Loads Mammoth.js from CDN (internet required on first load)">Mammoth.js (CDN)</div>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="card" id="workflowCard">
      <h2>Guided workflow</h2>
      <p class="muted" style="margin-top:0">
        Follow the steps below. Each step highlights what to do next, and the buttons jump to the relevant action.
      </p>

      <div class="stepper" role="list" aria-label="Workflow steps">
        <div class="step" id="step1" role="listitem">
          <div class="step-left">
            <div class="step-icon" id="step1Icon">1</div>
            <div class="step-line"></div>
          </div>
          <div class="step-content">
            <div class="step-title">
              <span>Select your DOCX</span>
              <span class="pill" id="step1State">Required</span>
            </div>
            <p class="step-desc">Choose the Word file to parse. The app will extract tables/sections deterministically.</p>
            <div class="step-actions">
              <button class="btn-outlined" id="step1Action"><span class="ms">upload_file</span>Choose DOCX</button>
              <span class="small" id="step1Hint">No file selected.</span>
            </div>
          </div>
        </div>

        <div class="step" id="step2" role="listitem">
          <div class="step-left">
            <div class="step-icon" id="step2Icon">2</div>
            <div class="step-line"></div>
          </div>
          <div class="step-content">
            <div class="step-title">
              <span>Add a reference JSON (optional)</span>
              <span class="pill" id="step2State">Recommended</span>
            </div>
            <p class="step-desc">Upload a JSON export from your Learning Designer. This constrains the GenAI output to your expected keys.</p>
            <div class="step-actions">
              <button class="btn-outlined" id="step2Action"><span class="ms">data_object</span>Choose JSON</button>
              <span class="small" id="step2Hint">Optional.</span>
            </div>
          </div>
        </div>

        <div class="step" id="step3" role="listitem">
          <div class="step-left">
            <div class="step-icon" id="step3Icon">3</div>
            <div class="step-line"></div>
          </div>
          <div class="step-content">
            <div class="step-title">
              <span>Extract intermediate JSON</span>
              <span class="pill" id="step3State">In-app</span>
            </div>
            <p class="step-desc">Click Extract. You will get a stable intermediate JSON + two prompts (TRANSFORM/REPAIR).</p>
            <div class="step-actions">
              <button class="btn-filled" id="step3Action" disabled><span class="ms">play_arrow</span>Extract</button>
              <span class="small" id="step3Hint">Select a DOCX first.</span>
            </div>
          </div>
        </div>

        <div class="step" id="step4" role="listitem">
          <div class="step-left">
            <div class="step-icon" id="step4Icon">4</div>
            <div class="step-line"></div>
          </div>
          <div class="step-content">
            <div class="step-title">
              <span>Run GenAI TRANSFORM</span>
              <span class="pill" id="step4State">External</span>
            </div>
            <p class="step-desc">Copy the TRANSFORM prompt and run it in your GenAI tool. It will produce an importable project JSON and (if supported) export a file.</p>
            <div class="step-actions">
              <button class="btn-outlined" id="step4Action" disabled><span class="ms">content_copy</span>Copy TRANSFORM</button>
              <label class="step-check"><input type="checkbox" id="step4Check">Mark done</label>
            </div>
            <div class="step-note">
              <strong>Tip:</strong> Paste the GenAI output JSON into a <span class="kbd">.json</span> file and import it into your Learning Designer.
            </div>
          </div>
        </div>

        <div class="step" id="step5" role="listitem">
          <div class="step-left">
            <div class="step-icon" id="step5Icon">5</div>
            <div class="step-line"></div>
          </div>
          <div class="step-content">
            <div class="step-title">
              <span>Import into your Learning Designer</span>
              <span class="pill" id="step5State">External</span>
            </div>
            <p class="step-desc">Import the project JSON. If the import fails, use the REPAIR step below.</p>
            <div class="step-actions">
              <label class="step-check"><input type="checkbox" id="step5Check">Mark done</label>
            </div>
          </div>
        </div>

        <div class="step" id="step6" role="listitem">
          <div class="step-left">
            <div class="step-icon" id="step6Icon">6</div>
          </div>
          <div class="step-content">
            <div class="step-title">
              <span>If import fails: REPAIR</span>
              <span class="pill" id="step6State">Fallback</span>
            </div>
            <p class="step-desc">Copy the REPAIR prompt. In GenAI, provide (1) the rejected JSON and (2) the import error/logs. It returns a corrected JSON.</p>
            <div class="step-actions">
              <button class="btn-outlined" id="step6Action" disabled><span class="ms">content_copy</span>Copy REPAIR</button>
              <label class="step-check"><input type="checkbox" id="step6Check">Mark done</label>
            </div>
          </div>
        </div>
      </div>

      <div class="callout" role="note" aria-label="Privacy note">
        <span class="ms">shield</span>
        <div>
          <div style="font-weight:700">Privacy / data handling</div>
          <div class="small" style="margin-top:4px">
            The parsing step runs locally in your browser. Only the content you paste into a GenAI tool leaves your device.
          </div>
        </div>
      </div>
    </div>


    <div class="card">
      <h2>Inputs</h2>
      <p class="muted" style="margin-top:0">
        Runs locally in your browser (no server upload). Best results with a stable Word template (headings + an “Activities” table).
      </p>

      <div class="grid two">
        <div class="field">
          <label>1) Word file <span class="kbd">.docx</span></label>
          <div class="file-row">
            <label for="docxInput" class="btn-outlined" style="display:inline-flex; align-items:center; gap:8px; padding:10px 14px">
              <span class="ms">upload_file</span>Choose DOCX
            </label>
            <input id="docxInput" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"/>
            <div id="docxName" class="file-name">No file selected</div>
          </div>
          <div class="small" style="margin-top:8px">Keep Activities headers consistent (Activity/Time/Teacher/Learner/Resources).</div>
        </div>

        <div class="field">
          <label>2) Reference JSON <span class="kbd">.json</span> <span class="small">(optional, recommended)</span></label>
          <div class="file-row">
            <label for="refJsonInput" class="btn-outlined" style="display:inline-flex; align-items:center; gap:8px; padding:10px 14px">
              <span class="ms">data_object</span>Choose JSON
            </label>
            <input id="refJsonInput" type="file" accept=".json,application/json"/>
            <div id="refJsonName" class="file-name">No file selected</div>
          </div>
          <div class="small" style="margin-top:8px">Derives a schema signature (expected keys) to constrain the GenAI prompt.</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="btn-row">
        <button id="btnExtract" class="btn-filled" disabled><span class="ms">play_arrow</span>Extract</button>
        <button id="btnDownloadIntermediate" class="btn-tonal" disabled><span class="ms">download</span>Download intermediate</button>
        <button id="btnCopyTransform" class="btn-outlined" disabled><span class="ms">content_copy</span>Copy TRANSFORM prompt</button>
        <button id="btnCopyRepair" class="btn-outlined" disabled><span class="ms">content_copy</span>Copy REPAIR prompt</button>
      </div>

      <div class="small" style="margin-top:10px">
        Flow: Extract → Copy TRANSFORM → run in ChatGPT with the intermediate JSON → import output into your Learning Designer → if import fails, use REPAIR.
      </div>
    </div>

    <div class="grid two" style="margin-top:16px">
      <div class="card">
        <h2>Extraction preview</h2>
        <div id="previewArea" class="small">No data yet.</div>
      </div>

      <div class="card">
        <h2>Intermediate JSON</h2>
        <textarea id="intermediateOut" placeholder="Intermediate JSON will appear here…"></textarea>
      </div>
    </div>

    <div class="grid two" style="margin-top:16px">
      <div class="card">
        <h2>TRANSFORM prompt</h2>
        <p class="small" style="margin-top:-2px">Intermediate → importable project JSON (strict enums, strict structure).</p>
        <textarea id="promptTransform" placeholder="TRANSFORM prompt will appear here…"></textarea>
      </div>

      <div class="card">
        <h2>REPAIR prompt</h2>
        <p class="small" style="margin-top:-2px">Use if the output JSON is rejected or the import logs show structural errors.</p>
        <textarea id="promptRepair" placeholder="REPAIR prompt will appear here…"></textarea>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Quick validation (minimal)</h2>
      <p class="muted" style="margin-top:0">Paste the final JSON produced by GenAI to check basic keys and step type enums.</p>
      <textarea id="finalJsonIn" placeholder="Paste final JSON here…"></textarea>
      <div class="btn-row" style="margin-top:10px">
        <button id="btnValidate" class="btn-outlined"><span class="ms">fact_check</span>Validate</button>
        <span id="validationResult" class="small"></span>
      </div>
      <div id="validationDetails" class="small" style="margin-top:10px"></div>
    </div>

    <div class="footer">
      <strong>Note:</strong> This MVP uses heuristics (“Activities” table detection via headers). For production: add manual table selection fallback, style-based mapping, multilingual header dictionaries, and corpus tests.
    </div>
  </div>

  <!-- Mammoth browser bundle -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      docxFile: null,
      refJson: null,
      intermediate: null,
      prompts: { transform: "", repair: "" }
    };

    const ALLOWED_TYPES = ["acquisition","collaboration","discussion","investigation","practice","production"];
    // ===== Guided stepper (visual cues) =====
    const LS_KEY = "docx_parser_mvp_stepper_v1";

    function loadStepperState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return { step4:false, step5:false, step6:false };
        const o = JSON.parse(raw);
        return {
          step4: !!o.step4,
          step5: !!o.step5,
          step6: !!o.step6
        };
      } catch(e){
        return { step4:false, step5:false, step6:false };
      }
    }

    function saveStepperState(s){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(s)); } catch(e){}
    }

    let stepperState = loadStepperState();

    function setStepClass(stepEl, done, active){
      if(!stepEl) return;
      stepEl.classList.toggle("done", !!done);
      stepEl.classList.toggle("active", !!active);
    }

    function setStepIcon(iconEl, n, done){
      if(!iconEl) return;
      if(done){
        iconEl.innerHTML = '<span class="ms" style="font-size:18px">check</span>';
      }else{
        iconEl.textContent = String(n);
      }
    }

    function updateStepper(){
      const hasDocx = !!state.docxFile;
      const hasRef = !!state.refJson;
      const hasIntermediate = !!state.intermediate;

      // External checklist steps (user-controlled)
      const s4 = !!stepperState.step4;
      const s5 = !!stepperState.step5;
      const s6 = !!stepperState.step6;

      // Decide "next" active step
      let next = 1;
      if(hasDocx) next = 2;
      if(hasDocx && (hasRef || true)) next = 3; // step2 is optional
      if(hasIntermediate) next = 4;
      if(hasIntermediate && s4) next = 5;
      if(hasIntermediate && s4 && s5) next = 6;
      if(hasIntermediate && s4 && s5 && s6) next = 0;

      // Step 1
      setStepClass($("step1"), hasDocx, next===1);
      setStepIcon($("step1Icon"), 1, hasDocx);
      $("step1State").textContent = "Required";
      $("step1Hint").textContent = hasDocx ? state.docxFile.name : "No file selected.";

      // Step 2 (optional)
      setStepClass($("step2"), hasRef, next===2);
      setStepIcon($("step2Icon"), 2, hasRef);
      $("step2State").textContent = hasRef ? "Loaded" : "Recommended";
      $("step2Hint").textContent = hasRef ? "Reference JSON loaded." : "Optional (improves schema constraints).";

      // Step 3
      const canExtract = hasDocx;
      setStepClass($("step3"), hasIntermediate, next===3);
      setStepIcon($("step3Icon"), 3, hasIntermediate);
      $("step3Action").disabled = !canExtract;
      $("step3Hint").textContent = hasIntermediate ? "Intermediate JSON generated." : (canExtract ? "Ready to extract." : "Select a DOCX first.");

      // Step 4
      setStepClass($("step4"), s4, next===4);
      setStepIcon($("step4Icon"), 4, s4);
      $("step4Action").disabled = !hasIntermediate;
      $("step4Check").checked = s4;

      // Step 5
      setStepClass($("step5"), s5, next===5);
      setStepIcon($("step5Icon"), 5, s5);
      $("step5Check").checked = s5;

      // Step 6
      setStepClass($("step6"), s6, next===6);
      setStepIcon($("step6Icon"), 6, s6);
      $("step6Action").disabled = !hasIntermediate;
      $("step6Check").checked = s6;
    }

    function wireStepperActions(){
      // Step action buttons trigger existing controls
      $("step1Action")?.addEventListener("click", () => $("docxInput").click());
      $("step2Action")?.addEventListener("click", () => $("refJsonInput").click());
      $("step3Action")?.addEventListener("click", () => $("btnExtract").click());
      $("step4Action")?.addEventListener("click", () => $("btnCopyTransform").click());
      $("step6Action")?.addEventListener("click", () => $("btnCopyRepair").click());

      // Checkboxes
      $("step4Check")?.addEventListener("change", (e) => {
        stepperState.step4 = !!e.target.checked;
        saveStepperState(stepperState);
        updateStepper();
      });
      $("step5Check")?.addEventListener("change", (e) => {
        stepperState.step5 = !!e.target.checked;
        saveStepperState(stepperState);
        updateStepper();
      });
      $("step6Check")?.addEventListener("change", (e) => {
        stepperState.step6 = !!e.target.checked;
        saveStepperState(stepperState);
        updateStepper();
      });
    }


    function setStatus(kind, text){
      const chip = $("statusChip");
      chip.classList.remove("ok","warn","bad");
      if(kind) chip.classList.add(kind);
      $("statusText").textContent = text || "";
    }

    function norm(s){
      return (s || "")
        .replace(/\u00A0/g," ")
        .replace(/\s+/g," ")
        .trim()
        .toLowerCase();
    }

    function parseMinutes(raw){
      const s = (raw || "").toString().trim();
      if(!s) return "";
      const mH = s.match(/(\d+)\s*h(?:\s*(\d+))?/i);
      if(mH){
        const h = parseInt(mH[1],10);
        const mn = mH[2] ? parseInt(mH[2],10) : 0;
        return String(h*60 + mn);
      }
      const m = s.match(/(\d+(?:[.,]\d+)?)/);
      if(!m) return "";
      const v = parseFloat(m[1].replace(",","."));
      if(Number.isFinite(v)) return String(Math.round(v));
      return "";
    }

    function tableHeaders(table){
      const row = table.querySelector("tr");
      if(!row) return [];
      return Array.from(row.querySelectorAll("th,td")).map(td => norm(td.textContent));
    }

    function scoreActivitiesTable(headers){
      let score = 0;
      const has = (k) => headers.some(h => h.includes(k));
      if(has("activity") || has("activité") || has("activite")) score += 4;
      if(has("time") || has("temps") || has("durée") || has("duree")) score += 3;
      if(has("teacher") || has("enseignant") || has("formateur")) score += 2;
      if(has("student") || has("learner") || has("apprenant") || has("pupil")) score += 2;
      if(has("resources") || has("ressource") || has("matériel") || has("materiel")) score += 1;
      if(headers.length < 3) score -= 2;
      return score;
    }

    function pickBestTable(tables, scorer){
      let best = null;
      let bestScore = -1e9;
      for(const t of tables){
        const headers = tableHeaders(t);
        const score = scorer(headers, t);
        if(score > bestScore){
          bestScore = score;
          best = { table: t, headers, score };
        }
      }
      return best;
    }

    function extractKeyValueTable(tables){
      const KEY_HINTS = ["title","titre","topic","thème","theme","author","auteur","age","time","temps","duration","durée","duree","language","langue","country","pays","school","école","ecole","aim","objectif","keywords","mots-clés","mots cles","subject","discipline"];
      function scorer(headers, table){
        const rows = Array.from(table.querySelectorAll("tr"));
        let score = 0;
        let twoCol = 0;
        for(const r of rows){
          const cells = Array.from(r.querySelectorAll("td,th"));
          if(cells.length === 2) twoCol++;
          if(cells.length >= 1){
            const k = norm(cells[0].textContent);
            if(KEY_HINTS.some(h => k.includes(h))) score += 2;
          }
        }
        if(twoCol >= 4) score += 3;
        const n = rows.length;
        if(n > 2 && n < 40) score += 1;
        return score;
      }
      const best = pickBestTable(tables, scorer);
      if(!best || best.score < 3) return null;

      const out = {};
      const rows = Array.from(best.table.querySelectorAll("tr"));
      for(const r of rows){
        const cells = Array.from(r.querySelectorAll("td,th"));
        if(cells.length !== 2) continue;
        const kRaw = cells[0].textContent || "";
        const vRaw = cells[1].textContent || "";
        const k = norm(kRaw).replace(/[:：]+$/,"").trim();
        const v = (vRaw || "").replace(/\s+/g," ").trim();
        if(!k) continue;
        out[k] = v;
      }
      return { tableScore: best.score, data: out };
    }

    function extractActivities(tables){
      const best = pickBestTable(tables, (headers, t) => scoreActivitiesTable(headers));
      if(!best || best.score < 4) return { rows: [], info: "Activities table not detected (heuristics)." };

      const headers = best.headers;
      const mapCol = (nameCandidates) => {
        for(let i=0;i<headers.length;i++){
          const h = headers[i];
          if(nameCandidates.some(c => h.includes(c))) return i;
        }
        return -1;
      };

      const colActivity = mapCol(["activity","activité","activite"]);
      const colTime = mapCol(["time","temps","durée","duree"]);
      const colTeacher = mapCol(["teacher","enseignant","formateur"]);
      const colLearner = mapCol(["student","learner","apprenant","pupil","élève","eleve"]);
      const colResources = mapCol(["resources","ressource","matériel","materiel","tools","outils"]);

      const rows = Array.from(best.table.querySelectorAll("tr")).slice(1);
      const out = [];
      for(const r of rows){
        const cells = Array.from(r.querySelectorAll("td,th"));
        if(cells.length < 2) continue;

        const get = (idx) => (idx >= 0 && idx < cells.length) ? (cells[idx].textContent || "").replace(/\s+/g," ").trim() : "";
        const title = get(colActivity >= 0 ? colActivity : 0);
        const timeRaw = get(colTime >= 0 ? colTime : 1);
        const teacher = get(colTeacher);
        const learner = get(colLearner);
        const resources = get(colResources);

        if(!title && !timeRaw && !teacher && !learner && !resources) continue;

        out.push({
          title,
          time_minutes: parseMinutes(timeRaw),
          time_raw: timeRaw,
          teacher_activity: teacher,
          learner_activity: learner,
          resources,
          raw: cells.map(c => (c.textContent || "").replace(/\s+/g," ").trim())
        });
      }
      return { rows: out, info: `Activities table detected (score ${best.score}).` };
    }

    function extractSectionsFromText(plainText){
      const t = (plainText || "").replace(/\r/g,"");
      const markers = [
        {key:"aim", names:["aim","objectif","objectifs"]},
        {key:"trends", names:["trends","tendances"]},
        {key:"skills", names:["21st century skills","compétences du 21","competences du 21"]},
        {key:"assessment", names:["assessment","évaluation","evaluation"]},
        {key:"subject", names:["subject","discipline"]},
      ];

      const out = {};
      for(const m of markers){
        for(const n of m.names){
          const reInline = new RegExp("\\b"+n.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")+"\\b\\s*[:：]\\s*([\\s\\S]{0,2000})","i");
          const mm = reInline.exec(t);
          if(mm){
            const chunk = mm[1];
            let stop = chunk.length;
            for(const m2 of markers){
              for(const n2 of m2.names){
                if(m2.key === m.key) continue;
                const reStop = new RegExp("\\n\\s*"+n2.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")+"\\b\\s*[:：]","i");
                const s = reStop.exec(chunk);
                if(s && s.index < stop) stop = s.index;
              }
            }
            out[m.key] = chunk.slice(0, stop).trim();
            break;
          }
        }
      }
      return out;
    }

    function schemaSignatureFromReference(ref){
      if(!ref || typeof ref !== "object") return null;
      const sig = {
        topLevelKeys: Object.keys(ref || {}).sort(),
        version: ref.version || "",
        schemaVersion: ref.schemaVersion || "",
        hasI18n: !!ref.i18n,
        parametresKeys: ref.parametres ? Object.keys(ref.parametres).sort() : [],
        moduleKeys: Array.isArray(ref.modules) && ref.modules[0] ? Object.keys(ref.modules[0]).sort() : [],
        momentKeys: (() => {
          const m = Array.isArray(ref.modules) && ref.modules[0] && Array.isArray(ref.modules[0].moments) && ref.modules[0].moments[0];
          return m ? Object.keys(m).sort() : [];
        })(),
        subMomentKeys: (() => {
          const sm = Array.isArray(ref.modules) && ref.modules[0] && Array.isArray(ref.modules[0].moments) && ref.modules[0].moments[0] &&
                    Array.isArray(ref.modules[0].moments[0].subMoments) && ref.modules[0].moments[0].subMoments[0];
          return sm ? Object.keys(sm).sort() : [];
        })(),
        stepKeys: (() => {
          const st = Array.isArray(ref.modules) && ref.modules[0] && Array.isArray(ref.modules[0].moments) && ref.modules[0].moments[0] &&
                    Array.isArray(ref.modules[0].moments[0].subMoments) && ref.modules[0].moments[0].subMoments[0] &&
                    Array.isArray(ref.modules[0].moments[0].subMoments[0].steps) && ref.modules[0].moments[0].subMoments[0].steps[0];
          return st ? Object.keys(st).sort() : [];
        })()
      };
      return sig;
    }

    function buildPromptTransform(intermediate, schemaSig){
      const sigText = schemaSig ? JSON.stringify(schemaSig, null, 2) : "";
      const intermediateText = JSON.stringify(intermediate, null, 2);
      const outFileName = ((intermediate && intermediate.source && intermediate.source.filename) ? intermediate.source.filename.replace(/\.docx$/i,"") : "learning_scenario") + "_project.json";

      return `
You are a STRICT converter: “intermediate learning-scenario JSON” → “importable Learning Designer project JSON”.

CRITICAL CONSTRAINTS:
- Output MUST be ONLY valid JSON (no markdown, no commentary).
- Do NOT invent factual content. If data is missing, use "" (empty string) or [] depending on the field.
- step.type MUST be one of: ${ALLOWED_TYPES.map(x=>`"${x}"`).join(", ")}.
- Durations: encode as minutes (strings) and use unit "60" where the interface expects a unit.
- Structure: follow the schema signature below (top-level keys + modules/moments/subMoments/steps).
- Segment into coherent moments without inventing new content.

SCHEMA SIGNATURE (derived from reference JSON if provided):
${sigText || "(not provided — use: version, schemaVersion, exportedAt, i18n, parametres, modules)"}

INPUT (intermediate JSON):
${intermediateText}

EXPECTED OUTPUT:
- A project JSON importable in the Learning Designer interface, including at minimum:
  version, schemaVersion, exportedAt, (i18n if used in reference), parametres, modules[].
- Each module has moments[]; each moment has subMoments[]; each subMoment has steps[].
- Populate teacher/learner/resources/notes from the intermediate, without excessive rewriting.

FILE EXPORT:
- Also export/attach a file named: ${outFileName} that contains EXACTLY the same JSON.
- The visible response content must remain ONLY the JSON (no extra text, no markdown).
- If file export is not supported in your environment, skip the export and just output the JSON.
`.trim();
    }

    function buildPromptRepair(schemaSig){
      const sigText = schemaSig ? JSON.stringify(schemaSig, null, 2) : "";
      return `
You are a STRICT JSON repair agent.

Goal: make a Learning Designer project JSON importable.

CONSTRAINTS:
- Output MUST be ONLY valid JSON (no markdown, no commentary).
- Do NOT change the meaning. Only fix: structure, missing keys, wrong field types, out-of-enum values.
- step.type MUST be one of: ${ALLOWED_TYPES.map(x=>`"${x}"`).join(", ")}.
- Durations: minutes + unit "60" when needed.
- Follow this schema signature:

${sigText || "(not provided — keep existing top-level keys and align modules/moments/subMoments/steps)"}

INPUTS I WILL PROVIDE AFTER THIS PROMPT:
1) JSON rejected by the interface
2) Import error / logs

Task:
- Diagnose errors, fix JSON, and return corrected JSON compliant with the signature.
`.trim();
    }

    function renderPreview(intermediate, activitiesInfo){
      if(!intermediate){ $("previewArea").textContent = "No data yet."; return; }

      const doc = intermediate.document || {};
      const sections = intermediate.sections || {};
      const acts = Array.isArray(intermediate.activities) ? intermediate.activities : [];

      const esc = (s) => (s||"").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

      let html = `<div class="small"><span class="pill">Source</span> ${esc(intermediate.source?.filename || "")} &nbsp; <span class="pill">Activities</span> ${acts.length} &nbsp; <span class="pill">Heuristic</span> ${esc(activitiesInfo || "")}</div>`;
      html += `<div class="hr"></div>`;
      html += `<table><tbody>`;
      const pairs = [
        ["Title", doc.title || ""],
        ["Age / level", doc.age_range || ""],
        ["Duration (raw)", doc.time_raw || ""],
        ["Language", doc.language || ""],
        ["Author(s)", doc.authors || ""]
      ];
      for(const [k,v] of pairs){
        if(!v) continue;
        html += `<tr><th style="width:180px">${esc(k)}</th><td>${esc(v)}</td></tr>`;
      }
      html += `</tbody></table>`;

      const secKeys = Object.keys(sections||{});
      if(secKeys.length){
        html += `<div class="hr"></div>`;
        html += `<table><tbody>`;
        for(const k of secKeys){
          const v = sections[k];
          html += `<tr><th style="width:180px">${esc(k)}</th><td>${esc((v||"").slice(0,260))}${(v||"").length>260?"…":""}</td></tr>`;
        }
        html += `</tbody></table>`;
      }

      if(acts.length){
        html += `<div class="hr"></div><div class="small"><span class="pill">Top activities</span></div>`;
        html += `<table><thead><tr><th>Activity</th><th>Min</th><th>Resources</th></tr></thead><tbody>`;
        acts.slice(0,8).forEach(a => {
          html += `<tr><td>${esc(a.title||"")}</td><td>${esc(a.time_minutes||"")}</td><td>${esc((a.resources||"").slice(0,120))}${(a.resources||"").length>120?"…":""}</td></tr>`;
        });
        html += `</tbody></table>`;
      }

      $("previewArea").innerHTML = html;
    }

    function makeIntermediate(docxName, kv, sections, activities, rawHtml){
      const pick = (cands) => {
        for(const c of cands){
          for(const k of Object.keys(kv || {})){
            if(norm(k) === norm(c) || norm(k).includes(norm(c))) return kv[k];
          }
        }
        return "";
      };

      const title = pick(["title","titre"]) || "";
      const authors = pick(["author","auteur","auteurs"]) || "";
      const age = pick(["age","âge","age range"]) || "";
      const timeRaw = pick(["time","temps","duration","durée","duree"]) || "";
      const language = pick(["language","langue"]) || "";

      return {
        source: {
          filename: docxName || "",
          parsedAt: new Date().toISOString(),
          parser: "parseur_docx_hybride_mvp_material.html"
        },
        meta: {
          kv_pairs: kv || {},
          extraction_notes: [
            "Intermediate produced without pedagogical interpretation.",
            "Fields may be empty if the Word file does not follow a stable template."
          ]
        },
        document: { title, authors, age_range: age, time_raw: timeRaw, language },
        sections: sections || {},
        activities: activities || [],
        raw: { mammoth_html: rawHtml || "" }
      };
    }

    async function readJsonFile(file){
      const txt = await file.text();
      return JSON.parse(txt);
    }

    async function extractFromDocx(file){
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.convertToHtml({arrayBuffer: arrayBuffer});
      const html = result.value || "";
      const doc = new DOMParser().parseFromString(html, "text/html");

      const tables = Array.from(doc.querySelectorAll("table"));
      const kvTable = extractKeyValueTable(tables);
      const kv = kvTable ? kvTable.data : {};

      const plainText = (doc.body && doc.body.textContent) ? doc.body.textContent : "";
      const sections = extractSectionsFromText(plainText);

      const acts = extractActivities(tables);
      const intermediate = makeIntermediate(file.name, kv, sections, acts.rows, html);

      return { intermediate, activitiesInfo: acts.info, mammothMessages: result.messages || [] };
    }

    function updateButtons(){
      $("btnExtract").disabled = !state.docxFile;
      const hasIntermediate = !!state.intermediate;
      $("btnDownloadIntermediate").disabled = !hasIntermediate;
      $("btnCopyTransform").disabled = !hasIntermediate;
      $("btnCopyRepair").disabled = !hasIntermediate;
    }

    function downloadJson(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    async function copyToClipboard(text){
      await navigator.clipboard.writeText(text);
    }

    function validateFinalJson(obj){
      const issues = [];
      if(!obj || typeof obj !== "object") issues.push("Root is not an object.");
      const topKeys = obj ? Object.keys(obj) : [];
      for(const k of ["version","schemaVersion","parametres","modules"]){
        if(!topKeys.includes(k)) issues.push(`Missing top-level key: "${k}".`);
      }

      const badTypes = [];
      try{
        const modules = Array.isArray(obj.modules) ? obj.modules : [];
        for(const mod of modules){
          const moments = Array.isArray(mod.moments) ? mod.moments : [];
          for(const mo of moments){
            const subs = Array.isArray(mo.subMoments) ? mo.subMoments : [];
            for(const sm of subs){
              const steps = Array.isArray(sm.steps) ? sm.steps : [];
              for(const st of steps){
                if(st && typeof st === "object" && st.type){
                  if(!ALLOWED_TYPES.includes(st.type)) badTypes.push(st.type);
                }
              }
            }
          }
        }
      } catch(e){
        issues.push("Unable to inspect modules/moments/subMoments/steps (unexpected structure).");
      }
      if(badTypes.length){
        issues.push(`Disallowed step.type values: ${Array.from(new Set(badTypes)).join(", ")}.`);
      }
      return issues;
    }

    $("docxInput").addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      state.docxFile = f || null;
      $("docxName").textContent = f ? f.name : "No file selected";
      if(state.docxFile){ setStatus("warn", "DOCX selected — ready"); }
      else { setStatus("", "Idle"); }
      updateButtons();
    });
      updateStepper();

    $("refJsonInput").addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      $("refJsonName").textContent = f ? f.name : "No file selected";
      if(!f){ state.refJson = null; return; }
      try{ state.refJson = await readJsonFile(f); setStatus("warn", "Reference JSON loaded"); }
      updateStepper();
      catch(err){ state.refJson = null; setStatus("bad", "Invalid reference JSON"); }
      updateStepper();
    });

    $("btnExtract").addEventListener("click", async () => {
      if(!state.docxFile) return;
      setStatus("warn", "Extracting…");
      $("previewArea").textContent = "Extracting…";
      try{
        const { intermediate, activitiesInfo, mammothMessages } = await extractFromDocx(state.docxFile);
        state.intermediate = intermediate;

        const schemaSig = schemaSignatureFromReference(state.refJson);
        state.prompts.transform = buildPromptTransform(intermediate, schemaSig);
        state.prompts.repair = buildPromptRepair(schemaSig);

        $("intermediateOut").value = JSON.stringify(intermediate, null, 2);
        $("promptTransform").value = state.prompts.transform;
        $("promptRepair").value = state.prompts.repair;

        renderPreview(intermediate, activitiesInfo);
        if(mammothMessages && mammothMessages.length){ setStatus("warn", "Extracted (Mammoth warnings)"); }
        else { setStatus("ok", "Extracted"); }
        updateStepper();
      } catch(err){
        console.error(err);
        setStatus("bad", "Extraction failed (see console)");
        $("previewArea").textContent = "Error: " + (err && err.message ? err.message : String(err));
      }
      updateButtons();
    });
      updateStepper();

    $("btnDownloadIntermediate").addEventListener("click", () => {
      if(!state.intermediate) return;
      const fn = (state.intermediate.source?.filename || "scenario").replace(/\.docx$/i,"");
      downloadJson(state.intermediate, fn + "_intermediate.json");
    });

    $("btnCopyTransform").addEventListener("click", async () => {
      if(!state.prompts.transform) return;
      try{ await copyToClipboard(state.prompts.transform); setStatus("ok","TRANSFORM copied"); stepperState.step4 = true; saveStepperState(stepperState); updateStepper(); }
      catch(e){ setStatus("bad","Copy failed (browser permissions)"); }
    });

    $("btnCopyRepair").addEventListener("click", async () => {
      if(!state.prompts.repair) return;
      try{ await copyToClipboard(state.prompts.repair); setStatus("ok","REPAIR copied"); stepperState.step6 = true; saveStepperState(stepperState); updateStepper(); }
      catch(e){ setStatus("bad","Copy failed (browser permissions)"); }
    });

    $("btnValidate").addEventListener("click", () => {
      const txt = $("finalJsonIn").value || "";
      $("validationDetails").textContent = "";
      try{
        const obj = JSON.parse(txt);
        const issues = validateFinalJson(obj);
        if(!issues.length){
          $("validationResult").textContent = "OK — no issues detected by this minimal check.";
          $("validationResult").style.color = "#2E7D32";
        } else {
          $("validationResult").textContent = "Warnings: " + issues.length;
          $("validationResult").style.color = "#F9A825";
          $("validationDetails").innerHTML = "<ul>" + issues.map(x=>"<li>"+x.replaceAll("<","&lt;")+"</li>").join("") + "</ul>";
        }
      } catch(err){
        $("validationResult").textContent = "Invalid JSON.";
        $("validationResult").style.color = "var(--md-sys-color-error)";
        $("validationDetails").textContent = err && err.message ? err.message : String(err);
      }
    });

    updateButtons();
    wireStepperActions();
    updateStepper();
  </script>
</body>
</html>
