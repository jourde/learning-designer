<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Designer AI Enhancement Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .prompt-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .section-card {
            transition: all 0.2s ease;
        }
        .section-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .upload-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        .upload-zone.dragover {
            border-color: #4f46e5;
            background-color: #e0e7ff;
        }
        .field-row {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .field-row:hover {
            background-color: #f8fafc;
        }
        .progress-bar {
            height: 1.25rem;
            border-radius: 0.375rem;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-3">Learning Designer AI Enhancement Tool</h1>
            <p class="text-gray-600 text-lg mb-4">Enhance your learning design using AI-powered analysis and content generation</p>
            
            <!-- Workflow Overview -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-indigo-200 rounded-lg p-5 mt-4">
                <h2 class="font-semibold text-indigo-900 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    How it works
                </h2>
                <div class="grid md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg p-3 border border-indigo-100">
                        <div class="font-bold text-indigo-600 mb-1">1. Upload</div>
                        <div class="text-sm text-gray-700">Upload your JSON export from Learning Designer</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-indigo-100">
                        <div class="font-bold text-indigo-600 mb-1">2. Select</div>
                        <div class="text-sm text-gray-700">Choose which categories and fields to enhance</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-indigo-100">
                        <div class="font-bold text-indigo-600 mb-1">3. Generate</div>
                        <div class="text-sm text-gray-700">Get a customized AI prompt with your requirements</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-indigo-100">
                        <div class="font-bold text-indigo-600 mb-1">4. Use with AI</div>
                        <div class="text-sm text-gray-700">Copy the prompt and use it with Generative AI chatbot</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JSON Upload Section -->
        <div id="uploadSection" class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Step 1: Upload Your JSON File</h2>
            <div id="dropZone" class="upload-zone rounded-lg p-12 text-center cursor-pointer">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg font-medium text-gray-700 mb-2">Drop your JSON file here</p>
                <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                <input type="file" id="fileInput" accept=".json" class="hidden">
                <button type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium">
                    Choose File
                </button>
            </div>
            <div id="fileInfo" class="mt-4 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-green-800 font-medium">âœ“ File loaded: <span id="fileName"></span></p>
                </div>
            </div>
        </div>

        <!-- Analysis Section (hidden until JSON loaded) -->
        <div id="analysisSection" class="hidden mb-6">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Step 2: Design Analysis</h2>
                
                <!-- Structure Overview -->
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                        </svg>
                        <h3 class="font-semibold text-indigo-900">Training Structure</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-blue-50 rounded-lg p-3 text-center border border-blue-200">
                            <div class="text-2xl font-bold text-blue-600" id="moduleCount">0</div>
                            <div class="text-xs text-blue-800">Modules</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-3 text-center border border-purple-200">
                            <div class="text-2xl font-bold text-purple-600" id="momentCount">0</div>
                            <div class="text-xs text-purple-800">Moments</div>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-3 text-center border border-amber-200">
                            <div class="text-2xl font-bold text-amber-600" id="submomentCount">0</div>
                            <div class="text-xs text-amber-800">Submoments</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 text-center border border-green-200">
                            <div class="text-2xl font-bold text-green-600" id="activityCount">0</div>
                            <div class="text-xs text-green-800">Activities</div>
                        </div>
                    </div>
                </div>

                <!-- Field Analysis -->
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-indigo-800">How to select fields for enhancement</h3>
                            <div class="mt-2 text-sm text-indigo-700">
                                <p class="mb-2"><strong>Step 1:</strong> Select one or more categories below (e.g., "Training Information", "Content & Structure", "Pedagogical Elements"). Your selections are tracked in real-time.</p>
                                <p class="mb-2"><strong>Step 2:</strong> Within each selected category, tick the specific fields you want the AI to enhance. The progress bars show completion status.</p>
                                <p class="mb-2"><strong>Note:</strong> You can enhance both general training parameters (name, objectives, tools) and specific content (modules, moments, activities).</p>
                                <p><strong>Default:</strong> Nothing is selected by default - choose exactly what you want enhanced based on your needs.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Selection -->
                <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900">Select Enhancement Categories</h3>
                            <p class="text-xs text-gray-600 mt-1">
                                <span id="selectionSummary" class="font-medium text-indigo-600">No selections yet</span>
                            </p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="selectAllCategories()" class="text-xs px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">
                                Select All Categories
                            </button>
                            <button onclick="deselectAllCategories()" class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
                                Deselect All
                            </button>
                        </div>
                    </div>
                    <div id="categoryContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div id="fieldsContainer" class="mb-6"></div>

                <!-- Learning Types Distribution -->
                <div id="typesContainer" class="mb-6"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="configSection" class="hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Left: Configuration -->
                <div class="space-y-4">
                    <!-- Base Instructions -->
                    <div class="bg-white rounded-lg shadow p-6 section-card">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="bg-indigo-100 text-indigo-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">3</span>
                            Customise Enhancement Options
                        </h2>
                        <p class="text-sm text-gray-600 bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4">
                            Select which fields to enhance in Step 2 above, then add optional requirements below.
                        </p>
                    </div>

                    <!-- Optional Additions -->
                    <div class="bg-white rounded-lg shadow p-6 section-card">
                        <h3 class="font-semibold text-gray-800 mb-4">Optional Requirements</h3>
                        
                        <!-- Output Language -->
                        <div class="mb-4 pb-4 border-b border-gray-200">
                            <label class="block mb-2">
                                <span class="text-gray-700 font-medium flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/>
                                    </svg>
                                    Output Language
                                </span>
                            </label>
                            <select id="languageSelect" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="en">English</option>
                                <option value="fr">FranÃ§ais</option>
                                <option value="es">EspaÃ±ol</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="pt">PortuguÃªs</option>
                                <option value="nl">Nederlands</option>
                                <option value="pl">Polski</option>
                                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                <option value="zh">ä¸­æ–‡</option>
                                <option value="ja">æ—¥æœ¬èªž</option>
                                <option value="ko">í•œêµ­ì–´</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2" id="detectedLangNote">
                                Detected from JSON: <span id="detectedLangDisplay" class="font-semibold">-</span>
                            </p>
                        </div>
                        
                        <!-- Focus Area -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="focusCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Focus on specific module/moment</span>
                            </label>
                            <select id="focusSelect" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                                <option value="">Select from your design...</option>
                            </select>
                        </div>

                        <!-- Activity Priority -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="activityCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Prioritise specific activity type</span>
                            </label>
                            <select id="activitySelect" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                                <option value="">Select activity type...</option>
                                <option value="collaborative">Collaborative activities</option>
                                <option value="acquisition">Acquisition activities</option>
                                <option value="discussion">Discussion activities</option>
                                <option value="investigation">Investigation activities</option>
                                <option value="practice">Practice activities</option>
                                <option value="production">Production activities</option>
                            </select>
                        </div>

                        <!-- Target Audience -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="audienceCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Specify pupil level/age group</span>
                            </label>
                            <input type="text" id="audienceInput" placeholder="e.g., University undergraduates or Ages 14-16" 
                                   class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                                   disabled>
                        </div>

                        <!-- Duration Constraint -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="durationCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Set total duration limit</span>
                            </label>
                            <div class="mt-2 flex gap-2">
                                <input type="number" id="durationInput" placeholder="24" min="1"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                                       disabled>
                                <select id="durationUnit" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                                    <option value="hours">hours</option>
                                    <option value="minutes">minutes</option>
                                    <option value="days">days</option>
                                </select>
                            </div>
                        </div>

                        <!-- Specific Tools -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="toolsCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Include specific tools/technologies</span>
                            </label>
                            <input type="text" id="toolsInput" placeholder="e.g., Moodle, Padlet, Google Workspace" 
                                   class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                                   disabled>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button onclick="updatePrompt()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 transform hover:scale-105">
                        Generate Prompt
                    </button>
                </div>

                <!-- Right: Generated Prompt -->
                <div class="bg-white rounded-lg shadow-lg p-6 section-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="bg-indigo-100 text-indigo-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">4</span>
                            Your Prompt
                        </h2>
                        <button onclick="copyPrompt()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-200 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <div id="promptOutput" class="prompt-box p-4 rounded-lg min-h-[500px] max-h-[700px] overflow-y-auto">
                        Upload your JSON file to generate a customised prompt.
                    </div>
                    <div id="copyFeedback" class="mt-3 text-green-600 font-medium text-sm hidden">
                        âœ“ Copied to clipboard!
                    </div>
                    
                    <!-- What's Next Instructions -->
                    <div class="mt-6 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            What's Next?
                        </h3>
                        <ol class="text-sm text-green-800 space-y-2 ml-2">
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">1.</span>
                                <span><strong>Copy the prompt</strong> using the button above</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">2.</span>
                                <span><strong>Go to Claude.ai</strong> (or use the Claude API)</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">3.</span>
                                <span><strong>Upload your JSON file</strong> to Claude</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">4.</span>
                                <span><strong>Paste the prompt</strong> into the conversation</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">5.</span>
                                <span><strong>Get your enhanced JSON</strong> from Claude's response</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">6.</span>
                                <span><strong>Import it back</strong> into Learning Designer</span>
                            </li>
                        </ol>
                        <div class="mt-3 pt-3 border-t border-green-200">
                            <p class="text-xs text-green-700">
                                ðŸ’¡ <strong>Tip:</strong> Claude works best with Claude Sonnet 3.5 or newer models for this type of complex JSON enhancement task.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p class="mb-2">Upload your JSON export to analyse field completion and generate a customised AI enhancement prompt.</p>
            <p class="text-xs">ðŸ’¡ This tool helps you create the perfect prompt for Claude AI to enhance your learning design content while preserving structure.</p>
        </div>
    </div>

    <script>
        let learningData = null;
        let analysisResults = null;
        let selectedFields = new Set();
        let selectedCategories = new Set();
        let detectedLanguage = null;

        // Helper functions for category selection
        function selectAllCategories() {
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                cb.checked = true;
                selectedCategories.add(cb.value);
            });
            updateFieldVisibility();
            updateSelectionSummary();
            updatePrompt();
        }

        function deselectAllCategories() {
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedCategories.clear();
            selectedFields.clear();
            document.querySelectorAll('.field-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateFieldVisibility();
            updateSelectionSummary();
            updatePrompt();
        }

        function updateFieldVisibility() {
            document.querySelectorAll('.field-category-section').forEach(section => {
                const category = section.dataset.category;
                if (selectedCategories.has(category) || selectedCategories.size === 0) {
                    section.style.display = '';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function updateSelectionSummary() {
            const summaryEl = document.getElementById('selectionSummary');
            if (!summaryEl) return;
            
            const catCount = selectedCategories.size;
            const fieldCount = selectedFields.size;
            
            if (catCount === 0 && fieldCount === 0) {
                summaryEl.textContent = 'No selections yet - select categories to begin';
                summaryEl.className = 'font-medium text-gray-500';
            } else if (catCount > 0 && fieldCount === 0) {
                summaryEl.textContent = `${catCount} ${catCount === 1 ? 'category' : 'categories'} selected - now select specific fields`;
                summaryEl.className = 'font-medium text-amber-600';
            } else {
                summaryEl.textContent = `${catCount} ${catCount === 1 ? 'category' : 'categories'}, ${fieldCount} ${fieldCount === 1 ? 'field' : 'fields'} selected`;
                summaryEl.className = 'font-medium text-green-600';
            }
        }

        // Field definitions organized by categories
        const fieldCategories = {
            'Training Information': ['nom', 'theme', 'auteurs', 'formateurs', 'niveau', 'modalite', 'tailleCohorte', 'description'],
            'Target Audience & Prerequisites': ['publicCible', 'prerequis'],
            'Learning Outcomes & Objectives': ['objectives', 'learningOutcomes', 'competences', 'objectifs', 'resultatsTexte'],
            'Resources & Tools': ['resources', 'notes', 'outilsMateriel', 'outilsMaterielNotes'],
            'Content & Structure': ['title', 'description'],
            'Pedagogical Elements': ['objective', 'tasks', 'learningType']
        };

        const fieldDefinitions = {
            training: {
                nom: 'Training Name',
                theme: 'Theme',
                auteurs: 'Authors',
                formateurs: 'Trainers',
                niveau: 'Level',
                publicCible: 'Target Audience',
                prerequis: 'Prerequisites',
                outilsMateriel: 'Tools & Materials',
                outilsMaterielNotes: 'Tools & Materials Notes',
                modalite: 'Modality (in-person/online/blended)',
                tailleCohorte: 'Cohort Size',
                objectifs: 'Training Objectives',
                resultatsTexte: 'Expected Learning Outcomes',
                description: 'Training Description'
            },
            module: {
                title: 'Title',
                description: 'Description',
                notes: 'Notes',
                objectives: 'Learning Objectives',
                learningOutcomes: 'Learning Outcomes',
                competences: 'Competences'
            },
            moment: {
                title: 'Title',
                description: 'Description'
            },
            submoment: {
                title: 'Title',
                description: 'Description'
            },
            activity: {
                title: 'Title',
                description: 'Description',
                objective: 'Objective',
                tasks: 'Tasks/Instructions',
                notes: 'Notes',
                resources: 'Resources/Links',
                learningType: 'Learning Type'
            }
        };

        // Get category for a field
        function getFieldCategory(fieldKey) {
            for (const [category, fields] of Object.entries(fieldCategories)) {
                if (fields.includes(fieldKey)) return category;
            }
            return 'Other';
        }

        // Base prompt template
        const basePrompt = `I'm uploading a JSON file: My current learning design export from Learning Designer.

**Your Task:**
Analyse and enhance the learning design by improving the quality and completeness of existing content. Do NOT create any new structural elements (no new modules, moments, submoments, or activities).

**Technical Constraints (CRITICAL):**
- Preserve ALL technical fields: IDs, durations, units, status codes, counts, timestamps
- Maintain the exact JSON structure and hierarchy
- Keep all existing field names in their original language (French/English mix is normal)
- Do not modify: id, unite, uniteDureeCible, etat, status, regroupement, formateur, lieu, temps
- The output must be valid JSON that can be directly reimported

**Enhancement Guidelines:**

1. **Content Quality:**
   - Make titles clear, specific, and descriptive
   - Expand brief descriptions into actionable, detailed explanations
   - Ensure objectives are measurable and aligned with Bloom's taxonomy
   - Make tasks/instructions concrete and step-by-step
   - Add relevant, specific resources and tools where missing

2. **Pedagogical Coherence:**
   - Ensure logical progression within and across modules/moments
   - Verify alignment between objectives, activities, and learning outcomes
   - Balance learning types (acquisition, collaboration, discussion, investigation, practice, production)
   - Ensure appropriate scaffolding and complexity progression
   - Make implicit pedagogical intentions explicit

3. **Completeness:**
   - Fill empty or placeholder fields with meaningful content
   - Replace generic statements with specific, contextual information
   - Ensure all activities have clear objectives and instructions
   - Add missing pedagogical rationale in notes where helpful

4. **Contextual Appropriateness:**
   - Respect the training's target audience, level, and modality
   - Ensure language is appropriate for the specified audience
   - Consider prerequisites and build upon them
   - Align with stated competences and learning outcomes

**What NOT to do:**
- Do not create new modules, moments, submoments, or activities
- Do not delete or merge existing elements
- Do not change technical/structural fields
- Do not translate field names or keys
- Do not add fields that don't exist in the original schema

**Output Requirements:**
1. The complete enhanced JSON file (valid and importable)
2. A concise summary of key improvements made, organized by category`;

        function getLanguageInstruction() {
            const langSelect = document.getElementById('languageSelect');
            const selectedLang = langSelect ? langSelect.value : detectedLanguage;
            
            const languageNames = {
                'en': 'English',
                'fr': 'French',
                'es': 'Spanish',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese',
                'nl': 'Dutch',
                'pl': 'Polish',
                'ar': 'Arabic',
                'zh': 'Chinese',
                'ja': 'Japanese',
                'ko': 'Korean'
            };
            
            const langName = languageNames[selectedLang] || selectedLang;
            return `\n\n**Output Language:** ${langName}\nAll enhanced content values (titles, descriptions, objectives, etc.) must be written in ${langName}. Field names and technical keys remain unchanged.`;
        }

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');

        fileInput.addEventListener('change', handleFileSelect);
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                alert('Please select a JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    learningData = JSON.parse(e.target.result);
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileInfo').classList.remove('hidden');
                    analyseDesign();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function analyseDesign() {
            if (!learningData) return;

            // Detect language from JSON
            detectedLanguage = 'en'; // default
            if (learningData.i18n && learningData.i18n.currentLang) {
                detectedLanguage = learningData.i18n.currentLang;
            } else if (learningData.i18n && learningData.i18n.defaultLang) {
                detectedLanguage = learningData.i18n.defaultLang;
            }
            
            // Set language selector to detected language
            const langSelect = document.getElementById('languageSelect');
            if (langSelect) {
                langSelect.value = detectedLanguage;
            }

            const analysis = {
                moduleCount: 0,
                momentCount: 0,
                submomentCount: 0,
                activityCount: 0,
                fields: {
                    training: {},
                    module: {},
                    moment: {},
                    submoment: {},
                    activity: {}
                },
                learningTypes: {
                    none: 0,
                    acquisition: 0,
                    collaboration: 0,
                    discussion: 0,
                    investigation: 0,
                    practice: 0,
                    production: 0
                },
                modules: [],
                moments: []
            };

            // Helper to check if field is filled
            const isFilled = (value) => {
                if (!value) return false;
                const str = String(value).trim();
                if (str === '') return false;
                if (str.toLowerCase().includes('aucun')) return false;
                if (str === 'none' || str === 'null' || str === 'undefined') return false;
                // Check for arrays
                if (Array.isArray(value)) {
                    return value.length > 0 && !value.every(v => 
                        String(v).toLowerCase().includes('aucun') || 
                        String(v).toLowerCase().includes('none')
                    );
                }
                return true;
            };

            // Helper to track field status
            const trackField = (level, fieldName, value) => {
                if (!analysis.fields[level][fieldName]) {
                    analysis.fields[level][fieldName] = { filled: 0, unfilled: 0, total: 0 };
                }
                analysis.fields[level][fieldName].total++;
                if (isFilled(value)) {
                    analysis.fields[level][fieldName].filled++;
                } else {
                    analysis.fields[level][fieldName].unfilled++;
                }
            };

            // Analyse training parameters
            if (learningData.parametres) {
                const params = learningData.parametres;
                trackField('training', 'nom', params.nom);
                trackField('training', 'theme', params.theme);
                trackField('training', 'auteurs', params.auteurs);
                trackField('training', 'formateurs', params.formateurs);
                trackField('training', 'niveau', params.niveau);
                trackField('training', 'publicCible', params.publicCible);
                trackField('training', 'prerequis', params.prerequis);
                trackField('training', 'outilsMateriel', params.outilsMateriel);
                trackField('training', 'outilsMaterielNotes', params.outilsMaterielNotes);
                trackField('training', 'modalite', params.modalite);
                trackField('training', 'tailleCohorte', params.tailleCohorte);
                trackField('training', 'objectifs', params.objectifs);
                trackField('training', 'resultatsTexte', params.resultatsTexte);
                trackField('training', 'description', params.description);
            }

            // Analyse modules
            if (learningData.modules && Array.isArray(learningData.modules)) {
                analysis.moduleCount = learningData.modules.length;
                
                learningData.modules.forEach((module, mIdx) => {
                    const moduleName = module.title || module.titre || `Module ${mIdx + 1}`;
                    analysis.modules.push({ id: module.id || mIdx, name: moduleName });

                    // Track module fields
                    trackField('module', 'title', module.title || module.titre);
                    trackField('module', 'description', module.description);
                    trackField('module', 'notes', module.notes);
                    trackField('module', 'objectives', module.objectifsApprentissageModule);
                    trackField('module', 'learningOutcomes', module.resultatsApprentissageModule);
                    trackField('module', 'competences', module.competencesModuleSujet);

                    // Analyse moments
                    if (module.moments && Array.isArray(module.moments)) {
                        analysis.momentCount += module.moments.length;
                        
                        module.moments.forEach((moment, momIdx) => {
                            const momentName = moment.title || moment.titre || `Moment ${momIdx + 1}`;
                            analysis.moments.push({ 
                                id: moment.id || `${module.id}-${momIdx}`, 
                                name: `${moduleName} > ${momentName}`,
                                moduleId: module.id || mIdx
                            });

                            // Track moment fields
                            trackField('moment', 'title', moment.title || moment.titre);
                            trackField('moment', 'description', moment.description);

                            // Function to analyse activities
                            const analyseActivities = (activities) => {
                                if (!activities || !Array.isArray(activities)) return;
                                
                                analysis.activityCount += activities.length;
                                
                                activities.forEach((activity) => {
                                    // Track activity fields
                                    trackField('activity', 'title', activity.title || activity.titre);
                                    trackField('activity', 'description', activity.description);
                                    trackField('activity', 'objective', activity.objective || activity.objectifActivite);
                                    trackField('activity', 'tasks', activity.tasks || activity.aFaire);
                                    trackField('activity', 'notes', activity.notes);
                                    trackField('activity', 'resources', activity.linksReferences || activity.liensReferences);
                                    
                                    // Track learning type
                                    const type = activity.learningType || activity.type || 'none';
                                    trackField('activity', 'learningType', (type !== 'none' && type !== '') ? type : null);
                                    
                                    // Count learning types for distribution
                                    if (analysis.learningTypes.hasOwnProperty(type)) {
                                        analysis.learningTypes[type]++;
                                    } else {
                                        analysis.learningTypes.none++;
                                    }
                                });
                            };

                            // Check for submoments
                            const submoments = moment.sousMoments || moment.submoments || moment.subMoments;
                            if (submoments && Array.isArray(submoments)) {
                                analysis.submomentCount += submoments.length;
                                
                                submoments.forEach((submoment) => {
                                    // Track submoment fields
                                    trackField('submoment', 'title', submoment.title || submoment.titre);
                                    trackField('submoment', 'description', submoment.description);
                                    
                                    // Analyse activities in submoment
                                    analyseActivities(submoment.activites);
                                    analyseActivities(submoment.activities);
                                    analyseActivities(submoment.steps);
                                });
                            }
                        });
                    }
                });
            }

            analysisResults = analysis;
            displayAnalysis(analysis);
        }

        function displayAnalysis(analysis) {
            // Show counts
            document.getElementById('moduleCount').textContent = analysis.moduleCount;
            document.getElementById('momentCount').textContent = analysis.momentCount;
            document.getElementById('submomentCount').textContent = analysis.submomentCount;
            document.getElementById('activityCount').textContent = analysis.activityCount;

            // Display category checkboxes
            const categoryContainer = document.getElementById('categoryContainer');
            let categoryHTML = '';
            
            const categoryDescriptions = {
                'Training Information': 'General training details: name, theme, authors, trainers, level, modality, cohort size. Example: "Enhance the training name to be more descriptive and appealing"',
                'Target Audience & Prerequisites': 'Who is the training for and what they need to know. Example: "Add specific prerequisite skills and tools learners should master beforehand"',
                'Learning Outcomes & Objectives': 'What learners will achieve at all levels (training, modules, activities). Example: "Make objectives measurable using action verbs (analyze, create, evaluate)"',
                'Resources & Tools': 'Materials, links, software, and supporting documentation. Example: "Add specific tool names, website URLs, or document references"',
                'Content & Structure': 'Titles and descriptions that organize and explain content. Example: "Transform vague titles into clear, descriptive ones"',
                'Pedagogical Elements': 'Learning approaches, task instructions, and activity types. Example: "Add step-by-step instructions and specify collaboration methods"'
            };

            Object.entries(fieldCategories).forEach(([category, fields]) => {
                categoryHTML += `
                    <label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition">
                        <input type="checkbox" 
                               value="${category}" 
                               class="category-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 mt-1 mr-3">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 text-sm">${category}</div>
                            <div class="text-xs text-gray-600 mt-1">${categoryDescriptions[category]}</div>
                        </div>
                    </label>
                `;
            });
            
            categoryContainer.innerHTML = categoryHTML;

            // Add event listeners to category checkboxes
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedCategories.add(e.target.value);
                    } else {
                        selectedCategories.delete(e.target.value);
                    }
                    updateFieldVisibility();
                    updateSelectionSummary();
                    updatePrompt();
                });
            });

            // Display field analysis grouped by category and level
            const fieldsContainer = document.getElementById('fieldsContainer');
            let fieldsHTML = '';

            const levelColors = {
                training: { bg: 'bg-indigo-50', border: 'border-indigo-200', title: 'text-indigo-900', bar: 'bg-indigo-500' },
                module: { bg: 'bg-blue-50', border: 'border-blue-200', title: 'text-blue-900', bar: 'bg-blue-500' },
                moment: { bg: 'bg-purple-50', border: 'border-purple-200', title: 'text-purple-900', bar: 'bg-purple-500' },
                submoment: { bg: 'bg-amber-50', border: 'border-amber-200', title: 'text-amber-900', bar: 'bg-amber-500' },
                activity: { bg: 'bg-green-50', border: 'border-green-200', title: 'text-green-900', bar: 'bg-green-500' }
            };

            // Group fields by category first
            const fieldsByCategory = {};
            
            Object.entries(analysis.fields).forEach(([level, fields]) => {
                Object.entries(fields).forEach(([fieldKey, data]) => {
                    const category = getFieldCategory(fieldKey);
                    if (!fieldsByCategory[category]) {
                        fieldsByCategory[category] = {};
                    }
                    if (!fieldsByCategory[category][level]) {
                        fieldsByCategory[category][level] = {};
                    }
                    fieldsByCategory[category][level][fieldKey] = data;
                });
            });

            // Display by category
            Object.entries(fieldsByCategory).forEach(([category, levels]) => {
                fieldsHTML += `
                    <div class="field-category-section mb-4" data-category="${category}" style="display: none;">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4">
                            <h3 class="font-bold text-indigo-900 mb-4 text-lg flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                ${category}
                            </h3>
                `;

                Object.entries(levels).forEach(([level, fields]) => {
                    if (Object.keys(fields).length === 0) return;

                    const colors = levelColors[level];
                    const levelName = level === 'training' ? 'Training Parameters' : (level.charAt(0).toUpperCase() + level.slice(1));
                    
                    fieldsHTML += `
                        <div class="${colors.bg} border ${colors.border} rounded-lg p-4 mb-3">
                            <h4 class="font-semibold ${colors.title} mb-3">${levelName}</h4>
                            <div class="space-y-2">
                    `;

                    Object.entries(fields).forEach(([fieldKey, data]) => {
                        const fieldName = fieldDefinitions[level][fieldKey] || fieldKey;
                        const percentage = data.total > 0 ? Math.round((data.filled / data.total) * 100) : 0;
                        const fieldId = `field-${level}-${fieldKey}`;
                        
                        fieldsHTML += `
                            <div class="field-row">
                                <input type="checkbox" 
                                       id="${fieldId}" 
                                       class="field-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 mr-3" 
                                       data-level="${level}" 
                                       data-field="${fieldKey}">
                                <label for="${fieldId}" class="flex-1 cursor-pointer">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">${fieldName}</span>
                                        <span class="text-xs text-gray-500">
                                            <span class="font-semibold text-${data.unfilled > 0 ? 'red' : 'green'}-600">${data.filled}/${data.total}</span> filled
                                            ${data.unfilled > 0 ? `<span class="text-red-600">(${data.unfilled} missing)</span>` : ''}
                                        </span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${colors.bar}" style="width: ${percentage}%">
                                            ${percentage > 15 ? percentage + '%' : ''}
                                        </div>
                                    </div>
                                </label>
                            </div>
                        `;
                    });

                    fieldsHTML += `
                            </div>
                        </div>
                    `;
                });

                fieldsHTML += `
                        </div>
                    </div>
                `;
            });

            fieldsContainer.innerHTML = fieldsHTML;

            // Add event listeners to field checkboxes
            document.querySelectorAll('.field-checkbox').forEach(checkbox => {
                const key = `${checkbox.dataset.level}.${checkbox.dataset.field}`;
                
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedFields.add(key);
                    } else {
                        selectedFields.delete(key);
                    }
                    updateSelectionSummary();
                    updatePrompt();
                });
            });

            // Display learning types distribution
            const typesContainer = document.getElementById('typesContainer');
            const totalActivities = analysis.activityCount;
            const typeColors = {
                acquisition: 'bg-cyan-400',
                collaboration: 'bg-yellow-400',
                discussion: 'bg-blue-400',
                investigation: 'bg-red-400',
                practice: 'bg-purple-400',
                production: 'bg-green-400',
                none: 'bg-gray-300'
            };

            const typeBars = Object.entries(analysis.learningTypes)
                .filter(([type, count]) => count > 0)
                .map(([type, count]) => {
                    const percentage = totalActivities > 0 ? ((count / totalActivities) * 100).toFixed(1) : 0;
                    return `
                        <div class="flex items-center gap-3">
                            <div class="w-32 text-sm text-gray-700 capitalize">${type}:</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-6">
                                <div class="${typeColors[type]} h-6 rounded-full flex items-center justify-end px-2" style="width: ${percentage}%">
                                    <span class="text-xs font-medium text-gray-900">${count} (${percentage}%)</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            typesContainer.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">Learning Types Distribution</h3>
                    <div class="space-y-2">
                        ${typeBars || '<p class="text-sm text-gray-500">No activities found</p>'}
                    </div>
                </div>
            `;

            // Populate focus dropdown
            const focusSelect = document.getElementById('focusSelect');
            focusSelect.innerHTML = '<option value="">Select from your design...</option>';
            
            analysis.modules.forEach(module => {
                const opt = document.createElement('option');
                opt.value = module.name;
                opt.textContent = module.name;
                focusSelect.appendChild(opt);
            });
            
            analysis.moments.forEach(moment => {
                const opt = document.createElement('option');
                opt.value = moment.name;
                opt.textContent = moment.name;
                focusSelect.appendChild(opt);
            });

            // Show sections
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('configSection').classList.remove('hidden');
            
            // Display detected language
            const languageNames = {
                'en': 'English',
                'fr': 'FranÃ§ais',
                'es': 'EspaÃ±ol',
                'de': 'Deutsch',
                'it': 'Italiano',
                'pt': 'PortuguÃªs',
                'nl': 'Nederlands',
                'pl': 'Polski',
                'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                'zh': 'ä¸­æ–‡',
                'ja': 'æ—¥æœ¬èªž',
                'ko': 'í•œêµ­ì–´'
            };
            const detectedLangDisplay = document.getElementById('detectedLangDisplay');
            if (detectedLangDisplay) {
                detectedLangDisplay.textContent = languageNames[detectedLanguage] || detectedLanguage;
            }
            
            // Initialize selection summary
            updateSelectionSummary();
            
            // Generate initial prompt
            updatePrompt();
        }

        // Enable/disable inputs
        document.getElementById('focusCheck').addEventListener('change', function(e) {
            document.getElementById('focusSelect').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('activityCheck').addEventListener('change', function(e) {
            document.getElementById('activitySelect').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('audienceCheck').addEventListener('change', function(e) {
            document.getElementById('audienceInput').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('durationCheck').addEventListener('change', function(e) {
            document.getElementById('durationInput').disabled = !e.target.checked;
            document.getElementById('durationUnit').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('toolsCheck').addEventListener('change', function(e) {
            document.getElementById('toolsInput').disabled = !e.target.checked;
            updatePrompt();
        });

        function updatePrompt() {
            if (!analysisResults) return;

            let prompt = basePrompt;
            
            // Add language instruction first
            prompt += getLanguageInstruction();
            
            let sections = [];

            // Add category and field-specific instructions
            if (selectedCategories.size > 0 || selectedFields.size > 0) {
                let fieldInstructions = '\n\n**Enhancement Focus:**\n';
                
                if (selectedCategories.size > 0) {
                    fieldInstructions += '\nSelected categories:\n- ' + Array.from(selectedCategories).join('\n- ') + '\n';
                }
                
                if (selectedFields.size > 0) {
                    const fieldsByLevel = {};
                    selectedFields.forEach(key => {
                        const [level, field] = key.split('.');
                        if (!fieldsByLevel[level]) fieldsByLevel[level] = [];
                        const fieldName = fieldDefinitions[level][field] || field;
                        const category = getFieldCategory(field);
                        fieldsByLevel[level].push(`${fieldName} (${category})`);
                    });

                    fieldInstructions += '\nSpecific fields to enhance:\n';
                    Object.entries(fieldsByLevel).forEach(([level, fields]) => {
                        const levelName = level === 'training' ? 'Training Parameters' : (level.charAt(0).toUpperCase() + level.slice(1) + ' level');
                        fieldInstructions += `\n${levelName}:\n  - ${fields.join('\n  - ')}\n`;
                    });
                }
                
                sections.push(fieldInstructions);
            }

            // Optional additions
            const additionalReqs = [];
            
            if (document.getElementById('focusCheck').checked) {
                const value = document.getElementById('focusSelect').value;
                if (value) {
                    additionalReqs.push(`Focus particularly on "${value}"`);
                }
            }

            if (document.getElementById('activityCheck').checked) {
                const value = document.getElementById('activitySelect').value;
                if (value) {
                    additionalReqs.push(`Prioritise adding ${value} activities`);
                }
            }

            if (document.getElementById('audienceCheck').checked) {
                const value = document.getElementById('audienceInput').value.trim();
                if (value) {
                    additionalReqs.push(`Ensure activities are suitable for ${value}`);
                }
            }

            if (document.getElementById('durationCheck').checked) {
                const value = document.getElementById('durationInput').value;
                const unit = document.getElementById('durationUnit').value;
                if (value) {
                    additionalReqs.push(`Keep the total duration within ${value} ${unit}`);
                }
            }

            if (document.getElementById('toolsCheck').checked) {
                const value = document.getElementById('toolsInput').value.trim();
                if (value) {
                    additionalReqs.push(`Add activities that incorporate ${value}`);
                }
            }

            if (additionalReqs.length > 0) {
                sections.push('\n**Additional Requirements:**\n- ' + additionalReqs.join('\n- '));
            }

            if (sections.length > 0) {
                prompt += '\n\n---' + sections.join('\n');
            }

            document.getElementById('promptOutput').textContent = prompt;
        }

        function copyPrompt() {
            const promptText = document.getElementById('promptOutput').textContent;
            
            if (promptText === 'Upload your JSON file to generate a customised prompt.') {
                alert('Please upload a JSON file first!');
                return;
            }

            navigator.clipboard.writeText(promptText).then(() => {
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.remove('hidden');
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 3000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // Update prompt when inputs change
        document.querySelectorAll('#languageSelect, #focusSelect, #activitySelect, #audienceInput, #durationInput, #durationUnit, #toolsInput').forEach(elem => {
            elem.addEventListener('input', () => {
                if (learningData) updatePrompt();
            });
            elem.addEventListener('change', () => {
                if (learningData) updatePrompt();
            });
        });
    </script>
</body>
</html>
