<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Designer AI Enhancement Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .prompt-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .section-card {
            transition: all 0.2s ease;
        }
        .section-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .upload-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        .upload-zone.dragover {
            border-color: #4f46e5;
            background-color: #e0e7ff;
        }
        .field-row {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .field-row:hover {
            background-color: #f8fafc;
        }
        .progress-bar {
            height: 1.25rem;
            border-radius: 0.375rem;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="flex items-center gap-3 mb-3">
                <h1 class="text-3xl font-bold text-gray-800">Learning Designer AI Enhancement Tool</h1>
                <span class="bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full border border-yellow-300">
                    PROTOTYPE
                </span>
            </div>
            <p class="text-gray-600 text-lg mb-4">Enhance your learning design using AI-powered analysis and content generation</p>
            
            <!-- Feature Selection -->
            <div class="grid md:grid-cols-2 gap-6 mt-6">
                <!-- Enhancement Feature -->
                <div class="border-2 border-indigo-200 rounded-lg p-6 hover:border-indigo-400 transition cursor-pointer bg-gradient-to-br from-indigo-50 to-blue-50" onclick="selectFeature('enhancement')">
                    <div class="flex items-center mb-3">
                        <svg class="w-10 h-10 text-indigo-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                        </svg>
                        <h3 class="text-xl font-bold text-indigo-900">AI Enhancement</h3>
                    </div>
                    <p class="text-gray-700 text-sm mb-4">Generate customised AI prompts to enhance your learning design content (works with JSON or MD files)</p>
                    <div class="flex items-center text-xs text-indigo-600 font-semibold">
                        <span>Select this feature</span>
                        <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- Conversion Feature -->
                <div class="border-2 border-green-200 rounded-lg p-6 hover:border-green-400 transition cursor-pointer bg-gradient-to-br from-green-50 to-emerald-50" onclick="selectFeature('conversion')">
                    <div class="flex items-center mb-3">
                        <svg class="w-10 h-10 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        <h3 class="text-xl font-bold text-green-900">MD to JSON Conversion</h3>
                    </div>
                    <p class="text-gray-700 text-sm mb-4">Convert Markdown learning designs to JSON format for import into Learning Designer</p>
                    <div class="flex items-center text-xs text-green-600 font-semibold">
                        <span>Select this feature</span>
                        <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversion Tool Section (initially hidden) -->
        <div id="conversionSection" class="hidden bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    MD to JSON Converter
                </h2>
                <button onclick="returnToFeatureSelection()" class="text-gray-600 hover:text-gray-800 text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Feature Selection
                </button>
            </div>

            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-green-800">
                            Upload a Markdown (.md) learning design file exported from Learning Designer. The tool will parse the structure and generate a valid JSON file that can be imported back into Learning Designer.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Conversion Upload Zone -->
            <div id="conversionDropZone" class="upload-zone rounded-lg p-12 text-center cursor-pointer mb-6">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg font-medium text-gray-700 mb-2">Drop your MD file here</p>
                <p class="text-sm text-gray-500 mb-4">or click to browse (.md files only)</p>
                <input type="file" id="conversionFileInput" accept=".md" class="hidden">
                <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                    Choose MD File
                </button>
            </div>

            <div id="conversionFileInfo" class="hidden mb-6">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-green-800 font-medium">âœ“ File loaded: <span id="conversionFileName"></span></p>
                </div>
            </div>

            <div id="conversionButton" class="hidden">
                <button onclick="convertMDToJSON()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-200 transform hover:scale-105 flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    Convert to JSON and Download
                </button>
            </div>
        </div>

        <!-- Enhancement Upload Section (initially hidden) -->
        <div id="uploadSection" class="hidden bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Step 1: Upload Your File</h2>
                <button onclick="returnToFeatureSelection()" class="text-gray-600 hover:text-gray-800 text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Feature Selection
                </button>
            </div>
            <div id="dropZone" class="upload-zone rounded-lg p-12 text-center cursor-pointer">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg font-medium text-gray-700 mb-2">Drop your JSON or MD file here</p>
                <p class="text-sm text-gray-500 mb-4">Accepts .json or .md files from Learning Designer</p>
                <input type="file" id="fileInput" accept=".json,.md" class="hidden">
                <button type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium">
                    Choose File
                </button>
            </div>
            <div id="fileInfo" class="mt-4 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-green-800 font-medium">âœ“ File loaded: <span id="fileName"></span> (<span id="fileType"></span>)</p>
                </div>
            </div>
        </div>

        <!-- Analysis Section (hidden until JSON loaded) -->
        <div id="analysisSection" class="hidden mb-6">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Step 2: Design Analysis</h2>
                
                <!-- Structure Overview -->
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                        </svg>
                        <h3 class="font-semibold text-indigo-900">Training Structure</h3>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-blue-50 rounded-lg p-3 text-center border border-blue-200">
                            <div class="text-2xl font-bold text-blue-600" id="moduleCount">0</div>
                            <div class="text-xs text-blue-800">Modules</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-3 text-center border border-purple-200">
                            <div class="text-2xl font-bold text-purple-600" id="momentCount">0</div>
                            <div class="text-xs text-purple-800">Moments</div>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-3 text-center border border-amber-200">
                            <div class="text-2xl font-bold text-amber-600" id="submomentCount">0</div>
                            <div class="text-xs text-amber-800">Submoments</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 text-center border border-green-200">
                            <div class="text-2xl font-bold text-green-600" id="activityCount">0</div>
                            <div class="text-xs text-green-800">Activities</div>
                        </div>
                    </div>
                </div>

                <!-- Field Analysis -->
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-indigo-800">How to select fields for enhancement</h3>
                            <div class="mt-2 text-sm text-indigo-700">
                                <p class="mb-2"><strong>Step 1:</strong> Select one or more categories below (e.g., "Training Information", "Content & Structure", "Pedagogical Elements"). Your selections are tracked in real-time.</p>
                                <p class="mb-2"><strong>Step 2:</strong> Within each selected category, tick the specific fields you want the AI to enhance. The progress bars show completion status.</p>
                                <p class="mb-2"><strong>Note:</strong> You can enhance both general training parameters (name, objectives, tools) and specific content (modules, moments, activities).</p>
                                <p><strong>Default:</strong> Nothing is selected by default - choose exactly what you want enhanced based on your needs.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Selection -->
                <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900">Select Enhancement Categories</h3>
                            <p class="text-xs text-gray-600 mt-1">
                                <span id="selectionSummary" class="font-medium text-indigo-600">No selections yet</span>
                            </p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="selectAllCategories()" class="text-xs px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">
                                Select All Categories
                            </button>
                            <button onclick="deselectAllCategories()" class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
                                Deselect All
                            </button>
                        </div>
                    </div>
                    <div id="categoryContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div id="fieldsContainer" class="mb-6"></div>

                <!-- Learning Types Distribution -->
                <div id="typesContainer" class="mb-6"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="configSection" class="hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Left: Configuration -->
                <div class="space-y-4">
                    <!-- Base Instructions -->
                    <div class="bg-white rounded-lg shadow p-6 section-card">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="bg-indigo-100 text-indigo-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">3</span>
                            Customise Enhancement Options
                        </h2>
                        <p class="text-sm text-gray-600 bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4">
                            Select which fields to enhance in Step 2 above, then add optional requirements below.
                        </p>
                    </div>

                    <!-- Optional Additions -->
                    <div class="bg-white rounded-lg shadow p-6 section-card">
                        <h3 class="font-semibold text-gray-800 mb-4">Optional Requirements</h3>
                        
                        <!-- Output Language -->
                        <div class="mb-4 pb-4 border-b border-gray-200">
                            <label class="block mb-2">
                                <span class="text-gray-700 font-medium flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/>
                                    </svg>
                                    Output Language
                                </span>
                            </label>
                            <select id="languageSelect" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="en">English</option>
                                <option value="fr">FranÃ§ais</option>
                                <option value="es">EspaÃ±ol</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="pt">PortuguÃªs</option>
                                <option value="nl">Nederlands</option>
                                <option value="pl">Polski</option>
                                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                <option value="zh">ä¸­æ–‡</option>
                                <option value="ja">æ—¥æœ¬èªž</option>
                                <option value="ko">í•œêµ­ì–´</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2" id="detectedLangNote">
                                Detected from JSON: <span id="detectedLangDisplay" class="font-semibold">-</span>
                            </p>
                        </div>
                        
                        <!-- Focus Area -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="focusCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Focus on specific module/moment</span>
                            </label>
                            <select id="focusSelect" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                                <option value="">Select from your design...</option>
                            </select>
                        </div>

                        <!-- Activity Priority -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="activityCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Prioritise specific activity type</span>
                            </label>
                            <select id="activitySelect" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                                <option value="">Select activity type...</option>
                                <option value="collaborative">Collaborative activities</option>
                                <option value="acquisition">Acquisition activities</option>
                                <option value="discussion">Discussion activities</option>
                                <option value="investigation">Investigation activities</option>
                                <option value="practice">Practice activities</option>
                                <option value="production">Production activities</option>
                            </select>
                        </div>

                        <!-- Target Audience -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="audienceCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Specify pupil level/age group</span>
                            </label>
                            <input type="text" id="audienceInput" placeholder="e.g., University undergraduates or Ages 14-16" 
                                   class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                                   disabled>
                        </div>

                        <!-- Duration Constraint -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="durationCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Set total duration limit</span>
                            </label>
                            <div class="mt-2 flex gap-2">
                                <input type="number" id="durationInput" placeholder="24" min="1"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                                       disabled>
                                <select id="durationUnit" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                                    <option value="hours">hours</option>
                                    <option value="minutes">minutes</option>
                                    <option value="days">days</option>
                                </select>
                            </div>
                        </div>

                        <!-- Specific Tools -->
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="toolsCheck" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="ml-3 text-gray-700 font-medium">Include specific tools/technologies</span>
                            </label>
                            <input type="text" id="toolsInput" placeholder="e.g., Moodle, Padlet, Google Workspace" 
                                   class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed" 
                                   disabled>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button onclick="updatePrompt()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 transform hover:scale-105">
                        Generate Prompt
                    </button>
                </div>

                <!-- Right: Generated Prompt -->
                <div class="bg-white rounded-lg shadow-lg p-6 section-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="bg-indigo-100 text-indigo-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">4</span>
                            Your Prompt
                        </h2>
                        <button onclick="copyPrompt()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-200 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <div id="promptOutput" class="prompt-box p-4 rounded-lg min-h-[500px] max-h-[700px] overflow-y-auto">
                        Upload your JSON file to generate a customised prompt.
                    </div>
                    <div id="copyFeedback" class="mt-3 text-green-600 font-medium text-sm hidden">
                        âœ“ Copied to clipboard!
                    </div>
                    
                    <!-- What's Next Instructions -->
                    <div class="mt-6 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            What's Next?
                        </h3>
                        <ol class="text-sm text-green-800 space-y-2 ml-2">
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">1.</span>
                                <span><strong>Copy the prompt</strong> using the button above</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">2.</span>
                                <span><strong>Go to Claude.ai</strong> (or use the Claude API)</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">3.</span>
                                <span><strong>Upload your JSON file</strong> to Claude</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">4.</span>
                                <span><strong>Paste the prompt</strong> into the conversation</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">5.</span>
                                <span><strong>Get your enhanced JSON</strong> from Claude's response</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2 min-w-[1.5rem]">6.</span>
                                <span><strong>Import it back</strong> into Learning Designer</span>
                            </li>
                        </ol>
                        <div class="mt-3 pt-3 border-t border-green-200">
                            <p class="text-xs text-green-700">
                                ðŸ’¡ <strong>Tip:</strong> Claude works best with Claude Sonnet 3.5 or newer models for this type of complex JSON enhancement task.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p class="mb-2">Upload your JSON export to analyse field completion and generate a customised AI enhancement prompt.</p>
            <p class="text-xs">ðŸ’¡ This tool helps you create the perfect prompt for Claude AI to enhance your learning design content while preserving structure.</p>
        </div>
    </div>

    <script>
        let learningData = null;
        let analysisResults = null;
        let selectedFields = new Set();
        let selectedCategories = new Set();
        let detectedLanguage = null;
        let fileType = null; // 'json' or 'md'
        let mdContent = null; // Store MD file content

        // Helper functions for category selection
        function selectAllCategories() {
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                cb.checked = true;
                selectedCategories.add(cb.value);
            });
            updateFieldVisibility();
            updateSelectionSummary();
            updatePrompt();
        }

        function deselectAllCategories() {
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedCategories.clear();
            selectedFields.clear();
            document.querySelectorAll('.field-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateFieldVisibility();
            updateSelectionSummary();
            updatePrompt();
        }

        function updateFieldVisibility() {
            document.querySelectorAll('.field-category-section').forEach(section => {
                const category = section.dataset.category;
                if (selectedCategories.has(category) || selectedCategories.size === 0) {
                    section.style.display = '';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function updateSelectionSummary() {
            const summaryEl = document.getElementById('selectionSummary');
            if (!summaryEl) return;
            
            const catCount = selectedCategories.size;
            const fieldCount = selectedFields.size;
            
            if (catCount === 0 && fieldCount === 0) {
                summaryEl.textContent = 'No selections yet - select categories to begin';
                summaryEl.className = 'font-medium text-gray-500';
            } else if (catCount > 0 && fieldCount === 0) {
                summaryEl.textContent = `${catCount} ${catCount === 1 ? 'category' : 'categories'} selected - now select specific fields`;
                summaryEl.className = 'font-medium text-amber-600';
            } else {
                summaryEl.textContent = `${catCount} ${catCount === 1 ? 'category' : 'categories'}, ${fieldCount} ${fieldCount === 1 ? 'field' : 'fields'} selected`;
                summaryEl.className = 'font-medium text-green-600';
            }
        }

        // Field definitions organized by categories
        const fieldCategories = {
            'Training Information': ['nom', 'theme', 'auteurs', 'formateurs', 'niveau', 'modalite', 'tailleCohorte', 'description'],
            'Target Audience & Prerequisites': ['publicCible', 'prerequis'],
            'Learning Outcomes & Objectives': ['objectives', 'learningOutcomes', 'competences', 'objectifs', 'resultatsTexte'],
            'Resources & Tools': ['resources', 'notes', 'outilsMateriel', 'outilsMaterielNotes'],
            'Content & Structure': ['title', 'description'],
            'Pedagogical Elements': ['objective', 'tasks', 'learningType']
        };

        const fieldDefinitions = {
            training: {
                nom: 'Training Name',
                theme: 'Theme',
                auteurs: 'Authors',
                formateurs: 'Trainers',
                niveau: 'Level',
                publicCible: 'Target Audience',
                prerequis: 'Prerequisites',
                outilsMateriel: 'Tools & Materials',
                outilsMaterielNotes: 'Tools & Materials Notes',
                modalite: 'Modality (in-person/online/blended)',
                tailleCohorte: 'Cohort Size',
                objectifs: 'Training Objectives',
                resultatsTexte: 'Expected Learning Outcomes',
                description: 'Training Description'
            },
            module: {
                title: 'Title',
                description: 'Description',
                notes: 'Notes',
                objectives: 'Learning Objectives',
                learningOutcomes: 'Learning Outcomes',
                competences: 'Competences'
            },
            moment: {
                title: 'Title',
                description: 'Description'
            },
            submoment: {
                title: 'Title',
                description: 'Description'
            },
            activity: {
                title: 'Title',
                description: 'Description',
                objective: 'Objective',
                tasks: 'Tasks/Instructions',
                notes: 'Notes',
                resources: 'Resources/Links',
                learningType: 'Learning Type'
            }
        };

        // Get category for a field
        function getFieldCategory(fieldKey) {
            for (const [category, fields] of Object.entries(fieldCategories)) {
                if (fields.includes(fieldKey)) return category;
            }
            return 'Other';
        }

        // Base prompt template
        const basePrompt = `I'm uploading a JSON file: My current learning design export from Learning Designer.

# YOUR TASK

Analyse and enhance the learning design by improving the quality and completeness of existing content. Do NOT create any new structural elements (no new modules, moments, submoments, or activities).

---

# CRITICAL TECHNICAL CONSTRAINTS (ABSOLUTELY MANDATORY)

## 1. JSON Structure Preservation
- **NEVER** modify the root structure or schema
- **PRESERVE** the exact value of \`schemaVersion\` (currently 2)
- **PRESERVE** the exact structure of \`i18n\` object
- **MAINTAIN** all array structures and nesting levels
- The output must be **valid, parseable JSON** that imports without errors

## 2. Immutable Technical Fields
**DO NOT MODIFY** any of these fields or their values:
- All \`id\` fields (e.g., \`id: "step_2ac095d7..."\`, \`id: "moment_1037c..."\`)
- All duration unit fields: \`unite\`, \`unit\`, \`uniteDureeCible\`, \`targetUnit\`, \`dureeApprentissageUniteSecs\`, \`dureeConcueUniteSecs\`, \`unitKey\`, \`targetUnitKey\`
- All status fields: \`etat\`, \`status\`, \`state\`
- All grouping fields: \`regroupement\`, \`groupMode\`, \`grouping\`, \`nombreGroupes\`, \`groupCount\`, \`tailleGroupe\`, \`groupSize\`
- All context fields: \`formateur\`, \`trainer\`, \`lieu\`, \`place\`, \`temps\`, \`time\`
- Boolean fields: \`ignored\`, \`ignore\`, \`isIgnored\`, \`ldIgnored\`
- Any field ending in \`Secs\` (e.g., \`targetTimeSec\`)
- Timestamp fields: \`exportedAt\`
- Version fields: \`version\`, \`schemaVersion\`

## 3. Dual-Language Field Handling
The schema uses **parallel French/English fields**. When enhancing content:
- âœ… **UPDATE BOTH** when they exist: \`titre\` AND \`title\`, \`description\` AND \`desc\`
- âœ… Use the **SAME enhanced content** for both language variants
- âŒ **NEVER** delete one variant to keep only the other
- âŒ **NEVER** translate between the two (they should contain identical content)

Example: \`"titre": "Welcome"\` and \`"title": "Welcome"\` should both have the same enhanced content.

## 4. Field Names - Zero Tolerance
- **NEVER** rename fields (e.g., don't change \`sousMoments\` to \`subMoments\`)
- **NEVER** add new fields that don't exist in the original
- **NEVER** translate field names themselves
- Keep the exact French/English mix as it appears

## 5. Array and Object Integrity
- **PRESERVE** empty arrays exactly as \`[]\`
- **PRESERVE** the order of all array elements
- **DO NOT** remove array elements, even if they seem redundant
- **DO NOT** merge or split objects

---

# ENHANCEMENT GUIDELINES

## Content Types to Enhance

### Level 1: Training Parameters (\`parametres\`)
Enhance these fields if present:
- \`nom\` / \`name\` - Make specific and professional
- \`description\` - Add comprehensive overview with context and goals
- \`publicCible\` - Detail audience characteristics, prerequisites, context
- \`prerequis\` - Make specific and testable
- \`objectifs\` - Make SMART and measurable
- \`outilsMateriel\` - Be specific about tools, versions, access requirements

### Level 2: Module-Level
For each module in \`modules\` array:
- \`titre\` / \`title\` - Clear, specific module purpose
- \`description\` - Module intent, learning approach, expected outputs
- \`notes\` - Add pedagogical rationale if appropriate

### Level 3: Moment-Level  
For each moment in \`modules[].moments\`:
- \`titre\` / \`title\` - Time + clear session purpose
- \`description\` - **THIS IS CRITICAL**: Add structured description with:
  - Learning intent (objectives for this session)
  - Pedagogical approach (how learning will happen)
  - Expected outputs (what participants will produce/achieve)
  
**Template for moment descriptions:**
\`\`\`
This [session type] [establishes/develops/applies] [specific learning goal].

**Learning intent**
- [Specific objective 1]
- [Specific objective 2]

**Approach**
[Description of pedagogical methods, activities, flow]

**Expected outputs**
- [Tangible deliverable/understanding 1]
- [Tangible deliverable/understanding 2]
\`\`\`

### Level 4: Sub-moment Level
For each submoment in \`moments[].sousMoments\` or \`moments[].subMoments\`:
- \`titre\` / \`title\` - Clear sub-session purpose
- \`description\` - Brief rationale for this segment

### Level 5: Activity/Step Level
For each activity in \`activites\` / \`steps\`:
- \`titre\` / \`title\` - Action-oriented, specific activity name
- \`objectifActivite\` / \`objective\` - Clear, measurable learning objective
- \`aFaire\` / \`tasks\` - Concrete, step-by-step instructions
- \`aFaireFormateur\` / \`trainerTasks\` - Specific trainer actions/preparations
- \`notes\` - Pedagogical tips, variations, potential issues
- \`liensReferences\` / \`linksReferences\` - Relevant resources

## Quality Standards

### For Titles
- âœ… Specific and descriptive
- âœ… Action-oriented where appropriate
- âœ… Include time indicators for moments (e.g., "10:00-12:30")
- âŒ Avoid generic terms

### For Descriptions
- âœ… Use structured formatting (bullets, sections)
- âœ… Include concrete details and context
- âœ… Explain the "why" not just the "what"
- âœ… Use markdown formatting (**, -, \\n\\n for readability)
- âŒ Don't exceed 500 words per description

### For Objectives
- âœ… Start with measurable verbs (analyse, create, evaluate, apply)
- âœ… Be specific about what participants will achieve
- âœ… Align with Bloom's taxonomy
- âŒ Avoid vague verbs (understand, know, learn about)

### For Tasks/Instructions
- âœ… Numbered or bulleted steps
- âœ… Clear sequence and timing
- âœ… Specify tools/materials needed
- âŒ Don't assume implicit knowledge

## Pedagogical Coherence
1. **Progression**: Ensure logical flow from foundational to advanced
2. **Alignment**: Match objectives â†’ activities â†’ assessment
3. **Balance**: Vary learning types across the design
4. **Scaffolding**: Build on previous learning appropriately
5. **Context**: Respect the specified audience, level, and modality

---

# WHAT NOT TO DO (CRITICAL ERRORS TO AVOID)

## Structural Changes (FORBIDDEN)
- âŒ Adding new modules, moments, submoments, or activities
- âŒ Deleting or merging existing elements
- âŒ Changing the hierarchy or nesting
- âŒ Reordering array elements

## Content Changes (FORBIDDEN)
- âŒ Changing field names or keys
- âŒ Modifying ID values
- âŒ Changing duration unit values (60, 3600, etc.)
- âŒ Altering status codes or enumerated values
- âŒ Translating technical field names
- âŒ Adding fields that don't exist in the schema

## Data Integrity (FORBIDDEN)
- âŒ Creating invalid JSON syntax
- âŒ Breaking object/array structures
- âŒ Removing duplicate language fields
- âŒ Changing data types (string â†’ number, etc.)

---

# OUTPUT REQUIREMENTS

## Part 1: The Enhanced JSON
Provide the **complete, valid JSON file** with:
- All enhancements applied
- All technical fields preserved exactly
- Valid JSON syntax (proper quotes, commas, brackets)
- No truncation - the entire file from \`{\` to final \`}\`

## Part 2: Summary of Changes
After the JSON, provide a concise summary (max 300 words).

---

# VALIDATION CHECKLIST

Before submitting, verify:
- âœ… JSON is valid and complete
- âœ… All \`id\` fields unchanged
- âœ… All duration units unchanged (still 60, 3600, etc.)
- âœ… Both \`titre\` and \`title\` updated when both exist
- âœ… No new structural elements added
- âœ… schemaVersion remains exactly \`2\`
- âœ… No field names translated or changed

**Remember**: The AI-enhanced JSON must be **directly importable** without any manual fixes. Preserve technical integrity while maximizing pedagogical quality.`;

        function getLanguageInstruction() {
            const langSelect = document.getElementById('languageSelect');
            const selectedLang = langSelect ? langSelect.value : detectedLanguage;
            
            const languageNames = {
                'en': 'English',
                'fr': 'French',
                'es': 'Spanish',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese',
                'nl': 'Dutch',
                'pl': 'Polish',
                'ar': 'Arabic',
                'zh': 'Chinese',
                'ja': 'Japanese',
                'ko': 'Korean'
            };
            
            const langName = languageNames[selectedLang] || selectedLang;
            return `\n\n**Output Language:** ${langName}\nAll enhanced content values (titles, descriptions, objectives, etc.) must be written in ${langName}. Field names and technical keys remain unchanged.`;
        }

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');

        fileInput.addEventListener('change', handleFileSelect);
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            const fileName = file.name;
            const extension = fileName.split('.').pop().toLowerCase();
            
            if (extension !== 'json' && extension !== 'md') {
                alert('Please select a JSON or MD file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                if (extension === 'json') {
                    try {
                        learningData = JSON.parse(e.target.result);
                        fileType = 'json';
                        document.getElementById('fileName').textContent = file.name;
                        document.getElementById('fileType').textContent = 'JSON';
                        document.getElementById('fileInfo').classList.remove('hidden');
                        analyseDesign();
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                } else if (extension === 'md') {
                    mdContent = e.target.result;
                    fileType = 'md';
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileType').textContent = 'Markdown';
                    document.getElementById('fileInfo').classList.remove('hidden');
                    initializeMDMode();
                }
            };
            reader.readAsText(file);
        }

        function analyseDesign() {
            if (!learningData) return;

            // Detect language from JSON
            detectedLanguage = 'en'; // default
            if (learningData.i18n && learningData.i18n.currentLang) {
                detectedLanguage = learningData.i18n.currentLang;
            } else if (learningData.i18n && learningData.i18n.defaultLang) {
                detectedLanguage = learningData.i18n.defaultLang;
            }
            
            // Set language selector to detected language
            const langSelect = document.getElementById('languageSelect');
            if (langSelect) {
                langSelect.value = detectedLanguage;
            }

            const analysis = {
                moduleCount: 0,
                momentCount: 0,
                submomentCount: 0,
                activityCount: 0,
                fields: {
                    training: {},
                    module: {},
                    moment: {},
                    submoment: {},
                    activity: {}
                },
                learningTypes: {
                    none: 0,
                    acquisition: 0,
                    collaboration: 0,
                    discussion: 0,
                    investigation: 0,
                    practice: 0,
                    production: 0
                },
                modules: [],
                moments: []
            };

            // Helper to check if field is filled
            const isFilled = (value) => {
                if (!value) return false;
                const str = String(value).trim();
                if (str === '') return false;
                if (str.toLowerCase().includes('aucun')) return false;
                if (str === 'none' || str === 'null' || str === 'undefined') return false;
                // Check for arrays
                if (Array.isArray(value)) {
                    return value.length > 0 && !value.every(v => 
                        String(v).toLowerCase().includes('aucun') || 
                        String(v).toLowerCase().includes('none')
                    );
                }
                return true;
            };

            // Helper to track field status
            const trackField = (level, fieldName, value) => {
                if (!analysis.fields[level][fieldName]) {
                    analysis.fields[level][fieldName] = { filled: 0, unfilled: 0, total: 0 };
                }
                analysis.fields[level][fieldName].total++;
                if (isFilled(value)) {
                    analysis.fields[level][fieldName].filled++;
                } else {
                    analysis.fields[level][fieldName].unfilled++;
                }
            };

            // Analyse training parameters
            if (learningData.parametres) {
                const params = learningData.parametres;
                trackField('training', 'nom', params.nom);
                trackField('training', 'theme', params.theme);
                trackField('training', 'auteurs', params.auteurs);
                trackField('training', 'formateurs', params.formateurs);
                trackField('training', 'niveau', params.niveau);
                trackField('training', 'publicCible', params.publicCible);
                trackField('training', 'prerequis', params.prerequis);
                trackField('training', 'outilsMateriel', params.outilsMateriel);
                trackField('training', 'outilsMaterielNotes', params.outilsMaterielNotes);
                trackField('training', 'modalite', params.modalite);
                trackField('training', 'tailleCohorte', params.tailleCohorte);
                trackField('training', 'objectifs', params.objectifs);
                trackField('training', 'resultatsTexte', params.resultatsTexte);
                trackField('training', 'description', params.description);
            }

            // Analyse modules
            if (learningData.modules && Array.isArray(learningData.modules)) {
                analysis.moduleCount = learningData.modules.length;
                
                learningData.modules.forEach((module, mIdx) => {
                    const moduleName = module.title || module.titre || `Module ${mIdx + 1}`;
                    analysis.modules.push({ id: module.id || mIdx, name: moduleName });

                    // Track module fields
                    trackField('module', 'title', module.title || module.titre);
                    trackField('module', 'description', module.description);
                    trackField('module', 'notes', module.notes);
                    trackField('module', 'objectives', module.objectifsApprentissageModule);
                    trackField('module', 'learningOutcomes', module.resultatsApprentissageModule);
                    trackField('module', 'competences', module.competencesModuleSujet);

                    // Analyse moments
                    if (module.moments && Array.isArray(module.moments)) {
                        analysis.momentCount += module.moments.length;
                        
                        module.moments.forEach((moment, momIdx) => {
                            const momentName = moment.title || moment.titre || `Moment ${momIdx + 1}`;
                            analysis.moments.push({ 
                                id: moment.id || `${module.id}-${momIdx}`, 
                                name: `${moduleName} > ${momentName}`,
                                moduleId: module.id || mIdx
                            });

                            // Track moment fields
                            trackField('moment', 'title', moment.title || moment.titre);
                            trackField('moment', 'description', moment.description);

                            // Function to analyse activities
                            const analyseActivities = (activities) => {
                                if (!activities || !Array.isArray(activities)) return;
                                
                                analysis.activityCount += activities.length;
                                
                                activities.forEach((activity) => {
                                    // Track activity fields
                                    trackField('activity', 'title', activity.title || activity.titre);
                                    trackField('activity', 'description', activity.description);
                                    trackField('activity', 'objective', activity.objective || activity.objectifActivite);
                                    trackField('activity', 'tasks', activity.tasks || activity.aFaire);
                                    trackField('activity', 'notes', activity.notes);
                                    trackField('activity', 'resources', activity.linksReferences || activity.liensReferences);
                                    
                                    // Track learning type
                                    const type = activity.learningType || activity.type || 'none';
                                    trackField('activity', 'learningType', (type !== 'none' && type !== '') ? type : null);
                                    
                                    // Count learning types for distribution
                                    if (analysis.learningTypes.hasOwnProperty(type)) {
                                        analysis.learningTypes[type]++;
                                    } else {
                                        analysis.learningTypes.none++;
                                    }
                                });
                            };

                            // Check for submoments
                            const submoments = moment.sousMoments || moment.submoments || moment.subMoments;
                            if (submoments && Array.isArray(submoments)) {
                                analysis.submomentCount += submoments.length;
                                
                                submoments.forEach((submoment) => {
                                    // Track submoment fields
                                    trackField('submoment', 'title', submoment.title || submoment.titre);
                                    trackField('submoment', 'description', submoment.description);
                                    
                                    // Analyse activities in submoment
                                    analyseActivities(submoment.activites);
                                    analyseActivities(submoment.activities);
                                    analyseActivities(submoment.steps);
                                });
                            }
                        });
                    }
                });
            }

            analysisResults = analysis;
            displayAnalysis(analysis);
        }

        function displayAnalysis(analysis) {
            // Show counts
            document.getElementById('moduleCount').textContent = analysis.moduleCount;
            document.getElementById('momentCount').textContent = analysis.momentCount;
            document.getElementById('submomentCount').textContent = analysis.submomentCount;
            document.getElementById('activityCount').textContent = analysis.activityCount;

            // Display category checkboxes
            const categoryContainer = document.getElementById('categoryContainer');
            let categoryHTML = '';
            
            const categoryDescriptions = {
                'Training Information': 'General training details: name, theme, authors, trainers, level, modality, cohort size. Example: "Enhance the training name to be more descriptive and appealing"',
                'Target Audience & Prerequisites': 'Who is the training for and what they need to know. Example: "Add specific prerequisite skills and tools learners should master beforehand"',
                'Learning Outcomes & Objectives': 'What learners will achieve at all levels (training, modules, activities). Example: "Make objectives measurable using action verbs (analyze, create, evaluate)"',
                'Resources & Tools': 'Materials, links, software, and supporting documentation. Example: "Add specific tool names, website URLs, or document references"',
                'Content & Structure': 'Titles and descriptions that organize and explain content. Example: "Transform vague titles into clear, descriptive ones"',
                'Pedagogical Elements': 'Learning approaches, task instructions, and activity types. Example: "Add step-by-step instructions and specify collaboration methods"'
            };

            Object.entries(fieldCategories).forEach(([category, fields]) => {
                categoryHTML += `
                    <label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition">
                        <input type="checkbox" 
                               value="${category}" 
                               class="category-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 mt-1 mr-3">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 text-sm">${category}</div>
                            <div class="text-xs text-gray-600 mt-1">${categoryDescriptions[category]}</div>
                        </div>
                    </label>
                `;
            });
            
            categoryContainer.innerHTML = categoryHTML;

            // Add event listeners to category checkboxes
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedCategories.add(e.target.value);
                    } else {
                        selectedCategories.delete(e.target.value);
                    }
                    updateFieldVisibility();
                    updateSelectionSummary();
                    updatePrompt();
                });
            });

            // Display field analysis grouped by category and level
            const fieldsContainer = document.getElementById('fieldsContainer');
            let fieldsHTML = '';

            const levelColors = {
                training: { bg: 'bg-indigo-50', border: 'border-indigo-200', title: 'text-indigo-900', bar: 'bg-indigo-500' },
                module: { bg: 'bg-blue-50', border: 'border-blue-200', title: 'text-blue-900', bar: 'bg-blue-500' },
                moment: { bg: 'bg-purple-50', border: 'border-purple-200', title: 'text-purple-900', bar: 'bg-purple-500' },
                submoment: { bg: 'bg-amber-50', border: 'border-amber-200', title: 'text-amber-900', bar: 'bg-amber-500' },
                activity: { bg: 'bg-green-50', border: 'border-green-200', title: 'text-green-900', bar: 'bg-green-500' }
            };

            // Group fields by category first
            const fieldsByCategory = {};
            
            Object.entries(analysis.fields).forEach(([level, fields]) => {
                Object.entries(fields).forEach(([fieldKey, data]) => {
                    const category = getFieldCategory(fieldKey);
                    if (!fieldsByCategory[category]) {
                        fieldsByCategory[category] = {};
                    }
                    if (!fieldsByCategory[category][level]) {
                        fieldsByCategory[category][level] = {};
                    }
                    fieldsByCategory[category][level][fieldKey] = data;
                });
            });

            // Display by category
            Object.entries(fieldsByCategory).forEach(([category, levels]) => {
                fieldsHTML += `
                    <div class="field-category-section mb-4" data-category="${category}" style="display: none;">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4">
                            <h3 class="font-bold text-indigo-900 mb-4 text-lg flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                ${category}
                            </h3>
                `;

                Object.entries(levels).forEach(([level, fields]) => {
                    if (Object.keys(fields).length === 0) return;

                    const colors = levelColors[level];
                    const levelName = level === 'training' ? 'Training Parameters' : (level.charAt(0).toUpperCase() + level.slice(1));
                    
                    fieldsHTML += `
                        <div class="${colors.bg} border ${colors.border} rounded-lg p-4 mb-3">
                            <h4 class="font-semibold ${colors.title} mb-3">${levelName}</h4>
                            <div class="space-y-2">
                    `;

                    Object.entries(fields).forEach(([fieldKey, data]) => {
                        const fieldName = fieldDefinitions[level][fieldKey] || fieldKey;
                        const percentage = data.total > 0 ? Math.round((data.filled / data.total) * 100) : 0;
                        const fieldId = `field-${level}-${fieldKey}`;
                        
                        fieldsHTML += `
                            <div class="field-row">
                                <input type="checkbox" 
                                       id="${fieldId}" 
                                       class="field-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 mr-3" 
                                       data-level="${level}" 
                                       data-field="${fieldKey}">
                                <label for="${fieldId}" class="flex-1 cursor-pointer">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-700">${fieldName}</span>
                                        <span class="text-xs text-gray-500">
                                            <span class="font-semibold text-${data.unfilled > 0 ? 'red' : 'green'}-600">${data.filled}/${data.total}</span> filled
                                            ${data.unfilled > 0 ? `<span class="text-red-600">(${data.unfilled} missing)</span>` : ''}
                                        </span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${colors.bar}" style="width: ${percentage}%">
                                            ${percentage > 15 ? percentage + '%' : ''}
                                        </div>
                                    </div>
                                </label>
                            </div>
                        `;
                    });

                    fieldsHTML += `
                            </div>
                        </div>
                    `;
                });

                fieldsHTML += `
                        </div>
                    </div>
                `;
            });

            fieldsContainer.innerHTML = fieldsHTML;

            // Add event listeners to field checkboxes
            document.querySelectorAll('.field-checkbox').forEach(checkbox => {
                const key = `${checkbox.dataset.level}.${checkbox.dataset.field}`;
                
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedFields.add(key);
                    } else {
                        selectedFields.delete(key);
                    }
                    updateSelectionSummary();
                    updatePrompt();
                });
            });

            // Display learning types distribution
            const typesContainer = document.getElementById('typesContainer');
            const totalActivities = analysis.activityCount;
            const typeColors = {
                acquisition: 'bg-cyan-400',
                collaboration: 'bg-yellow-400',
                discussion: 'bg-blue-400',
                investigation: 'bg-red-400',
                practice: 'bg-purple-400',
                production: 'bg-green-400',
                none: 'bg-gray-300'
            };

            const typeBars = Object.entries(analysis.learningTypes)
                .filter(([type, count]) => count > 0)
                .map(([type, count]) => {
                    const percentage = totalActivities > 0 ? ((count / totalActivities) * 100).toFixed(1) : 0;
                    return `
                        <div class="flex items-center gap-3">
                            <div class="w-32 text-sm text-gray-700 capitalize">${type}:</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-6">
                                <div class="${typeColors[type]} h-6 rounded-full flex items-center justify-end px-2" style="width: ${percentage}%">
                                    <span class="text-xs font-medium text-gray-900">${count} (${percentage}%)</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            typesContainer.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">Learning Types Distribution</h3>
                    <div class="space-y-2">
                        ${typeBars || '<p class="text-sm text-gray-500">No activities found</p>'}
                    </div>
                </div>
            `;

            // Populate focus dropdown
            const focusSelect = document.getElementById('focusSelect');
            focusSelect.innerHTML = '<option value="">Select from your design...</option>';
            
            analysis.modules.forEach(module => {
                const opt = document.createElement('option');
                opt.value = module.name;
                opt.textContent = module.name;
                focusSelect.appendChild(opt);
            });
            
            analysis.moments.forEach(moment => {
                const opt = document.createElement('option');
                opt.value = moment.name;
                opt.textContent = moment.name;
                focusSelect.appendChild(opt);
            });

            // Show sections
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('configSection').classList.remove('hidden');
            
            // Display detected language
            const languageNames = {
                'en': 'English',
                'fr': 'FranÃ§ais',
                'es': 'EspaÃ±ol',
                'de': 'Deutsch',
                'it': 'Italiano',
                'pt': 'PortuguÃªs',
                'nl': 'Nederlands',
                'pl': 'Polski',
                'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                'zh': 'ä¸­æ–‡',
                'ja': 'æ—¥æœ¬èªž',
                'ko': 'í•œêµ­ì–´'
            };
            const detectedLangDisplay = document.getElementById('detectedLangDisplay');
            if (detectedLangDisplay) {
                detectedLangDisplay.textContent = languageNames[detectedLanguage] || detectedLanguage;
            }
            
            // Initialize selection summary
            updateSelectionSummary();
            
            // Generate initial prompt
            updatePrompt();
        }

        // Enable/disable inputs
        document.getElementById('focusCheck').addEventListener('change', function(e) {
            document.getElementById('focusSelect').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('activityCheck').addEventListener('change', function(e) {
            document.getElementById('activitySelect').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('audienceCheck').addEventListener('change', function(e) {
            document.getElementById('audienceInput').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('durationCheck').addEventListener('change', function(e) {
            document.getElementById('durationInput').disabled = !e.target.checked;
            document.getElementById('durationUnit').disabled = !e.target.checked;
            updatePrompt();
        });

        document.getElementById('toolsCheck').addEventListener('change', function(e) {
            document.getElementById('toolsInput').disabled = !e.target.checked;
            updatePrompt();
        });

        function updatePrompt() {
            if (!analysisResults) return;

            let prompt = basePrompt;
            
            // Add language instruction first
            prompt += getLanguageInstruction();
            
            let sections = [];

            // Add category and field-specific instructions
            if (selectedCategories.size > 0 || selectedFields.size > 0) {
                let fieldInstructions = '\n\n**Enhancement Focus:**\n';
                
                if (selectedCategories.size > 0) {
                    fieldInstructions += '\nSelected categories:\n- ' + Array.from(selectedCategories).join('\n- ') + '\n';
                }
                
                if (selectedFields.size > 0) {
                    const fieldsByLevel = {};
                    selectedFields.forEach(key => {
                        const [level, field] = key.split('.');
                        if (!fieldsByLevel[level]) fieldsByLevel[level] = [];
                        const fieldName = fieldDefinitions[level][field] || field;
                        const category = getFieldCategory(field);
                        fieldsByLevel[level].push(`${fieldName} (${category})`);
                    });

                    fieldInstructions += '\nSpecific fields to enhance:\n';
                    Object.entries(fieldsByLevel).forEach(([level, fields]) => {
                        const levelName = level === 'training' ? 'Training Parameters' : (level.charAt(0).toUpperCase() + level.slice(1) + ' level');
                        fieldInstructions += `\n${levelName}:\n  - ${fields.join('\n  - ')}\n`;
                    });
                }
                
                sections.push(fieldInstructions);
            }

            // Optional additions
            const additionalReqs = [];
            
            if (document.getElementById('focusCheck').checked) {
                const value = document.getElementById('focusSelect').value;
                if (value) {
                    additionalReqs.push(`Focus particularly on "${value}"`);
                }
            }

            if (document.getElementById('activityCheck').checked) {
                const value = document.getElementById('activitySelect').value;
                if (value) {
                    additionalReqs.push(`Prioritise adding ${value} activities`);
                }
            }

            if (document.getElementById('audienceCheck').checked) {
                const value = document.getElementById('audienceInput').value.trim();
                if (value) {
                    additionalReqs.push(`Ensure activities are suitable for ${value}`);
                }
            }

            if (document.getElementById('durationCheck').checked) {
                const value = document.getElementById('durationInput').value;
                const unit = document.getElementById('durationUnit').value;
                if (value) {
                    additionalReqs.push(`Keep the total duration within ${value} ${unit}`);
                }
            }

            if (document.getElementById('toolsCheck').checked) {
                const value = document.getElementById('toolsInput').value.trim();
                if (value) {
                    additionalReqs.push(`Add activities that incorporate ${value}`);
                }
            }

            if (additionalReqs.length > 0) {
                sections.push('\n**Additional Requirements:**\n- ' + additionalReqs.join('\n- '));
            }

            if (sections.length > 0) {
                prompt += '\n\n---' + sections.join('\n');
            }

            document.getElementById('promptOutput').textContent = prompt;
        }

        function copyPrompt() {
            const promptText = document.getElementById('promptOutput').textContent;
            
            if (promptText === 'Upload your JSON file to generate a customised prompt.') {
                alert('Please upload a JSON file first!');
                return;
            }

            navigator.clipboard.writeText(promptText).then(() => {
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.remove('hidden');
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 3000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        // Update prompt when inputs change
        document.querySelectorAll('#languageSelect, #focusSelect, #activitySelect, #audienceInput, #durationInput, #durationUnit, #toolsInput').forEach(elem => {
            elem.addEventListener('input', () => {
                if (learningData) updatePrompt();
            });
            elem.addEventListener('change', () => {
                if (learningData) updatePrompt();
            });
        });

        // MD MODE FUNCTIONS
        let selectedMDFields = new Set();
        let conversionMDContent = null; // Separate variable for conversion feature

        function selectFeature(feature) {
            if (feature === 'enhancement') {
                document.getElementById('uploadSection').classList.remove('hidden');
                document.getElementById('conversionSection').classList.add('hidden');
            } else if (feature === 'conversion') {
                document.getElementById('conversionSection').classList.remove('hidden');
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('analysisSection').classList.add('hidden');
                document.getElementById('configSection').classList.add('hidden');
                document.getElementById('promptSection').classList.add('hidden');
            }
        }

        function returnToFeatureSelection() {
            // Hide all feature sections
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('conversionSection').classList.add('hidden');
            document.getElementById('analysisSection').classList.add('hidden');
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('promptSection').classList.add('hidden');
            
            // Reset file inputs
            document.getElementById('fileInput').value = '';
            document.getElementById('conversionFileInput').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('conversionFileInfo').classList.add('hidden');
            document.getElementById('conversionButton').classList.add('hidden');
            
            // Reset data
            learningData = null;
            mdContent = null;
            conversionMDContent = null;
            fileType = null;
        }

        // Conversion file handling
        const conversionDropZone = document.getElementById('conversionDropZone');
        const conversionFileInput = document.getElementById('conversionFileInput');

        conversionDropZone.addEventListener('click', () => conversionFileInput.click());
        
        conversionDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            conversionDropZone.classList.add('dragover');
        });
        
        conversionDropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            conversionDropZone.classList.remove('dragover');
        });
        
        conversionDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            conversionDropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                conversionFileInput.files = files;
                handleConversionFileSelect();
            }
        });

        conversionFileInput.addEventListener('change', handleConversionFileSelect);

        function handleConversionFileSelect() {
            const file = conversionFileInput.files[0];
            if (!file) return;

            const fileName = file.name;
            const extension = fileName.split('.').pop().toLowerCase();
            
            if (extension !== 'md') {
                alert('Please upload an MD file for conversion');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                conversionMDContent = e.target.result;
                document.getElementById('conversionFileName').textContent = fileName;
                document.getElementById('conversionFileInfo').classList.remove('hidden');
                document.getElementById('conversionButton').classList.remove('hidden');
            };
            
            reader.readAsText(file);
        }

        function updateMDFieldCount() {
            const countEl = document.getElementById('mdFieldCount');
            if (countEl) {
                countEl.textContent = selectedMDFields.size;
            }
        }

        function selectLevelFields(level) {
            document.querySelectorAll(`.md-field[data-level="${level}"]`).forEach(cb => {
                cb.checked = true;
                selectedMDFields.add(cb.dataset.field);
            });
            updateMDFieldCount();
            generateMDPrompt();
        }

        function toggleMDSection(sectionId) {
            const section = document.getElementById('section-' + sectionId);
            const arrow = document.getElementById('arrow-' + sectionId);
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function selectAllMDFields() {
            document.querySelectorAll('.md-field').forEach(cb => {
                cb.checked = true;
                selectedMDFields.add(cb.dataset.field);
            });
            updateMDFieldCount();
            generateMDPrompt();
        }

        function deselectAllMDFields() {
            document.querySelectorAll('.md-field').forEach(cb => {
                cb.checked = false;
            });
            selectedMDFields.clear();
            updateMDFieldCount();
            generateMDPrompt();
        }

        function initializeMDMode() {
            // Hide JSON-specific sections
            document.getElementById('analysisSection').classList.add('hidden');
            
            // Show MD-specific configuration
            showMDConfiguration();
            
            // Generate initial MD prompt
            generateMDPrompt();
        }

        function showMDConfiguration() {
            const configSection = document.getElementById('configSection');
            configSection.classList.remove('hidden');
            
            // Replace the content with MD-specific options
            const leftColumn = configSection.querySelector('.space-y-4');
            leftColumn.innerHTML = `
                <!-- MD Configuration -->
                <div class="bg-white rounded-lg shadow p-6 section-card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="bg-purple-100 text-purple-700 rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm font-bold">2</span>
                        Select Fields to Enhance
                    </h2>
                    <p class="text-sm text-gray-600 bg-purple-50 border-l-4 border-purple-400 p-3 rounded mb-4">
                        Select specific elements from your learning design to enhance. Click on categories to expand and select individual fields.
                    </p>
                    <div class="flex gap-2 mb-4">
                        <button onclick="selectAllMDFields()" class="text-xs px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition">
                            Select All
                        </button>
                        <button onclick="deselectAllMDFields()" class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
                            Deselect All
                        </button>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4">
                        <p class="text-sm">
                            <strong>Selected fields:</strong> <span id="mdFieldCount" class="font-semibold text-purple-700">0</span>
                        </p>
                    </div>
                </div>

                <!-- Fine-grained Field Selection -->
                <div class="bg-white rounded-lg shadow p-6 section-card">
                    <div id="mdFieldSelection" class="space-y-4">
                        <!-- Training Level -->
                        <div class="border border-gray-200 rounded-lg">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 cursor-pointer flex items-center justify-between" onclick="toggleMDSection('training')">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">ðŸ“š</span>
                                    <h4 class="font-semibold text-gray-800">Training Level (Metadata & Overview)</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); selectLevelFields('training')" class="text-xs px-2 py-1 bg-blue-200 text-blue-800 rounded hover:bg-blue-300 transition">
                                        Select All
                                    </button>
                                    <svg id="arrow-training" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                            <div id="section-training" class="p-3 space-y-2 hidden">
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.name" data-level="training"> Training name & description</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.designers" data-level="training"> Designers & trainers</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.audience" data-level="training"> Target audience</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.prerequisites" data-level="training"> Prerequisites</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.tools" data-level="training"> Tools & materials</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.objectives" data-level="training"> Learning objectives (what will be taught)</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.outcomes" data-level="training"> Learning outcomes (what learners will be able to do)</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="training.description" data-level="training"> General description</label>
                            </div>
                        </div>

                        <!-- Module Level -->
                        <div class="border border-gray-200 rounded-lg">
                            <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 p-3 cursor-pointer flex items-center justify-between" onclick="toggleMDSection('module')">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">ðŸ“¦</span>
                                    <h4 class="font-semibold text-gray-800">Module Level</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); selectLevelFields('module')" class="text-xs px-2 py-1 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
                                        Select All
                                    </button>
                                    <svg id="arrow-module" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                            <div id="section-module" class="p-3 space-y-2 hidden">
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="module.title" data-level="module"> Module titles</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="module.description" data-level="module"> Module descriptions</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="module.objectives" data-level="module"> Module objectives</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="module.outcomes" data-level="module"> Module outcomes</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="module.competences" data-level="module"> Module competences</label>
                            </div>
                        </div>

                        <!-- Moment Level -->
                        <div class="border border-gray-200 rounded-lg">
                            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-3 cursor-pointer flex items-center justify-between" onclick="toggleMDSection('moment')">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">â°</span>
                                    <h4 class="font-semibold text-gray-800">Moment Level (Learning Sessions)</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); selectLevelFields('moment')" class="text-xs px-2 py-1 bg-purple-200 text-purple-800 rounded hover:bg-purple-300 transition">
                                        Select All
                                    </button>
                                    <svg id="arrow-moment" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                            <div id="section-moment" class="p-3 space-y-2 hidden">
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="moment.title" data-level="moment"> Moment titles</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="moment.description" data-level="moment"> Moment descriptions</label>
                            </div>
                        </div>

                        <!-- Submoment Level -->
                        <div class="border border-gray-200 rounded-lg">
                            <div class="bg-gradient-to-r from-amber-50 to-amber-100 p-3 cursor-pointer flex items-center justify-between" onclick="toggleMDSection('submoment')">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">ðŸ”¸</span>
                                    <h4 class="font-semibold text-gray-800">Submoment Level (Session Segments)</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); selectLevelFields('submoment')" class="text-xs px-2 py-1 bg-amber-200 text-amber-800 rounded hover:bg-amber-300 transition">
                                        Select All
                                    </button>
                                    <svg id="arrow-submoment" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                            <div id="section-submoment" class="p-3 space-y-2 hidden">
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="submoment.title" data-level="submoment"> Submoment titles</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="submoment.description" data-level="submoment"> Submoment descriptions</label>
                            </div>
                        </div>

                        <!-- Activity Level -->
                        <div class="border border-gray-200 rounded-lg">
                            <div class="bg-gradient-to-r from-green-50 to-green-100 p-3 cursor-pointer flex items-center justify-between" onclick="toggleMDSection('activity')">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">âœï¸</span>
                                    <h4 class="font-semibold text-gray-800">Activity Level</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); selectLevelFields('activity')" class="text-xs px-2 py-1 bg-green-200 text-green-800 rounded hover:bg-green-300 transition">
                                        Select All
                                    </button>
                                    <svg id="arrow-activity" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                            <div id="section-activity" class="p-3 space-y-2 hidden">
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.title" data-level="activity"> Activity titles</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.type" data-level="activity"> Activity type</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.objective" data-level="activity"> Activity objective</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.learner_tasks" data-level="activity"> What learners must do</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.trainer_tasks" data-level="activity"> What trainer must do</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.evaluation" data-level="activity"> Evaluation / follow-up</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.notes" data-level="activity"> Pedagogical notes</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.tools" data-level="activity"> Activity-specific tools & materials</label>
                                <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 md-field" data-field="activity.competences" data-level="activity"> Activity competences</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Number of Modifications -->
                <div class="bg-white rounded-lg shadow p-6 section-card">
                    <h3 class="font-semibold text-gray-800 mb-4">Number of Modifications</h3>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="md_count" value="5" class="mr-2 md-count-radio">
                            <span>5 modifications</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="md_count" value="10" class="mr-2 md-count-radio" checked>
                            <span>10 modifications</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="md_count" value="15" class="mr-2 md-count-radio">
                            <span>15 modifications</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="md_count" value="custom" class="mr-2 md-count-radio">
                            <input type="number" id="md_custom_count" min="1" max="50" placeholder="Custom" 
                                   class="border rounded px-2 py-1 w-20 text-sm">
                        </label>
                    </div>
                </div>

                <!-- Priority Level -->
                <div class="bg-white rounded-lg shadow p-6 section-card">
                    <h3 class="font-semibold text-gray-800 mb-4">Modification Priority</h3>
                    <select id="md_priority" class="border rounded px-4 py-2 w-full">
                        <option value="high">High-impact modifications only</option>
                        <option value="mixed" selected>Mix of high and medium impact</option>
                        <option value="comprehensive">Comprehensive (all levels)</option>
                    </select>
                </div>

                <!-- Output Language -->
                <div class="bg-white rounded-lg shadow p-6 section-card">
                    <h3 class="font-semibold text-gray-800 mb-4">Output Language</h3>
                    <select id="md_language" class="border rounded px-4 py-2 w-full">
                        <option value="en">English</option>
                        <option value="fr" selected>FranÃ§ais</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">PortuguÃªs</option>
                    </select>
                </div>

                <!-- Additional Context -->
                <div class="bg-white rounded-lg shadow p-6 section-card">
                    <h3 class="font-semibold text-gray-800 mb-4">Additional Context (Optional)</h3>
                    <textarea id="md_context" rows="3" class="border rounded px-4 py-2 w-full" 
                        placeholder="Add any specific requirements or constraints for the modifications..."></textarea>
                </div>

                <!-- Generate Button -->
                <button onclick="generateMDPrompt()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 transform hover:scale-105">
                    Update Prompt
                </button>
            `;
            
            // Add event listeners for MD options
            setTimeout(() => {
                document.querySelectorAll('.md-field').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedMDFields.add(e.target.dataset.field);
                        } else {
                            selectedMDFields.delete(e.target.dataset.field);
                        }
                        updateMDFieldCount();
                        generateMDPrompt();
                    });
                });
                
                document.querySelectorAll('.md-count-radio, #md_priority, #md_language, #md_context, #md_custom_count').forEach(elem => {
                    elem.addEventListener('change', generateMDPrompt);
                    elem.addEventListener('input', generateMDPrompt);
                });
            }, 100);
        }

        function generateMDPrompt() {
            if (!mdContent) return;
            
            // Get selected fields organized by level
            const fieldsByLevel = {
                training: [],
                module: [],
                moment: [],
                submoment: [],
                activity: []
            };
            
            const fieldLabels = {
                'training.name': 'Training name & description',
                'training.designers': 'Designers & trainers',
                'training.audience': 'Target audience',
                'training.prerequisites': 'Prerequisites',
                'training.tools': 'Tools & materials',
                'training.objectives': 'Learning objectives',
                'training.outcomes': 'Learning outcomes',
                'training.description': 'General description',
                'module.title': 'Module titles',
                'module.description': 'Module descriptions',
                'module.objectives': 'Module objectives',
                'module.outcomes': 'Module outcomes',
                'module.competences': 'Module competences',
                'moment.title': 'Moment titles',
                'moment.description': 'Moment descriptions',
                'submoment.title': 'Submoment titles',
                'submoment.description': 'Submoment descriptions',
                'activity.title': 'Activity titles',
                'activity.type': 'Activity type',
                'activity.objective': 'Activity objective',
                'activity.learner_tasks': 'What learners must do',
                'activity.trainer_tasks': 'What trainer must do',
                'activity.evaluation': 'Evaluation / follow-up',
                'activity.notes': 'Pedagogical notes',
                'activity.tools': 'Activity-specific tools & materials',
                'activity.competences': 'Activity competences'
            };
            
            selectedMDFields.forEach(field => {
                const [level, fieldName] = field.split('.');
                if (fieldsByLevel[level]) {
                    fieldsByLevel[level].push(fieldLabels[field] || field);
                }
            });
            
            let modCount = document.querySelector('input[name="md_count"]:checked')?.value || '10';
            if (modCount === 'custom') {
                modCount = document.getElementById('md_custom_count')?.value || '10';
            }
            
            const priority = document.getElementById('md_priority')?.value || 'mixed';
            const language = document.getElementById('md_language')?.value || 'fr';
            const context = document.getElementById('md_context')?.value.trim() || '';
            
            const languageNames = {
                'en': 'English',
                'fr': 'French',
                'es': 'Spanish',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese'
            };
            
            const langName = languageNames[language] || language;
            
            let priorityDesc = '';
            if (priority === 'high') {
                priorityDesc = 'Focus only on high-impact modifications that will significantly improve learning outcomes.';
            } else if (priority === 'mixed') {
                priorityDesc = 'Provide a mix of high-impact and medium-impact modifications.';
            } else {
                priorityDesc = 'Provide a comprehensive set of modifications covering all aspects of the design.';
            }
            
            // Build focus areas description
            let focusAreasText = '';
            if (selectedMDFields.size > 0) {
                focusAreasText = '\n**FOCUS YOUR MODIFICATIONS ON THESE SPECIFIC FIELDS:**\n\n';
                
                if (fieldsByLevel.training.length > 0) {
                    focusAreasText += '**Training Level:**\n' + fieldsByLevel.training.map(f => `- ${f}`).join('\n') + '\n\n';
                }
                if (fieldsByLevel.module.length > 0) {
                    focusAreasText += '**Module Level:**\n' + fieldsByLevel.module.map(f => `- ${f}`).join('\n') + '\n\n';
                }
                if (fieldsByLevel.moment.length > 0) {
                    focusAreasText += '**Moment Level:**\n' + fieldsByLevel.moment.map(f => `- ${f}`).join('\n') + '\n\n';
                }
                if (fieldsByLevel.submoment.length > 0) {
                    focusAreasText += '**Submoment Level:**\n' + fieldsByLevel.submoment.map(f => `- ${f}`).join('\n') + '\n\n';
                }
                if (fieldsByLevel.activity.length > 0) {
                    focusAreasText += '**Activity Level:**\n' + fieldsByLevel.activity.map(f => `- ${f}`).join('\n') + '\n\n';
                }
                
                focusAreasText += 'Only propose modifications for the fields listed above. Do not modify other fields.\n';
            } else {
                focusAreasText = '\n**FOCUS AREAS:**\nNo specific fields selected. Please select fields from the checkboxes above to focus the enhancement.\n';
            }
            
            const prompt = `You are an expert instructional designer. Please analyse the following learning design document (in Markdown format) and propose ${modCount} specific modifications to enhance it.

**CRITICAL REQUIREMENTS:**

For each modification, you MUST provide all three components:

1. **Original Segment**: Quote the exact text or section from the document that needs modification. Include enough context (e.g., the section heading or activity number) to locate it precisely in the document.

2. **Proposed Modification**: Provide the complete improved version of that text.

3. **Explanation**: Explain why this modification improves the learning design. Reference specific instructional design principles, learning theories, or pedagogical best practices (e.g., Bloom's Taxonomy, constructive alignment, scaffolding, SMART objectives, etc.).

---
${focusAreasText}
---

**PRIORITY LEVEL:**
${priorityDesc}

**OUTPUT LANGUAGE:**
All modifications and explanations must be written in ${langName}.
${context ? `\n**ADDITIONAL CONTEXT:**\n${context}\n` : ''}
---

**OUTPUT FORMAT:**

Structure your response EXACTLY as follows for each modification:

## Modification 1: [Brief Descriptive Title]

**Location in Document:**
[Specify where this appears - e.g., "Module 1, Moment 1.1, Activity 1.1.1.1" or "Training metadata - Target audience section"]

**Original Segment:**
\`\`\`
[Quote the exact text from the document that you are modifying]
\`\`\`

**Proposed Modification:**
\`\`\`
[Provide your complete improved version here]
\`\`\`

**Explanation:**
[Explain clearly and specifically why this modification enhances the learning design. Reference instructional design principles, learning theories, or pedagogical best practices. Be concrete about the improvement - avoid vague statements like "this is better" - instead explain HOW and WHY it improves learning outcomes, clarity, alignment, engagement, etc.]

---

[Repeat the above structure for each of the ${modCount} modifications]

---

**LEARNING DESIGN DOCUMENT:**

${mdContent}

---

**IMPORTANT REMINDERS:**

- Provide exactly ${modCount} modifications
- Each modification MUST include: Location, Original Segment, Proposed Modification, and Explanation
${selectedMDFields.size > 0 ? `- Focus ONLY on the selected fields listed above (${selectedMDFields.size} fields selected)` : '- Please wait for field selection before proceeding'}
- All text must be in ${langName}
- Quote enough context in "Original Segment" to make the location unambiguous
- Be specific and actionable in your modifications
- Ground your explanations in pedagogical theory and best practices

Please begin with your first modification now.`;
            
            document.getElementById('promptOutput').textContent = prompt;
        }

        // MD TO JSON CONVERSION
        function generateUniqueId(prefix) {
            return `${prefix}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function parseDuration(durationStr) {
            if (!durationStr) return { value: 0, unit: 60, unitKey: 'minutes' };
            
            // Parse formats like "2h16", "25m", "155 min", "2 Heures"
            const hourMatch = durationStr.match(/(\d+)\s*h/i);
            const minMatch = durationStr.match(/(\d+)\s*m(?:in)?/i);
            
            let totalMinutes = 0;
            if (hourMatch) totalMinutes += parseInt(hourMatch[1]) * 60;
            if (minMatch) totalMinutes += parseInt(minMatch[1]);
            
            return {
                value: totalMinutes,
                unit: 60,
                unitKey: 'minutes'
            };
        }

        function convertMDToJSON() {
            // Check which content to use (conversion feature or enhancement feature)
            const contentToConvert = conversionMDContent || mdContent;
            
            if (!contentToConvert) {
                alert('No MD file loaded');
                return;
            }

            try {
                const jsonData = parseMDToJSON(contentToConvert);
                
                // Create downloadable JSON file
                const jsonString = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'learning-design-converted.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success message
                alert('JSON file generated successfully! The file has been downloaded.');
            } catch (error) {
                alert('Error converting MD to JSON: ' + error.message);
                console.error(error);
            }
        }

        function parseMDToJSON(mdText) {
            const lines = mdText.split('\n');
            let currentSection = null;
            let currentModule = null;
            let currentMoment = null;
            let currentSubmoment = null;
            let currentActivity = null;
            let currentField = null;
            
            const data = {
                schemaVersion: 2,
                exportedAt: new Date().toISOString(),
                i18n: {
                    currentLang: 'fr',
                    defaultLang: 'fr',
                    availableLangs: ['fr', 'en']
                },
                parametres: {
                    nom: '',
                    name: '',
                    theme: '',
                    auteurs: [],
                    formateurs: [],
                    niveau: '',
                    modalite: '',
                    tailleCohorte: 0,
                    publicCible: '',
                    prerequis: '',
                    outilsMateriel: [],
                    outilsMaterielNotes: '',
                    objectifs: [],
                    resultatsTexte: [],
                    description: ''
                },
                modules: []
            };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // Skip empty lines
                if (!trimmedLine) continue;

                // Detect sections
                if (trimmedLine === '## mÃ©tadonnÃ©es' || trimmedLine === '## metadata') {
                    currentSection = 'metadata';
                    continue;
                } else if (trimmedLine === '## informations_clÃ©s' || trimmedLine === '## key_information') {
                    currentSection = 'key_info';
                    continue;
                } else if (trimmedLine === '## structure_pÃ©dagogique' || trimmedLine === '## pedagogical_structure') {
                    currentSection = 'structure';
                    continue;
                }

                // Parse metadata
                if (currentSection === 'metadata') {
                    const match = trimmedLine.match(/^-\s+\*\*([^:]+):\*\*\s*(.+)$/);
                    if (match) {
                        const fieldName = match[1].trim();
                        const value = match[2].trim();
                        
                        if (fieldName.includes('Nom de la formation') || fieldName.includes('Training name')) {
                            data.parametres.nom = value;
                            data.parametres.name = value;
                        } else if (fieldName.includes('Concepteur') || fieldName.includes('Designer')) {
                            data.parametres.auteurs = [value];
                        } else if (fieldName.includes('Formateur') || fieldName.includes('Trainer')) {
                            data.parametres.formateurs = [value];
                        } else if (fieldName.includes('ThÃ¨me') || fieldName.includes('Theme')) {
                            data.parametres.theme = value;
                        } else if (fieldName.includes('ModalitÃ©') || fieldName.includes('Modality')) {
                            data.parametres.modalite = value;
                        } else if (fieldName.includes('Niveau') || fieldName.includes('Level')) {
                            data.parametres.niveau = value;
                        } else if (fieldName.includes('Taille') || fieldName.includes('Cohort')) {
                            data.parametres.tailleCohorte = parseInt(value) || 0;
                        }
                    }
                }

                // Parse key information
                if (currentSection === 'key_info') {
                    if (trimmedLine.startsWith('### Public cible') || trimmedLine.startsWith('### Target audience')) {
                        currentField = 'audience';
                        continue;
                    } else if (trimmedLine.startsWith('### PrÃ©requis') || trimmedLine.startsWith('### Prerequisites')) {
                        currentField = 'prerequisites';
                        continue;
                    } else if (trimmedLine.startsWith('### Outils') || trimmedLine.startsWith('### Tools')) {
                        currentField = 'tools';
                        continue;
                    } else if (trimmedLine.startsWith('### Objectifs')) {
                        currentField = 'objectives';
                        continue;
                    } else if (trimmedLine.startsWith('### RÃ©sultats')) {
                        currentField = 'outcomes';
                        continue;
                    } else if (trimmedLine.startsWith('### Description')) {
                        currentField = 'description';
                        continue;
                    } else if (trimmedLine.startsWith('###')) {
                        currentField = null;
                        continue;
                    }

                    if (currentField && trimmedLine && !trimmedLine.startsWith('#')) {
                        switch (currentField) {
                            case 'audience':
                                data.parametres.publicCible += (data.parametres.publicCible ? '\n' : '') + trimmedLine;
                                break;
                            case 'prerequisites':
                                data.parametres.prerequis += (data.parametres.prerequis ? '\n' : '') + trimmedLine;
                                break;
                            case 'tools':
                                if (!trimmedLine.startsWith('-')) {
                                    data.parametres.outilsMaterielNotes += (data.parametres.outilsMaterielNotes ? '\n' : '') + trimmedLine;
                                } else {
                                    data.parametres.outilsMateriel.push(trimmedLine.replace(/^-\s*/, ''));
                                }
                                break;
                            case 'objectives':
                                if (trimmedLine && !trimmedLine.startsWith('Aucun')) {
                                    data.parametres.objectifs.push(trimmedLine);
                                }
                                break;
                            case 'outcomes':
                                if (trimmedLine && !trimmedLine.startsWith('Aucun')) {
                                    data.parametres.resultatsTexte.push(trimmedLine);
                                }
                                break;
                            case 'description':
                                data.parametres.description += (data.parametres.description ? '\n' : '') + trimmedLine;
                                break;
                        }
                    }
                }

                // Parse pedagogical structure
                if (currentSection === 'structure') {
                    // Module
                    if (trimmedLine.match(/^###\s+MODULE\s+\d+/i)) {
                        const titleMatch = trimmedLine.match(/^###\s+MODULE\s+\d+\s*[:ï¼š]\s*(.+)$/i);
                        currentModule = {
                            id: generateUniqueId('module'),
                            titre: titleMatch ? titleMatch[1] : '',
                            title: titleMatch ? titleMatch[1] : '',
                            description: '',
                            desc: '',
                            notes: '',
                            objectifs: [],
                            objectives: [],
                            learningOutcomes: [],
                            competences: [],
                            moments: []
                        };
                        data.modules.push(currentModule);
                        currentMoment = null;
                        currentSubmoment = null;
                        currentActivity = null;
                        continue;
                    }

                    // Moment
                    if (trimmedLine.match(/^####\s+MOMENT\s+[\d.]+/i)) {
                        const titleMatch = trimmedLine.match(/^####\s+MOMENT\s+[\d.]+\s*[:ï¼š]\s*(.+)$/i);
                        currentMoment = {
                            id: generateUniqueId('moment'),
                            titre: titleMatch ? titleMatch[1] : '',
                            title: titleMatch ? titleMatch[1] : '',
                            description: '',
                            desc: '',
                            sousMoments: [],
                            activites: []
                        };
                        if (currentModule) {
                            currentModule.moments.push(currentMoment);
                        }
                        currentSubmoment = null;
                        currentActivity = null;
                        continue;
                    }

                    // Submoment
                    if (trimmedLine.match(/^#####\s+SOUS-MOMENT\s+[\d.]+/i)) {
                        const titleMatch = trimmedLine.match(/^#####\s+SOUS-MOMENT\s+[\d.]+\s*[:ï¼š]\s*(.+)$/i);
                        currentSubmoment = {
                            id: generateUniqueId('submoment'),
                            titre: titleMatch ? titleMatch[1] : '',
                            title: titleMatch ? titleMatch[1] : '',
                            description: '',
                            desc: '',
                            activites: []
                        };
                        if (currentMoment) {
                            currentMoment.sousMoments.push(currentSubmoment);
                        }
                        currentActivity = null;
                        continue;
                    }

                    // Activity
                    if (trimmedLine.match(/^#####\s+ACTIVITÃ‰\s+[\d.]+/i)) {
                        const titleMatch = trimmedLine.match(/^#####\s+ACTIVITÃ‰\s+[\d.]+\s*[:ï¼š]\s*(.+)$/i);
                        currentActivity = {
                            id: generateUniqueId('step'),
                            titre: titleMatch ? titleMatch[1] : '',
                            title: titleMatch ? titleMatch[1] : '',
                            description: '',
                            desc: '',
                            objectifActivite: '',
                            objective: '',
                            aFaire: '',
                            tasks: '',
                            aFaireFormateur: '',
                            trainerTasks: '',
                            notes: '',
                            liensReferences: '',
                            resources: '',
                            typeDApprentissage: '',
                            learningType: '',
                            duree: 0,
                            duration: 0,
                            unite: 60,
                            unit: 60,
                            regroupement: '',
                            groupMode: '',
                            evaluation: '',
                            outilsMateriel: ''
                        };
                        
                        if (currentSubmoment) {
                            currentSubmoment.activites.push(currentActivity);
                        } else if (currentMoment) {
                            currentMoment.activites.push(currentActivity);
                        }
                        continue;
                    }

                    // Parse activity/moment/module fields
                    if (trimmedLine.startsWith('- **Type :**') || trimmedLine.startsWith('- **Type:**')) {
                        if (currentActivity) {
                            const value = trimmedLine.split(':')[1]?.trim() || '';
                            currentActivity.typeDApprentissage = value;
                            currentActivity.learningType = value;
                        }
                    } else if (trimmedLine.startsWith('- **DurÃ©e')) {
                        const durationMatch = trimmedLine.match(/:\s*(.+)$/);
                        if (durationMatch && currentActivity) {
                            const parsed = parseDuration(durationMatch[1]);
                            currentActivity.duree = parsed.value;
                            currentActivity.duration = parsed.value;
                        } else if (durationMatch && currentMoment && !currentActivity) {
                            const parsed = parseDuration(durationMatch[1]);
                            if (!currentMoment.dureeConcue) {
                                currentMoment.dureeConcue = parsed.value;
                                currentMoment.dureeConcueUnite = parsed.unit;
                            }
                        }
                    } else if (trimmedLine.startsWith('- **Regroupement')) {
                        if (currentActivity) {
                            const value = trimmedLine.split(':')[1]?.trim() || '';
                            currentActivity.regroupement = value;
                            currentActivity.groupMode = value;
                        }
                    } else if (trimmedLine.startsWith('- **Objectif de l\'activitÃ©') || trimmedLine.startsWith('- **Activity objective')) {
                        if (currentActivity) {
                            const value = trimmedLine.split(':')[1]?.trim() || '';
                            currentActivity.objectifActivite = value;
                            currentActivity.objective = value;
                        }
                    } else if (trimmedLine.startsWith('**Ce que les apprenants')) {
                        currentField = 'learner_tasks';
                    } else if (trimmedLine.startsWith('**Ce que le formateur')) {
                        currentField = 'trainer_tasks';
                    } else if (trimmedLine.startsWith('**Ã‰valuation')) {
                        currentField = 'evaluation';
                    } else if (trimmedLine.startsWith('**Notes pÃ©dagogiques')) {
                        currentField = 'pedagogical_notes';
                    } else if (trimmedLine.startsWith('**Outils et matÃ©riel')) {
                        currentField = 'activity_tools';
                    } else if (trimmedLine === 'Non renseignÃ©' || trimmedLine === 'â€”') {
                        currentField = null;
                    } else if (currentField && currentActivity && trimmedLine && !trimmedLine.startsWith('**') && !trimmedLine.startsWith('#')) {
                        switch (currentField) {
                            case 'learner_tasks':
                                currentActivity.aFaire += (currentActivity.aFaire ? '\n' : '') + trimmedLine;
                                currentActivity.tasks += (currentActivity.tasks ? '\n' : '') + trimmedLine;
                                break;
                            case 'trainer_tasks':
                                currentActivity.aFaireFormateur += (currentActivity.aFaireFormateur ? '\n' : '') + trimmedLine;
                                currentActivity.trainerTasks += (currentActivity.trainerTasks ? '\n' : '') + trimmedLine;
                                break;
                            case 'evaluation':
                                currentActivity.evaluation += (currentActivity.evaluation ? '\n' : '') + trimmedLine;
                                break;
                            case 'pedagogical_notes':
                                currentActivity.notes += (currentActivity.notes ? '\n' : '') + trimmedLine;
                                break;
                            case 'activity_tools':
                                currentActivity.outilsMateriel += (currentActivity.outilsMateriel ? '\n' : '') + trimmedLine;
                                break;
                        }
                    }

                    // Module description
                    if (currentModule && !currentMoment && trimmedLine.startsWith('>')) {
                        const desc = trimmedLine.replace(/^>\s*/, '');
                        currentModule.description = desc;
                        currentModule.desc = desc;
                    }
                }
            }

            return data;
        }
    </script>
</body>
</html>
